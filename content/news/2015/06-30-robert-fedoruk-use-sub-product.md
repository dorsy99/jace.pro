---
title: "Use SubProduction Notifications Like a Boss"
date: 2015-06-29T23:17:40.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=83bc6e25dbd0dbc01dcaf3231f96192d"
---
<h2><span style="font-family: verdana, geneva;">THE PROBLEM WITH OOB CAPABILITIES</span></h2><p><span style="font-family: verdana, geneva;">Those of you who've had rigorous testing protocols on ServiceNow know that there's a critical weakness with notification handling on non-production systems.   You have only three options:</span></p><ol><li><span style="font-family: verdana, geneva;"><strong>Disable all notifications</strong> - "Great, now I can't test notifications at all!"   <span __jive_emoticon_name="sad" __jive_macro_name="emoticon" class="jive_macro jive_emote" src="/6.0.3.0/images/emoticons/sad.png"></span> </span></li><li><span style="font-family: verdana, geneva;"><strong>Enable all notifications</strong> - "Great, now my customers get notifications they neither want nor expect"   <span __jive_emoticon_name="sad" __jive_macro_name="emoticon" class="jive_macro jive_emote" src="/6.0.3.0/images/emoticons/sad.png"></span> x2</span></li><li><span style="font-family: verdana, geneva;"><strong>Send all notifications to specified email addresses</strong> -   "Great, now my testers have to separate signal from noise" <span __jive_emoticon_name="sad" __jive_macro_name="emoticon" class="jive_macro jive_emote" src="/6.0.3.0/images/emoticons/sad.png"></span></span></li></ol><p></p><p><span style="font-family: verdana, geneva;">There must be a better way.</span></p><p></p><h2><span style="font-family: verdana, geneva;">SOLUTION:   FILTER INTENDED RECIPIENTS</span></h2><p><span style="font-family: verdana, geneva;">We need a solution that provides the following</span></p><ul><li><span style="font-family: verdana, geneva;">Req1 - authorize whole groups to receive notifications on non-prod</span></li><li><span style="font-family: verdana, geneva;">Req2 - authorize single users to receive notifications on non-prod</span></li><li><span style="font-family: verdana, geneva;">Req3 - exists on all instances, but only works on non-prod instances</span></li></ul><p></p><p><span style="font-family: verdana, geneva;">We'll provide this solution with one dictionary entry and one before-insert business rule.</span></p><p></p><p><span style="font-family: verdana, geneva;">First, we build a true/false field named u_subprodemail on the Group table only.   You might look at Req2 and say "don't we need this on User table too"?   Nope!   We're solving two use cases here.   First is flagging whole groups that want to receive notifications.   For individuals, we'll simply create a new group (with u_subprodemail = true) that we can put those 'one of' users in.</span></p><p></p><p><span style="font-family: verdana, geneva;">Now we create a Before Insert business rule on the Sys_Email table.   We're going to intercept outbound email and bend it to our will! </span></p><p><span style="font-family: verdana, geneva;"><strong>NAME</strong>:   Control Sub-Prod Email</span></p><p><span style="font-family: verdana, geneva;"><strong>CONDITION</strong>:   </span></p><p><span style="font-family: verdana, geneva;"><span>gs.getProperty('glide.servlet.uri') != "</span><a title="k-external-small" class="jive-link-external-small" href="https://" rel="nofollow" target="_blank">https://</a><span>&lt;yourinstancename&gt;.service-now.com" &amp;&amp; current.type != "received"</span></span></p><p></p><p><span style="font-family: verdana, geneva;"><strong>SCRIPT</strong>: <br/></span></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_text_macro jive_macro_code _jivemacro_uid_14356014048112554" jivemacro_uid="_14356014048112554">
<p><span style="font-family: verdana, geneva;">function onBefore(current, previous) {</span></p>
<p><span style="font-family: verdana, geneva;">   var validSends = [];</span></p>
<p><span style="font-family: verdana, geneva;">   var ga = new GlideAggregate('sys_user_grmember');</span></p>
<p><span style="font-family: verdana, geneva;">   ga.addQuery('group.u_subprod_email',true);</span></p>
<p><span style="font-family: verdana, geneva;">   ga.groupBy('user');</span></p>
<p><span style="font-family: verdana, geneva;">   ga.query();</span></p>
<p><span style="font-family: verdana, geneva;">   while (ga.next()){</span></p>
<p><span style="font-family: verdana, geneva;">       if (current.recipients.indexOf(ga.user.email.toString()) &gt;= 0){</span></p>
<p><span style="font-family: verdana, geneva;">           validSends.push(ga.user.email.toString());</span></p>
<p><span style="font-family: verdana, geneva;">       }</span></p>
<p><span style="font-family: verdana, geneva;">   }</span></p>
<p><span style="font-family: verdana, geneva;">   current.recipients = validSends.toString();</span></p>
<p><span style="font-family: verdana, geneva;">   current.body = "SENT FROM NON-PRODUCTION SYSTEM \n\n" + current.body;</span></p>
<p><span style="font-family: verdana, geneva;">   gs.log(gs.getProperty('glide.servlet.uri') + " " + validSends, 'Sub-Prod Notifications');</span></p>
<p><span style="font-family: verdana, geneva;">}</span></p>
</pre><p></p><h2>SCRIPT EXPLAINED</h2><ul><li>We declare validSends variable as a blank array.</li><li>We query the sys_user_grmember table finding all group members for groups that have the u_subprod_email set to true.</li><li>We're using GlideAggregate and GroupBy so that multiple memberships with the same User are represented only once.</li><li>For each result we compare the group member's email against the list of recipients targeted for the sys_email insert.</li><li>If there's a match, we push the value to the validSends array.</li><li>After we've tested all validated addresses, we overwrite current.recipients with validSends.</li><li>We also add text to the top of the email body to reinforce it was sent from a non-prod system.</li><li>REMEMBER:   Because we're checking *group memberships* to groups that have been flagged as enabled, you may have users part of multiple groups, only one which is email enabled.   A user only needs one "enabled" membership to receive all email targeted at them.</li></ul><p></p><h2>CONGRATULATIONS!</h2><ul><li>You can include notifications as a component of your UAT.   </li><li>You can precision control the groups and users to receive those notifications.</li><li>You can push this customization to prod so you don't have to rebuild it after every clone-back.</li></ul>