---
title: "Example of how cart api could cause request items missing or in the wrong request"
date: 2015-09-16T23:26:54.000Z
authors: ["jonnyseymour"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=38ccee25dbd0dbc01dcaf3231f961977"
---
<p>One of my post <a title="" _jive_internal="true" data-containerid="-1" data-containertype="-1" data-objectid="45437" data-objecttype="3" href="/people/jonnyseymour/content"> my past blog posts</a> talked about <a title="SOAP Web Service and time zones examples" __default_attr="4389" __jive_macro_name="blogpost" class="jive_macro jive_macro_blogpost" data-orig-content="SOAP Web Service and time zones examples" data-renderedposition="10.25_314.23333740234375_302_17" href="/community?id=community_blog&sys_id=15bcaa25dbd0dbc01dcaf3231f96199f">SOAP Web Service and time zones examples</a>. I will discuss now a race condition that can cause missing service catalog items or attached to the wrong request REQ.</p><p></p><p><img  alt="missing_item.png" class="image-6 jive-image" height="96" src="73e78406dbd81304b322f4621f961908.iix" style="width: 131px; height: 96.4306px; display: block; margin-left: auto; margin-right: auto;" width="131"/></p><p>Let's talk about</p><ul><li>Service Cart API</li><li>Scripted Web services</li><li>Example of scripted webservices where request items got missing or in the wrong request</li></ul><p></p><h2>Service Cart API</h2><p>The <a title="ocs.servicenow.com/bundle/istanbul-it-service-management/page/product/service-catalog-management/concept/c_ServiceCatalogManagement.html" href="https://docs.servicenow.com/bundle/istanbul-it-service-management/page/product/service-catalog-management/concept/c_ServiceCatalogManagement.html">Service Catalog application</a> is a way for customers to order pre-defined, bundled goods and services from your IT organization or other departments. It offers a consistent and intuitive online ordering experience with as much flexibility as you need. The catalog is a structured commodity with its own description, fields, price, and execution schedule.</p><p></p><p>A <a title="ocs.servicenow.com/bundle/istanbul-servicenow-platform/page/script/server-scripting/reference/r_ServiceCatalogScriptAPI.html" href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/script/server-scripting/reference/r_ServiceCatalogScriptAPI.html">scriptable cart API for the service catalog</a> makes it easier to order from the catalog when using business rules.</p><p>The cart API allows you to order any quantity of catalog items, using the sys_id of the Catalog Item [sc_cat_item] you want.</p><p>You can then set catalog variables to values as required, assuming the variables have names.</p><p></p><h2>Scripted Web services</h2><p><a title="ocs.servicenow.com/bundle/istanbul-servicenow-platform/page/integrate/inbound-soap/concept/c_ScriptedWebServices.html" href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/integrate/inbound-soap/concept/c_ScriptedWebServices.html">Scripted Web Services</a> allow a ServiceNow administrator to create new web services that are not addressed by the system. You can define input and output parameters for the web service and use JavaScript to perform operations. Though this feature is very powerful, use <a title="ocs.servicenow.com/bundle/istanbul-servicenow-platform/page/integrate/inbound-soap/concept/c_DirectWebServices.html" href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/integrate/inbound-soap/concept/c_DirectWebServices.html">Direct Web Services</a> or <a title="ocs.servicenow.com/bundle/istanbul-servicenow-platform/page/administer/import-sets/concept/c_WebServiceImportSets.html" href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/administer/import-sets/concept/c_WebServiceImportSets.html">Web Service import sets</a> instead whenever possible since they are simpler to implement and maintain.</p><p></p><h2>Example of scripted webservices where request items got missing or in the wrong request</h2><p>This is an example to create requested Items (RITM) from Service Catalog API that causes some items to disappear or get attached to the wrong REQ request.</p><p></p><p>In this example I will show you how cart() API could cause Requested Items disappearing or attached to the wrong request.</p><p>I will explore one possible cause that is sometimes overlooked:</p><p>--&gt; RACE CONDITIONS on the new Cart() call.</p><p></p><p>Race conditions are difficult to avoid and they are present on most applications.</p><p>i.e. Threads "racing" to access/change the data.</p><p></p><p>On this example, I will explore why some Requested Items (sc_req_item) disappear or get assigned to the wrong cart just by an incorrect script using our Cart API.</p><p></p><p>A scriptable API for the service catalog makes it easier to order from the catalog when using business rules (e.g. Email Inbound Actions, Scripted Web-services, etc)</p><p></p><p>In more detail, you can use our Service Catalog API Cart by giving an explicit-cartID e.g. new cart("cartID"). Or you could leave the system to assume a new cart by the call Cart(). However, this is attached to the user you are executing with (shared resource).</p><p></p><p>Both calls will generate a cart. However, only on the first call you have control to guarantee an UNIQUE-ID.</p><p></p><p>This is important because if you are generating multiple cart request that may run in parallel, the multiple cart() calls generated on each transaction can have race conditions. To avoid that, you just need to explicitly give a unique id.</p><table border="1"><tbody><tr><td style="text-align: left;"><h1><span style="font-weight: normal; font-size: 10pt; line-height: 1.5em;">Below is a an example of a simple Scripted Web service to explain this:</span></h1><ul><li><span style="font-weight: normal; font-size: 10pt; line-height: 1.5em;">Input parameter: cat_item</span></li><li>Output parameter: request_number</li></ul><p></p><p><img   alt="2015-09-16_1825.png" class="image-1 jive-image" src="b522a7b9db5c9f04e9737a9e0f961988.iix" style="height: 446px; width: 620px;"/></p><p></p><p></p><p>For these testings, we will submit two items each of the 'cat_item' per request.</p><p>The items will be</p><p>request 1: 2x Acrobat (sys_id 7198552237b1300054b6a3549dbe5dea)</p><p>request 2: 2x Apple iPad 3 (sys_id 060f3afa3731300054b6a3549dbe5d3e)</p><p></p><p>The script is:</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_1443277580417541" data-renderedposition="1907.0333251953125_11_911_304" jivemacro_uid="_1443277580417541"><p>// var cart = new Cart(); // &lt;-- if run in parallel, the same instance of a cart can be set</p><p>var cart = new Cart(generateId()); // recommended way</p><p>var item1 = cart.addItem(request.cat_item);</p><p>var item2 = cart.addItem(request.cat_item);</p><p>if (request.cat_item == "7198552237b1300054b6a3549dbe5dea")</p><p>       Packages.java.lang.Thread.sleep(5000);</p><p>var rc = cart.placeOrder();</p><p>response.request_number = rc.number;</p><p></p><p></p><p>// note this is an example.</p><p>function generateId() {</p><p>       var text = "CART-";</p><p>       var possible = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";</p><p>       for (var i = 0; i &lt; 7; i++)</p><p>               text += possible.charAt(Math.floor(Math.random() * possible.length));</p><p>       return text;</p><p>}</p>   </pre><p></p><p>With the generatedID, you do not have problems. <span style="font-size: 10pt; line-height: 1.5em;">Executing the Scripted script.</span></p><p><img   alt="2015-09-16_1819.png" class="image-2 jive-image" src="20a90006dbdc5fc03eb27a9e0f961949.iix" style="height: 367px; width: 620px;"/></p><p>Checking in sc_req_item.list , we can see the two items attached to each request.</p><p><img   alt="2015-09-16_1817.png" class="image-3 jive-image" src="9e4aebb5db94dfc0b322f4621f961999.iix" style="height: 203px; width: 620px;"/></p><p></p><p>However, with <span style="font-size: 10pt; line-height: 1.5em;"><strong>&gt; var cart = new Cart(); </strong></span><span style="font-size: 10pt; line-height: 1.5em;">if you execute two simultaneous calls, it appears same instance* of cart is used to add items </span><span style="font-size: 10pt; line-height: 1.5em;">and place only one order. You will also notice that adding a slight delay for one requested </span><span style="font-size: 10pt; line-height: 1.5em;">item would place more or less items into same order.</span></p><p></p><p>On my testings:</p><p><img   alt="2015-09-16_1904.png" class="image-0 jive-image" src="3c982c0adb509344e9737a9e0f961903.iix" style="height: 348px; width: 620px;"/></p><p>Checking in sc_req_item.list there is only two records. REQ0010031 is missing.</p><p><img   alt="2015-09-16_1902.png" class="image-5 jive-image" src="f0090542db14130468c1fb651f9619fc.iix" style="height: 161px; width: 620px;"/></p><p>That is caused by an incorrect usage of Cart API. <span style="font-size: 10pt; line-height: 1.5em;">The way the Cart API is being used, does indeed use the same instance of a cart.</span></p><p></p><p>Note: If the script runs as a result of a scheduled import, the script runs as system <span style="font-size: 10pt; line-height: 1.5em;">or as the user specified by that import in the Run as field. The script uses the</span></p><p>specified user's cart. Each call to new Cart() empties the cart of the calling user, <span style="font-size: 10pt; line-height: 1.5em;">but does not use or empty any other carts.</span></p></td></tr></tbody></table><p></p><p></p><p></p><p>In conclusion, if you are writing complex scripts with chance of concurrency (email, soap, etc), give <span style="font-size: 10pt; line-height: 1.5em;">an unique-id to you new cart created if you are having missing request items (or attach to the wrong request). </span><span style="font-size: 10pt; line-height: 1.5em;">Note* that different users, run on different cart(). This is only one possible explanation.</span></p><p></p><p>More information can be found here:</p><ul><li><a href="https://hi.service-now.com/kb_view.do?sysparm_article=KB0541631" title="https://hi.service-now.com/kb_view.do?sysparm_article=KB0541631">Import and Export Resources Page (KB0541631)</a> </li><li><a href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/integrate/web-services/reference/r_AvailableWebServices.html" title="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/integrate/web-services/reference/r_AvailableWebServices.html">Docs: Web services</a> </li><li><a href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/integrate/custom-web-services/concept/c_CustomWebServices.html" title="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/integrate/custom-web-services/concept/c_CustomWebServices.html">Docs: Scripted REST APIs</a> </li><li><a href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/integrate/inbound-soap/concept/c_SOAPWebService.html" title="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/integrate/inbound-soap/concept/c_SOAPWebService.html">Docs: SOAP web service</a> </li><li><a href="https://docs.servicenow.com/bundle/istanbul-it-service-management/page/product/service-catalog-management/concept/c_ServiceCatalogManagement.html" title="https://docs.servicenow.com/bundle/istanbul-it-service-management/page/product/service-catalog-management/concept/c_ServiceCatalogManagement.html">Docs: Service Catalog</a> </li><li><a href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/integrate/inbound-rest/concept/c_ServiceCatalogAPI.html" title="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/integrate/inbound-rest/concept/c_ServiceCatalogAPI.html">Docs: Service Catalog API</a></li><li><a title="" _jive_internal="true" href="/search.jspa?q=jonnyseymour&amp;type=post">My other blogs</a></li></ul><p></p><p></p><p></p><p>Thank you<a __default_attr="10802" __jive_macro_name="user" class="jive_macro jive_macro_user" data-orig-content="Ben Phillips" data-renderedposition="4064.683349609375_73.08332824707031_92_17" href="/community?id=community_user_profile&user=68211265db981fc09c9ffb651f96192d" modifiedtitle="true" title="Ben Phillips">Ben Phillips</a></p><p></p><p><strong>Q. Is there other example to create a unique id?</strong></p><p>Answer. Yes, see the example below:</p><p></p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_14432777791233130" data-renderedposition="4188.43310546875_8_917_48" jivemacro_uid="_14432777791233130"><p><strong>// note this is an example.</strong></p><p><strong>var cartId = GlideGuid.generate(null);</strong></p><p>var cart = new Cart(<strong>cartId</strong>);   // &lt;---   with Unique id</p></pre>