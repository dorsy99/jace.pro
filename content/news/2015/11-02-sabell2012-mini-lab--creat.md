---
title: "MiniLab Creating a Workflow Cancel for the Active Context List View"
date: 2015-11-02T05:59:28.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=11fca2a5dbd0dbc01dcaf3231f9619f1"
---
<p>There is something I have observed as a performance issue: Hung workflow jobs.   A lot of administrators simply don't know that there may be literally thousands of these sitting there in the Active Contexts list.   Or just a few.   It depends on the age of your company's instance.   A worker process has to be assigned every few seconds to go spin through all of these and see if there has been a state change.   If so, then the worker handles the change.   If not, it keeps looking until it reaches the end, and goes off to do other work.   Enough of these and that worker is tied down for the duration.</p><p></p><p>Therefore I have wanted a way to kill hung (executing) contexts en-mass for some time.   This feature is not available in ServiceNow out-of-the-box (OOtB).   However, I have found code on the web that allows you to blow everything out of the Executing Workflows list (not my desired functionality). </p><p></p><p>Now I have been mentioning this for awhile in my ServiceNow Scripting classes (trying to get someone else to write it! <span __jive_emoticon_name="wink" __jive_macro_name="emoticon" class="jive_emote jive_macro" data-renderedposition="176_753_16_16" src="/8.0.1.35b65d4/images/emoticons/wink.png"></span>).   One class recently flat out challenged me to write one and publish it here.   I finally broke down and took the challenge!   Here you are!</p><p></p><p>I started by investigating how the Cancel Workflow UI Action from the executing Workflow Context works.   It uses GlideAjax and a couple of Glide dialogs to manage the cancelling of an active workflow.   The GlideAjax function calls an Ajax Script Include (WorkflowCancelKill) on the server-side.   This script is passed the current workflow context sys_id and attempts to cancel the job.   If it fails, it then prompts the user if they want to attempt to kill the context.   If so, then another call is made to the Ajax Script Include to fire a broadcastKill call and try to take it out that way.   If that fails then, well, you manually need to go delete that job.</p><p></p><p>So, borrowing heavily from the OOtB Cancel I used essentially the same functionality, but adapted it to a List View UI Action.</p><p></p><p>Pre-requisites:</p><p></p><p style="padding-left: 30px;">A working knowledge of Scripting in ServiceNow (<a title="tp//www.servicenow.com/services/training-and-certification/scripting-in-servicenow-training.html" href="http://http//www.servicenow.com/services/training-and-certification/scripting-in-servicenow-training.html">class</a>)</p><p style="padding-left: 30px;">A working knowledge of Workflows, and the Workflow Editor in ServiceNow (<a title="tp//www.servicenow.com/services/training-and-certification/system-administration.html" href="http://http//www.servicenow.com/services/training-and-certification/system-administration.html">class</a>)</p><p></p><p>Scripting Features Utilized:</p><p></p><p style="padding-left: 30px;">Client Script</p><p style="padding-left: 60px;"><a title="tp//wiki.servicenow.com/index.php?title=GlideList2_(g_list)#gsc.tab=0" href="http://http//wiki.servicenow.com/index.php?title=GlideList2_(g_list)#gsc.tab=0" style="line-height: 1.5;">g_list</a><span style="line-height: 1.5;"> object</span></p><p style="padding-left: 60px;"><a title="tp//wiki.servicenow.com/index.php?title=GlideDialogWindow_API_Reference" href="http://http//wiki.servicenow.com/index.php?title=GlideDialogWindow_API_Reference">GlideDialogWindow</a></p><p style="padding-left: 60px;">UI Action</p><p style="padding-left: 60px;">         this.bind</p><p style="padding-left: 60px;">         callback function</p><p style="padding-left: 60px;">         List Choice functionality from a UI Action</p><p style="padding-left: 60px;"><a title="tp//wiki.servicenow.com/index.php?title=GlideAjax#gsc.tab=0" href="http://http//wiki.servicenow.com/index.php?title=GlideAjax#gsc.tab=0">GlideAjax</a></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;">Script Include</p><p style="padding-left: 60px;"><a title="tp//wiki.servicenow.com/index.php?title=Workflow_Script#gsc.tab=0" href="http://http//wiki.servicenow.com/index.php?title=Workflow_Script#gsc.tab=0">Workflow</a> object</p><p style="padding-left: 60px;">cancelContext</p><p style="padding-left: 60px;">broadcastKill</p><p></p><p><span style="font-size: 14pt;"><strong>Lab 1.1: Creating the Ajax Script Include</strong></span></p><p></p><p>First we will need to create our script include that carries out our Cancel and Execute commands.</p><p></p><p>1. From your ServiceNow instance navigate to System Definition -&gt; Script Includes.   The list view of Script Includes will be displayed.</p><p>2. Click on the New button.   The new Script Include form will be displayed.</p><p>3. Fill in the form with the following:</p><p>         a. <strong>Name</strong>: CancelWorkflowContextsAjax</p><p>         b. <strong>Accessible From</strong>: All application scopes</p><p>         c. <strong>Client Callable</strong>: Checked</p><p>         d. <strong>Active</strong>: Checked</p><p>         e. <strong>Description</strong>: Kill context from the executing workflows list view</p><p>         f. <strong>Script</strong>:</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_14464183677751356" data-renderedposition="1129_8_1192_848" jivemacro_uid="_14464183677751356" modifiedtitle="true"><p>var CancelWorkflowContextsAjax = Class.create();</p><p>CancelWorkflowContextsAjax.prototype = Object.extendsObject(AbstractAjaxProcessor, {</p><p>       cancelContexts: function() {</p><p>               var cancelIds = this.getParameter('sysparm_contextIds').split(',');</p><p></p><p>               // loop through all of our workflow context sys_ids</p><p>               for (var i=0; i &lt; cancelIds.length; i++) {</p><p>                       this.cancelSingleContext(cancelIds[i]);</p><p>               }</p><p></p><p>               gs.info('[{0}]:\n {1}', this.type, this.message);</p><p>       },</p><p></p><p>       // Cancel OR Kill a single workflow context</p><p>       cancelSingleContext: function(contextId) {</p><p>                   try {</p><p>                               this.message += '\n---&gt; Attempting to cancel: ' + contextId + '\n';</p><p>                               var wfContext = new GlideRecord('wf_context');</p><p>                               wfContext.get(contextId);</p><p>                               new Workflow().cancelContext(wfContext);</p><p>                               this.message += '---&gt; Workflow canceled: ' + contextId + '\n';</p><p>                   }</p><p>                   catch(err) {</p><p>                               this.message += '---&gt; ERROR: ' + err + '\n';</p><p></p><p>                               // If we fail and it was due to a ModelRunTimeException, then attempt a kill</p><p>                               // Interestingly since we do not have "instanceOf" available in the language</p><p>                               // definition we have to play the game of searching for it in the message itself</p><p><span>                               // (</span><a title="k-external-small" class="jive-link-external-small" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/instanceof" rel="nofollow" target="_blank">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/instanceof</a><span>)</span></p><p>                               //com.glideapp.workflow.model.ModelRunTimeException</p><p>                               if (err.toString().indexOf('ModelRunTimeException') &gt; -1) {</p><p>                                       this.killContext(contextId);</p><p>                               }</p><p>                   }</p><p>       },</p><p></p><p></p><p>       // This fires a kill message to the specified workflow context</p><p>       killContext: function(contextId) {</p><p>               this.message += '---&gt; Attempting to kill context: ' + contextId + '\n';</p><p>               var wfContext = new GlideRecord('wf_context');</p><p>               wfContext.get(contextId);</p><p></p><p>               var workFlow = new Workflow();</p><p>               workFlow.cancel(wfContext);   // first cancel the context</p><p>               workFlow.broadcastKill(wfContext); // now send the kill message to the context</p><p></p><p>               this.message += '---&gt; Workflow context killed: ' + contextId + '\n';</p><p>       },</p><p></p><p>       type: "CancelWorkflowContextsAjax",</p><p>       message: ""   /* this is our general message container */</p><p>});</p></pre><p></p><p>         g. Click on the Submit button to save your work.</p><p></p><p><img  alt="1. Script Include.png" class="image-1 jive-image" src="78a53331db1cdf04e9737a9e0f961976.iix" style="width: 620px; height: 327px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p>         We are now ready to build the browser-side code.</p><p></p><p></p><p><span style="font-size: 14pt;"><strong>Lab 1.2: Creating the Ajax UI Action</strong></span></p><p></p><p>Now we will create our List View List Choice UI Action to carry out actions against a list of chosen executing Workflows</p><p></p><p>1. From your ServiceNow instance navigate to: System UI -&gt; UI Actions.   This will display the List View of all UI Actions.</p><p>2. Click on the New button.   This will bring up a blank UI Action form.</p><p>3. Fill in the form with the following:</p><p style="padding-left: 30px;">a. <strong>Name</strong>: Cancel Workflows</p><p style="padding-left: 30px;">b. <strong>Table</strong>: Workflow Context [wf_context]</p><p style="padding-left: 30px;">c. <strong>Order</strong>: 250</p><p style="padding-left: 30px;">d. <strong>Action Name</strong>: blank</p><p style="padding-left: 30px;">e. <strong>Active:</strong> checked</p><p style="padding-left: 30px;">f. <strong>Show insert</strong>: checked</p><p style="padding-left: 30px;">g. <strong>Show update</strong>: checked</p><p style="padding-left: 30px;">h. <strong>Client</strong>: checked</p><p style="padding-left: 30px;">i. <strong>List choice</strong>: checked</p><p style="padding-left: 30px;">         All other check boxes: unchecked</p><p style="padding-left: 30px;">j. <strong>Comments</strong>: Cancel the selected list of workflows.   If cancel fails attempt to automatically force the kill.</p><p style="padding-left: 30px;">k. <strong>Hint</strong>: Cancel the selected list of workflows</p><p style="padding-left: 30px;">l. <strong>Onclick</strong>: cancelWorkflowContexts();</p><p style="padding-left: 30px;">m. <strong>Condition</strong>: gs.hasRole('admin')</p><p style="padding-left: 30px;">n. <strong>Script</strong>:</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14464190519633706 jive_text_macro" data-renderedposition="2986_8_1192_544" jivemacro_uid="_14464190519633706" modifiedtitle="true"><p>function cancelWorkflowContexts() {</p><p>       var contextIds = g_list.getChecked().split(',');</p><p>     </p><p>       if (!contextIds || contextIds.length == 0) {</p><p>               return;</p><p>       }</p><p></p><p>       // our callback function from the dialog that executes the ajax call</p><p>       var callback = function() {</p><p>   <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">         </span>   var cancelContexts = new GlideAjax("CancelWorkflowContextsAjax");</p><p> <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">         </span>     cancelContexts.addParam("sysparm_name", "cancelContexts");</p><p>   <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">         </span>   cancelContexts.addParam("sysparm_contextIds", contextIds.join(','));</p><p></p><p>     <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">         </span> // Our Async callback handler</p><p>       <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">         </span>var handleResponse = function () {</p><p>               <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">         </span>reloadWindow(window);   // reload the list view</p><p>       <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">         </span>};</p><p></p><p>       <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">         </span>// We really don't care about the answer, and throw it away</p><p>       <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">         </span>// Our callback here is to fire the reloadWindow</p><p>       <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">         </span>cancelContexts.getXMLAnswer(handleResponse.bind(this));</p><p>                 return true;</p><p>       };</p><p></p><p>       // Glide dialog window - this is fancier than JavaScript prompt</p><p>       var dialogClass = window.GlideModal ? GlideModal : GlideDialogWindow;</p><p>       var dialog = new dialogClass('glide_confirm_standard');</p><p>       dialog.setTitle('Confirmation');</p><p>       dialog.setPreference('warning', true);</p><p>       var title = 'Are you sure you want to cancel the selected Worklfow Contexts?';</p><p>       dialog.setPreference('title', title);</p><p>       dialog.setPreference('onPromptComplete', callback.bind(this));</p><p>       dialog.render();</p><p>}</p></pre><p style="padding-left: 30px;"></p><p style="padding-left: 30px;">o. Click on the Submit button to save your work.</p><p></p><p style="text-align: center;"><img  alt="2. UI Action.png" class="image-2 jive-image" src="d22c5d86db14d7041dcaf3231f961912.iix" style="width: 620px; height: 315px;"/></p><p></p><p>We are now ready to set up our test, and test our our new UI Action!</p><p></p><p></p><p><span style="font-size: 14pt;"><strong>Lab 1.3: Testing</strong></span></p><p></p><p>Finally we will create bad workflow that will hang, and fire it off a few times.</p><p></p><p>1. Navigate to: Workflow -&gt; Workflow Editor.   The Workflow Editor will be displayed in a new browser tab.</p><p>2. From the Workflows tab on the right, click on the "+" button to create a new workflow.   The New Workflow form will be displayed.</p><p>3. Fill in the form with the following:</p><p style="padding-left: 30px;">a. <strong>Name</strong>: Broken Workflow</p><p style="padding-left: 30px;">b. <strong>Table</strong>: Global</p><p style="padding-left: 30px;">c. Click on the Submit button to create your new workflow</p><p>4. From the Workflow Editor navigate to Core -&gt; Utilities and drag out a new Run Script Activity</p><p style="padding-left: 30px;">a. <strong>Name</strong>: Initialize</p><p style="padding-left: 30px;">b. <strong>Script:</strong> gs.log('---&gt; Broken Workflow!', 'Broken Workflow.Initialize');</p><p style="padding-left: 30px;">c. Click on the Submit button to save your activity.</p><p>5. From the Workflow Editor navigate to Core -&gt; Approvals and drag out a new Approval - User Activity</p><p style="padding-left: 30px;">a. <strong>Name</strong>: Do Nothing Approval</p><p style="padding-left: 30px;">b. <strong>Users</strong>: Add Beth Anglin to the list</p><p style="padding-left: 30px;">c. Click on the Submit button to save your activity</p><p>6. Wire up your workflow to look like this:</p><p></p><p><img  alt="3. Broken Workflow.png" class="image-3 jive-image" src="79f5bc46db9097041dcaf3231f9619b6.iix" style="width: 620px; height: 413px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p>7. Run the workflow five times.   Since Beth is not around to approve things this effectively "hangs" the workflow.</p><p>8. From your ServiceNow instance navigate to: System Logs -&gt; All.   The list view of log entries will appear.   Filter on Source Contains Broken.   You should see your workflow logging itself.</p><p></p><p><img  alt="4. Broken Workflow Logs.png" class="image-4 jive-image" src="f4831042db145304b322f4621f961924.iix" style="margin-right: auto; margin-left: auto; width: 620px; height: 206px; display: block;"/></p><p></p><p>8. From your ServiceNow instance navigate to: Workflow -&gt; Active Contexts.   The list view of active contexts should appear.</p><p>9. Filter on Workflow Version = Broken Workflow.   Your five test workflows should be shown with State of Executing</p><p></p><p><img  alt="5. Hung Workflow Active Contexts.png" class="image-6 jive-image" src="12379946db9813043eb27a9e0f96197b.iix" style="width: 620px; height: 299px; display: block; margin-left: auto; margin-right: auto;"/></p><p>10. Check a couple of the list view check boxes to select the workflows you want to cancel.   </p><p>11. Click on the Actions on Selected Rows dropdown at the bottom of the list view.   A menu will appear displaying list action choices.</p><p></p><p><img  alt="6. Pick Two and Choose Cancel.png" class="image-7 jive-image" src="a2a6f8c2dbdcd704ed6af3231f961934.iix" style="width: 620px; height: 284px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p>12. Click on the Cancel Workflows link.   A dialog box will appear asking if your are sure you want to cancel the chosen workflows. </p><p></p><p><img  alt="7. Are you sure.png" class="image-8 jive-image" src="dc719c4adb149fc03eb27a9e0f96197e.iix" style="width: 620px; height: 311px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p>13. Click on the Ok button to confirm you want to cancel the workflows.</p><p>14. The list view will be refreshed, and you should be down a couple of executing workflows!</p><p>15. Navigate to: System Logs -&gt; All and filter on Message Contains Attempting.   This will show you the logging from the Script Include.</p><p></p><p><img  alt="8. Broken Workflow Logs.png" class="image-9 jive-image" src="50cfa3f9dbd4df04e9737a9e0f961980.iix" style="width: 620px; height: 104px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p>16. Go ahead and cancel the remaining workflows using Steps 10 through 12.</p><p></p><p>So there you have it!   A List Choice UI Action that allows you to cancel multiple executing workflow contexts from a List View.</p><p></p><p>I went ahead and placed this solution out on the ServiceNow Share: <a title="hare.servicenow.com/app.do#/detailV2/4c776a5413a3420057ce58222244b005/overview" href="https://share.servicenow.com/app.do#/detailV2/4c776a5413a3420057ce58222244b005/overview">here</a></p><p></p><p>Steven Bell</p><p></p><p></p><p style="font-family: arial, sans-serif; color: #666666;"><span style="font-weight: inherit; font-style: inherit; font-size: 12pt; color: #800080;"><strong style="font-style: inherit; font-family: inherit;">If you find this article helps you, don't forget to log in and "like" it! </strong></span></p><p></p><p style="font-family: arial, sans-serif; color: #666666;"><span style="font-weight: inherit; font-style: inherit; font-size: 12pt; color: #800080;"><strong style="font-style: inherit; font-family: inherit;">I would also like to encourage you to become a member of our blog!</strong></span></p>