---
title: "Using GlideAjax in Catalog Items  pushing a version of the variablepool to the client"
date: 2015-08-27T22:52:32.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=7bec22a5dbd0dbc01dcaf3231f961921"
---
<p style="margin-bottom: .0001pt;">In my learning the ServiceNow platform as a part of MetLife, one thing I have been tasked with is optimizing various client scripts on our catalog item pages to improve page-load time.   A recent ServiceNow ACE report showed we had a large number of client scripts using the XMLWait function.   My hope is that   the scripts I am developing here will help in that optimization effort.</p><p></p><p style="margin-bottom: .0001pt;">As I was recently working with a new catalog, I found that I would like to be able to inspect the full list of variables on the page, and since DOM inspection is a no-no in service now, I found myself confronting the need to write some script to query the various tables holding variable info.</p><p></p><p style="margin-bottom: .0001pt;">My first approach was to try and bootstrap the data in via the g_scratchpad variable.   This seemed like a great idea, but I quickly hit a brick wall due <a title="" _jive_internal="true" href="/community?id=community_question&sys_id=37994fa5db5cdbc01dcaf3231f961945">to onDisplay business rules not firing on catalog items</a>.</p><p></p><p style="margin-bottom: .0001pt;">So I want to share with you the scripts I developed to push my simple variable_pool data structure into the clients. </p><p></p><p style="margin-bottom: .0001pt;">I have added a few global UI scripts to make my life easier, those being <a title="derscorejs.org/" href="http://underscorejs.org/">underscore.js</a>, and <a title="ithub.com/pimterry/loglevel" href="https://github.com/pimterry/loglevel">loglevel.js</a>, both are available on github, and I highly recommend them.</p><p></p><p style="margin-bottom: .0001pt;"><img   alt="variable_pool_ajax_diagram.png" class="image-0 jive-image" src="9216108edb545304b322f4621f9619df.iix" style="height: 471px; width: 620px;"/></p><p style="margin-bottom: .0001pt;"></p><p style="margin-bottom: .0001pt;"><span style="font-size: 12pt;"><strong>Script Include — CatalogVariableList.js</strong></span></p><ul style="list-style-type: disc;"><li>Performs glide record queries against item_option_new, io_set_item to get variables, and variables sets on the catalog item</li></ul><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14406979822966379 jive_text_macro" data-renderedposition="866.3209838867188_7.997159004211426_1192_3369" jivemacro_uid="_14406979822966379"><p>/**</p><p>   Class that provide glidejax endpoint where catalog client scripts can retrieve a list of all the variables on the form</p><p>   @class CatalogVariableList</p><p>   @author kevin anderson</p><p>   @date 8-26-2015</p><p>*/</p><p>var CatalogVariableList = Class.create();</p><p>CatalogVariableList.prototype = Object.extendsObject(AbstractAjaxProcessor, {</p><p>       /**</p><p>       process the catalog sysid parameter and fetch the name and sysid for each variable defined on the catalog item</p><p>       @method get</p><p>       @param {string} cat_item_sysid - note: parameter may also be found in the class getParameter method (ajax call)</p><p>       */</p><p>       get: function(cat_item_sysid) {</p><p>               var json = new JSON();</p><p>               var ajax_param = json.decode(this.getParameter('sysparm_data'));</p><p>               var result = {</p><p>                       error: 'false',</p><p>                       message: '',</p><p>                       payload: {}</p><p>               };</p><p></p><p></p><p></p><p></p><p>               try {</p><p>                       if (ajax_param &amp;&amp; this._has(ajax_param, 'catalog_item_sysid') &amp;&amp; this._isString(ajax_param.catalog_item_sysid)) {</p><p>                               // function called via ajax from client, read parameter from getParameter method</p><p>                               cat_item_sysid = ajax_param.catalog_item_sysid;</p><p>                       }</p><p>                       if (this._isString(cat_item_sysid) &amp;&amp; cat_item_sysid.length) {</p><p>                               // get the variables defined on the catalog item</p><p>                               var list = this._getCatalogVariables(cat_item_sysid);</p><p></p><p></p><p></p><p></p><p>                               // add the variable sets assigned to this catalog item</p><p>                               result.payload = list.concat(this._getCatalogVariableSets(cat_item_sysid));</p><p></p><p></p><p></p><p></p><p>                       } else {</p><p>                               result.message = 'The parameter "catalog item sys_id" is not of type string';</p><p>                               result.error = true;</p><p></p><p></p><p>                       }</p><p>               } catch (e) {</p><p>                       result.message = 'Error occured attempting to retrieve catalog item variable list - ' + e.message;</p><p>                       result.error = true;</p><p>               }</p><p></p><p></p><p></p><p></p><p>               return json.encode(result);</p><p>       },</p><p>       /**</p><p>         get the list of variables defined on the catalog item</p><p>         @method _getCatalogVariables</p><p>         @param {string} sysid of the catalog item to query the variable list for</p><p>         @returns {array}</p><p>       */</p><p>       _getCatalogVariables: function(cat_item_sysid) {</p><p>               // query for all catalog_item variables</p><p>               var catalog_item_vars_rec = new GlideRecord('item_option_new');</p><p>               catalog_item_vars_rec.addNotNullQuery('cat_item');</p><p>               catalog_item_vars_rec.addQuery('cat_item', cat_item_sysid);</p><p>               catalog_item_vars_rec.query();</p><p></p><p></p><p></p><p></p><p>               var data = [],</p><p>                       variable_info;</p><p></p><p></p><p></p><p></p><p>               while (catalog_item_vars_rec.next()) {</p><p></p><p></p><p>                       variable_info = {</p><p>                               'name': catalog_item_vars_rec.name.getDisplayValue(),</p><p>                               'label': catalog_item_vars_rec.getDisplayValue(),</p><p>                               'sys_id': catalog_item_vars_rec.sys_id.getDisplayValue(),</p><p>                               'set_name': '',</p><p>                               'set_sys_id': ''</p><p>                       };</p><p></p><p></p><p>                       //gs.log('catalog vars: '+variable_info.label+' : '+variable_info.name+' : '+variable_info.sys_id, '_getCatalogVariables::CatalogVariableList');</p><p></p><p></p><p>                       data.push(variable_info);</p><p>               }</p><p>               return data;</p><p></p><p></p><p>       },</p><p></p><p></p><p>       /**</p><p>         get a list of all the variable sets that belong to a catalog item</p><p>         @method _getCatalogSetVariableInfo</p><p>         @param {string} cat_item_sysid sysid of the catalog item to query the variable list for</p><p>         @returns {array} each array element is an object with the keys "sys_id" and "name"</p><p>       */</p><p>       _getCatalogSetVariableInfo: function(cat_item_sysid) {</p><p>               // get variable sets on the catalog</p><p>               var data = [],</p><p>                       variable_info;</p><p>               var cat_varset_rec = new GlideRecord('io_set_item');</p><p>               cat_varset_rec.addNotNullQuery('cat_item');</p><p>               cat_varset_rec.addQuery('sc_cat_item', cat_item_sysid);</p><p>               cat_varset_rec.query();</p><p></p><p></p><p></p><p></p><p>               while (cat_varset_rec.next()) {</p><p>                       // get the variable set name and sysid and lookup all its related variables</p><p>                       variable_info = {</p><p>                               'name': cat_varset_rec.variable_set.name.getDisplayValue(),</p><p>                               'sys_id': cat_varset_rec.variable_set.sys_id.getDisplayValue(),</p><p>                       };</p><p></p><p></p><p></p><p></p><p>                       if (variable_info.name &amp;&amp; variable_info.sys_id) {</p><p>                               //gs.log('varset info: '+variable_info.name+' - '+variable_info.sys_id,'_getCatalogSetVariableInfo::CatalogVariableList');</p><p>                               data.push(variable_info);</p><p>                       }</p><p>               }</p><p>               return data;</p><p>       },</p><p>       /**</p><p>         get list of all the variables in the variable sets that belong to a catalog item</p><p>         @method _getCatalogVariableSets</p><p>         @param {array} array of variable sets, each array element is an object with the keys "sys_id" and "name"</p><p>         @returns {array}</p><p>       */</p><p>       _getCatalogVariableSets: function(cat_item_sysid) {</p><p>               this._array_polyfill();</p><p>               var data = [];</p><p>               var variable_sets = this._getCatalogSetVariableInfo(cat_item_sysid);</p><p>               gs.log("test array : " + variable_sets.length, '_getCatalogVariableSets::CatalogVariableList');</p><p>               variable_sets.forEach(function(element, index, array) {</p><p></p><p></p><p>                       if (this._has(element, 'sys_id') &amp;&amp; this._isString(element.sys_id)) {</p><p>                               var varset_name = '';</p><p>                               if (this._has(element, 'name') &amp;&amp; this._isString(element.name)) {</p><p>                                       varset_name = element.name;</p><p>                               }</p><p>                               // query for all the variable set variables</p><p>                               var varset_rec = new GlideRecord('item_option_new');</p><p>                               varset_rec.addQuery('variable_set', element.sys_id);</p><p>                               varset_rec.query();</p><p>                               while (varset_rec.next()) {</p><p></p><p></p><p>                                       variable_info = {</p><p>                                               'name': varset_rec.name.getDisplayValue(),</p><p>                                               'label': varset_rec.getDisplayValue(),</p><p>                                               'sys_id': varset_rec.sys_id.getDisplayValue(),</p><p>                                               'set_name': varset_name,</p><p>                                               'set_sys_id': element.sys_id</p><p>                                       };</p><p></p><p></p><p>                                       //gs.log(variable_info.label+' : '+variable_info.name+' : '+variable_info.sys_id+' : '+variable_info.set_name+' : '+variable_info.set_sys_id,'_getCatalogSetVariables::CatalogVariableList');</p><p></p><p></p><p>                                       data.push(variable_info);</p><p></p><p></p><p>                               }</p><p>                       }</p><p>               }, this); // pass 'this' reference to the array.foreach method</p><p></p><p></p><p>               return data;</p><p></p><p></p><p>       },</p><p></p><p></p><p></p><p></p><p>       /**</p><p>       private method to test if an object contains a   property</p><p>       @method _has</p><p>       @param {object} obj</p><p>       @param {string} prop object key to verify exist in object</p><p>       */</p><p>       _has: function(obj, prop) { // this function is not client callable       </p><p>               var result = false;</p><p>               if (typeof obj === "object" &amp;&amp; typeof prop === 'string' &amp;&amp; obj &amp;&amp; prop.length) {</p><p>                       if (obj.hasOwnProperty(prop)) {</p><p>                               result = true;</p><p>                       }</p><p></p><p></p><p>               }</p><p>               return result;</p><p>       },</p><p></p><p></p><p></p><p></p><p>       /**</p><p>         Is a given variable an object?</p><p>         @method isObject</p><p>         @param {object} obj</p><p><span>         @link </span><a title="k-external-small" class="jive-link-external-small" href="https://github.com/jashkenas/underscore/blob/master/underscore.js" rel="nofollow" target="_blank">https://github.com/jashkenas/underscore/blob/master/underscore.js</a></p><p>       */</p><p>       _isObject: function(obj) {</p><p>               var type = typeof obj;</p><p>               return type === 'function' || type === 'object' &amp;&amp; !!obj;</p><p>       },</p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p>       /**</p><p>         determine if parameter is a string</p><p>         @method _isString</p><p>         @param {object} str</p><p><span>         @link </span><a title="k-external-small" class="jive-link-external-small" href="https://github.com/jashkenas/underscore/blob/master/underscore.js" rel="nofollow" target="_blank">https://github.com/jashkenas/underscore/blob/master/underscore.js</a></p><p>       */</p><p>       _isString: function(str) {</p><p>               return Object.prototype.toString.call(str) === '[object String]';</p><p>       },</p><p></p><p></p><p></p><p></p><p>       /**</p><p>         polyfill for the array.each method which is an es5 component</p><p>         @method _array_polyfill</p><p><span>         @link </span><a title="k-external-small" class="jive-link-external-small" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach" rel="nofollow" target="_blank">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach</a></p><p>       */</p><p>       _array_polyfill: function() {</p><p>               // Production steps of ECMA-262, Edition 5, 15.4.4.18</p><p><span>               // Reference: </span><a title="k-external-small" class="jive-link-external-small" href="http://es5.github.io/#x15.4.4.18" rel="nofollow" target="_blank">http://es5.github.io/#x15.4.4.18</a></p><p>               if (!Array.prototype.forEach) {</p><p></p><p></p><p></p><p></p><p>                       Array.prototype.forEach = function(callback, thisArg) {</p><p></p><p></p><p></p><p></p><p>                               var T, k;</p><p></p><p></p><p></p><p></p><p>                               if (this == null) {</p><p>                                       throw new TypeError(' this is null or not defined');</p><p>                               }</p><p></p><p></p><p></p><p></p><p>                               // 1. Let O be the result of calling ToObject passing the |this| value as the argument.</p><p>                               var O = Object(this);</p><p></p><p></p><p></p><p></p><p>                               // 2. Let lenValue be the result of calling the Get internal method of O with the argument "length".</p><p>                               // 3. Let len be ToUint32(lenValue).</p><p>                               var len = O.length &gt;&gt;&gt; 0;</p><p></p><p></p><p></p><p></p><p>                               // 4. If IsCallable(callback) is false, throw a TypeError exception.</p><p><span>                               // See: </span><a title="k-external-small" class="jive-link-external-small" href="http://es5.github.com/#x9.11" rel="nofollow" target="_blank">http://es5.github.com/#x9.11</a></p><p>                               if (typeof callback !== "function") {</p><p>                                       throw new TypeError(callback + ' is not a function');</p><p>                               }</p><p></p><p></p><p></p><p></p><p>                               // 5. If thisArg was supplied, let T be thisArg; else let T be undefined.</p><p>                               if (arguments.length &gt; 1) {</p><p>                                       T = thisArg;</p><p>                               }</p><p></p><p></p><p></p><p></p><p>                               // 6. Let k be 0</p><p>                               k = 0;</p><p></p><p></p><p></p><p></p><p>                               // 7. Repeat, while k &lt; len</p><p>                               while (k &lt; len) {</p><p></p><p></p><p></p><p></p><p>                                       var kValue;</p><p></p><p></p><p></p><p></p><p>                                       // a. Let Pk be ToString(k).</p><p>                                       //     This is implicit for LHS operands of the in operator</p><p>                                       // b. Let kPresent be the result of calling the HasProperty internal method of O with argument Pk.</p><p>                                       //     This step can be combined with c</p><p>                                       // c. If kPresent is true, then</p><p>                                       if (k in O) {</p><p></p><p></p><p></p><p></p><p>                                               // i. Let kValue be the result of calling the Get internal method of O with argument Pk.</p><p>                                               kValue = O[k];</p><p></p><p></p><p></p><p></p><p>                                               // ii. Call the Call internal method of callback with T as the this value and</p><p>                                               // argument list containing kValue, k, and O.</p><p>                                               callback.call(T, kValue, k, O);</p><p>                                       }</p><p>                                       // d. Increase k by 1.</p><p>                                       k++;</p><p>                               }</p><p>                               // 8. return undefined</p><p>                       };</p><p>               }</p><p></p><p></p><p></p><p></p><p>       }</p><p></p><p></p><p></p><p></p><p></p><p></p><p>});</p></pre><p><span style="font-size: 12pt;"><strong>UI Script — LoadCatalogItemVariablePool.js</strong></span></p><ul style="list-style-type: disc;"><li>Provides reusable class to make Ajax call to DB and parse response</li></ul><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_1440697982181717 jive_text_macro" data-renderedposition="4285.5537109375_7.997159004211426_1192_2241" jivemacro_uid="_1440697982181717"><p>/**</p><p>   query the DB via glidejax to provide the client a list of all the variables and variable sets</p><p>   UI script</p><p>   @class LoadCatalogItemVariablePool</p><p>   @filename load_catalog_item_var_pool</p><p>   Requires underscore.js and loglevel.js</p><p>*/</p><p>function LoadCatalogItemVariablePool(obj) {</p><p>       // ie8 protection</p><p>       if (!window.console) {</p><p>               console = {</p><p>                       log: function() {}</p><p>               }</p><p>       }</p><p></p><p></p><p>       // incase the loglevel module gets disabled</p><p>       if (!window.log) {</p><p>               window.log = {};</p><p>               window.log.error = console.log;</p><p>               window.log.info = console.log;</p><p>               window.log.warn = console.log;</p><p>       }</p><p></p><p></p><p>       /**</p><p>         provide browser namespace for metlife functions</p><p>         @namespace metlife</p><p>       */</p><p>       if (!window.metlife) {</p><p>               window.metlife = {};</p><p>       }</p><p>}</p><p></p><p></p><p>LoadCatalogItemVariablePool.prototype = {</p><p>       constructor: LoadCatalogItemVariablePool,</p><p></p><p></p><p>       /**</p><p>               contents of the ajax response after json parse and extract</p><p>         @property {object} data </p><p>   </p><p>       */</p><p>       data: [],</p><p></p><p></p><p>       /**</p><p>               if a server-side db error message is generated, the error message from the ajax response stored here</p><p>         @property {string} error_msg </p><p>   </p><p>       */</p><p>       error_msg: '',</p><p></p><p></p><p>       /**</p><p>         start the process to query database for the catalog item variables and variable sets</p><p>         @method getVariablePool</p><p>       */</p><p>       getVariablePool: function() {</p><p>               try {</p><p>                       // set the logging level - for production this should be "disableAll"</p><p>                       log.enableAll();</p><p></p><p></p><p>                       /**</p><p>                           anonymous function to maintain "this" scope for ajax callback</p><p>                           @method callback</p><p>                           @param {object} data response from ajax request</p><p>                       */</p><p>                       var context = this;</p><p>                       var callback = function(data) {</p><p>                               context.callback_load_variable_pool(data);</p><p>                       };</p><p></p><p></p><p>                       var payload = {</p><p>                               'catalog_item_sysid': g_form.getParameter("sysparm_id")</p><p>                       };</p><p></p><p></p><p>                       log.info("catalog sysid: " + payload.catalog_item_sysid + ' - getVariablePool::LoadCatalogItemVariablePool');</p><p></p><p></p><p>                       // send the catalog item sys_id from the form to the server endpoint to feth all form variable data</p><p>                       var ga = new GlideAjax('CatalogVariableList');</p><p>                       ga.addParam('sysparm_name', 'get');</p><p>                       ga.addParam('sysparm_data', JSON.stringify(payload));</p><p>                       ga.getXML(callback);</p><p></p><p></p><p></p><p></p><p>               } catch (err) {</p><p>                       log.error('Error occured: ' + err.message + ' - getVariablePool::LoadCatalogItemVariablePool (UI Script)');</p><p>               }</p><p></p><p></p><p></p><p></p><p>       },</p><p></p><p></p><p>       /**</p><p>         ajax callback handler to save the variable pool</p><p>         value saved to the form</p><p>         @method callback_load_variable_pool</p><p>         @param {object} response ajax server reply</p><p>       */</p><p>       callback_load_variable_pool: function(response) {</p><p>               try {</p><p>                       var parse_result = this.parseAjaxResponse(response);</p><p>                       if (!parse_result) {</p><p>                               // parsing failed, sent the stored error message to the error handler</p><p>                               throw this.error_msg;</p><p>                       }</p><p>                       //log.info(this.data);</p><p></p><p></p><p>                       // loosely validate the response data and save to the global namespace</p><p>                       if (_.isArray(this.data) &amp;&amp; this.data.length &amp;&amp; _.isObject(this.data[0]) &amp;&amp; _.has(this.data[0], 'sys_id')) {</p><p>                               window.metlife.variable_pool = this.data;</p><p></p><p></p><p>                               log.info('saved variable pool data to window.metlife.variable_pool - callback_load_variable_pool::LoadCatalogItemVariablePool');</p><p></p><p></p><p>                               // fire the event variable_pool::received after the variable pool saved to window.metlife object</p><p>                               // any scripts that depend on this data set will receive the notification and begin processing</p><p><span>                               // </span><a title="k-external-small" class="jive-link-external-small" href="http://api.prototypejs.org/dom/Element/fire/" rel="nofollow" target="_blank">http://api.prototypejs.org/dom/Element/fire/</a></p><p><span>                               // </span><a title="k-external-small" class="jive-link-external-small" href="http://stackoverflow.com/questions/5823782/prototype-custom-event-not-on-a-dom-element" rel="nofollow" target="_blank">http://stackoverflow.com/questions/5823782/prototype-custom-event-not-on-a-dom-element</a></p><p>                               document.fire("variable_pool::received");</p><p></p><p></p><p>                       } else {</p><p>                               throw 'unexpected format for the parsed database response object';</p><p>                       }</p><p></p><p></p><p>               } catch (e) {</p><p>                       log.error('Error occured: ' + e.message + ' - callback_load_variable_pool::LoadCatalogItemVariablePool');</p><p>               }</p><p></p><p></p><p></p><p></p><p>       },</p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p>       /**</p><p>         extract the contents of the ajax response for either the error message or the payload</p><p>         returns true if successfuly extracted ajax payload data</p><p>         @method parseAjaxResponse</p><p>         @param {string} response raw XML string from servicenow GlideAjax</p><p>         @param {string} resp_key object key the repsonse data is stored under, defaults to 'payload'</p><p>         @returns {boolean}</p><p>       */</p><p>       parseAjaxResponse: function(response, resp_key) {</p><p>               var result = false;</p><p>               var ajax_data, resp_str;</p><p>               if (!(_.isString(resp_key) &amp;&amp; resp_key.length)) {</p><p>                       resp_key = 'payload';</p><p>               }</p><p></p><p></p><p>               try {</p><p>                       resp_str = response.responseXML.documentElement.getAttribute("answer") + '';</p><p>                       if (!_.isString(resp_str)) {</p><p>                               throw 'Ajax response is not of type "string"';</p><p>                       }</p><p></p><p></p><p>                       //log.info(resp_str + ' - parseAjaxResponse::LoadCatalogItemVariablePool');</p><p></p><p></p><p>                       ajax_data = JSON.parse(resp_str);</p><p></p><p></p><p>                       // verify the ajax parsing passed</p><p>                       if (!(ajax_data &amp;&amp; _.isObject(ajax_data))) {</p><p>                               throw 'Ajax parsing result is not of type "object"';</p><p>                       }</p><p></p><p></p><p>                       // check for server DB error message in the ajax response</p><p>                       if (_.has(ajax_data, 'error') &amp;&amp; typeof ajax_data.error === 'boolean' &amp;&amp; ajax_data.error &amp;&amp; _.has(ajax_data, 'message')) {</p><p>                               throw 'Ajax server-side error occurred: "' + ajax_data.message + '"';</p><p>                       }</p><p></p><p></p><p>                       // verify the parsed ajax response object contains the 'payload' attribute</p><p>                       if (!(_.has(ajax_data, resp_key) &amp;&amp; ajax_data[resp_key] &amp;&amp; _.isObject(ajax_data[resp_key]))) {</p><p>                               throw 'invalid object parameter "payload" in the ajax response';</p><p>                       }</p><p></p><p></p><p>                       // if we got here, everything is good with the ajax parsing</p><p>                       result = true;</p><p>                       this.data = ajax_data[resp_key];</p><p>               } catch (e) {</p><p>                       this.error_msg = 'Error: ' + e.message;</p><p>               }</p><p></p><p></p><p>               return result;</p><p></p><p></p><p>       }</p><p></p><p></p><p>};</p></pre><p style="margin-bottom: .0001pt;"><span style="font-size: 12pt;">Catalog Client Script — load_catalog_variable_pool</span></p><ul style="list-style-type: disc;"><li>Inject the UI script onto the page and instanciate the class, begin the ajax process</li></ul><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_14406979821661550" data-renderedposition="6576.60498046875_7.997159004211426_1192_247" jivemacro_uid="_14406979821661550"><p>// include the class for performing database insert via glide ajax</p><p>document.write('&lt;script&gt;&lt;\/script&gt;');</p><p>/**</p><p>     perform ajax request back to db to retrieve the list of variables on this catalog</p><p>     @method onload </p><p>*/</p><p></p><p></p><p>function onLoad() {</p><p>       var lcvp = new LoadCatalogItemVariablePool();</p><p>       lcvp.getVariablePool();</p><p></p><p></p><p>};</p> </pre><p style="margin-bottom: .0001pt;"></p><p style="margin-bottom: .0001pt;"><span style="font-size: 12pt;">Catalog UI Policy — hide_device_recipient_variables_onload</span></p><ul style="list-style-type: disc;"><li>Very basic example client script that shows how the variable pool can be used</li></ul><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14406979820436130 jive_text_macro" data-renderedposition="6894.9287109375_7.997159004211426_1192_1082" jivemacro_uid="_14406979820436130" modifiedtitle="true"><p></p><p></p><p>function onCondition() {</p><p>       /**</p><p>         when the recipient reference field is empty, hide the email and employee id fields</p><p>         note:</p><p>         Due to the fact the variable data is delivered via an ajax request, we may have to</p><p>         create an event handler to listen for the variable data to arrive from the server</p><p>         condition - user reference field is empty (default when page loads)</p><p>         @method onCondition</p><p>   </p><p>       */</p><p>       if (window._ === 'undefined') {</p><p>               throw "underscore.js is undefined";</p><p>       }</p><p>       try {</p><p></p><p></p><p>               // set the user reference related variables to hidden</p><p>               if (_.has(window.metlife, 'variable_pool')) {</p><p>                       window.metlife.set_user_ref_fields_hidden();</p><p>               } else {</p><p>                       // execute via callback after variable data loads from ajax call</p><p>                       // listen for the event notification that the variable data exists on window.metlife.variable_pool</p><p>                       // uses prototype custom events</p><p></p><p></p><p>                       document.observe("variable_pool::received", function() {</p><p>                               window.metlife.set_user_ref_fields_hidden()</p><p>                       });</p><p>               }</p><p></p><p></p><p>       } catch (e) {</p><p>               // ie8 protection</p><p>               if (!window.console) {</p><p>                       console = {</p><p>                               log: function() {}</p><p>                       }</p><p>               };</p><p></p><p></p><p>               // incase the loglevel module gets disabled</p><p>               if (!window.log) {</p><p>                       log = {</p><p>                               error: console.log</p><p>                       };</p><p>               }</p><p>               log.error('Error: ' + e.message + ' - UI Policy hide recipient fields');</p><p>       }</p><p></p><p></p><p></p><p></p><p>};</p><p></p><p></p><p></p><p></p><p>/**</p><p>   namespace functions added for processing various form   data</p><p>   @property window.metlife</p><p>*/</p><p>if (!window.metlife) {</p><p>       window.metlife = {};</p><p>}</p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p>/**</p><p>   process the variable list and set the recipient user fields hidden</p><p>   @method window.metlife.set_user_ref_fields_hidden</p><p>*/</p><p>window.metlife.set_user_ref_fields_hidden = function() {</p><p>       log.info('Hide Device Recipient fields - onCondition::Catalog UI Policy');</p><p></p><p></p><p>       var target_variables = ['recipient_email', 'recipient_employee_id'];</p><p></p><p></p><p>       // verify the expected variables exist on the form before processing</p><p>       if (_.isArray(window.metlife.variable_pool) &amp;&amp; window.metlife.variable_pool.length) {</p><p>               var observed_variables = _.pluck(window.metlife.variable_pool, 'name');</p><p></p><p></p><p></p><p></p><p>               if (_.intersection(observed_variables, target_variables).length === 2) {</p><p>                       // set the target variable to hidden</p><p>                       _.each(target_variables, function(value, key) {</p><p>                               log.info('set variable "' + value + '" display state to hidden - window.metlife.set_user_ref_fields_hidden');</p><p>                               g_form.setDisplay(value, false);</p><p>                       });</p><p></p><p></p><p>               }</p><p></p><p></p><p></p><p></p><p>       }</p><p></p><p></p><p></p><p></p><p>};</p> </pre>