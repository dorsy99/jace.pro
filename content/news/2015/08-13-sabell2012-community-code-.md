---
title: "Community Code Snippets  A Method of Reworking a GlideRecord Inside a Loop"
date: 2015-08-12T06:20:33.000Z
authors: ["sabell2012"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=056eaeaddbd0dbc01dcaf3231f9619d1"
---
<p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;">Something I see quite often in the codebase is a GlideRecord call followed by the requisite While-Loop with another GlideRecord call in the loop.   This is super inefficient.   Not only does it have the possibility of taking a long time to complete the code (regular Business Rules would be the worse as they could impact the user experience), but it could possibly bring the instance it is running on to a crawl.   This is due to the number of hits on the database.   The more times the code loops then the worse the situation becomes.   Each database hit takes the computer time to set it up (connection to the database, submission of the query, execution of the query, collection of the results, packaging of the results, return of the results).   Remember that with the opening of a regular GlideRecord that the connection with the database remains open for the entirety of execution (even after you do an update, insert, or delete).</p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;">If you encounter the need for a structure like this then my advice is to look at it carefully and determine if it is possible to refactor the code to limit the number of hits on the database.</p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;">Steven</p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"></p><p></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;"><span style="color: #008000;">// Example of GlideRecord Inside a GlideRecord.   <strong style="color: #ff0000;">THIS IS A BAD PRACTICE!</strong></span><br/></span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;">var problemRecords = new GlideRecord('problem');</span><br/><span style="font-family: 'courier new', courier;">problemRecords.addQuery('state', 1);</span><br/><span style="font-family: 'courier new', courier;">problemRecords.query();</span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;"><br/></span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;">gs.info('Number of problem records found: {0}', problemRecords.getRowCount());</span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="color: #008000; font-family: 'courier new', courier;"><br/></span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;"><span style="color: #008000;">// The more loops the worse the performance gets!</span><br/>while(problemRecords.next()) {</span><br/><span style="font-family: 'courier new', courier;">           var incidentRecords = new GlideRecord('incident');</span><br/><span style="font-family: 'courier new', courier;">           incidentRecords.addQuery('problem_id', problemRecords.sys_id + '');</span><br/><span style="font-family: 'courier new', courier;">           incidentRecords.query();</span></p><p></p><p><span style="font-family: 'courier new', courier;">           gs.info('Number of incident records for problem {0} is: {1}.', problemRecords.number, incidentRecords.getRowCount());</span><br/><span style="font-family: 'courier new', courier;">}</span></p><p></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;">After some consideration the following would be a way to reduce this to just two calls to the database:</p><p></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;">var problemRecords = new GlideRecord('problem');</span><br/><span style="font-family: 'courier new', courier;">problemRecords.addQuery('state', 1);</span><br/><span style="font-family: 'courier new', courier;">problemRecords.orderBy('problem_id');</span><br/><span style="font-family: 'courier new', courier;">problemRecords.query();</span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="color: #008000; font-family: 'courier new', courier;"><br/></span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;"><span style="color: #008000;">// push the problem sys_id's to a one-dimensional array. THIS IS A BEST PRACTICE!</span><br/>var problemList = [];</span><br/><span style="font-family: 'courier new', courier;">while(problemRecords.next()) {</span><br/><span style="font-family: 'courier new', courier;">           problemList.push(problemRecords.sys_id + '');</span><br/><span style="font-family: 'courier new', courier;">}</span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier; color: #008000;"><br/></span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier; color: #008000;">// get rid of duplicates</span><br/><span style="font-family: 'courier new', courier;">problemList = new ArrayUtil().unique(problemList);</span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;"><br/></span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;">gs.info('Number of problem records found: {0}', problemList.length);</span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;"><br/></span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;">var countIncidents = new GlideAggregate('incident');</span><br/><span style="font-family: 'courier new', courier;">countIncidents.addAggregate('COUNT');</span><br/><span style="font-family: 'courier new', courier;">countIncidents.addQuery('problem_id', 'IN', problemList);   <span style="color: #008000;">// forced to a comma delimited list</span></span><br/><span style="font-family: 'courier new', courier;">countIncidents.groupBy('problem_id');</span><br/><span style="font-family: 'courier new', courier;">countIncidents.query();</span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;"><br/></span></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"><span style="font-family: 'courier new', courier;">while(countIncidents.next()) {</span><br/><span style="font-family: 'courier new', courier;">           gs.info('Number of incident records for problem {0} is: {1}.', countIncidents.problem_id.getDisplayValue(), countIncidents.getAggregate('COUNT'));</span><br/><span style="font-family: 'courier new', courier;">}</span></p><p></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;">Some timings for the GlideRecord inside of a loop:</p><p></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;">[0:00:00.025] Total Time for 5<br/>[0:00:00.018] Total Time<br/>[0:00:00.021] Total Time</p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;">[0:00:00.037] Total Time for 17   &lt;----- expected<br/>[0:00:00.039] Total Time<br/>[0:00:00.044] Total Time</p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;">Notice that the more loops the worse the performance.</p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;">Now some timings for the refactored code:</p><p></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;">[0:00:00.029] Total Time for 5<br/>[0:00:00.022] Total Time<br/>[0:00:00.042] Total Time       &lt;--- who knows   :-/</p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;">[0:00:00.022] Total Time For 17 &lt;---- wow!<br/>[0:00:00.018] Total Time<br/>[0:00:00.013] Total Time   &lt;--- double wow!</p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;"></p><p style="color: #000000; font-family: Arial, Verdana, Helvetica, sans-serif; font-size: 13.3333330154419px;">It is interesting that the efficiency appears to be bad for small number of records and improve significantly as more are lumped in!</p>