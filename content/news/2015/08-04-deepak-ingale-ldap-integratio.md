---
title: "LDAP Integration  Load Locations and Departments along with user records"
date: 2015-08-03T16:39:13.000Z
authors: ["Deepak Ingale"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=c10e6a2ddbd0dbc01dcaf3231f96197b"
---
<p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">   </span></p><p style="margin: 0px 0px 10pt;"><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">Many a times we integrate LDAP with servicenow and does not get all the information required for reference fields like 'location' and 'department' on 'sys_user' table from LDAP itself. </span></p><p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">   </span></p><p style="margin: 0px 0px 10pt;"><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">We are then left with the option to load these information from another spreadsheet and then associate it with user records which is sometime a painful task. </span></p><p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">   </span></p><p style="margin: 0px 0px 10pt;"><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">Recently we happened to work on LDAP integration with one of the customer. Good thing   we noticed while doing this integration is that their user object attributes were really defined nicely and contained a lot of information rather than the basic attributes like samAccountName, firstName etc.</span></p><p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">   </span></p><p style="margin: 0px 0px 10pt;"><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">We found user object was containing information related to locations (attributes like 'c' for country, 'st' for state, 'physicaldeliveryofficename' for city and 'streetaddress' for street address. Similar thing we noticed about department information also. So we thought to leverage those attributes, import location and department details to their respective tables and associate them to user record along with loading user information from LDAP. </span></p><p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">   </span></p><p style="margin: 0px 0px 10pt;"><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">I had to write certain amount of code but it paid well and we could load locations and department details with no issue. So sharing the same with you, so that you can use it with <strong>little bit modification</strong> if required after analyzing location attributes completely.</span></p><p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">   </span></p><p style="margin: 0px 0px 10pt;"><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">You will require to paste this code into 'onBefore' transform map of LDAP. Code will take care to import locations and department details.</span></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_text_macro _jivemacro_uid_14386015725094908 jive_macro_code" jivemacro_uid="_14386015725094908">
<p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 12pt;">   </span></p>
<p>//gs.log('Deepak: xform User ' + source.u_givenname + ' ' + source.u_sn + ' in country:   ' + <br/>       //source.u_c + ' With complete address ' + source.u_streetaddress + ', ' + source.u_physicaldeliveryofficename + ', ' + source.u_st + ', ' + source.u_c);<br/>if(source.u_c != '')<br/>{<br/> var country = new GlideRecord('cmn_location');<br/> country.addQuery('name',source.u_c); //look for country assoicated with current user record being imported<br/> country.addQuery('company','a4e3e06a37014200cb18341643990e39');// query a record in domain separated environment associated with company<br/> country.query();<br/> var countryCount = 0;<br/> if(country.next())<br/> {<br/>   var countrySysID = country.sys_id; // if exists, then store sys_id to variable. Lateron, it will be used to set as parent for state<br/>   countryCount++;<br/> //gs.log('Deepak: Already exist country' + ' '   + countryCount + ' ' + source.u_c );<br/> }<br/> else if(countryCount == 0)<br/> {<br/> //gs.log('Deepak: ' + 'We need to insert new Country ' + source.u_c);<br/> var countryNew = new GlideRecord('cmn_location');<br/> countryNew.initialize();<br/> countryNew.name = source.u_c;<br/>       countryNew.company = 'a4e3e06a37014200cb18341643990e39'; // associate location to company in domain separated environment. simply comment it out if you dont have domain separation setup<br/> var countrySysID = countryNew.insert(); // if does not exists, then insert new contry and store sys_id to variable, use it to set as parent for state<br/> //gs.log('Deepak: new country inserted ' + countryNew.name + ' ' + countrySysID);<br/> }<br/>}<br/>if(source.u_st != '')<br/>{<br/> var state = new GlideRecord('cmn_location');<br/> state.addQuery('name',source.u_st); <br/> state.addQuery('company','a4e3e06a37014200cb18341643990e39');<br/> state.query();<br/> var stateCount = 0;<br/> if(state.next())<br/> {<br/>   var stateSysID = state.sys_id;<br/>   stateCount++;<br/> //gs.log('Deepak: Already exist state ' + stateCount + ' ' + source.u_st);<br/> }<br/> else if(stateCount == 0)<br/> {<br/>   gs.log('Deepak: ' + 'We need to insert new state');<br/>   var stateNew = new GlideRecord('cmn_location');<br/>   stateNew.initialize();<br/>   stateNew.name = source.u_st;<br/>   stateNew.state = source.u_st;<br/>   stateNew.parent = countrySysID;<br/>   stateNew.company = 'a4e3e06a37014200cb18341643990e39';<br/>   var stateSysID = stateNew.insert();<br/> //gs.log('Deepak: new state inserted ' + stateNew.name + ' ' + stateSysID);<br/> }<br/>}<br/>if(source.u_physicaldeliveryofficename != '')<br/>{<br/> var city = new GlideRecord('cmn_location');<br/> city.addQuery('name',source.u_physicaldeliveryofficename);<br/> city.addQuery('company','a4e3e06a37014200cb18341643990e39');<br/> city.query();<br/> var cityCount = 0;<br/> if(city.next())<br/> {<br/>   var citySysID = city.sys_id;<br/>   cityCount++;<br/> //gs.log('Deepak: Already exist city ' + cityCount + ' ' + source.u_physicaldeliveryofficename);<br/> }<br/> else if(cityCount == 0)<br/> {<br/>   gs.log('Deepak: ' + 'We need to insert new city');<br/>   var cityNew = new GlideRecord('cmn_location');<br/>   cityNew.initialize();<br/>   cityNew.name = source.u_physicaldeliveryofficename;<br/>   cityNew.city = source.u_physicaldeliveryofficename;<br/>   cityNew.state = source.u_st;<br/>   cityNew.parent = stateSysID;<br/>   cityNew.company = 'a4e3e06a37014200cb18341643990e39';<br/>   var citySysID = cityNew.insert();<br/> //gs.log('Deepak: new city inserted ' + cityNew.name + ' ' + citySysID);<br/> }<br/>}<br/>if(!(source.u_streetaddress == '' &amp;&amp; source.u_physicaldeliveryofficename == '' &amp;&amp; source.u_st == '')) // if all address related attributes are not blank, then evaluate other things.<br/>{<br/> var address = new GlideRecord('cmn_location');<br/> if(source.u_streetaddress != '' &amp;&amp; source.u_physicaldeliveryofficename != '' &amp;&amp; source.u_st != '')<br/> {<br/>   address.addQuery('name',source.u_streetaddress + ', ' + source.u_physicaldeliveryofficename + ', ' + source.u_st);<br/> }<br/> else if(source.u_streetaddress == '' &amp;&amp; source.u_physicaldeliveryofficename != '' &amp;&amp; source.u_st != '')<br/> {<br/>   address.addQuery('name',source.u_physicaldeliveryofficename + ', ' + source.u_st);<br/> }<br/> else if(source.u_streetaddress == '' &amp;&amp; source.u_physicaldeliveryofficename == '' &amp;&amp; source.u_st != '')<br/> {<br/> address.addQuery('name',source.u_st);<br/> }<br/> else if(source.u_streetaddress != '' &amp;&amp; source.u_physicaldeliveryofficename == '' &amp;&amp; source.u_st != '')<br/> {<br/>   address.addQuery('name',source.u_streetaddress + ', ' + source.u_st);<br/> }<br/> else if(source.u_streetaddress != '' &amp;&amp; source.u_physicaldeliveryofficename == '' &amp;&amp; source.u_st == '')<br/> {<br/>   address.addQuery('name',source.u_streetaddress );<br/> }<br/> else if(source.u_streetaddress == '' &amp;&amp; source.u_physicaldeliveryofficename != '' &amp;&amp; source.u_st == '')<br/> {<br/>   address.addQuery('name',source.u_physicaldeliveryofficename );<br/> }<br/> else if(source.u_streetaddress != '' &amp;&amp; source.u_physicaldeliveryofficename != '' &amp;&amp; source.u_st == '')<br/> {<br/>   address.addQuery('name',source.u_streetaddress + ', ' + source.u_physicaldeliveryofficename );<br/> }<br/> address.addQuery('company','a4e3e06a37014200cb18341643990e39');<br/> address.query();<br/> var addressCount = 0;<br/> if(address.next())<br/> {<br/>   var addressSysID = address.sys_id;<br/>   target.location = addressSysID;<br/>   target.company = 'a4e3e06a37014200cb18341643990e39' ;<br/>   addressCount++;<br/> //gs.log('Deepak: Already exist address' + addressCount + ' ' + source.u_streetaddress + ', ' + source.u_physicaldeliveryofficename + ', ' + source.u_st);<br/> }<br/> else if(addressCount == 0)<br/> {<br/> //gs.log('Deepak: ' + 'We need to insert new address');<br/> var addressNew = new GlideRecord('cmn_location');<br/> addressNew.initialize();<br/> if(source.u_streetaddress != '' &amp;&amp; source.u_physicaldeliveryofficename != '' &amp;&amp; source.u_st != '')<br/> {<br/>   addressNew.name = source.u_streetaddress + ', ' + source.u_physicaldeliveryofficename + ', ' + source.u_st ;<br/> }<br/> else if(source.u_streetaddress == '' &amp;&amp; source.u_physicaldeliveryofficename != '' &amp;&amp; source.u_st != '')<br/> {<br/>   addressNew.name = source.u_physicaldeliveryofficename + ', ' + source.u_st;<br/> }<br/> else if(source.u_streetaddress == '' &amp;&amp; source.u_physicaldeliveryofficename == '' &amp;&amp; source.u_st != '')<br/> {<br/>   addressNew.name = source.u_st;<br/> }<br/> else if(source.u_streetaddress != '' &amp;&amp; source.u_physicaldeliveryofficename == '' &amp;&amp; source.u_st != '')<br/> {<br/>   addressNew.name = source.u_streetaddress + ', ' + source.u_st;<br/> }<br/> else if(source.u_streetaddress != '' &amp;&amp; source.u_physicaldeliveryofficename == '' &amp;&amp; source.u_st == '')<br/> {<br/>   addressNew.name = source.u_streetaddress ;<br/> }<br/> else if(source.u_streetaddress == '' &amp;&amp; source.u_physicaldeliveryofficename != '' &amp;&amp; source.u_st == '')<br/> {<br/>   addressNew.name = source.u_physicaldeliveryofficename;<br/> }<br/> else if(source.u_streetaddress != '' &amp;&amp; source.u_physicaldeliveryofficename != '' &amp;&amp; source.u_st == '')<br/> {<br/>   addressNew.name = source.u_streetaddress + ', ' + source.u_physicaldeliveryofficename;<br/> }<br/> addressNew.street = source.u_streetaddress;<br/>       addressNew.parent = citySysID;<br/> addressNew.city = source.u_physicaldeliveryofficename;<br/> addressNew.state = source.u_st;<br/> addressNew.zip = source.u_postalcode;<br/> addressNew.company = 'a4e3e06a37014200cb18341643990e39';<br/> var addressSysID = addressNew.insert();<br/> target.location = addressSysID; // location field visisble in user record in combination of streetaddress, physicaldeliery address(city) and state<br/> target.company = 'a4e3e06a37014200cb18341643990e39';<br/> //gs.log('Deepak: new address inserted ' + addressNew.name + ' ' + addressSysID);<br/> }<br/>}</p>
<p>//Load Department details also along with user records.<br/>if(source.u_department != '') //if department is not null<br/>{<br/> var depart = new GlideRecord('cmn_department');<br/> depart.addQuery('name',source.u_department);<br/> depart.addQuery('company','a4e3e06a37014200cb18341643990e39');<br/> depart.query();<br/> var departCount = 0;<br/> if(depart.next())<br/> {<br/>   var departSysID = depart.sys_id;<br/>   target.department = departSysID;<br/>   departCount++;<br/> }<br/> else if(departCount == 0)<br/> {<br/> //gs.log('Deepak: ' + 'We need to insert new depart');<br/>   var departNew = new GlideRecord('cmn_department');<br/>   departNew.initialize();<br/>   departNew.name = source.u_department;<br/>   departNew.company = 'a4e3e06a37014200cb18341643990e39';<br/>   var departSysID = departNew.insert();<br/>   target.department = departSysID;<br/> }<br/>}</p>
<p></p>
</pre>