---
title: "A Background Script to Scrub a Tables Duplicates and keep references to them"
date: 2015-06-01T22:21:48.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=f27ce2e1dbd0dbc01dcaf3231f961910"
---
<p>I recently ran into a problem that I'm sure many people run into in their instances of Service Now: duplication of data. Ours was caused by an integration with an outside system, wherein the transform map was creating multiple departments of the same name for each individual user within the department in question. I'm relatively certain that there's a process in place out there to keep this from happening (we're currently in the process of setting up the Field Normalization module ourselves), but I came up with what I think is a fairly elegant solution to cleaning up a specific table without messing up the references to the individual objects. Here's my background script:</p><p></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">var department = new GlideAggregate('cmn_department');</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">department.groupBy('name');</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">var names = [];</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">var ids = [];</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">var encodedQuery = '';</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">department.query();</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">while(department.next()){</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">   var temp = new GlideRecord('cmn_department');</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">               temp.get('name',department.name);</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">               if(temp.name){</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">   names.push(new String(temp.name));</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">   ids.push(new String(temp.sys_id));</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">   if(encodedQuery == '')</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">   encodedQuery = 'sys_id!=' + temp.sys_id.toString();</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">   else</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">   encodedQuery += '^sys_id!=' + temp.sys_id.toString();</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">   }</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">}</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">var column = new GlideRecord('sys_dictionary');</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">column.addEncodedQuery('reference=cmn_department');</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">column.query();</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">while(column.next()){</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">   for(var i = 0; i &lt; names.length; i++){</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">           var table = new GlideRecord(column.name);</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">           table.addEncodedQuery(column.element + 'ISNOTEMPTY^' + column.element + '.name=' + names[i]);</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">           table.query();</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">           while(table.next()){</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">                   table.setValue(column.element, ids[i]);</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">                   table.update();</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">           }</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">   }</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">}</span></p><p style="padding-left: 30px;"></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">var depart2 = new GlideRecord('cmn_department');</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">depart2.addEncodedQuery(encodedQuery);</span></p><p style="padding-left: 30px;"><span style="font-size: 8pt; line-height: 1.5em;">depart2.deleteMultiple();</span></p><p></p><p>Obviously you'd want to replace any mention of "cmn_department" to be whatever table you're cleaning, but it should work in almost any situation. Please let me know if you have a better way of accomplishing this, preferably in a way that doesn't require a background script.</p>