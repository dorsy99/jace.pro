---
title: "Avoid scripting for the Happy Path"
date: 2015-05-13T22:45:14.000Z
authors: ["kbsimm"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=774da229dbd0dbc01dcaf3231f9619ec"
---
<p><img   alt="RogueOnBridgeCropped.png" class="image-0 jive-image" height="169" src="d49f6c8edb949304b322f4621f9619b6.iix" style="height: 169px; float: left; width: 125.131914893617px;" width="125"/></p><p><span style="font-size: 10pt; line-height: 1.5em;">The very first incident I worked as a ServiceNow support engineer is an interesting subject for any customization effort; don't just code for what a mentor of mine called the "Happy Path."</span></p><p style="text-align: left;"></p><p><span style="font-size: 10pt; line-height: 1.5em;">Consider what happens if things don't go as you expect. </span></p><p><span style="font-size: 10pt; line-height: 1.5em;">There is nothing quite like trying to understand why your code isn't working only to find out after much debugging that it really was working but just not quite how you expected.   </span></p><p><span style="font-size: 10pt; line-height: 1.5em;"> </span></p><p style="text-align: center;"><span style="font-size: 10pt; line-height: 1.5em;"><em>See the new <a title="ki.servicenow.com/index.php?title=JavaScript_Debugger" href="http://wiki.servicenow.com/index.php?title=JavaScript_Debugger">javascript debugger</a> available beginning with the Dublin release.</em> <br/></span></p><p><span style="font-size: 10pt; line-height: 1.5em;"><em> </em></span></p><p><span style="font-size: 10pt; line-height: 1.5em;"><em> </em></span></p><p><span style="font-size: 10pt; line-height: 1.5em;"><em>Rogue 2006-2015 On one of his "Happy Paths"</em></span></p><p></p><p>In brief, a query for a specific record in a script did not find a result. (See <a title="ki.servicenow.com/index.php?title=Script_in_ServiceNow" href="http://wiki.servicenow.com/index.php?title=Script_in_ServiceNow">Scripting in ServiceNow</a>.) The script's author did not account for this and thus the data from the previous iteration was used populating an incident with incorrect data.</p><p></p><p>In detail, a custom email inbound action, System Policy &gt; Inbound Actions, "Some_Clever_InBound_Email_Script_Name" existed and in that script we find a query for a user as follows:</p><p></p><pre __default_attr="plain" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14315392600982395 jive_text_macro" data-renderedposition="355_8_1192_592" jivemacro_uid="_14315392600982395"><p>var userLookup = new GlideRecord('sys_user');</p><p>userLookup.addQuery('email', email.from);</p><p>userLookup.query();</p><p></p><p>while (usrlookup.next())</p><p>{</p><p>   var userID = userLookup.sys_id;</p><p>}</p>                                                       </pre><p></p><p style="text-align: left;"><em>Yesterday, on the plane, I saw a guy in his Seahawks jersey and hat.   It is not even close to football season but it got me fired up.   Thus explains some of the sample data I use below.</em></p><p style="text-align: left;"><em> </em></p><p><em>For great information on Email including Inbound Actions see Katharine Campbell's blog posts found here, <a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=f0dc2665dbd0dbc01dcaf3231f9619f7">Email, Email, and More Email</a></em></p><p><span> </span></p><p><span>If the above "userlookup.query();" fails to find the record, then the loop is not entered and the userID will not be set.   In fact, it could have data from the previous run of the script or simply be undefined.   In this particular case the email came from marshawn.lynch[@]seahawks.com </span><span>but in his user record his email is listed as beastmode[@]seahawks.com</span><span>.   So of course no match was found.</span></p><p></p><p><span>Later in the script, userID is used to set opened_by on an incident and the customer was surprised to find that the data said the incident was opened by russell.wilson[@]seahawks.com</span><span><span> When we looked into the details we found that the previous email processed was from russell.wilson[@]seahawks.com</span><span> (oops!).</span></span></p><p></p><p>To fix this issue you can modify your script to set the userID to null or to some default user before using the result of the lookup query.</p><p></p><pre __default_attr="plain" __jive_macro_name="code" class="_jivemacro_uid_14315392600949323 jive_macro_code jive_text_macro" data-renderedposition="1241_8_1192_432" jivemacro_uid="_14315392600949323"><p><span>var userID = </span><a title="k-email-small" class="jive-link-email-small" href="mailto:'pete.carroll@seahawks.com">'pete.carroll@seahawks.com</a><span>';</span></p><p>while (usrlookup.next()){</p><p>   userID = usrlookup.sys_id;</p><p>}</p>                                           </pre><p></p><p>Or put the lookup in an "if-else" rather then a while:</p><p></p><pre __default_attr="plain" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14315392600887420 jive_text_macro" data-renderedposition="1736_8_1192_448" jivemacro_uid="_14315392600887420"><p>if (userlookup.next()){</p><p>   var userID = userlookup.sys_id;</p><p>} else{</p><p><span><span>   var userID = </span><a title="k-email-small" class="jive-link-email-small" href="mailto:'pete.carroll@seahawks.com">'pete.carroll@seahawks.com</a><span>'</span><span>;</span></span></p><p>}</p>                                           </pre><p></p><p>Your choice will vary depending on your business needs; whether you use a default user or some other action, if the user lookup fails to find a record you want to make sure you account for that not so Happy Path.   Additionally, you might need to consider what you would do if more then one record is found.</p><p></p><p>Other areas where I have seen the "Happy Path" cause issues:</p><ol class="ol1"><li>"While it never happened"   - Use of a while loop without considering what to do when the loop is not entered.</li><li>"Pass it to me" - When you write a function consider what will happen if the caller passes you bad data.</li><li>"Bad returns" - When you call a function but don't get back what you expected.</li><li>"Talk to me" - When you log a certain condition but don't log when the condition doesn't occur.</li></ol><p></p><p><span style="font-size: 10pt; line-height: 1.5em;"> And finally:   "Undefined is not fine" -   This one caused a P1 incident last week.   A <a title="ki.servicenow.com/index.php?title=Server_Scripting" href="http://wiki.servicenow.com/index.php?title=Server_Scripting">Glide Scriptable</a> was being called:</span></p><p><span style="font-size: 10pt; line-height: 1.5em;"> </span></p><pre __default_attr="plain" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14315392600791557 jive_text_macro" data-renderedposition="2447.984375_8_1192_352" jivemacro_uid="_14315392600791557"><p>var enc = new GlideEncrypter();</p><p>var encryptedString = enc.encrypt(source.u_stringToEncrypt);</p>                                     </pre><p></p><p>But source.u_stringToEncrypt was undefined.   GlideEncrypter eventually tried to make a copy of source.u_stringToEncrypt and since this string was undefined it pointed to some random place in memory.   And with nothing to terminate the string it copied and copied and copied and copied until the <a title="cs.oracle.com/javase/7/docs/api/java/lang/OutOfMemoryError.html" href="http://docs.oracle.com/javase/7/docs/api/java/lang/OutOfMemoryError.html">JVM ran out of memory</a>.   (See #2 above.   I have submitted a problem report.<span __jive_emoticon_name="blush" __jive_macro_name="emoticon" class="jive_emote jive_macro" data-renderedposition="2841.984375_1183.859375_16_16" src="/8.0.4.21bdc7e/images/emoticons/blush.png"></span>)</p><p></p><p>When scripting in your customizations be sure to always be ready to react if you don't get what you want.   Just as Russell Wilson always has an audible ready if he doesn't get the defensive look he wants.</p><p></p><h3 style="text-align: center;"><a href="http://www.seahawks.com/"><span style="color: #00ff00; font-size: 14pt;">G</span><span style="font-size: 14pt;"><span style="color: #0000ff;">o</span> <span style="color: #00ff00;">H</span><span style="color: #0000ff;">a</span><span style="color: #00ff00;">w</span><span style="color: #0000ff;">k</span><span style="color: #00ff00;">s</span></span><span style="color: #0000ff; font-size: 14pt;">!</span></a></h3>