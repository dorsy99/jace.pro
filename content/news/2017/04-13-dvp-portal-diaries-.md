---
title: "Portal diaries Service Portal  Multiple Catalogs Part "
date: 2017-04-12T22:31:33.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=7b5e2eaddbd0dbc01dcaf3231f961990"
---
<p style="margin-bottom: .0001pt;">Today, I would like to explain how to only display the categories that are related to a catalog.</p><p></p><p style="margin-bottom: .0001pt;">For this we need to update SC categories widget, SC Category Page as well as SC Popular items OOB widgets.</p><p></p><p style="margin-bottom: .0001pt;">Before going into the widget, I would like to shed some light on a method available in $sp API <a href="https://github.com/service-portal/documentation/blob/master/documentation/widget_server_script_apis.md#getParameter"><span style="color: blue;">getParameter</span></a> returns the value of given key. This methods helps to retrieve the sys id of the selected catalog.</p><p></p><p style="margin-bottom: .0001pt;">If you have observed in the part 1 of this article series, the anchor tag has the sys id of catalog in URL.</p><p style="margin-bottom: .0001pt;">&lt;a ng-href="?id=sc_home2&amp;<strong>catalog_sys_id={{inc.sysid}}</strong>" class="panel-body block"&gt;</p><p></p><p style="margin-bottom: .0001pt;">And $sp.getParameter('catalog_sys_id');   will get the sys id of the catalog.</p><p></p><p style="margin-bottom: .0001pt;">Once we have the sys id of the catalog all we need to do is update the existing widgets with the above method and filter the categories.</p><p style="margin-bottom: .0001pt;"></p><p style="margin-bottom: .0001pt;">Below is the Updated server code of the SC categories widget</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_14920093461218131 jive_macro_code jive_text_macro" data-renderedposition="331_8_1175_3216" jivemacro_uid="_14920093461218131"><p>(function() {</p><p>// populate the 'data' object</p><p>data.categories = [];</p><p></p><p>data.sc_catalog = $sp.getParameter('catalog_sys_id'); //$sp.getValue('sc_catalog');</p><p>     </p><p>   var sc_cat = new GlideRecord('sc_catalog');</p><p>   sc_cat.addQuery('sys_id', data.sc_catalog);</p><p>   sc_cat.query();</p><p></p><p></p><p>   while(sc_cat.next())</p><p>   {</p><p>   data.catalog_name = sc_cat.title.toString();</p><p>   } </p><p></p><p>options.category_layout = options.category_layout || "Nested";</p><p></p><p></p><p>if (options.page) {</p><p>   var pageGR = new GlideRecord("sp_page");</p><p>   options.page = (pageGR.get(options.page)) ? pageGR.getValue("id") : null;</p><p>} else {</p><p>   options.page = 'sc_category';</p><p>}</p><p></p><p></p><p>if (input &amp;&amp; input.action === "retrieve_nested_categories") {</p><p>   var childCategoriesGR = buildSubcategoryGR(input.parentID);</p><p>   data.subcategories = retrieveCategoriesFromGR(childCategoriesGR);</p><p>   return ;</p><p>}</p><p></p><p></p><p>var sc = new GlideRecord('sc_category');</p><p>sc.addQuery('sys_class_name', 'sc_category');</p><p>sc.addActiveQuery();</p><p>sc.orderBy('title');</p><p>//data.sc_catalog = $sp.getParameter('catalog_sys_id'); //$sp.getValue('sc_catalog');</p><p>if (data.sc_catalog)</p><p>   sc.addQuery('sc_catalog', data.sc_catalog);</p><p>if (options.category_layout === "Nested")</p><p>   sc.addQuery('parent', '');</p><p>sc.query();</p><p>data.categories = retrieveCategoriesFromGR(sc);</p><p></p><p></p><p>// If the selected category is a subcategory, we need to </p><p>// open all it's parent categories</p><p>var selectedCategory = new GlideRecord("sc_category");</p><p>var categoryID = $sp.getParameter("sys_id");</p><p>if (!categoryID || !selectedCategory.get(categoryID))</p><p>   return;</p><p></p><p></p><p>var parentArr;</p><p>if (options.category_layout !== "Nested" || !selectedCategory.parent)</p><p>   parentArr = data.categories;</p><p>else</p><p>   parentArr = openParent(selectedCategory.getElement("parent").getRefRecord());</p><p></p><p></p><p>var selectedCategoryItem = findElementBySysID(parentArr, selectedCategory.getUniqueValue());</p><p>if (selectedCategoryItem)</p><p>   selectedCategoryItem.selected = true;</p><p></p><p></p><p>function openParent(gr) {</p><p>   var catItem;</p><p></p><p>   if (!gr.parent) {</p><p>   catItem = findElementBySysID(data.categories, gr.getUniqueValue());</p><p>   } else {</p><p>   var parentCategoryArr = openParent(gr.getElement("parent").getRefRecord());</p><p>   catItem = findElementBySysID(parentCategoryArr, gr.getUniqueValue());</p><p>   }</p><p></p><p>   if (!catItem)</p><p>   return [];</p><p></p><p>   var subcategoryGR = buildSubcategoryGR(catItem.sys_id);</p><p>   catItem.subcategories = retrieveCategoriesFromGR(subcategoryGR);</p><p>   catItem.showSubcategories = true;</p><p>   return catItem.subcategories;</p><p>}</p><p></p><p></p><p>function findElementBySysID(arr, id) {</p><p>   var foundElements = arr.filter(function(item) {</p><p>   return item.sys_id === id;</p><p>   });</p><p></p><p>   return (foundElements.length &gt; 0) ? foundElements[0] : null;</p><p>}</p><p></p><p></p><p>function retrieveCategoriesFromGR(gr) {</p><p>   var categories = []</p><p>   while (gr.next()) {</p><p>   var category = retrieveCategoryFromGR(gr);</p><p>   if (category)</p><p>   categories.push(category);</p><p>   }</p><p></p><p>   return categories;</p><p>}</p><p></p><p></p><p>function retrieveCategoryFromGR(gr) {</p><p>   if (!$sp.canReadRecord("sc_category", gr.getUniqueValue()))</p><p>   return null;</p><p></p><p></p><p>   if (options.check_can_view != true &amp;&amp; options.check_can_view != "true") {</p><p>   // use GlideAggregate by way of GlideRecordCounter, doesn't check canView on each item</p><p>   var count = new GlideRecordCounter('sc_cat_item_category');</p><p>   prepQuery(count, gr.getUniqueValue());</p><p>   var item_count = count.getCount();</p><p>   if (item_count &gt; 0) {</p><p>   var cat = {};</p><p>   cat.title = gr.title.getDisplayValue();</p><p>   cat.sys_id = gr.getUniqueValue();</p><p>   cat.catalog_sys_id = gr.sc_catalog.sys_id.toString();</p><p>   cat.count = item_count;</p><p>   cat.parent = gr.parent.getDisplayValue();</p><p>   if (options.category_layout === "Nested")</p><p>   cat.isParentCategory = checkIsParentCategory(gr);</p><p>   return cat;</p><p>   }</p><p>   }</p><p></p><p></p><p>   if (options.check_can_view == true || options.check_can_view == "true") {</p><p>   // use GlideRecord, checking canView on each item</p><p>   var itemCat = new GlideRecord('sc_cat_item_category');</p><p>   prepQuery(itemCat, gr.getUniqueValue());</p><p>   itemCat.query();</p><p>   var validatedCount = 0;</p><p>   var checked = 0;</p><p>   while (itemCat.next()) {</p><p>   checked++;</p><p>   if ($sp.canReadRecord("sc_cat_item", itemCat.sc_cat_item))</p><p>   validatedCount++;</p><p></p><p></p><p>   // if user can't see the first 50 items in this category, give up</p><p>   if (validatedCount == 0 &amp;&amp; checked == 50)</p><p>   break;</p><p></p><p></p><p>   // if omitting badges, and if we found one, work is done</p><p>   if (validatedCount &gt; 0 &amp;&amp; options.omit_badges)</p><p>   break;</p><p>   }</p><p></p><p></p><p>   if (validatedCount &gt; 0) {</p><p>   var cat = {};</p><p>   cat.title = gr.title.getDisplayValue();</p><p>   cat.sys_id = gr.getUniqueValue();</p><p>   cat.catalog_sys_id = gr.sc_catalog.sys_id.toString();</p><p>   cat.count = validatedCount;</p><p>   cat.parent = gr.parent.getDisplayValue();</p><p>   if (options.category_layout === "Nested")</p><p>   cat.isParentCategory = checkIsParentCategory(gr);</p><p>   return cat;</p><p>   }</p><p>   }</p><p></p><p>   return null;</p><p>}</p><p></p><p></p><p>function prepQuery(gr, scUniqueValue) {</p><p>   gr.addQuery('sc_category', scUniqueValue);</p><p>   gr.addQuery('sc_cat_item.active', true);</p><p>   gr.addQuery('sc_cat_item.visible_standalone', true);</p><p>   gr.addQuery('sc_cat_item.sys_class_name', 'NOT IN', 'sc_cat_item_wizard');</p><p>}</p><p></p><p></p><p>function checkIsParentCategory(cat) {</p><p>   var count = new GlideRecordCounter('sc_category');</p><p>   count.addQuery('active', true);</p><p>   count.addQuery('parent', cat.getUniqueValue());</p><p>   return count.getCount() &gt; 0;</p><p>}</p><p></p><p></p><p>function buildSubcategoryGR(parentID) {</p><p>   var subcategoryGR = new GlideRecord("sc_category");</p><p>   subcategoryGR.addActiveQuery();</p><p>   subcategoryGR.orderBy('title');</p><p>   var sc_catalog = data.sc_catalog; //$sp.getValue('sc_catalog');</p><p>   if (sc_catalog)</p><p>   subcategoryGR.addQuery('sc_catalog', sc_catalog);</p><p>   subcategoryGR.addQuery('parent', parentID);</p><p>   subcategoryGR.query();</p><p>   return subcategoryGR;</p><p>}</p><p>})();</p></pre><p style="margin-bottom: .0001pt;"></p><p style="margin-bottom: .0001pt;"></p><p style="margin-bottom: .0001pt;">Also, we need to update <strong>spCategoryListItem </strong>angular provider to show only the categories of a selected catalog</p><p style="margin-bottom: .0001pt;"></p><p style="margin-bottom: .0001pt;">Below is the updated client script of category angular provider</p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_14920093852866860 jive_macro_code jive_text_macro" data-renderedposition="3652_8_1175_519" jivemacro_uid="_14920093852866860"><p style="margin-bottom: .0001pt;">function spCategoryListItem() {</p><p style="margin-left: 27.0pt; margin-bottom: .0001pt;">return {</p><p style="margin-left: .75in; margin-bottom: .0001pt;">restrict: 'E',</p><p style="margin-left: .75in; margin-bottom: .0001pt;">scope: {</p><p style="margin-left: 81.0pt; margin-bottom: .0001pt;">category: "=",</p><p style="margin-left: 81.0pt; margin-bottom: .0001pt;">omitBadges: "=",</p><p style="margin-left: 81.0pt; margin-bottom: .0001pt;">level: "=",</p><p style="margin-left: 81.0pt; margin-bottom: .0001pt;">page: "=?"</p><p style="margin-left: .75in; margin-bottom: .0001pt;">},</p><p style="margin-left: .75in; margin-bottom: .0001pt;">replace: true,</p><p style="margin-left: .75in; margin-bottom: .0001pt;">template:     '&lt;div ng-class="{\'indent-category\': indentCategory}"&gt;' +</p><p style="margin-left: 2.25in; margin-bottom: .0001pt;">'&lt;a class="list-group-item" ng-class="{selected: category.selected}" href="?id={{page}}&amp;sys_id={{::category.sys_id}}&amp;catalog_sys_id={{::category.catalog_sys_id}}"&gt;' +</p><p style="margin-left: 189.0pt; margin-bottom: .0001pt;">'&lt;span ng-if="!omitBadges" class="label label-as-badge label-primary"&gt;{{::category.count}}&lt;/span&gt;' +</p><p style="margin-left: 189.0pt; margin-bottom: .0001pt;">'&lt;i class="fa fa-fw text-muted" ng-class="{\'fa-folder\': !category.showSubcategories, \'fa-folder-open\': category.showSubcategories}" ng-if="category.isParentCategory" ng-click="toggleShowSubcategories($event)"&gt;&lt;/i&gt;{{::category.title}}' +</p><p style="margin-left: 2.25in; margin-bottom: .0001pt;">'&lt;/a&gt;' +</p><p style="margin-left: 2.25in; margin-bottom: .0001pt;">'&lt;sp-category-list-item ng-if="category.showSubcategories" ng-repeat="subcategory in category.subcategories" category="subcategory" omit-badges="omitBadges" level="level + 1"&gt;&lt;/sp-category-list-item&gt;' +</p><p style="margin-left: 135.0pt; margin-bottom: .0001pt;">'&lt;/div&gt;',</p><p style="margin-left: .75in; margin-bottom: .0001pt;">controller: function($scope) {</p><p style="margin-left: 81.0pt; margin-bottom: .0001pt;">// We have to eventually stop indenting the categories.</p><p style="margin-left: 81.0pt; margin-bottom: .0001pt;">// So, we're choosing to indent up to 3 times. Otherwise,</p><p style="margin-left: 81.0pt; margin-bottom: .0001pt;">// there won't be enough room to show the category name.</p><p style="margin-left: 81.0pt; margin-bottom: .0001pt;">$scope.indentCategory = ($scope.level &gt; 0 &amp;&amp; $scope.level &lt; 4);</p><p style="margin-left: 81.0pt; margin-bottom: .0001pt;">$scope.page = $scope.page || 'sc_category';</p><p style="margin-left: 81.0pt; margin-bottom: .0001pt;">$scope.toggleShowSubcategories = function(e) {</p><ol style="list-style-type: lower-alpha;"><li>e.originalEvent.stopPropagation();</li><li>e.originalEvent.preventDefault();</li></ol><p style="margin-left: 1.5in; margin-bottom: .0001pt;">$scope.$emit("$sp.sc_category.retrieve_subcategories", $scope.category);</p><p style="margin-left: 1.5in; margin-bottom: .0001pt;">$scope.category.showSubcategories = !$scope.category.showSubcategories;</p><p style="margin-left: 81.0pt; margin-bottom: .0001pt;">}</p><p style="margin-left: .75in; margin-bottom: .0001pt;">}</p><p style="margin-left: 27.0pt; margin-bottom: .0001pt;">}</p><p style="margin-bottom: .0001pt;">}</p></pre><p style="margin-bottom: .0001pt;"></p><p style="margin-bottom: .0001pt;">Once we have the widget ready, create a new page with id <strong>sc_home2 </strong>and add updated SC category widget the the left…</p><p style="margin-bottom: .0001pt;">One may follow the similar steps to get the popular items. But keep in mind that existing popular items widget will only work for catalog items and not for record producers.</p><p></p><p>Screenshot pointing the the page id of a catalog homepage</p><p style="margin-bottom: .0001pt;"><img   class="image-2 jive-image" src="73116735db901fc068c1fb651f9619a4.iix" style="max-width: 1200px; max-height: 900px;"/></p><p></p><p><img   class="image-3 jive-image" src="48ab8d8adbd49f048c8ef4621f96195c.iix" style="max-width: 1200px; max-height: 900px;"/></p><p>                                                                                                                                                                                                   <em>Catalog Homepage </em></p><p></p><p></p><p style="margin-bottom: .0001pt;"><span style="color: #e23d39;"><em>Note: If a different name is used for page id other than sc_home2, update the same in multi catalog widget that was created in part 1 of this article</em></span></p><p></p><p></p><p style="margin-bottom: .0001pt;">After user landed on the desired Catalog homepage and when the user picks any category on the left then URL will redirect to sc_category page. Below is the screenshot of the sc_category page with the widgets.</p><p style="margin-bottom: .0001pt;">In order to support multi portal functionality, the category page needs to be updated with the widget mentioned below. </p><p style="margin-bottom: .0001pt;"></p><p style="margin-bottom: .0001pt;"><img   class="jive-image image-4" src="d846e4cadbd0dfc03eb27a9e0f961967.iix" style="max-width: 1200px; max-height: 900px;"/></p><p style="margin-bottom: .0001pt;"></p><p style="margin-bottom: .0001pt;">Below is the updated code for SC Category Page Widget</p><p style="margin-bottom: .0001pt;"></p><p style="margin-bottom: .0001pt;"><strong>Server Code</strong></p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_14920096123198867 jive_macro_code jive_text_macro" data-renderedposition="6075.171875_8_1175_1184" jivemacro_uid="_14920096123198867"><p>(function() {</p><p>   data.category_id = $sp.getParameter("sys_id");</p><p>   data.showPrices = $sp.showCatalogPrices();</p><p>   if (options &amp;&amp; options.sys_id)</p><p>   data.category_id = options.sys_id;</p><p></p><p></p><p>   data.sc_catalog = $sp.getParameter('catalog_sys_id');</p><p></p><p>   var sc_cat = new GlideRecord('sc_catalog');</p><p>   sc_cat.addQuery('sys_id', data.sc_catalog);</p><p>   sc_cat.query();</p><p></p><p></p><p>   while(sc_cat.next())</p><p>   {</p><p>   data.catalog_name = sc_cat.title.toString();</p><p>   data.catalog_url = 'sc_home2&amp;catalog_sys_id=' + sc_cat.sys_id.toString();</p><p></p><p></p><p>   } </p><p></p><p>// data.sc_catalog_page = $sp.getDisplayValue("sc_catalog_page") || "oa_sc_home2";</p><p>   // Does user have permission to see this category?</p><p>   if (!$sp.canReadRecord("sc_category", data.category_id)) {</p><p>   data.error = "You do not have permission to see this category";</p><p>   return;</p><p>   } </p><p></p><p></p><p>   var cat = new GlideRecord('sc_category');</p><p>   cat.get(data.category_id);</p><p>   data.category = cat.getDisplayValue('title');</p><p>   var items = data.items = [];</p><p>   var sc = new GlideRecord('sc_cat_item_category');</p><p>   if (data.category_id) </p><p>   sc.addQuery('sc_category', data.category_id);</p><p></p><p></p><p>   sc.addQuery('sc_cat_item.active',true);</p><p>   sc.addQuery('sc_cat_item.sys_class_name', 'NOT IN', 'sc_cat_item_wizard');</p><p>   sc.orderBy('sc_cat_item.order');</p><p>   sc.orderBy('sc_cat_item.name');</p><p>   sc.query();</p><p>   while (sc.next()) {</p><p>   // Does user have permission to see this item?</p><p>   if (!$sp.canReadRecord("sc_cat_item", sc.sc_cat_item.sys_id.getDisplayValue()))</p><p>   continue;</p><p></p><p></p><p>   var item = {};</p><p>   var gr = new GlideRecord('sc_cat_item');</p><p>   gr.get(sc.sc_cat_item);</p><p>   gr = GlideScriptRecordUtil.get(gr).getRealRecord();</p><p>   $sp.getRecordDisplayValues(item, gr, 'name,short_description,picture,price,sys_id');</p><p>   item.sys_class_name = sc.sc_cat_item.sys_class_name + "";</p><p>   item.page = 'sc_cat_item';</p><p>   if (item.sys_class_name == 'sc_cat_item_guide')</p><p>   item.page = 'sc_cat_item_guide';</p><p>   else if (item.sys_class_name == 'sc_cat_item_content') {</p><p>   $sp.getRecordValues(item, gr, 'url,content_type,kb_article');</p><p>   if (item.content_type == 'kb') {</p><p>   item.page = 'kb_article';</p><p>   item.sys_id = item.kb_article;</p><p>   } else if (item.content_type == 'literal') {</p><p>   item.page = 'sc_cat_item';</p><p>   } else if (item.content_type == 'external')</p><p>   item.target = '_blank';</p><p>   }</p><p></p><p></p><p>   items.push(item);</p><p>   }</p><p>})()</p></pre><p></p><p></p><p>Once we have all the widgets needed, all we need to do is use the updated widgets on the page.</p><p></p><p style="margin-bottom: .0001pt;">For this, follow the below steps</p><ol style="list-style-type: decimal;"><li>Open sc_category page</li><li>Open the Instance of SC categories widget and update the widget   reference field with multi categories widget that was created earlier.</li></ol><p></p><p style="margin-bottom: .0001pt;"><img   class="image-1 jive-image" src="0e904802dbd85704ed6af3231f9619c3.iix" style="max-width: 1200px; max-height: 900px;"/></p><p></p><p>this concludes the part 2 of multi catalog functionality in Service Portal. In the next part, I will delve into Search and Breadcrumbs functionalities that supports multi catalogs.</p><p></p><p></p><p><span style="color: #666666; font-family: arial, sans-serif;">Attached are the XML files of the following Widgets</span></p><ul><li><span style="color: #666666; font-family: arial, sans-serif;">Multi SC Categories</span></li><li><span style="color: #666666; font-family: arial, sans-serif;">Multi SC Popular Items</span></li><li><span style="color: #666666; font-family: arial, sans-serif;">Multi SC Category Page</span></li></ul><p></p><p><strong style="color: #666666; font-family: arial, sans-serif;">Blogs in this series:</strong></p><p><a title="Portal diaries: Service Portal — Multiple Catalogs (Part 1)" __default_attr="6616" __jive_macro_name="blogpost" class="jive_macro jive_macro_blogpost" data-orig-content="Portal diaries: Service Portal — Multiple Catalogs (Part 1)" data-renderedposition="7741.75_8_375_16" href="/community?id=community_blog&sys_id=8e5da629dbd0dbc01dcaf3231f961907">Portal diaries: Service Portal — Multiple Catalogs (Part 1)</a> </p>