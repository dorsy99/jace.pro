---
title: "CI Relationship Duplicate records clean up"
date: 2017-09-21T15:36:35.000Z
authors: ["Mihir Mohanta"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=74aca225dbd0dbc01dcaf3231f961978"
---
<p>Many users come across the scenario where some duplicate records created in ci relationship(cmdb_rel_ci) table.</p><p>It is always a difficult task to find out and clean up those duplicate records as thousands of duplicate records might present in ci relationship table.</p><p></p><p>Below are some methods using which you can clean up duplicate records in ci relationship(cmdb_rel_ci) table.</p><p></p><p><span style="color: #2873ee; font-size: 14pt;"><strong>1. By running background script</strong></span></p><p></p><p>Below is the sample code.You can add more filters there if you want to perform it for some specific ci class.</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_15059036421553146 jive_text_macro" data-renderedposition="203_8_1192_288" jivemacro_uid="_15059036421553146"><p>var rel= new GlideAggregate('cmdb_rel_ci');</p><p>rel.groupBy('parent');</p><p>rel.groupBy('child');</p><p>rel.groupBy('type');</p><p>rel.addHaving('COUNT', '&gt;', 1);</p><p>rel.query();</p><p>     while (rel.next()) {</p><p>var del= new GlideRecord('cmdb_rel_ci');   </p><p>     del.addQuery('parent', rel.parent);</p><p>del.addQuery('child', rel.child); </p><p>del.addQuery('type', rel.type);         </p><p>     del.query();   </p><p>     del.next(); // Skip the first result   </p><p>     while (del.next()) { // delete the rest   </p><p>             del.deleteRecord();   </p><p>     }   </p><p> }</p><p></p></pre><p></p><p></p><p><span style="color: #2873ee; font-size: 14pt;"><strong>2. Through Export as excel</strong></span></p><p></p><p><span style="color: #2873ee; font-size: 10pt;"><strong>(This method is not recommended by me)</strong></span></p><p></p><p>Other way through which this can be achieved is as follows:</p><p></p><p>* Go to cmdb_rel_ci.list</p><p>* Right click on the column header &gt; Export &gt;Excel</p><p>* Open the Excel</p><p>*Remove the duplicate records in the excel sheet.</p><p>*Now you have the excel sheet which does not contain any duplicate rows.</p><p>*Remove all records in the cmdb_rel_ci table.</p><p>*Import the excel file to cmdb_rel_ci table through transform map.</p><p></p><p><span style="font-size: 12pt;"><strong>Note:</strong></span></p><p>If less numbers of duplicate rows are present in the excel sheet then you can delete the duplicate records manually by comparing them with records of cmdb_rel_ci table.</p><p></p><p></p><p><span style="color: #3334ca; font-size: 14pt;">Below are some product documentation where you can find the duplicate/orphan relationships</span></p><p></p><p><strong>Use the CMDB dashboard and health jobs to detect duplicate relationships.</strong></p><p></p><p><a href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/product/configuration-management/task/t_ViewRelationshipsHealth.html" title="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/product/configuration-management/task/t_ViewRelationshipsHealth.html">https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/product/configuration-management/task/t_ViewRelationshipsHealth.html</a></p><p></p><p><strong>You can enable the job "CMDB Health Dashboard - Relationship Compliance Processor" as follows:</strong></p><p></p><p><a href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/product/configuration-management/task/t_EnableCMDBHealthDashboardJob.html" title="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/product/configuration-management/task/t_EnableCMDBHealthDashboardJob.html">https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/product/configuration-management/task/t_EnableCMDBH…</a></p><p></p><p></p><p><span style="color: #3334ca; font-size: 18.6667px;">You can write a business rule in cmdb_rel_ci table to restrict duplicate records creation.</span></p><p></p><p><span style="color: #343d47; font-size: 13px; font-family: Arial; text-align: right;">Advanced : True</span></p><p>When to run : <span style="color: #303030; font-size: 10pt;">Before insert/update</span></p><p><span style="color: #303030; font-size: 12pt;">Script:</span></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_15059877953003230 jive_text_macro" data-renderedposition="1267_8_1192_288" jivemacro_uid="_15059877953003230"><p>(function executeRule(current, previous /*null when async*/) {</p><p></p><p></p><p>// Add your code here</p><p>var ci= new GlideRecord('cmdb_rel_ci');   </p><p>     ci.addQuery('parent', current.parent);</p><p>ci.addQuery('child', current.child); </p><p>ci.addQuery('type', current.type);         </p><p>     ci.query();   </p><p>     if (ci.next()) {   </p><p>   gs.addErrorMessage("Relationship record already present.Duplicate records cant be created");</p><p>           current.setAbortAction(true);</p><p></p><p></p><p>     }   </p><p></p><p></p><p>})(current, previous);</p></pre><p></p><p></p><p></p><p>Lastly while using the transform map to bulk import ci relationship records, design the transform map properly so that no duplicate ci relationship records will be created.</p>