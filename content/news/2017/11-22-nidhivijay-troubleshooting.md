---
title: "Troubleshooting Stuck Default Semaphores"
date: 2017-11-22T05:59:13.000Z
authors: ["nidhivijay"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=93bd6ea9dbd0dbc01dcaf3231f96195b"
---
<p>A semaphore is used on the platform to limit the number of transactions that can occur on a node at one time in order to protect resources on the node. When a user submits a request, it is routed through a semaphore pool where it basically joins a queue. If there is a free semaphore in that pool, then the request will grab it and process. When the transaction is complete, the semaphore is released and is free to process other requests that are in the queue.</p><p></p><p>The default semaphore pool is used to process all UI transactions (for example, homepages, Service Portal pages, the catalog, etc.). Unless a request is specified to go through a different semaphore pool, it will end up in the default pool, which is the most critical pool for performance. If the default fills up and the semaphore waits, or rejected requests (queue depth is full) begin to occur, users will see an immediate impact.</p><p></p><h2>Why do default semaphores get stuck?</h2><p>Here are some of the things that can cause a default semaphore to get stuck:</p><ul><li>Heavy load on the server is causing processes to delay the release of semaphores.</li><li>Two semaphores are waiting for the resources the other uses and neither can break the loop.</li><li>There is an infinite JavaScript loop in a scripted business rule.</li><li>The transaction being processed is extensive.</li></ul><p></p><p>To verify whether a semaphore is stuck, start by going to stats.do and identifying if one or more semaphores are currently running for a long time. A long time generally is more than 2 hours. If the transaction time exceeds this time, it is highly possible that the semaphore is stuck.</p><p></p><h1>How to troubleshoot a stuck semaphore</h1><p></p><h2>Identify the stuck semaphore</h2><ul><li>Go to stats.do and locate the long-running semaphore(s) by looking at the total execution time (highlighted in the example below).<br/><span style="color: #3d3d3d;">0:EA04429355F83D00B029B0D9928DBEE3 #1556314</span> /u_hr_employee_import.do <strong>(<span style="color: #0000ff;">Default-thread-633</span>) (22:00:39.504)<br/></strong>0:786F3143DB7FB680BB6BF7951D9619BE #2925841 /service_catalog.do <strong>(<span style="color: #0000ff;"><strong>Default-thread-10</strong></span>) (29:30:07.809)</strong></li><li>Click the link to the thread (the blue links above) to see the stack trace of the thread. This will tell you what the code is doing that is taking so long.<br/><img   alt="Screen Shot 2017-11-20 at 10.47.01 AM.png" class="image-2 jive-image" src="4254fc06db9cd704ed6af3231f96199c.iix" style="width: 620px; height: 613px; display: block; margin-left: auto; margin-right: auto;"/></li></ul><h2>Investigate the issue</h2><ul><li>It is important to understand what the thread is doing before charting the next steps.<ul><li>If you refresh the page, does the stack change or stay the same? If it stays exactly the same, then it is probably stuck.</li><li>If the top part of the stack changes but the bottom part of the stack is always the same, then you've encountered either an endless loop (recursive logic) or a very slow loop.</li><li>If the stack trace includes a line with <strong>sys_script_include.&lt;sys_id&gt;</strong>, that means a script include is being executed. <strong>sys_script.&lt;sys_id&gt;</strong> is a Business Rule. If you see a Business Rule or a Script Include in the stack trace, this will need to be reviewed for further optimization. If it is a custom script, please review. But if it is a ServiceNow script, I recommend opening a HI incident for review</li></ul></li><li>Path of relief<ul><li>If the thread is not causing severe performance issues and will eventually complete, then just let it run.</li><li>If the thread is causing severe performance issues, is stuck, or is in an endless loop, then you will have to terminate it somehow.<span style="color: #9900ff;"><br/></span></li></ul></li></ul><h2></h2><h2>Kill a long-running transaction</h2><pre __default_attr="warning" __jive_macro_name="alert" alert="warning" class="jive_text_macro jive_macro_alert" data-renderedposition="1540.953125_8_1192_43"><p>Do not kill a long-running transaction without confirming that it is acceptable and safe.</p></pre><p>The above warning is especially true when you cancel a sys.scripts.do transaction taking a long time. <strong>sys.scripts.do</strong> is the <strong>Scripts - Background</strong> module and is often used to do large operations that are known to take a long time to complete. To terminate a stuck transaction, follow these instructions:</p><p></p><p>Role required: <strong>Admin</strong> (If high security is enabled, elevate privileges to <strong>security_admin</strong>)</p><ol><li>Log in to the instance that is experiencing performance issues.</li><li>Navigate to the appropriate Active Transactions module.<ul><li>To view and kill transactions on the current node for your instance, navigate to <span class="ph menucascade"><span class="ph uicontrol" style="font-weight: bold;">User Administration</span> &gt; <span class="ph uicontrol" style="font-weight: bold;">Active Transactions</span></span>.</li><li>To view and kill transactions on all nodes for your instance, navigate to <span class="ph menucascade"><span class="ph uicontrol" style="font-weight: bold;">System Diagnostics</span> &gt; <span class="ph uicontrol" style="font-weight: bold;">Active Transactions (All Nodes)</span></span>.</li></ul></li><li>Kill the transaction by either right-clicking on the record and selecting <strong>Kill</strong>, or by selecting the check box next to the record and selecting Kill from the <strong>Actions on selected rows</strong> choice list. DO NOT select <strong>Delete</strong> as that will only remove the Active Transaction record and will not stop the transaction itself. This process may take a few minutes to complete.<img   alt="kill long running transaction.png" class="image-3 jive-image" height="281" src="4c735882db905344e9737a9e0f96199c.iix" style="color: #000000; font-size: 10pt; text-align: center; height: 281px; width: 781.256px; display: block; margin-left: auto; margin-right: auto;" width="781"/></li><li>If the above steps don't resolve the problem open a HI incident and schedule a restart of the node.</li></ol>