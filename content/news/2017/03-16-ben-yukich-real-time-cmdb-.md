---
title: "Realtime CMDB Mapping as a Service"
date: 2017-03-16T04:15:45.000Z
authors: ["ben.yukich"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=721d62e5dbd0dbc01dcaf3231f961988"
---
<p>It seems like a lifetime ago that we discussed <a __default_attr="5556" __jive_macro_name="blogpost" class="jive_macro jive_macro_blogpost" data-orig-content="Real-time CMDB: Disco as a Service" data-renderedposition="10_294.78125_248_16" href="/community?id=community_blog&sys_id=bacda2e9dbd0dbc01dcaf3231f961942" modifiedtitle="true" title="Real-time CMDB: Disco as a Service">Real-time CMDB: Disco as a Service</a>. Let's revisit this topic, this time with a focus on Service Mapping rather than simple CI discovery.</p><p></p><p>As you may already know, <a title="ocs.servicenow.com/bundle/istanbul-it-operations-management/page/product/service-mapping/reference/c_ServiceMappingOverview.html" href="https://docs.servicenow.com/bundle/istanbul-it-operations-management/page/product/service-mapping/reference/c_ServiceMappingOverview.html">Service Mapping</a> is a unique method to automate the mapping of application deployments (aka business services). The mapping process always begins with an <a title="ocs.servicenow.com/bundle/istanbul-it-operations-management/page/product/service-mapping/reference/r_EntryPointsforBizSvcDef.html#r_EntryPointsforBizSvcDef" href="https://docs.servicenow.com/bundle/istanbul-it-operations-management/page/product/service-mapping/reference/r_EntryPointsforBizSvcDef.html#r_EntryPointsforBizSvcDef">Entry Point</a> to the business service you wish to map. The most intuitive (for me) entry point is a URL, though it is an extensible concept, typically distilling down to a hostname/IP, a port, and likely additional metadata to convey the context of a request. It's the job of Service Mapping to take that Entry Point and uncover all the technical dependencies that make the service available - I'm talking load balancer, down to web tier, to app tier, to database tier, etc... however your service happens to be constructed. Now, this is not magic, it's a technique that takes some effort to ensure all the discovery patterns needed are in place, but that's a discussion for another day.</p><p></p><p>Let's assume we've already implemented Service Mapping and it understands the patterns for the various applications typically used in our environment (like nginx, tomcat, mysql, etc.). Ordinarily, to add a new business service we need to log in to our ServiceNow instance, create a new Business Service record, add an entry point, and we're good to go. Not bad, but why do something manually that we can just as easily script?</p><p></p><p>Just like last time when we created CI Disco as a Service, to start we'll <span style="color: #666666; font-family: arial, sans-serif;">create a new </span><span style="font-family: arial, sans-serif; color: #666666;"><strong>Scripted REST API</strong></span><span style="color: #666666; font-family: arial, sans-serif;">, define a </span><span style="font-family: arial, sans-serif; color: #666666;"><strong>Scripted REST Resource</strong></span><span style="color: #666666; font-family: arial, sans-serif;">, </span><span style="color: #666666; font-family: arial, sans-serif;">and take it for a spin in the </span><span style="font-family: arial, sans-serif; color: #666666;"><strong>REST API Explorer</strong></span><span style="color: #666666; font-family: arial, sans-serif;">. Here's a Scripted REST Resource script for a POST action where we're relying on the body defining a JSON object with a </span><span style="font-family: arial, sans-serif; color: #666666;"><em>serviceName</em></span><span style="color: #666666; font-family: arial, sans-serif;"> and </span><span style="font-family: arial, sans-serif; color: #666666;"><em>url </em>defined</span><span style="color: #666666; font-family: arial, sans-serif;">, and returning a URL that will take us directly to the graphical service map. It's slightly more complex than last time, but still quite approachable:</span></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14896167521055365 jive_text_macro" data-renderedposition="344_8_1120_352" jivemacro_uid="_14896167521055365" modifiedtitle="true"><p>(function process(/*RESTAPIRequest*/ request, /*RESTAPIResponse*/ response) {   </p><p>       var businessServiceGr = insertRecord('cmdb_ci_service_discovered', {'name':request.body.data.serviceName, 'operational_status':'1', 'traffic_discovery':'false'});</p><p>       var entryPointGr = insertRecord('cmdb_ci_endpoint_http', {'url':request.body.data.url});</p><p>       </p><p>       new SNC.BusinessServiceManager().addEntryPoint(<span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">businessServiceGr</span>.sys_id, <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">entryPointGr</span>);</p><p>       var mapUrl = gs.getProperty('glide.servlet.uri') </p><p>                             + '$sw_topology_map.do?sysparm_bsid=' + <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">businessServiceGr</span>.sys_id </p><p>                             + '&amp;sysparm_bsname=' + <span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">businessServiceGr</span>.name </p><p>                             + '&amp;sysparm_plugin_mode=mapping';</p><p>       </p><p>       return {'mapUrl': mapUrl};   </p><p></p><p>       function insertRecord(table, properties) {</p><p>               var gr = new GlideRecord(table);</p><p>               for (var key in properties) {</p><p>                       gr[key] = properties[key];</p><p>               }</p><p>               gr.insert();</p><p></p><p>               return gr;</p><p>       }</p><p>})(request, response);</p></pre><p></p><p>As before, we can easily test this in the REST API Explorer, just be sure to pass a JSON object in the request body such as:</p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14896189905882170 jive_text_macro" data-renderedposition="738_8_1120_16" jivemacro_uid="_14896189905882170"><p><span class="ng-binding"><span>{"serviceName":"There's no place like home","url":"</span><a title="" _jive_internal="true" href="http://127.0.0.1" rel="nofollow" target="_blank">http://127.0.0.1</a><span>"}</span></span></p></pre><p></p><p>You should receive a 200 response, and your output will give you a deep link to the newly discovered service:</p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_14896190349551640 jive_macro_code jive_text_macro" data-renderedposition="796_8_1120_80" jivemacro_uid="_14896190349551640" modifiedtitle="true"><p><span class="ng-binding">{</span></p><p><span class="ng-binding">       "result": {</span></p><p><span class="ng-binding"><span>               "mapUrl": "</span><a title="" _jive_internal="true" href="https://your_instance.service-now.com/$sw_topology_map.do?sysparm_bsid=806519d5dba13a00f3223ecf9d961976&sysparm_bsname=There's" rel="nofollow" target="_blank">https://your_instance.service-now.com/$sw_topology_map.do?sysparm_bsid=806519d5dba13a00f3223ecf9d961976&amp;sysparm_bsname=There's</a><span> no place like home&amp;sysparm_plugin_mode=mapping"</span><br/>       }<br/>}</span></p></pre><p></p><p>Pretty nifty, right? Now you can automate the creation of a service topology in ServiceNow with a simple REST request. Maybe next time we'll tackle partial refresh of a business service map, perhaps in response to a specific component being changed... what do you think?</p>