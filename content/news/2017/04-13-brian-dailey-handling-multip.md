---
title: "Handling Multiple Email Addresses per User"
date: 2017-04-12T07:54:40.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=5a5da629dbd0dbc01dcaf3231f961937"
---
<p>You will have users who insist on emailing you from Gmail, Yahoo, Outlook, anything and everything EXCEPT for the email address they have registered with you in their user profile.   Their issue is either going to be rejected or logged as Guest.</p><p></p><p>This is a topic near and dear to my heart (well, the Service Management one at least), and it's something I believe is missed out-of-the-box by many ITSM solutions (this one included).   For some reason, properly handling more than one email address for each user just doesn't seem to be a serious consideration.   Perhaps they were all designed around more corporate-centric requirements, where all users are given a single address they are expected to use for official business.</p><p></p><p>But in other less structured organizations, users can be free to contact you however they wish.   This is especially true for users in Education, simply due to the nature of the environment.   You can always deny service, reject the request and force them to email you from a recognized account, but that just comes off as rigid and unhelpful.   As any modern service organization should, we strive to be accommodating wherever reasonably possible.   And logging all those under a Guest account just leads to more work for us.</p><p></p><p>Luckily for us, the ServiceNow platform comes ready-made with a method for managing multiple email addresses per user known as Notification Devices.   The challenge here is that it still only checks the single email address field on user profiles when processing Inbound messages.   Any message received from a sender's address that is not found in the email field of an active user can be either rejected or processed as Guest.</p><p></p><p></p><h3>Challenge accepted...</h3><p></p><p><strong>Overall layout of the solution:</strong></p><p><img   alt="alt_email_handling_1.png" class="image-1 jive-image" height="287" src="a7df13b1dbd01704ed6af3231f9619a9.iix" style="float: left; height: 287px; width: 443.028px;" width="443"/></p><p><img   alt="alt_email_handling_2.png" class="image-2 jive-image" height="234" src="28e541c2db5497049c9ffb651f961999.iix" style="height: 234px; width: 477.993px;" width="478"/></p><p></p><p></p><p></p><p><strong>Here's a brief explanation of the approach, before we dive in:</strong></p><ol><li>The first part is the meat of it... this is what allows you to use multiple email addresses per user and have the system recognize them for Inbound Email processing by performing a lookup on the Notification Device table before the record for the email message gets inserted.</li><li>The second part is just a low-maintenance method to manage the notification devices.   Let the user profiles do the work for you...   devices will get populated as user email addresses are updated.   That way, you don't need to create any special UI or train your users/analysts to handle the additional email addresses as Notification Devices.   With a few business rules setup, you can simply allow all email addresses to be entered via the Email field on a user's profile, and the devices are managed automatically in the background. And since this all happens server-side, it applies to data imports as well.   (you could still script population of notification devices for your users, if you have the data handy and a desire to do so)</li></ol><p></p><p>Note: as a part of the Lookup process, we store the original sender's address in the [sys_email].reply_to field before overwriting [sys_email].user, so you can still use it later during Inbound Email Processing to add to a Watch List (or some other field) to maintain the original point of contact.</p><p></p><p></p><p></p><p><strong>Now, the scripts you'll need for each process item 1 &amp; 2, as listed above:</strong></p><p></p><table border="1" class="jiveBorder" jive-data-cell="{&quot;color&quot;:&quot;#3D3D3D&quot;,&quot;textAlign&quot;:&quot;left&quot;,&quot;padding&quot;:&quot;6&quot;,&quot;backgroundColor&quot;:&quot;transparent&quot;,&quot;fontFamily&quot;:&quot;Helvetica Neue,Helvetica,Arial,Lucida Grande,sans-serif&quot;,&quot;verticalAlign&quot;:&quot;baseline&quot;}" jive-data-header="{&quot;color&quot;:&quot;#505050&quot;,&quot;backgroundColor&quot;:&quot;#F2F2F2&quot;,&quot;textAlign&quot;:&quot;left&quot;,&quot;padding&quot;:&quot;6&quot;}" style="border: 1px solid #c6c6c6; width: 100%;"><tbody><tr><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px; width: 30%;" valign="middle"><strong>1. Lookup User by Alternate Email</strong></th><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px;" valign="middle">Script</th></tr><tr><td style="padding: 6px;"><p>Business Rule on [sys_email]</p><p></p><p style="font-family: Calibri; font-size: 11.0pt;"><strong>Match User on Alternate Address</strong></p><p style="font-family: Calibri; font-size: 11.0pt;"></p><p></p><table border="1" cellpadding="0" cellspacing="0" style="border-style: solid; border-color: #a3a3a3; border-width: 1pt;"><tbody><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 4pt;"><p style="font-family: Calibri; font-size: 11.0pt;">When</p></td><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 4pt 4pt 4pt 4pt;"><p style="font-family: Calibri; font-size: 11.0pt;">before/on Insert</p></td></tr><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 4pt;"><p style="font-family: Calibri; font-size: 11.0pt;">Condition</p></td><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 4pt 4pt 4pt 4pt;"><p style="font-family: Calibri; font-size: 11.0pt;">User ID is EMPTY</p><p style="font-family: Calibri; font-size: 11.0pt;">Type is Received</p><p style="font-family: Calibri; font-size: 11.0pt;">   OR Type is Received Ignored</p></td></tr></tbody></table><p></p><p style="font-family: Calibri; font-size: 11.0pt;">Desc:</p><p style="font-family: Calibri; font-size: 11.0pt;">If the user is unrecognized by email address, check the From address (current.user) to see if there is a match in [cmn_notif_device].</p><p></p><p style="font-family: Calibri; font-size: 11.0pt;">Note:</p><p style="font-family: Calibri; font-size: 11.0pt;">Copying current.user to current.reply_to allows you to keep the original sender address, since current.user is about to be overwritten.</p></td><td><p style="font-family: Calibri; font-size: 11pt;">matchUserByAltEmail();</p><p style="font-family: Calibri; font-size: 11pt;"></p><p style="font-family: Calibri; font-size: 11pt;"></p><p style="font-family: Calibri; font-size: 11pt;">function matchUserByAltEmail(){</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">try{</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">// If a sender is unrecognized, the sender's email address is stored in current.user and user_id is empty.</p><p>                                 current.reply_to = current.user.toString();</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">// This returns a user object if found, otherwise returns null (defined by BR function)</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">var existingUser = getUserByAltEmail(current.user);</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">if (!(JSUtil.nil(existingUser))){</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">// If a match was found, change the email UserID to existingUser</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">current.user_id = existingUser.sys_id.toString();</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">current.user = existingUser.sys_id.toString();</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">else{</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">gs.log("No user found for address: " + current.user, "BR-Match User on Alternate Address");</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">//<strong>Automatic User Creation functionality can also be inserted here, if desired.</strong></p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">catch(err){</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">gs.log("An error occurred: (" + err.lineNumber + ") " + err, "BR-Match User on Alternate Address");</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="font-family: Calibri; font-size: 11pt;">}</p></td></tr><tr><td style="padding: 6px;"><p>Script Include</p><p style="font-family: Calibri; font-size: 11pt;">getUserByAltEmail</p></td><td style="padding: 6px;"><p>function getUserByAltEmail(altEmail){</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">// Do not attempt lookup with a null address</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">if(JSUtil.nil(altEmail)){</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">return null;</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">// Find record from existing Alternate Email Addresses</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">try{</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">var gr = new GlideRecord('cmn_notif_device');</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">gr.query('email_address',altEmail);</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">if(!gr.next()){</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">// Alternate Email Address was not found</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">return null;</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">else{</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">// Alternate Email Address has matched, return the user object</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">return gr.user.getRefRecord();</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">catch(err){</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">gs.log(" An error occurred: (" + err.lineNumber + ") " + err, "BR-getUserByAltEmail");</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">return null;</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="font-family: Calibri; font-size: 11pt;">}</p></td></tr></tbody></table><p></p><p></p><p></p><div><div><div><table border="1" cellpadding="0" cellspacing="0" jive-data-cell="{&quot;color&quot;:&quot;#3D3D3D&quot;,&quot;textAlign&quot;:&quot;left&quot;,&quot;padding&quot;:&quot;2&quot;,&quot;backgroundColor&quot;:&quot;transparent&quot;,&quot;fontFamily&quot;:&quot;Helvetica Neue,Helvetica,Arial,Lucida Grande,sans-serif&quot;,&quot;verticalAlign&quot;:&quot;baseline&quot;}" jive-data-header="{&quot;color&quot;:&quot;#505050&quot;,&quot;backgroundColor&quot;:&quot;#F2F2F2&quot;,&quot;textAlign&quot;:&quot;left&quot;,&quot;padding&quot;:&quot;6&quot;}" style="border-style: solid; border-color: #a3a3a3; border-width: 1pt;"><tbody><tr><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px; width: 30%;" valign="middle"><strong>2. Manage Devices by Entering as User Email Addresses</strong></th><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px;" valign="middle">Script</th></tr><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2pt 3pt;"><p>Business Rule [sys_user]</p><p style="font-family: Calibri; font-size: 11.0pt;">Create primary email device</p><p style="font-family: Calibri; font-size: 11.0pt;"></p><table border="1" cellpadding="0" cellspacing="0" style="border-style: solid; border-color: #a3a3a3; border-width: 1pt;"><tbody><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 4pt;"><p style="font-family: Calibri; font-size: 11.0pt;">When</p></td><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 4pt 4pt 4pt 4pt;"><p style="font-family: Calibri; font-size: 11.0pt;">After/on Insert</p></td></tr><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 4pt;"><p style="font-family: Calibri; font-size: 11.0pt;">Condition</p></td><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 4pt 4pt 4pt 4pt;"><p style="font-family: Calibri; font-size: 11.0pt;">current.email != ''</p></td></tr></tbody></table></td><td>createPrimaryEmailDevice(current);</td></tr><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2pt 3pt;"><p style="font-family: Calibri; font-size: 11pt;">Business Rule [sys_user]</p><p style="font-family: Calibri; font-size: 11pt;">Update primary email device</p><p style="font-family: Calibri; font-size: 11pt;"></p><table border="1" cellpadding="0" cellspacing="0" style="border-style: solid; border-color: #a3a3a3; border-width: 1pt;"><tbody><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2pt 3pt;"><p style="font-family: Calibri; font-size: 11pt;">When</p></td><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2.0pt 3.0pt 2.0pt 3.0pt;"><p style="font-family: Calibri; font-size: 11pt;">Before/on Update</p></td></tr><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2pt 3pt;"><p style="font-family: Calibri; font-size: 11pt;">Condition</p></td><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2.0pt 3.0pt 2.0pt 3.0pt;"><p>current.email.changes()</p></td></tr></tbody></table></td><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2.0pt 3.0pt 2.0pt 3.0pt;"><p style="font-family: Calibri; font-size: 11pt;">updatePrimaryEmail();</p><p style="font-family: Calibri; font-size: 11pt;"></p><p style="font-family: Calibri; font-size: 11pt;">function updatePrimaryEmail(){</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">try{</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">//User email address was cleared (deleted)</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">if(current.email == ''){</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">var userDevices = new GlideRecord('cmn_notif_device');</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">userDevices.addQuery('type=Email^user=' + current.sys_id + '^email_address!=' + previous.email);</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">userDevices.query();</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">//Another email device exists for this user, set it as primary</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">if(userDevices.next()){</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">                   userDevices.primary_email = true;</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">                   current.email = userDevices.email_address;</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">                   userDevices.update();</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">//No other email device exists for this user, abort update</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">else{</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">                   current.email = previous.email;</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">                   current.setAbortAction(true);</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">                   gs.setRedirectURL(current);</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">                   gs.addInfoMessage("Cannot delete a user's only email address.");</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">//A new email address was entered</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">else{</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">verifyNewPrimaryAddress(current.email);</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">catch(e){</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">                   gs.log("Error (" + e.lineNumber + "): " + e, "updatePrimaryEmail()");</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="font-family: Calibri; font-size: 11pt;">}</p><p style="font-family: Calibri; font-size: 11pt;"></p><p style="font-family: Calibri; font-size: 11pt;"></p><p style="font-family: Calibri; font-size: 11pt;">//Checks for an existing cmn_notif_device and makes it primary if it belongs to the user, denies the</p><p style="font-family: Calibri; font-size: 11pt;">//update if it belongs to another user, or creates it as the user's primary if not already in existence.</p><p style="font-family: Calibri; font-size: 11pt;"></p><p style="font-family: Calibri; font-size: 11pt;">function verifyNewPrimaryAddress(email){</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">try{</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">var existing = new GlideRecord('cmn_notif_device');</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">existing.addQuery('email_address', email);</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">existing.query();</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">//An email device already exists for this address</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">if(existing.next()){</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">//Existing email device belongs to another user, abort update</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">if(existing.user.sys_id != current.sys_id){</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">                   current.setAbortAction(true);</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">//Existing email device belongs to the current user, update Primary to true</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">else{</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">         existing.primary_email = true;</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">         existing.update();</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">//No email device exists for this address, create one as Primary</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">else{</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">createPrimaryEmailDevice(current);</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">catch(e){</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">         gs.log("Error (" + e.lineNumber + "): " + e, "verifyNewPrimaryAddress()");</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="font-family: Calibri; font-size: 11pt;">}</p></td></tr><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2pt 3pt;"><p style="font-family: Calibri; font-size: 11pt;">Script Include</p><p style="font-family: Calibri; font-size: 11pt;">createPrimaryEmailDevice</p></td><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2.0pt 3.0pt 2.0pt 3.0pt;"><p style="font-family: Calibri; font-size: 11pt;">function createPrimaryEmailDevice(userRecord){</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">try{</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">var thisSysID = userRecord.sys_id;</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">var device = new GlideRecord('cmn_notif_device');</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">device.user = thisSysID;</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">device.email_address = userRecord.email;</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">device.primary_email = true;</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">device.active = true;</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">device.type = 'Email';</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">device.name = 'Primary email';</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">if(device.insert()){</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">                   gs.addInfoMessage(gs.getMessage('Primary email device created for') + ' ' + GlideStringUtil.escapeHTML(userRecord.name) + ": " + userRecord.email);</p><p style="padding-left: 101.25px; font-family: Calibri; font-size: 11pt;">return true;</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">else{</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">                   gs.log("Failed to insert Primary email device created for " + GlideStringUtil.escapeHTML(userRecord.name) + ": " + userRecord.email, "createPrimaryEmailDevice()");</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">catch(e){</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">                   gs.log("Failed to insert Primary email device created for " + GlideStringUtil.escapeHTML(userRecord.name) + ": " + userRecord.email, "createPrimaryEmailDevice()");</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="font-family: Calibri; font-size: 11pt;">}</p></td></tr><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2pt 3pt;"><p style="font-family: Calibri; font-size: 11pt;">Business Rule [cmn_notif_device]</p><p style="font-family: Calibri; font-size: 11pt;">Restrict to Only One Primary Address</p><p style="font-family: Calibri; font-size: 11pt;"></p><table border="1" cellpadding="0" cellspacing="0" style="border-style: solid; border-color: #a3a3a3; border-width: 1pt;"><tbody><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2pt 3pt;"><p style="font-family: Calibri; font-size: 11pt;">When</p></td><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2.0pt 3.0pt 2.0pt 3.0pt;"><p style="font-family: Calibri; font-size: 11pt;">After/on Insert or Update</p></td></tr><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2pt 3pt;"><p style="font-family: Calibri; font-size: 11pt;">Condition</p></td><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2.0pt 3.0pt 2.0pt 3.0pt;"><p>current.primary_email == true &amp;&amp; !current.user.nil()</p></td></tr></tbody></table></td><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2.0pt 3.0pt 2.0pt 3.0pt;"><p style="font-family: Calibri; font-size: 11pt;">restrictToSinglePrimaryAddress();</p><p style="font-family: Calibri; font-size: 11pt;"></p><p style="font-family: Calibri; font-size: 11pt;">function restrictToSinglePrimaryAddress(){</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">try{</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">// Set the user's default email address ([sys_user].email) equal to this Primary address.</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">var grUser = current.user.getRefRecord();</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">grUser.setWorkflow(false);</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">if(grUser.email != current.email_address){</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">           grUser.email = current.email_address;</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">           grUser.update();</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">// If there are other primary addresses for this user, set Primary=False for each</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">var gr = new GlideRecord('cmn_notif_device');</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">gr.addQuery('user',current.user);</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">gr.addQuery('sys_id','!=',current.sys_id);</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">gr.addQuery('primary_email',true);</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">gr.addQuery('type','Email');</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">gr.query();</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">while(gr.next()){</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">           gr.setWorkflow(false);</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">           gr.primary_email = false;</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">           gr.update();</p><p style="padding-left: 67.5px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">catch(err){</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">         gs.addErrorMessage("(BR) Restrict to One Primary Email Address: An error occurred saving the record.   " + err);</p><p style="padding-left: 33.75px; font-family: Calibri; font-size: 11pt;">}</p><p style="font-family: Calibri; font-size: 11pt;">}</p></td></tr><tr><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2pt 3pt;"></td><td style="border-style: solid; border-color: #a3a3a3; border-width: 1pt; padding: 2pt 3pt;"></td></tr></tbody></table></div></div></div><p></p><p></p><p></p><h3>And that's all there is to it...</h3><p>Yes, I actually did say those words.   I know it looks like a lot of code, but really the functional part of the Lookup can be done with a single business rule, even though I packaged it with a separate Script Include.   The rest is just fluff to make the functional change invisible in terms of maintenance, so that you won't have to worry about managing Notification Devices from here on out.   Attention to the details is just a bunch of little steps that eventually get us over the hill.</p><p></p><p></p><p>Enjoy, and please post any suggestions or questions you may have.</p><p></p><p></p><p>-Brian</p>