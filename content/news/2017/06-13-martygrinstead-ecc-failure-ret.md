---
title: "ECC Failure Retry  Async REST Web Service Example"
date: 2017-06-12T23:59:02.000Z
authors: ["martygrinstead"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=f1cc2265dbd0dbc01dcaf3231f9619c2"
---
<p>Web Service calls fail.   That's just a fact of life.</p><p></p><p>If you are making an outbound web service call from your ServiceNow instance, you may be able to use the <a title="ocs.servicenow.com/bundle/helsinki-it-operations-management/page/product/discovery/concept/c_ECCQueueRetryPolicy.html" href="https://docs.servicenow.com/bundle/helsinki-it-operations-management/page/product/discovery/concept/c_ECCQueueRetryPolicy.html">ECC Queue Retry</a> feature to have the outbound web service call retried upon failure.   This won't work for every outbound web service call, because this is only available for ASYNC calls.   Async web service calls are made using the ECC Queue as the "holding place" while waiting for the response to be returned from the web service back to your ServiceNow instance.</p><p></p><h1>Example of using ECC queue retry policy to check for a specific failure condition</h1><p>We will go through an example using REST asynchronously and have an ECC queue retry policy check for a specific failure condition.   When that failure condition is found, the REST call will be automatically tried again (3 times, with 1 minute between checks, for our example).</p><p></p><p>Let's get started with a REST Message that is part of the demo data provided with your instance "Yahoo Finance." The documentation provides an example of calling this REST message through a ServiceNow script, and making the call <a title="ocs.servicenow.com/bundle/istanbul-servicenow-platform/page/app-store/dev_portal/API_reference/RESTMessageV2/reference/r_AsynchronousRESTMessageV2Example.html" href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/app-store/dev_portal/API_reference/RESTMessageV2/reference/r_AsynchronousRESTMessageV2Example.html">asynchronously</a>.</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14959904966466014 jive_text_macro" data-renderedposition="283.54168701171875_7.986111640930176_1174_373" jivemacro_uid="_14959904966466014"><p><span class="kwd" style="color: #000088;">var</span><span class="pln" style="color: #000000;"> requestBody</span><span class="pun" style="color: #666600;">;</span><span class="pln" style="color: #000000;"><br/></span><span class="kwd" style="color: #000088;">var</span><span class="pln" style="color: #000000;"> responseBody</span><span class="pun" style="color: #666600;">;</span><span class="pln" style="color: #000000;"><br/></span><span class="kwd" style="color: #000088;">var</span><span class="pln" style="color: #000000;"> status</span><span class="pun" style="color: #666600;">;</span><span class="pln" style="color: #000000;"><br/></span><span class="kwd" style="color: #000088;">var</span><span class="pln" style="color: #000000;"> sm</span><span class="pun" style="color: #666600;">;</span><span class="pln" style="color: #000000;"><br/></span><span class="kwd" style="color: #000088;">try</span><span class="pun" style="color: #666600;">{</span><span class="pln" style="color: #000000;"><br/> sm </span><span class="pun" style="color: #666600;">=</span><span class="pln" style="color: #000000;"> </span><span class="kwd" style="color: #000088;">new</span><span class="pln" style="color: #000000;"> sn_ws</span><span class="pun" style="color: #666600;">.</span><span class="typ" style="color: #660066;">RESTMessageV2</span><span class="pun" style="color: #666600;">(</span><span class="str" style="color: #008800;">"Yahoo Finance"</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: #000000;"> </span><span class="str" style="color: #008800;">"get"</span><span class="pun" style="color: #666600;">);</span><span class="pln" style="color: #000000;">   </span><span class="com" style="color: #880000;">// Might throw exception if message doesn't exist or not visible due to scope.</span><span class="pln" style="color: #000000;"><br/> sm</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">setBasicAuth</span><span class="pun" style="color: #666600;">(</span><span class="str" style="color: #008800;">"admin"</span><span class="pun" style="color: #666600;">,</span><span class="str" style="color: #008800;">"admin"</span><span class="pun" style="color: #666600;">);</span><span class="pln" style="color: #000000;"><br/> sm</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">setStringParameter</span><span class="pun" style="color: #666600;">(</span><span class="str" style="color: #008800;">"symbol"</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: #000000;"> </span><span class="str" style="color: #008800;">"NOW"</span><span class="pun" style="color: #666600;">);</span><span class="pln" style="color: #000000;"><br/> sm</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">setStringParameterNoEscape</span><span class="pun" style="color: #666600;">(</span><span class="str" style="color: #008800;">"xml_data"</span><span class="pun" style="color: #666600;">,</span><span class="str" style="color: #008800;">"&lt;data&gt;test&lt;/data&gt;"</span><span class="pun" style="color: #666600;">);</span><span class="pln" style="color: #000000;"><br/> response </span><span class="pun" style="color: #666600;">=</span><span class="pln" style="color: #000000;"> sm</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">executeAsync</span><span class="pun" style="color: #666600;">();</span><span class="pln" style="color: #000000;"> </span><span class="com" style="color: #880000;">//Might throw exception if http connection timed out or some issue with sending request itself because of encryption/decryption of password.</span><span class="pln" style="color: #000000;"><br/><br/> response</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">waitForResponse</span><span class="pun" style="color: #666600;">(</span><span class="lit" style="color: #006666;">60</span><span class="pun" style="color: #666600;">);</span><span class="com" style="color: #880000;">// In seconds. Wait at most 60 seconds to get response from ECC Queue/Mid Server //Might throw exception timing out waiting for response in ECC queue.</span><span class="pln" style="color: #000000;"><br/><br/> responseBody </span><span class="pun" style="color: #666600;">=</span><span class="pln" style="color: #000000;"> response</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">haveError</span><span class="pun" style="color: #666600;">()</span><span class="pln" style="color: #000000;"> </span><span class="pun" style="color: #666600;">?</span><span class="pln" style="color: #000000;"> response</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">getErrorMessage</span><span class="pun" style="color: #666600;">()</span><span class="pln" style="color: #000000;"> </span><span class="pun" style="color: #666600;">:</span><span class="pln" style="color: #000000;"> response</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">getBody</span><span class="pun" style="color: #666600;">();</span><span class="pln" style="color: #000000;"><br/> status </span><span class="pun" style="color: #666600;">=</span><span class="pln" style="color: #000000;"> response</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">getStatusCode</span><span class="pun" style="color: #666600;">();</span><span class="pln" style="color: #000000;"><br/></span><span class="pun" style="color: #666600;">}</span><span class="pln" style="color: #000000;"> </span><span class="kwd" style="color: #000088;">catch</span><span class="pun" style="color: #666600;">(</span><span class="pln" style="color: #000000;">ex</span><span class="pun" style="color: #666600;">)</span><span class="pln" style="color: #000000;"> </span><span class="pun" style="color: #666600;">{</span><span class="pln" style="color: #000000;"><br/> responseBody </span><span class="pun" style="color: #666600;">=</span><span class="pln" style="color: #000000;"> ex</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">getMessage</span><span class="pun" style="color: #666600;">();</span><span class="pln" style="color: #000000;"><br/> status </span><span class="pun" style="color: #666600;">=</span><span class="pln" style="color: #000000;"> </span><span class="str" style="color: #008800;">'500'</span><span class="pun" style="color: #666600;">;</span><span class="pln" style="color: #000000;"><br/></span><span class="pun" style="color: #666600;">}</span><span class="pln" style="color: #000000;"> </span><span class="kwd" style="color: #000088;">finally</span><span class="pln" style="color: #000000;"> </span><span class="pun" style="color: #666600;">{</span><span class="pln" style="color: #000000;"><br/> requestBody </span><span class="pun" style="color: #666600;">=</span><span class="pln" style="color: #000000;"> sm </span><span class="pun" style="color: #666600;">?</span><span class="pln" style="color: #000000;"> sm</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">getRequestBody</span><span class="pun" style="color: #666600;">():</span><span class="kwd" style="color: #000088;">null</span><span class="pun" style="color: #666600;">;</span><span class="pln" style="color: #000000;"><br/></span><span class="pun" style="color: #666600;">}</span><span class="pln" style="color: #000000;"><br/>gs</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">log</span><span class="pun" style="color: #666600;">(</span><span class="str" style="color: #008800;">"Request Body: "</span><span class="pln" style="color: #000000;"> </span><span class="pun" style="color: #666600;">+</span><span class="pln" style="color: #000000;"> requestBody</span><span class="pun" style="color: #666600;">);</span><span class="pln" style="color: #000000;"><br/>gs</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">log</span><span class="pun" style="color: #666600;">(</span><span class="str" style="color: #008800;">"Response: "</span><span class="pln" style="color: #000000;"> </span><span class="pun" style="color: #666600;">+</span><span class="pln" style="color: #000000;"> responseBody</span><span class="pun" style="color: #666600;">);</span><span class="pln" style="color: #000000;"><br/>gs</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">log</span><span class="pun" style="color: #666600;">(</span><span class="str" style="color: #008800;">"HTTP Status: "</span><span class="pln" style="color: #000000;"> </span><span class="pun" style="color: #666600;">+</span><span class="pln" style="color: #000000;"> status</span><span class="pun" style="color: #666600;">);</span></p></pre><p></p><p>Notice the 10th line of this example:     <strong><span class="pln" style="color: #000000;">response </span><span class="pun" style="color: #666600;">=</span><span class="pln" style="color: #000000;"> sm</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">executeAsync</span><span class="pun" style="color: #666600;">()</span></strong></p><p><span class="pun" style="color: #666600;"><span style="color: #303030;">If this was</span> <strong><span class="pln" style="color: #000000;">response </span><span class="pun" style="color: #666600;">=</span><span class="pln" style="color: #000000;"> sm</span><span class="pun" style="color: #666600;">.</span><span class="pln" style="color: #000000;">execute</span><span class="pun" style="color: #666600;">() </span></strong><span class="pun" style="color: #303030;">then the request would not go through the ECC queue, and the retry policy could not be used.</span></span></p><p></p><p>I have created a "fix script" with this code, so I can easily execute it when I want, and can make quick changes to it.   It could also be executed through "scripts - background".</p><p>After executing the script, the response message is placed in the ECC queue as an "input" message that is in "Response to" the "REST Probe" (outbound REST Message).</p><p></p><p style="text-align: center;"><img   alt="ECC_Response_good.jpg" class="image-5 jive-image" src="9e995ccadb945344e9737a9e0f9619d5.iix" style="width: 620px; height: 262px;"/></p><p></p><p>This example was successful, but now, it it time to break something.   Notice we added a new statement to change the endpoint</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_14959929956116601 jive_macro_code jive_text_macro" data-renderedposition="1142.4306640625_7.986111640930176_1174_109" jivemacro_uid="_14959929956116601"><p>try{</p><p>   sm = new sn_ws.RESTMessageV2("Yahoo Finance", "get");   // Might throw exception if message doesn't exist or not visible due to scope.</p><p>   sm.setBasicAuth("admin","admin");</p><p>   sm.setStringParameter("symbol", "NOW");</p><p>   sm.setStringParameterNoEscape("xml_data","&lt;data&gt;test&lt;/data&gt;");</p><p><span>   sm.setEndpoint("</span><a title="" _jive_internal="true" href="http://not_valid.com" rel="nofollow" target="_blank">http://not_valid.com</a><span>");   //Clearly, this is not a valid endpoint, so we should get an exception</span></p><p>   response = sm.executeAsync(); //Might throw exception if http connection timed out or some issue with sending request itself because of encryption/decryption of password.</p></pre><p>Notice we added a new statement to change the endpoint.</p><p></p><p>When I execute the fix script again (with the invalid endpoint), we get a different response in the ECC queue:</p><p style="text-align: center;"><img   alt="ECC_retry_failed.jpg" class="image-6 jive-image" src="6e7e7b7ddb141304b322f4621f9619a9.iix" style="width: 620px; height: 161px;"/></p><p></p><p>Using this failed response, we can create an ECC Retry Policy:</p><p style="text-align: center;"><img   alt="ECC_Retry_Condition.jpg" class="image-7 jive-image" src="1d952946db9c130468c1fb651f96193e.iix" style="width: 620px; height: 184px;"/></p><p></p><p>After testing the script with the "retry policy" now in place, we can check the ECC's   "Queue Retry Activity" module.</p><p>This shows us that the failed REST message was retried 3 additional times.   After it failed for the 3 retry, it was marked as "Failed" and no additional reties happened.</p><p style="text-align: center;"><img   alt="ECC+Retry+Activity.jpg" class="image-8 jive-image" src="90344d42db90130468c1fb651f9619d1.iix" style="width: 620px; height: 82px;"/></p><p></p><p></p><p></p><p>To summarize, ServiceNow has the capability to retry actions that are placed in the ECC queue.   This typically is used for SOAP and REST outbound web service calls.   Web Service endpoints may be unavailable for a number of reasons, so having a way to automatically retry those calls a few times can be the best way to handle these faults.   Since the ECC queue is used for asynchronous communication, the platform can send the same request multiple times, to facilitate the retry.   As the administrator, you can be very clear about which failures you want to retry, how many times you want to retry, and how long you want to wait after a failure is returned before you send the next request.</p>