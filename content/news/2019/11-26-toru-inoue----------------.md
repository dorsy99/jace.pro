---
title: ""
date: 2019-11-25T07:28:37.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=1943d54edb154c94feb1a851ca961997"
---
<p><em>※本記事は、ServiceNowのパートナー様より寄稿いただいたものをServiceNow社員が代理で投稿しています</em></p>
<p> </p>
<p>&#xff1d;&#xff1d;&#xff1d;</p>
<p>皆さんこんにちは&#xff01;</p>
<p>コムチュア株式会社です&#xff01;</p>
<p> </p>
<p>初投稿ということもあり、皆様のお役に立てればと気合を入れて書いていきたいと思います&#xff01;</p>
<p>今回は「要求アイテムに関する承認依頼通知」についてご紹介します。</p>
<p> </p>
<ol><li><strong>概要</strong></li></ol>
<p>カタログを使ったリクエスト機能、とっても便利ですよね。</p>
<p>カタログアイテムは簡単に作れますし、リクエストと承認プロセスも既存のものが優秀で使いやすい。</p>
<p>この機能を使った要件の中では、「複数のカタログアイテムを使い、リクエストがあった時や承認された時に、メール通知を申請者や承認者に送りたい」なんてことがよくあると思います。</p>
<p>とーっても便利な機能ですが、ひとたびいじりだすと&#xff11;つのカタログとそれに付随する変数、リクエスト、承認、ビジネスルール、そしてメール通知…</p>
<p>設定するものも多くて正直大変…</p>
<p>本日はその中でも複雑なビジネスルールとメール通知の作成についてのコラムをご紹介します。</p>
<p>題しまして、「カタログアイテムが増えても大丈夫&#xff01;意外と簡単な承認通知ルール作成」です&#xff01;</p>
<p>  </p>
<ol start="2"><li><strong>実装説明</strong></li></ol>
<p>今回のやりたいことは以下の&#xff12;点です。</p>
<p>・カタログアイテムからリクエストをした時に、承認者にメール通知を送信したい。</p>
<p>・メール通知の内容には要求アイテムの内容(価格など)も入れたい。</p>
<p>わりと要件としてよくありそうな内容です。</p>
<p> </p>
<p>大まかな実装の流れとしては、</p>
<p>①ビジネスルールで、メールに要求アイテムの情報を渡してイベントを発報する<br />②イベント発生時起点のメール通知を作る</p>
<p>以上です&#xff01;</p>
<p>なんだか簡単にできそうな気がしてきますね&#xff01;</p>
<p> </p>
<p>では早速説明に入っていきます。</p>
<p>※作業の前に、あらかじめイベントを作っておいてください</p>
<p> </p>
<p><u>①ビジネスルールで、メールに要求アイテムの情報を渡してイベントを発報する</u></p>
<p>まずは複数承認のためにビジネスルールを改修します。</p>
<p>今回は要求アイテム&#xff08;sc_req_item&#xff09;に対する承認イベントなので、改修するビジネスルールは標準設定の「Approval Events (Task)」です。</p>
<p> </p>
<p>①-1.もとからあるスクリプトを参考に、</p>
<p>レコードが要求アイテムテーブルのものであるかを判定するスクリプトを付け加えます。</p>
<p>&#xff08;オレンジ枠で囲んである部分が追加箇所です&#xff09;</p>
<p><img style="max-width: 100%; max-height: 480px;" src="https://community.servicenow.com/9a52558adb154c94feb1a851ca96196b.iix" /> </p>
<p>①-2.次に①-1に当てはまった時にイベントを発信するスクリプトを書き加えます。</p>
<p>こちらももとからあるスクリプトを参考にしています。</p>
<p>(イベントに関しては、メンテナンス性などを考慮し、プロパティに外出しで設定して</p>
<p>それを呼び出す形をとっています)</p>
<p><img style="max-width: 100%; max-height: 480px;" src="https://community.servicenow.com/03821d4adb154c94feb1a851ca961911.iix" /></p>
<p><span style="color: #ff0000;"><strong>今回のポイント</strong></span></p>
<p>ズバリ赤線で囲んであるところ、その中でも特に</p>
<p>var gr &#61; new GlideRecord(table);</p>
<p>です&#xff01;</p>
<p>これ、承認対象の要求アイテムレコードを指しています。</p>
<p>このレコードをメール通知に渡すと、メールの件名や本文を作る時に、</p>
<p>要求アイテムの情報を埋め込めるようになるのです&#xff01;</p>
<p>また後ほど説明しますね。</p>
<p> </p>
<p>ビジネスルール改修はこれでおしまいです。</p>
<p>元のビジネスルール自体の拡張性が高いため、ほとんど真似っ子で済みました。</p>
<p>簡単&#xff01;</p>
<p>ちなみにビジネスルールに出てきたイベントとプロパティの設定はこんな感じです。</p>
<p> <img style="max-width: 100%; max-height: 480px;" src="https://community.servicenow.com/6754910adb554c94feb1a851ca961964.iix" /></p>
<p> <img style="max-width: 100%; max-height: 480px;" src="https://community.servicenow.com/1b64990adb554c94feb1a851ca9619a5.iix" /></p>
<p><u>②イベント発生時起点のメール通知を作る</u></p>
<p>ではメール通知作成です。</p>
<p>承認依頼通知なので、普通なら承認ステータス(sysapproval_approver)テーブルに対して</p>
<p>作ることになりますが、</p>
<p>それだとカタログアイテムごとに通知を分けたい場合や、要求レコードの内容をメール本文に引用するには</p>
<p>設定が面倒ですよね。</p>
<p> </p>
<p>なので今回は要求アイテムテーブルに通知を作っていきます。</p>
<p>　要求アイテムテーブルなら、ConditionsでItemが選べるので</p>
<p><img style="max-width: 100%; max-height: 480px;" src="https://community.servicenow.com/ce94d14adb554c94feb1a851ca961996.iix" /></p>
<p><br /> 拡張性を考えても非常に有用ですね。</p>
<p>受信者設定もとっても簡単です。</p>
<p>先ほどのビジネスルールの81行目でイベントの第&#xff11;パラメータに承認者の情報を渡しているので、</p>
<p>Event parm 1 contains recipientにチェックを入れるだけでOK&#xff01;</p>
<p> </p>
<p>メール本文に要求アイテムの内容を記載するには、先ほどの<span style="color: #ff0000;"><strong>ポイント</strong></span>が効いてきます。</p>
<p>要求アイテムのレコードをメール通知に渡しているので、</p>
<p>必要な情報をSelect variablesから選べば引用が可能です&#xff01;</p>
<p><img style="max-width: 100%; max-height: 480px;" src="https://community.servicenow.com/ccb4158adb554c94feb1a851ca9619e0.iix" /><br /> </p>
<p><img style="max-width: 100%; max-height: 480px;" src="https://community.servicenow.com/cac4198adb554c94feb1a851ca961917.iix" /></p>
<p>これで全工程終了です&#xff01;</p>
<p>ほぼコピー&#xff06;ペーストのスクリプトで、</p>
<p>・要求アイテムの内容をメール本文に引用できる</p>
<p>・どれだけカタログアイテムが増えても通知修正が簡単</p>
<p>なシステムができましたね&#xff01;&#xff01;</p>
<p> </p>
<ol start="3"><li><strong>メリットと事例紹介</strong></li></ol>
<p><strong>これを知っていると私たちエンジニア目線では、こんな時に楽&#xff01;</strong></p>
<p>・<u>承認に関わる通知を作りたい時</u></p>
<p style="padding-left: 30px;">今回は要求アイテムについてお話ししましたが、</p>
<p style="padding-left: 30px;">&#xff12;.実装説明で説明した手順を用いることで、</p>
<p style="padding-left: 30px;">タスクテーブルを拡張した他のテーブルに対しての承認通知作成も簡単になります。</p>
<p>・<u>カタログアイテムが増えた時</u></p>
<p style="padding-left: 30px;">要求アイテムの情報はイベント発報時にメール通知に渡すので</p>
<p style="padding-left: 30px;">通知のConditionsでitemを選ぶだけで、</p>
<p style="padding-left: 30px;">カタログアイテムごとのメール通知を作ることができます。</p>
<p> </p>
<p><strong>また、これをやっておくとお客様目線ではこんなメリットが&#xff01;</strong></p>
<p><u>・カスタマイズ不要で、設定ベースで拡張できる&#xff01;</u></p>
<p style="padding-left: 30px;">お客様自身で運用していくと、カタログアイテムの追加は必ず発生するでしょう。</p>
<p style="padding-left: 30px;">この実装はお客様自身による開発が不要になり、設定ベースでメール通知を行えるようになります。</p>
<p> </p>
<p>他にもCSMのセルフレジストレーションや、</p>
<p>ITSMの変更管理などでも応用ができます。</p>
<p>ぜひいろいろ拡張してみてください&#xff01;</p>
<p> </p>
<p><strong>&#xff14;&#xff0e;終わりに</strong></p>
<p>いかがでしたでしょうか&#xff1f;</p>
<p>拙い記事ではありますが、少しでもこの記事をご覧いただいた方の参考になれば幸いです。</p>
<p>ここまでお付き合いいただきありがとうございました&#xff01;</p>
<p> </p>