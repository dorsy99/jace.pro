---
title: "Programatically importing users from external apps and adding them to groups"
date: 2014-06-06T04:02:04.000Z
authors: ["yjaques"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=fd2d66e5dbd0dbc01dcaf3231f961984"
---
<p>One thing I was recently tasked with was programatically importing users from external apps, comparing them to the users we have in the system (which all come from our LDAP anyway) and adding them to groups. The idea is that this way we can more easily see who is affected if we need to have some downtime on a CI. Turns out it's not too difficult. Below are the steps I followed to do this:</p><p></p><p>1. Create a Data Source from the Administration area of the System Import Sets menu. Ideally, you have the SQL plugin enabled and a MID server running on your infrastructure so that you can simply write an SQL query against the user table for the app in question. That's what I did. This means that you have a data source item that whenever you run it you're getting a fresh vision of the app's users. It's important that you are importing a user id that you will be able to compare to the id of the users in Servicew Now.</p><p></p><p>2. Go ahead and Load Data from the System Import Sets menu. This will create an Import Set table which you need in order to keep going forward (the process is not terribly intuitive).</p><p></p><p>3. Create a Transform Map that has your Import Set table as the source and the Group Member [sys_user_grmember] table as the target. In this transform map is where I had to do most of the lifting. Below is the script I put in in order to find the group and the user and the group member tables and add users as needed:</p><p></p><p><span style="font-size: 10pt; line-height: 1.5em;">//the user group </span><span class="base_lang_reserved" style="font-size: 10pt; line-height: 1.5em;">for</span><span style="font-size: 10pt; line-height: 1.5em;"> the application </span></p><p><span class="base_lang_reserved">var</span> group = <span class="base_lang_string">"Nexams"</span>;</p><p><span class="base_lang_comments">//the user id from the source table import</span></p><p><span class="base_lang_reserved">var</span> uid = source.u_user_id.<span class="base_lang_special">toString</span>();</p><p><span class="base_lang_comments">//get the system id <span class="base_lang_reserved">for</span> the user from service now</span></p><p><span class="base_lang_reserved">var</span> user_sys_id = getUserSysId(uid);</p><p><span class="base_lang_comments">//<span class="base_lang_reserved">if</span> no user in service now we stop</span></p><p><span class="base_lang_reserved">if</span>(user_sys_id == <span class="base_lang_reserved">null</span>) {</p><p>log.error(<span class="base_lang_string">"No user found. No one to add to group. Exiting"</span>);</p><p>} <span class="base_lang_reserved">else</span> {</p><p><span class="base_lang_comments">//get or create the group</span></p><p><span class="base_lang_reserved">var</span> group_sys_id = getGroupSysId(group);</p><p><span class="base_lang_comments">//check <span class="base_lang_reserved">if</span> the user us already a member</span></p><p><span class="base_lang_reserved">if</span>(!isMember(group_sys_id,user_sys_id)) {</p><p>log.info(<span class="base_lang_string">"Adding user member to group."</span>);</p><p><span class="base_lang_comments">//<span class="base_lang_reserved">if</span> user is not a member we create a <span class="base_lang_reserved">new</span> record</span></p><p><span class="base_lang_reserved">if</span>(setMember(group_sys_id,user_sys_id)) {</p><p>log.info(<span class="base_lang_string">"Done adding member."</span>);</p><p></p><p>}</p><p>}</p><p>}</p><p></p><p><span class="base_lang_comments">//<span class="base_lang_reserved">for</span> each row to process from the import, get the user <span class="base_lang_special">name</span>, find the sys id from the user table</span></p><p><span class="base_lang_reserved">function</span> getUserSysId(uid) {</p><p><span class="base_lang_reserved">var</span> userRecord = <span class="base_lang_reserved">new</span> GlideRecord(<span class="base_lang_string">"sys_user"</span>);</p><p>userRecord.addQuery(<span class="base_lang_string">'user_name'</span>, uid);</p><p>userRecord.query();</p><p><span class="base_lang_reserved">while</span> (userRecord.next()) {</p><p>log.info(<span class="base_lang_string">"Found user: "</span> + userRecord.user_name);</p><p><span class="base_lang_reserved">return</span> userRecord.sys_id;</p><p>}</p><p><span class="base_lang_comments">//no user found in LDAP</span></p><p>log.error(<span class="base_lang_string">"No user found. Check LDAP!"</span>);</p><p><span class="base_lang_reserved">return</span> <span class="base_lang_reserved">null</span>;</p><p>}</p><p></p><p><span class="base_lang_reserved">function</span> getGroupSysId(group) {</p><p><span class="base_lang_reserved">var</span> groupRecord = <span class="base_lang_reserved">new</span> GlideRecord(<span class="base_lang_string">"sys_user_group"</span>);</p><p>groupRecord.addQuery(<span class="base_lang_string">'<span class="base_lang_special">name</span>'</span>, group);</p><p>groupRecord.query();</p><p><span class="base_lang_reserved">while</span> (groupRecord.next()) {</p><p>log.info(<span class="base_lang_string">"Found group: "</span> + groupRecord.getDisplayValue());</p><p><span class="base_lang_reserved">return</span> groupRecord.sys_id;</p><p>}</p><p><span class="base_lang_comments">//group doesn<span class="base_lang_string">"t exist so create it</span><br/></span> log.warn(<span class="base_lang_string">"No existing group found. Creating one."</span>);</p><p>groupRecord.initialize();</p><p>groupRecord.<span class="base_lang_special">name</span> = group;</p><p><span class="base_lang_reserved">var</span> group_sys_id = groupRecord.insert();</p><p><span class="base_lang_reserved">if</span> (group_sys_id != <span class="base_lang_reserved">null</span>) {</p><p>log.info(<span class="base_lang_string">"Created <span class="base_lang_reserved">new</span> group: "</span> + group_sys_id);</p><p><span class="base_lang_reserved">return</span> group_sys_id;</p><p>} <span class="base_lang_reserved">else</span> {</p><p>log.error(<span class="base_lang_string">"Failed to create <span class="base_lang_reserved">new</span> group!"</span>);</p><p><span class="base_lang_reserved">return</span> <span class="base_lang_reserved">null</span>;</p><p>}</p><p>}</p><p></p><p><span class="base_lang_comments">// now see <span class="base_lang_reserved">if</span> the user is in the group table</span></p><p><span class="base_lang_reserved">function</span> isMember(group_sys_id, user_sys_id) {</p><p><span class="base_lang_reserved">var</span> groupUserRecord = <span class="base_lang_reserved">new</span> GlideRecord(<span class="base_lang_string">"sys_user_grmember"</span>);</p><p>groupUserRecord.addQuery(<span class="base_lang_string">'group'</span>, group_sys_id);</p><p>groupUserRecord.addQuery(<span class="base_lang_string">'user'</span>, user_sys_id);</p><p>groupUserRecord.query();</p><p><span class="base_lang_reserved">while</span> (groupUserRecord.next()) {</p><p>userInGroup = <span class="base_lang_reserved">true</span>;</p><p>log.info(<span class="base_lang_string">"Found User as a Group member."</span>);</p><p><span class="base_lang_reserved">return</span> <span class="base_lang_reserved">true</span></p><p>}</p><p>log.warn(<span class="base_lang_string">"User not found as group member."</span>);</p><p><span class="base_lang_reserved">return</span> <span class="base_lang_reserved">false</span>;</p><p>}</p><p></p><p><span class="base_lang_comments">//user in group doesn<span class="base_lang_string">"t exist so create it</span><br/></span><span class="base_lang_reserved">function</span> setMember(group_sys_id, user_sys_id) {</p><p><span class="base_lang_reserved">var</span> groupUserRecord = <span class="base_lang_reserved">new</span> GlideRecord(<span class="base_lang_string">"sys_user_grmember"</span>);</p><p>groupUserRecord.initialize();</p><p>groupUserRecord.group = group_sys_id;</p><p>groupUserRecord.user = user_sys_id;</p><p><span class="base_lang_reserved">if</span> (groupUserRecord.insert() != <span class="base_lang_reserved">null</span>) {</p><p>   gs.addInfoMessage(<span class="base_lang_string">"Successfully added user as group member."</span>);</p><p>     <span class="base_lang_reserved">return</span> <span class="base_lang_reserved">true</span>;</p><p>   }</p><p>   gs.addInfoMessage(<span class="base_lang_string">"Failed to add user to group!"</span>);</p><p>     <span class="base_lang_reserved">return</span> <span class="base_lang_reserved">false</span>;</p><p>}</p><p></p><p>============================================================</p><p>4. The final step is to create a Scheduled Import from the same System Import Sets menu. In this Scheduled Import which you can run as often as you like (I chose weekly) you can specify it to run a pre-import script. This is necessary so that you can wipe the group member table clean before you reload it. My script looks like this:</p><p></p><p>//get the system id of the group and if it doesn"t exist create it</p><p>//if it does exist empty it.</p><p>var group = "Nexams";</p><p></p><p></p><p>//get or create the group</p><p>var group_sys_id = getGroupSysId(group);</p><p>if (group_sys_id != null) {</p><p>   emptyTable(group_sys_id);</p><p>}</p><p></p><p></p><p>function getGroupSysId(group) {</p><p>   var groupRecord = new GlideRecord("sys_user_group");</p><p>   groupRecord.addQuery('name', group);</p><p>   groupRecord.query();</p><p>   while (groupRecord.next()) {</p><p>   log.info("Found group: " + groupRecord.getDisplayValue());</p><p>   return groupRecord.sys_id;</p><p>   }</p><p>   //group doesn"t exist so create it</p><p>   log.warn("No existing group found. Creating one.");</p><p>   groupRecord.initialize();</p><p>   groupRecord.name = group;</p><p>   var group_sys_id = groupRecord.insert();</p><p>   if (group_sys_id != null) {</p><p>   log.info("Created new group: " + group_sys_id);</p><p>   return group_sys_id;</p><p>   } else {</p><p>   log.error("Failed to create new group!");</p><p>   return null;</p><p>   }</p><p>}</p><p></p><p></p><p>// now empty the group member table</p><p>function emptyTable(group_sys_id) {</p><p>   var failCount = 0;</p><p>   var groupUserRecord = new GlideRecord("sys_user_grmember");</p><p>   groupUserRecord.addQuery('group', group_sys_id);</p><p>   groupUserRecord.query();</p><p>   while (groupUserRecord.next()) {</p><p>   if (!groupUserRecord.deleteRecord()) {</p><p>   failCount++;</p><p>   }</p><p>   }</p><p>   if (failCount &gt; 0) {</p><p>   log.warn("Failed to delete " + failCount + " rows.");</p><p></p><p>   }</p><p>}</p><p>==============================================================</p><p>Well that's about it. The next step I plan to do is to associate the group to the application CI. That should be easy. Then it's time to look into the reporting. Cheers!</p>