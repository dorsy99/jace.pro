---
title: "Geo Locating for Latitude and Longitude"
date: 2014-07-03T21:25:10.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=8b2e2a6ddbd0dbc01dcaf3231f9619e6"
---
<p style="font-size: 12.727272033691406px; font-family: arial, sans-serif; color: #666666;">I found myself with about a 1000 locations in the cmn_location table of which only about a 100 had lat long. I tried the get_lat_long business rule but it didn't work (I think it's based on a dead Google service.) After poking around a bit I found a way to update them using a background script which you can also use with a bit of modification to fix the get_lat_long business rule. The main issue is that you MUST have a MID Server and set up a REST client on it. If you try and run any of the public APIs for geolocation you will find that the usage limits have been totally exceeded since your running on a Service Now instance that's shared with lots of other people. The MID server however is running on your local network and that makes all the difference. So how does this work?</p><p style="font-size: 12.727272033691406px; font-family: arial, sans-serif; color: #666666;"></p><p style="font-size: 12.727272033691406px; font-family: arial, sans-serif; color: #666666;">1. Set up a Rest service using the Rest Message functionality of Service Now with an endpoint of<a title="k-external-small" class="jive-link-external-small" href="https://maps.googleapis.com/maps/api/geocode/json" rel="nofollow" style="font-weight: inherit; font-style: inherit; font-family: inherit; color: #000000;" target="_blank">https://maps.googleapis.com/maps/api/geocode/json</a>. It should look like this:</p><p style="font-size: 12.727272033691406px; font-family: arial, sans-serif; color: #666666;"><a _jive_internal="true" href="/servlet/JiveServlet/showImage/38-3222-11469/rest_client.png" style="font-weight: inherit; font-style: inherit; font-family: inherit; color: #000000;"><img  alt="rest_client.png" class="image-0 jive-image jiveImage" height="402" src="d36d7fb9db185704ed6af3231f961912.iix" style="border: 0px; font-weight: inherit; font-style: inherit; font-family: inherit;" width="1207"/></a></p><p style="font-size: 12.727272033691406px; font-family: arial, sans-serif; color: #666666;">2. Run this background script, adjusting the J variable to do as many records as you want at a time (I did them in batches of 100 to not tie up the server for too long as each lookup takes 3-15 seconds). Anytime it fails it will mark the lat_long_error field and skip the record the following pass:</p><p>var loc = new GlideRecord('cmn_location');</p><p></p><p>// Issue the query to the database to get all records</p><p>loc.query();</p><p>var j=0;     </p><p>while (loc.next()) {</p><p>         if(loc.lat_long_error != "true" &amp;&amp; (loc.latitude=="" || loc.longitude=="")) {</p><p>                   if(updateLatLong(loc)) {</p><p>                             gs.log("Updated: "+loc.name);</p><p>                   } else {</p><p>                             gs.log("Failed to update: "+loc.name);</p><p>                   }</p><p>                   //only process 100 records</p><p>                   if (j&lt;100)</p><p>                             j++;</p><p>                   else</p><p>                             break;</p><p>         }</p><p>}</p><p></p><p></p><p>function updateLatLong(loc) {</p><p>         if(loc.city != "") {</p><p>                   var address = new String(loc.city);</p><p>         } else {</p><p>                   var address = new String(loc.name);</p><p>         }</p><p>         if(loc.country != "") {</p><p>                   address+= ("," + loc.country);</p><p>         }</p><p>         gs.log("requesting address:"+address);</p><p>         //get the Rest Message service</p><p>         var r = new RESTMessage('Google GeoLocate', 'get');</p><p>         r.setStringParameter('address',address);</p><p>         var response = r.execute();</p><p>         </p><p>         // put in a a wait or it will return undefined</p><p>         var k = 1;</p><p>         while ( response == null ) {</p><p>                   response = r.getResponse( 1000 );</p><p>                   k++;</p><p>                   if ( k &gt; 30 ) {</p><p>                             gs.log( 'service time-out' );</p><p>                             break;</p><p>                   }</p><p>         }</p><p>         gs.log( "response took ... " + k + " seconds");</p><p>         //parse response</p><p>         var parser = new JSONParser();</p><p>         var parsed = parser.parse(response.getBody());</p><p>         if(parsed != null &amp;&amp; typeof(parsed) != undefined) {</p><p>                   loc.latitude = parsed.results[0].geometry.location.lat;</p><p>                   loc.longitude = parsed.results[0].geometry.location.lng;</p><p>                   </p><p>                   var g_address = parsed.results[0].address_components;                   </p><p>                   for(var m=0;m&lt;g_address.length;m++) {                             </p><p>                             for(var n=0;n&lt;g_address[m].types.length;n++) {                                       </p><p>                                       if (g_address[m].types[n] == "country") {</p><p>                                                 loc.country = g_address[m].short_name;</p><p>                                       }</p><p>                             }</p><p>                   }</p><p>         } else {</p><p>                   gs.log("Problem with returned JSON");         </p><p>         }</p><p>         //update record on change</p><p>         if (loc.latitude.changes() || loc.longitude.changes()) {</p><p>                   loc.update();</p><p>                   return true;</p><p>         } else {</p><p>                   loc.lat_long_error = "true"; </p><p>                   loc.update();</p><p>                   return false;</p><p>         }</p><p>}</p>