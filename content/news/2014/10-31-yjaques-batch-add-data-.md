---
title: "Batch add Data Sources Transform Maps and Scheduled Imports"
date: 2014-10-30T19:53:10.000Z
authors: ["yjaques"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=db7da269dbd0dbc01dcaf3231f9619f5"
---
<p>I was asked to create user groups for about 50 of our applications. The requirement was to access on a daily basis the user IDs in the various DB tables used by these applications and update a set of groups in ServiceNow, each one being attached to a CI. In this way, using CI upstream and downstream relationships we can tell exactly how many users might be impacted from a change request, thus helping us to decide whether a change needs to be considered Normal or Standard in ITIL terms.</p><p></p><p>Of course I didn't want to do this all by hand, so I put a script together that iterates through a CI table and creates a Data Source, a Transform Map and a Scheduled Import for each CI. It still meant going back and doing some manual work as the database name was not always consistent, nor the SQL query that would get the list of user IDs, but once this whole important mechanism was created, it was just the work of a few hours to get the database names and queries configured. Here's the script I used. Note that I removed one piece, which is the script that is launched by the Transform Map that helps populate the user tables. You can find that script in another one of my blog posts: <a title="Programatically importing users from external apps and adding them to groups" __default_attr="3150" __jive_macro_name="blogpost" class="jive_macro jive_macro_blogpost" data-orig-content="Programatically importing users from external apps and adding them to groups" href="/community?id=community_blog&sys_id=fd2d66e5dbd0dbc01dcaf3231f961984">Programatically importing users from external apps and adding them to groups</a></p><p></p><p>Here's the script to create <span style="font-size: 13.63636302948px;">Data Sources, Transform Maps and Scheduled Imports (simply change the CI table to your CI table. And note that you can easily restrict the set of objects created by adding some parameters to the first query):</span></p><p></p><p>var gr = new GlideRecord('u_cmdb_ci_applications_web_jav'); //Indicate the table to query from</p><p>gr.query(); //Execute the query. you can add parameters here to filter the result set</p><p>while (gr.next()) { //While the recordset contains records, iterate through them</p><p>       var dsName = 'Users ' + gr.name;</p><p>       var dsTable = 'u_' + dsName.toLowerCase().replace(/ /g, '_');</p><p>       var dsId = createDataSource(dsName, dsTable, gr.name);</p><p>       if (dsId != null) {</p><p>               if (createTransformMap(dsName, dsTable, gr.name) != null) {</p><p>                       createScheduledImport(dsName, dsId);</p><p>               }</p><p>       }</p><p>}</p><p></p><p></p><p>function createDataSource(dsName, dsTable, grName) {</p><p>       var ds = new GlideRecord('sys_data_source'); //Indicate the table to query from</p><p>       ds.query('name', dsName); //Execute the query</p><p>       while (ds.next()) {</p><p>               //exists so just return sys_id and don't create new record</p><p>               return ds.sys_id;</p><p>       }</p><p>       ds.initialize();</p><p>       ds.name = dsName;</p><p>       ds.import_set_table_label = dsName;</p><p>       ds.import_set_table_name = dsTable;</p><p>       ds.type = "JDBC";</p><p>       ds.mid_server = '2aa0ed1b44cc11004e4f4c79f38a2a50'; //the sys_id of our mid server</p><p>       ds.database_name = grName;</p><p>       ds.jdbc_user_name = ''; //credentials</p><p>       ds.jdbc_password = ''; //credentials</p><p>       ds.jdbc_server = ''; //put your server url here</p><p>       ds.query = 'Specific SQL';</p><p>       ds.sql_statement = 'select distinct user_id from users'; //whatever SQL query you need</p><p></p><p></p><p>       var dsId = ds.insert();</p><p>       if (dsId != null) {</p><p>               gs.log("Added data source" + ds.name);</p><p>               return dsId;</p><p>       }</p><p>       return null;</p><p>}</p><p></p><p></p><p>function createScheduledImport(dsName, dsId) {</p><p>       var is = new GlideRecord('scheduled_import_set'); //Indicate the table to query from</p><p>       is.query('name', dsName); //Execute the query</p><p>       while (is.next()) { </p><p>               //exists so just return sys_id and don't create a new record</p><p>               return is.sys_id;</p><p>       }</p><p>       is.initialize();</p><p>       is.name = dsName;</p><p>       is.data_source = dsId;</p><p>       is.run_type = 'daily';</p><p>       is.run_as = '2d80600e785649003305f202b7c713ed';         //sys_id of user to run process as. must have appropriate rights</p><p></p><p></p><p>       var isId = is.insert();</p><p>       if (isId != null) {</p><p>               gs.log("Created scheduled import" + is.name);</p><p>               return true;</p><p>       }</p><p>       return false;</p><p>}</p><p></p><p></p><p>function createTransformMap(dsname, dsTable, grName) {</p><p>       var tm = new GlideRecord('sys_transform_map'); //Indicate the table to query from</p><p>       tm.query('name', dsName); //Execute the query</p><p>       while (tm.next()) {</p><p>               //exists so just return sys_id and don't create record</p><p>               return tm.sys_id;</p><p>       }</p><p>       tm.initialize();</p><p>       tm.name = dsName;</p><p>       tm.source_table = dsTable;</p><p>       tm.target_table = 'sys_user_grmember';</p><p>       tm.active = true;</p><p>       tm.run_business_rules = true;</p><p>       tm.enforce_mandatory_fields = 'No';</p><p>       tm.run_script = true;</p><p>       tm.script = ''; //put any script you need to process your data here</p><p></p><p></p><p>       var tmId = tm.insert();</p><p>       if (tmId != null) {</p><p>               gs.log("Added transform map" + tm.name);</p><p>               return tmId;</p><p>       }</p><p>       return null;</p><p>}</p>