---
title: "Custom Charts now working"
date: 2014-10-07T01:42:45.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=597dee29dbd0dbc01dcaf3231f96192a"
---
<p>I finally wrestled this to the ground and decided it is time to post my modest script for Custom Charts in the hope that someone can benefit:</p><p></p><p><span style="font-size: 18pt;"><strong>The Chart:</strong></span></p><p></p><p><img  alt="CustomChart01.png" class="image-0 jive-image" src="addd3779dbd4d3041dcaf3231f96191e.iix" style="height: auto;"/></p><p><strong style="font-size: 18pt;"><img  alt="CustomChart02.png" class="image-1 jive-image" height="153" src="cd97c18adb50d344e9737a9e0f961948.iix" style="height: 153px; width: 758.88px;" width="759"/><br/></strong></p><p><strong style="font-size: 18pt;"><br/></strong></p><p><strong style="font-size: 18pt;">The Script:</strong></p><p></p><p><span style="font-family: 'courier new', courier;">//gs.log('PP Test Script 010:   Start of script');</span></p><p></p><p><span style="font-family: 'courier new', courier;">//***************************************************************************************</span></p><p><span style="font-family: 'courier new', courier;">// </span></p><p><span style="font-family: 'courier new', courier;">// This script produces a stacked bar chart of incidents within SLA, Breached SLA and</span></p><p><span style="font-family: 'courier new', courier;">// Supplier Assigned tickets (breached and not-breached)</span></p><p><span style="font-family: 'courier new', courier;">//</span></p><p><span style="font-family: 'courier new', courier;">// Note:   some files are site specific (e.g. u_resolved_at - the DateTime the incident was resolved</span></p><p><span style="font-family: 'courier new', courier;">//</span></p><p><span style="font-family: 'courier new', courier;">// There are many quirks with jFree Chart support, Summary Sets, etc. that I couldn't figure out so</span></p><p><span style="font-family: 'courier new', courier;">// this represents a lot of trial and error but should give some pointers to using jFree Charts in Service Now</span></p><p><span style="font-family: 'courier new', courier;">//</span></p><p><span style="font-family: 'courier new', courier;">// Note:   all work was done in Eureka!</span></p><p><span style="font-family: 'courier new', courier;">//</span></p><p><span style="font-family: 'courier new', courier;">// Paul Plato - October 2014 - Toyota Motor Manufacturing Canada</span></p><p><span style="font-family: 'courier new', courier;">//</span></p><p><span style="font-family: 'courier new', courier;">// Feel free to use within Service Now but no guarantees are made on this script!</span></p><p><span style="font-family: 'courier new', courier;">//</span></p><p><span style="font-family: 'courier new', courier;">//***************************************************************************************</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// Define number of days to show on the report</span></p><p><span style="font-family: 'courier new', courier;">var num_days = 33;</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// lookup the sysid for Managed Print Service group</span></p><p><span style="font-family: 'courier new', courier;">var group_mps = new GlideRecord('sys_user_group');   </span></p><p><span style="font-family: 'courier new', courier;">group_mps.get('name', 'Managed Print Service');   </span></p><p><span style="font-family: 'courier new', courier;">var mps = group_mps.sys_id;</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// get today's date and force 08:15:00 time</span></p><p><span style="font-family: 'courier new', courier;">var today_815 = GlideDateTime();</span></p><p><span style="font-family: 'courier new', courier;">var today_date = today_815.getValue();</span></p><p><span style="font-family: 'courier new', courier;">var today_date_only = today_date.substr(0, 11);</span></p><p><span style="font-family: 'courier new', courier;">today_815.setDisplayValue(today_date_only + "08:15:00");</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// Get Number of Days to go back (days_to_report) days ago at 08:15:00</span></p><p><span style="font-family: 'courier new', courier;">var days_to_report = 0 - num_days;</span></p><p><span style="font-family: 'courier new', courier;">var days_ptr = GlideDateTime();</span></p><p><span style="font-family: 'courier new', courier;">days_ptr.setGlideDateTime(today_815);</span></p><p><span style="font-family: 'courier new', courier;">days_ptr.addDaysLocalTime(days_to_report);</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">//gs.log('PP Test Script 020:   Today           :   ' + today_815.getDisplayValue());</span></p><p><span style="font-family: 'courier new', courier;">//gs.log('PP Test Script 030:   ' + days_to_report + ' days ago:   ' + days_ptr.getDisplayValue());</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// create needed variables</span></p><p><span style="font-family: 'courier new', courier;">var count_ok = new GlideAggregate('incident');</span></p><p><span style="font-family: 'courier new', courier;">var count_nl = new GlideAggregate('incident');</span></p><p><span style="font-family: 'courier new', courier;">var count_ng = new GlideAggregate('task_sla');</span></p><p><span style="font-family: 'courier new', courier;">var count_sa = new GlideAggregate('incident');</span></p><p><span style="font-family: 'courier new', courier;">var inc = "incident";</span></p><p><span style="font-family: 'courier new', courier;">var this_datetime = ' ';</span></p><p><span style="font-family: 'courier new', courier;">var this_date = ' ';</span></p><p><span style="font-family: 'courier new', courier;">var incidents_all = 0;</span></p><p><span style="font-family: 'courier new', courier;">var incidents_ok = 0;</span></p><p><span style="font-family: 'courier new', courier;">var incidents_nl = 0;</span></p><p><span style="font-family: 'courier new', courier;">var incidents_ng = 0;</span></p><p><span style="font-family: 'courier new', courier;">var incidents_sa = 0;</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// To define a data set for the bar chart, we create an instance of type CategoryDataset.</span></p><p><span style="font-family: 'courier new', courier;">var dataset = new Packages.org.jfree.data.category.DefaultCategoryDataset();</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// Dummy up the target data for the target line</span></p><p><span style="font-family: 'courier new', courier;">var datatarg = new Packages.org.jfree.data.category.DefaultCategoryDataset();</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">for (var i = 0; i &lt; num_days; i++) {</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   // add one day</span></p><p><span style="font-family: 'courier new', courier;">   days_ptr.addDaysLocalTime(1);</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   // get just the date for the graph</span></p><p><span style="font-family: 'courier new', courier;">   this_datetime = days_ptr.getValue();</span></p><p><span style="font-family: 'courier new', courier;">   this_date = this_datetime.substr(0, 11);</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   // Get count of tickets opened before 8:15 and already resolved (unresolved at that time will be added later)</span></p><p><span style="font-family: 'courier new', courier;">   count_all = new GlideAggregate('incident');</span></p><p><span style="font-family: 'courier new', courier;">   count_all.addQuery('opened_at', '&lt;', days_ptr);</span></p><p><span style="font-family: 'courier new', courier;">   count_all.addQuery('u_resolved_at', '&gt;', days_ptr); </span></p><p><span style="font-family: 'courier new', courier;">   count_all.addQuery('assignment_group', '!=', mps);           // exclude "Supplier Assigned" tickets</span></p><p><span style="font-family: 'courier new', courier;">   count_all.addAggregate('COUNT');</span></p><p><span style="font-family: 'courier new', courier;">   count_all.query();</span></p><p><span style="font-family: 'courier new', courier;">   incidents_all = 0;</span></p><p><span style="font-family: 'courier new', courier;">   if (count_all.next()) </span></p><p><span style="font-family: 'courier new', courier;">         incidents_all = count_all.getTotal('COUNT')</span></p><p><span style="font-family: 'courier new', courier;">   else</span></p><p><span style="font-family: 'courier new', courier;">         incidents_all = 0;</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   // Get count of tickets open at 8:15 of that day not yet resolved (u_resolved_at is NULL, only include active ones</span></p><p><span style="font-family: 'courier new', courier;">   // to exclude some old tickets that had this field blank</span></p><p><span style="font-family: 'courier new', courier;">   count_nl = new GlideAggregate('incident');</span></p><p><span style="font-family: 'courier new', courier;">   count_nl.addQuery('opened_at', '&lt;', days_ptr);</span></p><p><span style="font-family: 'courier new', courier;">   count_nl.addNullQuery('u_resolved_at');                             // Null u_resolved_at Date (Resolution Time)</span></p><p><span style="font-family: 'courier new', courier;">   count_nl.addActiveQuery();                                                       // only active ones!</span></p><p><span style="font-family: 'courier new', courier;">   count_nl.addQuery('assignment_group', '!=', mps);         // exclude "Supplier Assigned" tickets</span></p><p><span style="font-family: 'courier new', courier;">   count_nl.addAggregate('COUNT');</span></p><p><span style="font-family: 'courier new', courier;">   count_nl.query();</span></p><p><span style="font-family: 'courier new', courier;">   incidents_nl = 0;</span></p><p><span style="font-family: 'courier new', courier;">   if (count_nl.next()) </span></p><p><span style="font-family: 'courier new', courier;">         incidents_nl = count_nl.getTotal('COUNT')</span></p><p><span style="font-family: 'courier new', courier;">   else</span></p><p><span style="font-family: 'courier new', courier;">         incidents_nl = 0;</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   // Get count of tickets open at 8:15 of that day and HAVE breached</span></p><p><span style="font-family: 'courier new', courier;">   count_ng = new GlideAggregate('task_sla');</span></p><p><span style="font-family: 'courier new', courier;">   count_ng.addQuery('start_time', '&lt;', days_ptr);</span></p><p><span style="font-family: 'courier new', courier;">   count_ng.addQuery('end_time', '&gt;', days_ptr);</span></p><p><span style="font-family: 'courier new', courier;">   count_ng.addQuery('has_breached',true);</span></p><p><span style="font-family: 'courier new', courier;">   count_ng.addQuery('task.number', 'STARTSWITH','INC');                   // Only include Incidents from the TASK_SLA table</span></p><p><span style="font-family: 'courier new', courier;">   count_ng.addQuery('task.u_resolved_by_group','!=', mps);             // exclude "Supplier Assigned" tickets</span></p><p><span style="font-family: 'courier new', courier;">   count_ng.addAggregate('COUNT');</span></p><p><span style="font-family: 'courier new', courier;">   count_ng.query();</span></p><p><span style="font-family: 'courier new', courier;">   incidents_ng = 0;</span></p><p><span style="font-family: 'courier new', courier;">   if (count_ng.next()) </span></p><p><span style="font-family: 'courier new', courier;">         incidents_ng = count_ng.getTotal('COUNT')</span></p><p><span style="font-family: 'courier new', courier;">   else</span></p><p><span style="font-family: 'courier new', courier;">         incidents_ng = 0;</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   // Debugging - look at intermediate values to solve issues with</span></p><p><span style="font-family: 'courier new', courier;">   //gs.log('PP Test Script ~A~' + i + '~:   Date:   ' + days_ptr.getDisplayValue() + ' &lt;=&gt; Count ~ALL~:   ~' + incidents_all );</span></p><p><span style="font-family: 'courier new', courier;">   //gs.log('PP Test Script ~A.5~' + i + '~:   Date:   ' + days_ptr.getDisplayValue() + ' &lt;=&gt; Count ~ALL~:   ~' + typeof incidents_all );   </span></p><p><span style="font-family: 'courier new', courier;">   //gs.log('PP Test Script ~B~' + i + '~:   Date:   ' + days_ptr.getDisplayValue() + ' &lt;=&gt; Count ~NL~:   ~' + incidents_nl );</span></p><p><span style="font-family: 'courier new', courier;">   //gs.log('PP Test Script ~B.5~' + i + '~:   Date:   ' + days_ptr.getDisplayValue() + ' &lt;=&gt; Count ~NL~:   ~' + typeof incidents_nl );   </span></p><p><span style="font-family: 'courier new', courier;">   //gs.log('PP Test Script ~C~' + i + '~:   Date:   ' + days_ptr.getDisplayValue() + ' &lt;=&gt; Count ~NG~:   ~' + incidents_ng );</span></p><p><span style="font-family: 'courier new', courier;">   //gs.log('PP Test Script ~C.5~' + i + '~:   Date:   ' + days_ptr.getDisplayValue() + ' &lt;=&gt; Count ~NG~:   ~' + typeof incidents_ng );</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   incidents_ok = incidents_all + incidents_nl - incidents_ng;       // OK tickets include all tickets resolved and not resolved, minus Breaches</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   //gs.log('PP Test Script ~D~' + i + '~:   Date:   ' + days_ptr.getDisplayValue() + ' &lt;=&gt; Count ~OK~:   ~' + incidents_ok );</span></p><p><span style="font-family: 'courier new', courier;">   //gs.log('PP Test Script ~D.5~' + i + '~:   Date:   ' + days_ptr.getDisplayValue() + ' &lt;=&gt; Count ~OK~:   ~' + typeof incidents_ok );</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   // Add Ok and Breached number of tickets to the Dataset for charting</span></p><p><span style="font-family: 'courier new', courier;">   dataset.addValue(incidents_ok, "Within SLA", this_date);</span></p><p><span style="font-family: 'courier new', courier;">   dataset.addValue(incidents_ng, "Breached SLA", this_date);</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   // Get count of tickets open at 8:15 that are just Supplier Assigned - i.e. Managed Print Service group</span></p><p><span style="font-family: 'courier new', courier;">   count_sa = new GlideAggregate('incident');</span></p><p><span style="font-family: 'courier new', courier;">   count_sa.addQuery('opened_at', '&lt;', days_ptr);</span></p><p><span style="font-family: 'courier new', courier;">   count_sa.addQuery('u_resolved_at', '&gt;', days_ptr);</span></p><p><span style="font-family: 'courier new', courier;">   count_sa.addQuery('assignment_group', mps);</span></p><p><span style="font-family: 'courier new', courier;">   count_sa.addAggregate('COUNT');</span></p><p><span style="font-family: 'courier new', courier;">   count_sa.query();</span></p><p><span style="font-family: 'courier new', courier;">   var incidents_sa = 0;</span></p><p><span style="font-family: 'courier new', courier;">   if (count_sa.next()) </span></p><p><span style="font-family: 'courier new', courier;">         incidents_sa = count_sa.getTotal('COUNT')</span></p><p><span style="font-family: 'courier new', courier;">   else</span></p><p><span style="font-family: 'courier new', courier;">         incidents_sa = 0;</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   //gs.log('PP Test Script ~E~' + i + '~:   Date:   ' + days_ptr.getDisplayValue() + ' &lt;=&gt; Count ~SA~:   ~' + incidents_sa );</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   // Add Supplier Assigned number of tickets to the Dataset</span></p><p><span style="font-family: 'courier new', courier;">   dataset.addValue(incidents_sa, "Supplier Assigned", this_date);</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">   // add target row - note, couldn't figure out how to do this using gfree charts draw function!</span></p><p><span style="font-family: 'courier new', courier;">   datatarg.addValue(20, "Target", this_date);</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">}     // end of the while loop</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// Use ServiceNow Wrapper since some of the base jFree Chart objects don't seem to work</span></p><p><span style="font-family: 'courier new', courier;">var barr = new ChartGenerator("bar");</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// Indicate a Stacked Bar</span></p><p><span style="font-family: 'courier new', courier;">barr.setStacked();</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// Get the jFree Chart "Chart" object so we can manipulate it</span></p><p><span style="font-family: 'courier new', courier;">var chart = barr.getChart(dataset);</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// Get the jFree Chart Plot object and modify the background</span></p><p><span style="font-family: 'courier new', courier;">var plot = chart.getPlot();</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// Set plot background light Gray - commented out for now</span></p><p><span style="font-family: 'courier new', courier;">//plot.setBackgroundPaint(Packages.java.awt.Color.lightGray);</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// Set Axis labels and cap at 80 incidents ==&gt; keeps the charts consistent each day and a kluge because</span></p><p><span style="font-family: 'courier new', courier;">// I can't figure out how to have the Target Line use the first (left) value range, forcing the bars and lines</span></p><p><span style="font-family: 'courier new', courier;">// to Max at 80 was a work-around</span></p><p><span style="font-family: 'courier new', courier;">axisD = plot.getDomainAxis();</span></p><p><span style="font-family: 'courier new', courier;">axisD.setLabel("Date");</span></p><p><span style="font-family: 'courier new', courier;">axisV = plot.getRangeAxis();</span></p><p><span style="font-family: 'courier new', courier;">axisV.setLabel("# Incidents");</span></p><p><span style="font-family: 'courier new', courier;">axisV.setRange(0,80);</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// Change Series Colors to Match the original report</span></p><p><span style="font-family: 'courier new', courier;">rendererBar = plot.getRenderer();</span></p><p><span style="font-family: 'courier new', courier;">rendererBar.setSeriesPaint(0, Packages.java.awt.Color(0.0,0.5,0.0));</span></p><p><span style="font-family: 'courier new', courier;">rendererBar.setSeriesPaint(1, Packages.java.awt.Color(1.0,0.0,0.0));</span></p><p><span style="font-family: 'courier new', courier;">rendererBar.setSeriesPaint(2, Packages.java.awt.Color(1.0,0.647,0.0));</span></p><p><span style="font-family: 'courier new', courier;">rendererBar.setDrawBarOutline(false);</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// Create a new Line chart for the target line (couldn't figure out how to draw a target line)</span></p><p><span style="font-family: 'courier new', courier;">var line = new ChartGenerator("line");</span></p><p><span style="font-family: 'courier new', courier;">var renderer = line.getChartGenerator().getLineRenderer(Packages.java.awt.Color.BLACK, 3.0, false, false, false);</span></p><p><span style="font-family: 'courier new', courier;">barr.addRenderer(renderer, datatarg, false, "Target");</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// set Max on target axis to 80 so it matches the main Range Axis (I can't figure out how to force to use the </span></p><p><span style="font-family: 'courier new', courier;">// first Range Axis</span></p><p><span style="font-family: 'courier new', courier;">axisV2 = plot.getRangeAxis(1);</span></p><p><span style="font-family: 'courier new', courier;">axisV2.setRange(0,80);</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// Change the title</span></p><p><span style="font-family: 'courier new', courier;">chart.setTitle("Open Incidents at 8:15");</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">// return our chart</span></p><p><span style="font-family: 'courier new', courier;">answer = chart;</span></p><p></p><p></p><p><span style="font-family: 'courier new', courier;">//gs.log('PP Test Script 100:   End of Script');</span></p>