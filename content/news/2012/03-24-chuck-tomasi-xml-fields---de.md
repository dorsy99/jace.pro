---
title: "XML Fields  Deferred Record Updates"
date: 2012-03-23T19:51:45.000Z
authors: ["Chuck Tomasi"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=ca0deaa5dbd0dbc01dcaf3231f96191b"
---
<p><img  alt="" class="jive-image" src="dd013042db189304b322f4621f96194b.iix" align="right" />XML fields are a great way to save form content and apply it later. You may already be familiar with this concept from the <a title="ki.service-now.com/index.php?title=Managing_CI_Changes" href="http://wiki.service-now.com/index.php?title=Managing_CI_Changes">Propose Changes</a> functionality. If you haven't used this, here's a quick refresher. At some point in the change process, you right click on an a CI listed in the affected CIs related list, make some changes on the form, then click the Save Proposed Changes UI action, and all your changes are saved in an XML field to be applied later when you click "Apply Proposed Changes." Recently, a customer had me build a cancelation process that did something similar. This is what I came up withâ€¦<br /><!--break--><br />The key requirements were:<br /><br /><ol><li>The user canceling the request must provide a mandatory reason (u_reason choice list) and descriptive text (close_notes)</li><li>For compliance reasons, the user must provide <a title="ki.service-now.com/index.php?title=Approval_with_E-Signature" href="http://wiki.service-now.com/index.php?title=Approval_with_E-Signature">eSignature</a> validation that they are closing the request</li><li>The cancel option is only available in states Draft, Assess &amp; Schedule, Approval, and Implement (up until the time tasks begin), not in Review and not in Close.<br /></li></ol><br /><br />To make the Cancel user experience consistent with the rest of the process, I used a <a title="w.servicenowguru.com/system-ui/glidedialogwindow-quickforms/" href="http://www.servicenowguru.com/system-ui/glidedialogwindow-quickforms/">Glide Dialog Window</a> to pop up and prompt for the two mandatory fields.<br /><br /><center><br /><img  alt="" class="jive-image" src="940ee1cedb9cd304b322f4621f961920.iix" /><br /></center><br /><br /><br />My initial implementation borrowed the eSignature logic from the Approval form's UI actions and put it on the pop-up's Update button. When the form was filled in, the user clicks Update and another pop up appears prompting for login and password, then continues to cancel the request.<br /><br />That worked fine until the customer required <a title="ki.service-now.com/index.php?title=External_Authentication_(Single_Sign-On_-_SSO)" href="http://wiki.service-now.com/index.php?title=External_Authentication_(Single_Sign-On_-_SSO)">single sign on</a>. Once enabled, the update button still prompted for login and password, unfortunately it took any valid credentials, not necessarily the currently logged in user. So I went back to the drawing board.<br /><br />After lots of pictures on my sunroom windows using whiteboard markers (my modus operandi), I came up with this design:<br /><br /><ol><li>User chooses the Cancel UI action (available in states indicated above and if no other cancelations are pending)</li><li>The Glide dialog window pops up and requires the mandatory fields for u_reason and close_notes as before.</li><li>The user clicks Update</li><li>A (before) business rule:</li><li style="list-style: none"><br /> <ol><li>Saves the desired field/values to a (hidden) XML field</li><li>Creates a stand alone approval - this not connected to the change workflow.</li><li>Restores the previous values to the form</li></ol><br /></li></ol><br /><center><br /><img  alt="" class="jive-image" src="46ceadc6dbd8d7041dcaf3231f9619eb.iix" /><br /></center><br /><br /><br /><br />If the approval is rejected, the XML field is cleared and the process goes on unaffected. If the approval is approved, another business rule applies the contents of the XML field to the change, thus closing the request.<br /><br />Creating an XML field is much like any other field. You can do this from the form via right-click Personalize&gt; Form Layout, or create a new dictionary entry directly. If you create the field via the form, go back to the form and right click on the new field and choose Personalize Dictionary. Be sure to check the "XML view" attribute on the dictionary entry. Note: you may have to personalize your dictionary form to have it show up.<br /><br /><center><br /><img  alt="" class="jive-image" src="ba511d0adb989f048c8ef4621f9619ca.iix" /><br /></center><br /><br />Checking the XML view on the dictionary gives you this little orange XML tag next to the field label. True, I said this field was hidden, but during debug it was helpful to expose it on the form. <br /><center><br /><img  alt="" class="jive-image" src="853d0d8adb54130468c1fb651f96195e.iix" /><br /></center><br /><br />Clicking the XML tag pops a window with a nicely formatted XML tree for easier reading.<br /><br /><center><br /><img  alt="" class="jive-image" src="3aafa3b1db1c1fc068c1fb651f961971.iix" /><br /></center><br /><br /><br /><br />So now we have a field to store stuff in, let's take a look at the part that does the actual work. After the Update button on the Glide Dialog Window is clicked, a business rule is run that is triggered by two things, the status going to Canceled, and the XML field being empty. The business rule script looks like this:<br /><br /><ul><li>Name: Save cancel values</li><li>Table: Change Request [change_request]</li><li>Order: 50</li><li>Active: true</li><li>When: before</li><li>Insert: true</li><li>Update: true</li><li>Condition: current.u_status.changesTo('930') &amp;&amp; current.u_xml.nil()</li></ul><br />Note: 930 is the value of status "Canceled". Status (u_status) is a choice list dependent on state.<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />saveValues();<br />createApproval();<br />restoreValues();<br /><br />/*<br /> * saveValues - save the current S/S/R+res notes to the XML field<br /> *<br /> * @param - none<br /> * @return - none<br /> *<br /> */<br />function saveValues() {<br /><br />  var xml = '&lt;change_request&gt;\n';<br /><br />  xml += '\t&lt;state&gt;' + current.state + '&lt;/state&gt;\n';<br />  xml += '\t&lt;u_status&gt;' + current.u_status + '&lt;/u_status&gt;\n';<br />  xml += '\t&lt;u_reason&gt;' + current.u_reason + '&lt;/u_reason&gt;\n';<br />  xml += '\t&lt;close_notes&gt;' + current.close_notes + '&lt;/close_notes&gt;\n';<br />  xml += '&lt;/change_request&gt;\n';<br />  current.u_xml = xml;<br />}<br /><br />/*<br /> * createApproval - create a standalone approval and connect it to the WF activity 'Cancel Request'<br /> *<br /> * @param - none<br /> * @return - none<br /> *<br /> */<br />function createApproval() {<br /><br />  var wf = new GlideRecord('wf_context');<br /><br />  wf.addQuery('table', 'change_request');<br />  wf.addQuery('id', current.sys_id);<br />  wf.setLimit(1);<br />  wf.query();<br /><br />  if (wf.next()){<br /><br />    var activity = new GlideRecord('wf_activity');<br /><br />    activity.addQuery('name', 'Cancel Request');<br />    activity.addQuery('workflow_version', wf.workflow_version);<br />    activity.setLimit(1);<br />    activity.query();<br /><br />    if (activity.next()) {<br /><br />      var app = new GlideRecord('sysapproval_approver');<br /><br />      // Create approval<br />      app.initialize();<br />      app.wf_activity = activity.sys_id;<br />      app.sysapproval = current.sys_id;<br />      app.approver    = gs.getUserID();<br />      app.state       = 'requested';<br />      app.u_element   = 'chg_cancel';<br />      app.insert();<br />      // Approval created<br />    }<br />  }<br />}<br /><br />/*<br /> * restoreValues - restore the previous values to SSR so the process continues uninterrupted<br /> *<br /> * @param - none<br /> * @return - none<br /> *<br /> */<br />function restoreValues() {<br /><br />  var pr = new GlideRecord('change_request');<br /><br />  if (pr.get(current.sys_id)) {<br />    current.state       = pr.state;<br />    current.u_status    = pr.u_status;<br />    current.u_reason    = pr.u_reason;<br />    current.close_notes = pr.close_notes;<br />  }<br />}<br /></pre><br /><br />A couple notes about the script:<br /><ul><li>I could have used the serializer to capture the entire record rather than hand build the XML. I did it this way for simplicity. (For more information about the serializer take a look at some of the OOB script includes that use it.)</li><li>You may also notice that the createApproval() function appears more complex that it needs to be. This was done because the customer wanted the workflow activity (wf_activity) field to reflect "Cancel Request". Remember, earlier when I said that this was a stand alone approval and not part of the of the workflow. Well, partially. I have an activity on the workflow, but it's not connected to anything. The only value it has is to provide a reference to that activity so the workflow activity name displays like any other approval. If you don't need that, just use the part of the function from "// Create approval" to "// Approval created"</li><li>In the restoreValues() function, the "previous" object isn't available in a before script. pr.get(current.sys_id) is used to retrieve the old values</li></ul><br /><center><br /><img  alt="" class="jive-image" src="e1bea54adb9053043eb27a9e0f9619b4.iix" /><br /></center><br /><br />If the approval is rejected, the following business rule cleans things up:<br /><br /><ul><li>Name: Change Cancel - Rejected</li><li>Table: Approval [sysapproval_approver]</li><li>Order: 100</li><li>Active: true</li><li>When: after</li><li>Update: true</li><li>Condition: current.sysapproval.sys_class_name == 'change_request' &amp;&amp; current.u_element == 'chg_cancel' &amp;&amp; current.state.changesTo('rejected')</li></ul><br />Script:<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />var chg = new GlideRecord('change_request');<br />if (chg.get(current.sysapproval.sys_id)) {<br /><br />  // If it's rejected, clear the XML field to allow the UI action to appear again<br />  chg.u_xml = '';<br />  chg.update();<br />}<br /><br /></pre><br />(FYI - the u_element field was added to sysapproval_approver for another purpose. It provides a way to differentiate this approval record from any other associated with this change)<br /><br />If the approval is approved (confirming the cancelation) then this business rule is run to finally apply the saved data in the XML field to the change request:<br /><ul><li>Name: Change Cancel - Approved</li><li>Table: Approval [sysapproval_approver]</li><li>Order: 100</li><li>Active: true</li><li>When: after</li><li>Update: true</li><li>Condition: current.sysapproval.sys_class_name == 'change_request' &amp;&amp; current.u_element == 'chg_cancel' &amp;&amp; current.state.changesTo('approved')</li></ul><br />Script:<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />// Get the change record associated with this approval<br />// Get the values from the XML field and put them in the appropriate fields<br />var chg = new GlideRecord('change_request');<br />if (chg.get(current.sysapproval.sys_id)) {<br /><br />  chg.state       = gs.getXMLText(chg.u_xml, '//state');<br />  chg.u_status    = gs.getXMLText(chg.u_xml, '//u_status');<br />  chg.u_reason    = gs.getXMLText(chg.u_xml, '//u_reason');<br />  chg.close_notes = gs.getXMLText(chg.u_xml, '//close_notes');<br />  chg.active      = false;<br />  chg.update();<br />}<br /><br /></pre><br /> <br />This was a pretty specific example of saving information to an XML field, but it gives you an idea of how you can use XML fields to store information and retrieve it later. The customer was happy because the user experience didn't change and they gained improved audit evidence for cancelations while maintaining all the key requirements.</p>