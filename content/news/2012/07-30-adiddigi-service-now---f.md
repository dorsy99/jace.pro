---
title: "ServiceNow  FTP communication via MID server"
date: 2012-07-29T21:56:06.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=676d6e29dbd0dbc01dcaf3231f961901"
---
<p>This post is an improvement over the post <a title="mmunity.servicenow.com/blog/adiddigi/get-list-file-names-ftp-server" href="http://community.servicenow.com/blog/adiddigi/get-list-file-names-ftp-server">Get filenames from a FTP server</a>. <br />In this post we run the entire code of getting the files names in a Business Rule on a MID server Script Include.The reason why you would want to run this on the MID server is : Some times, you forget to close the connection you made to FTP, and that may result in bringing down the instance(It did happen to me). Not only closing a connection, too many sessions from SNOW to FTP will result in performance issues.<br /><br />There are 3 steps involved in this entire communication :<br />1. Call the MID script include from the business rule(when you actually want to get the filenames in Service Now and do something)<br />2. In the MID server script, embed the call to an FTP server.<br />3.When ever you make this call, a probe will be sent to MID server and the MID server will reply(after executing the MID script include),and both these entries are found in ECC Queue;So have a business rule to process the Input we received from MID server's Script Include(I used XML helper for this)<br /><br /> <b>Business Rule:</b> <br />Name : Talk to MID<br />Type : Can be anything- depends on the requirement<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />fnToMidserver();<br /><br />function fnToMidserver(){<br />  <br />   try{<br /><br />/* we have defined many parameters as we use it again and again at many places*/<br />      var ftpServer = gs.getProperty("host");<br />      var username = gs.getProperty("login");<br />      var pswrd = gs.getProperty("password");<br />      var port= gs.getProperty("port");<br />      var type=gs.getProperty("type");<br />      var timeout=gs.getProperty("timeout");<br />      var passive=gs.getProperty("passive");<br />      var ftpFilePath = gs.getProperty("FTP Attachment");<br />      var StringUtil = Packages.com.glide.util.StringUtil;<br />     /* You can actually skip these two variables binData and encData;This is specific to my requirement*/<br />      var binData =  'test';<br />      var encData =StringUtil.base64Encode(binData);<br />      var jspr = new JavascriptProbe('Integration');/*Integration is the Name of MID server*/<br />      jspr.setName('FileGetMIDServer'); /* Any description will do, this will be the name of the PROBE that will be sent and the identifier in ECC Queue*/<br />      jspr.setJavascript("var ddr = new MidFilenameRetr();res = ddr.execute();");<br />      /* Again you can ignore setting this parameter */<br />      jspr.addParameter("encodedData",encData);<br />      var cred = username+":"+pswrd;<br />      /* this is the sys_id of the current parameter, I used it as when I get a reply from MID server and there are multiple Inputs(the MID server script include is called multiple times, and it sends the replies back, we would want to identify the particular record that made the request*/<br />      jspr.addParameter("sysId",current.sys_id);<br />      jspr.addParameter("ftpCred",cred);<br />      jspr.addParameter("ftpTargetServer",ftpServer);<br />      jspr.addParameter("ftpPort",port);<br />      jspr.addParameter("targetPath",ftpFilePath);<br />      jspr.addParameter("host",ftpServer);<br />      jspr.addParameter("transportMethod",type);<br />      jspr.create();<br />      gs.log('Completed: Check Mid Server log');<br />   }<br />   catch(e){<br />      gs.log('exception in calling mid server : '+e);<br />     <br />   }<br />}<br /></pre><br /><br />Now we have a business rule that talks to MID server. Please note, the MID server Script Include MidFilenameRetr() will <b>NOT</b> have access to Service Now gs object,it runs in the scope of MID server and it has access to all the jars that are defined with in the MID server setup.More information on this for another day.That post will also have a java code which users Reflection API to get the class definitions and method declarations of the MID jars.<br /><br /><b>Script Include :</b><br />Name : MidFilenameRetr<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />var MidFilenameRetr= Class.create();<br /><br />MidFilenameRetr.prototype = {<br />   initialize : function() {<br />     <br />      this.debug = false;<br />      this.MIDSERVER_PROCESSED_FILE_PATH = "processed/";<br />      this.resLog = "FTP Log: \n";<br />      this.log("Initializing SNDataRetriever");<br />      this.MIDSERVER_FILE_PATH = "work/";<br />      //this.MIDSERVER_FILE_NAME = probe.getParameter('targetFileName');<br />     <br />      this.Encoded_Data = probe.getParameter('encodedData');<br />     <br />      this.useProxy = this.getConfigParameter("mid.proxy.use_proxy");<br />      if (this.useProxy){<br />         this.proxyHost =this.getConfigParameter("mid.proxy.host");<br />         this.proxyPort =this.getConfigParameter("mid.proxy.port");<br />         this.proxyUser =this.getConfigParameter("mid.proxy.username");<br />         this.proxyPass =this.getConfigParameter("mid.proxy.password");<br />      }<br />      this.user = this.getConfigParameter("mid.instance.username");<br />      this.password = this.getConfigParameter("mid.instance.password");<br />      /* here we are creating an actual FTP connection between MID server and FTP*/<br />      var ftpCredArr = this.decryptCredentials(probe.getParameter('ftpCred'));<br />      this.ftpUser = ftpCredArr[0];<br />      this.ftpPass = ftpCredArr[1];<br />      this.log('ftp username : '+ftpCredArr[0]);<br />      this.log('ftp password : '+ftpCredArr[1]);<br />      this.ftpTargetServer = probe.getParameter('ftpTargetServer');<br />      this.ftpPort = (this.isANumber(probe.getParameter('ftpPort'))) ? (probe.getParameter('ftpPort')) : null;<br />     <br />      this.sysID = probe.getParameter("sysId");<br />      this.targetPath = probe.getParameter('targetPath');<br />      // this.targetFileName = probe.getParameter('targetFileName');<br />     <br />      this.host = probe.getParameter('host');<br />     <br />      this.transportMethod = probe.getParameter('transportMethod');<br />     <br />      if (this.debug){<br />         this.log("\n********** Debug Info **********\nuser: " + this.user + "\npass: " + this.password + "\ntransportMethod: " + this.transportMethod + "\nreport: " + this.reportURL+ "\nhost: "+ this.host);<br />         this.log("\n********** Proxy Info **********\nproxyNeeded: " + this.proxyNeeded +"\nproxyUser : " + this.proxyUser + "\nproxyPass :" + this.proxyPass );<br />         this.log("\nproxyHost: " + this.proxyHost + "\nproxyPort:" + this.proxyPort);<br />         this.log("\n********** FTP Info ************\nftpUser: "+ this.ftpUser + "\nftpPass: " + this.ftpPass + "\nftpPort: " + this.ftpPort);<br />         this.log("\n********** End of Debug ********\n\n");<br />      }<br />   },<br />    getConfigParameter: function(parm){<br />      var m= Packages.com.service_now.mid.MIDServer.get();<br />      var config = m.getConfig();<br />      var res = config.getParameter(parm);<br />      var res2 = config.getProperty(parm);<br />      if (res){<br />         return res;<br />      }<br />      else if (res2){<br />         return res2;<br />      }<br />      else{<br />         config = Packages.com.service_now.mid.services.Config.get();<br />         return config.getProperty(parm);<br />      }<br />     <br />   },<br />  <br />   decryptCredentials: function(data) {<br />      var cred = new String(data);<br />      var e = new Packages.com.glide.util.Encrypter();<br />     <br />      var jsCred = cred + '';<br />      var usernamePass = e.decrypt(jsCred);<br />      var credArr = usernamePass.split(":", 2);<br />      return credArr;<br />   },<br />  <br /> execute: function() {<br />      var result = '';<br />      this.log("Running FileDataRetriever execute");<br />      var pt = new Packages.java.util.Properties();<br />      pt.setProperty("connection.host", this.ftpTargetServer);<br />      pt.setProperty("connection.port", this.ftpPort);<br />      pt.setProperty("user.login", this.ftpUser);<br />      pt.setProperty("user.password", this.ftpPass);<br />      pt.setProperty("connection.type", this.transportMethod);<br />      pt.setProperty("connection.timeout", '10000');<br />      pt.setProperty("connection.passive", 'true');<br />      var connection = Packages.org.ftp4che.FTPConnectionFactory.getInstance(pt);<br />      connection.connect();<br />      var myFiles = connection.getDirectoryListing(this.targetPath);<br />      /* myFiles is an ArrayList - connection.getDirectoryListing returns an ArrayList object - hence the lines below, thanks to the community, I found the join method and used it :) */   <br />      var toArray = myFiles.toArray();<br />      var ret= toArray.join(',');<br />      ret = this.sysID+'|'+ret;<br />/* note that, as I said,I  am appending the sysID so that i can identify the sys_id that generated the request on MID server, and I can do something on that record */<br />      return ret;<br />     <br />     <br />   },<br />   getLog: function() {<br />      return this.resLog;<br />   },<br />  <br />   log: function(data) {<br />      ms.log(data);<br />      this.resLog+="\n"+data;<br />   },<br />  <br />   isANumber: function(data) {<br />      data = data + '';<br />      return ((data - 0) == data &amp;amp;&amp;amp; data.length &gt; 0);<br />   },<br />  <br />  <br />   type : "MidFilenameRetr"<br />};<br /></pre><br /><br />Point to note : The result that you return in this MID server Script include will be embedded in the tags <br /><br /> <br /> !What ever you return!<br /> <br /><br />in the incoming payload in the ECC Queue.<br /><br /><br />[Thanks to Mark Stanger and Jacob Andersen for the Script Includes that import the attachments and put them on an FTP, Most of the code is lifted from there]<br /><br />Now, the last step of processing the ECC queue and returning it back to the record that created the request :<br /><br />Name : Business Rule<br />Table: ecc_queue<br />Condition :current.queue=="input"<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br /><br />function checkFile(){<br />  <br />   var content=current.payload;<br />   var xh = new XMLHelper();<br />   var obj = xh.toObject(content);<br />   content = obj.result.output;<br />   var files=content.split('|')[1];<br />   var sysId='';<br />   sysId= content.split('|')[0];<br />  /*This is how you use XML helper to process the output.Thanks to Tom for  the XML helper class- I mean Script Include*/ <br />}<br /></pre><br /><br /><br /><br />Acknowledgements:<br />1.The original idea was different, it was to move a file into MID server from Service Now and then from MID server to a FTP server.I modified the code, to get the file names. Mohammed Ishaq Khan is the guy who worked on that, and you can read the <a title="rvicenowdiary.com/2012/07/send-an-attachment-from-service-now-and-store-it-on-ftp-server-v-i-a-mid-server/" href="http://servicenowdiary.com/2012/07/send-an-attachment-from-service-now-and-store-it-on-ftp-server-v-i-a-mid-server/">Send files out to FTP via MID server</a> on Service Now Diary. <br />2.To James Andersen, for the information on MID server Script Includes.</p>