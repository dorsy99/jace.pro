---
title: "Script Actions Take II  an impersonation log"
date: 2012-08-22T09:10:57.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=adcc2265dbd0dbc01dcaf3231f961965"
---
<p>So I got a lot of discussion and positive feedback stemming from my last blog entitled <a title="mmunity.servicenow.com/blog/garrick/script-actions-forgotten-action" href="http://community.servicenow.com/blog/garrick/script-actions-forgotten-action">Script Actions, the forgotten action</a> and have decided to share another use case as a quick follow up. Some of our customers have faced audit requirements that require keeping track of administrator impersonations. In other words, they want to keep tabs on the start/stop times of their users with rights to impersonate--a very handy thing to have!<br /><br />You might be thinking, "Aren't these already kept in the system logs?". <strong>And you'd be right.</strong> However, these logs can grow large, unwieldy, and sometimes difficult to report against. We can solve the size of the logs by simply using <a title="ki.servicenow.com/index.php?title=Table_Rotation" href="http://wiki.servicenow.com/index.php?title=Table_Rotation">Table Rotations</a> to keep these in check. When using table rotation, you're limiting the amount of time that you hold on to the data and dropping off the oldest table in the rotation thereby remaining nice and efficient (it's commonly determined that the vast majority of information in the logs are no longer important after a certain period of time). Though generally, the time you'd want to setup your rotation for are in conflict with the amount of time the auditors are asking you to retain the data. Hmmmmmâ€¦.<br /><br />So lets now turn our attention back to script actions and how you can solve this use case. If you recall from the last post, script actions are a way to trigger script based on an event in the system. Aside from notifications, these are one of the only other common mechanisms for readily accomplishing this. <strong>Conceptually, we're going to carve out the impersonation logs from the syslog into a new table that we can keep for a much longer period for auditing.</strong> <br /><br />To begin, we want to create a new table and some fields to capture the impersonation logs. We're also going to create some ACLs that will lock all these down to read access only. Take a look at the screen shot below for an idea of how you might want to set this up. (If you're really lazy, check out the update set that's attached for all the work to be done for you including the ACLs and Script Actions.) <br /><br />Once this is in place, we'll need to create a couple of basic script actions that write to this table when an impersonation starts, stops, and keeps track of the impersonator and impersonatee. <br /><img  class="jive-image" src="4ac6484edb5c5fc068c1fb651f961989.iix" alt="new table" /><br /><br /><br />The first Script Action is a basic one that's fired on "impersonation.start"<br /><br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />// Log admin impersonations into separate table allowing for truncation of syslog<br />// Add this as a new Script Action. Event name: impersonation.start<br /><br />var impStart = new GlideRecord('u_impersonation_log');<br />impStart.initialize();<br />impStart.u_impersonator_user_id = event.parm1;<br />impStart.u_impersonator = getUserName(event.parm1);<br />impStart.u_impersonatee_user_id = event.parm2;<br />impStart.u_impersonatee = getUserName(event.parm2);<br />impStart.u_impersonation_start = event.sys_created_on;<br />impStart.insert();<br /><br />function getUserName(id) {<br />     var ret = "Unknown";<br />     var usr = new GlideRecord('sys_user');<br />     usr.addQuery('user_name', id);<br />     usr.query();<br />     if (usr.next() ) { ret = usr.name.toString(); }<br />     return ret;<br />}<br /><br /></pre><br /><br />Very similarily, the second sends an update once that impersonation ends and should trigger on the "impersonation.end" script action.<br /><br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br /><br />// Log admin impersonations into separate table allowing for truncation of syslog<br />// Add this as a new Script Action. Event name: impersonation.end<br /><br />var impEnd = new GlideRecord('u_impersonation_log');<br />impEnd.addQuery('u_impersonator_user_id', event.parm1);<br />impEnd.addQuery('u_impersonatee_user_id', event.parm2);<br />impEnd.addNullQuery('u_impersonation_end');<br />impEnd.orderByDesc('u_impersonation_start');<br />impEnd.query();<br /><br />if (impEnd.next()) {<br />   impEnd.u_impersonation_end = event.sys_created_on;<br />   impEnd.update();<br />}<br /><br /></pre><br /><br />And there you have it. A basic table, a few fields, some ACLs, and two simple script actions. What did we gain? <strong>A clear and easy way to report and log our impersonations and no need to keep the costly syslogs around for only an audit requirement.</strong> <br /><br /><img  class="jive-image" src="7ec6444edbdcd3049c9ffb651f961938.iix" alt="more hidden alt tags..it's just a sample" /><br /><br />While this is a narrow use; hopefully, it allows you to see how to take advantage of the script actions to solve some real life business problems. <strong>There's a ton of script actions out there, so get creative and give them a shot!</strong> <br /><br />Again, if you want to play with this one, check out the update set below that contains the table, fields, ACLs, and the script actions referenced above.<br /><br />Have a great week,<br /><br />Garrick</p>