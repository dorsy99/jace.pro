---
title: "Walking to find all tasks for all relationships"
date: 2012-02-14T15:32:54.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=26dc2a65dbd0dbc01dcaf3231f961971"
---
<p>I had an interesting challenge set to me by <a title="itter.com/PaulHardyUK" href="http://twitter.com/PaulHardyUK">Paul Hardy</a> of Informa recently.<br /><br />He has a CMDB in his ServiceNow instance which defines his applications and its dependancies on his Infrastructure.<br /><br /><a href="http://www.flickr.com/photos/soyunterrorista/44731269/" title="walk street sign by kate at yr own risk, on Flickr"><img src="http://farm1.staticflickr.com/28/44731269_524992ae79.jpg" width="500" height="375" alt="walk street sign" /></a><br /><br />His request was fairly simple:<br /><br /><blockquote><br />I'd like to see all of the tasks (Incidents, Problems and Changes) that are currently open for an Application and all of it's dependancies<br /></blockquote><br /><br /><br /><br />That would be a good list to see - take an Enterprise Application and get a quick view on all of the ITSM activity that is currently affecting or scheduled for that Configuration Item (CI).<br /><br />It led to a moment of head scratching, but here is one method of getting what he wants.<br /><br />To do this we used 3 objects - a Script Include that does all of the heavy lifting, a couple of Business Rules that provide a easy-to-use wrapper around that script and a Record Producer as an optional nice User Interface.<br /><br /><h2>The Script Include</h2><br /><br />Lets have a look at the Script Include first.<br /><br />The purpose of the Script Include is to output a list of all the sys_id values for every CI that the Application is dependant on. <br /><br />If my example below I'm using the demo data we ship with ServiceNow and concentrating on a Rack CI named <b>"NY-01-02"</b><br /><br />You can see its relationships here.<br /><br /><img  alt="" class="jive-image" src="77e01542db581b04ed6af3231f9619a0.iix" width="900" /><br /><br />To use the script you simply pass in the name of the Application and the direction that you want to walk the relationships in: either "parent" or "child".<br /><br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />var x = new CIEnum();<br />gs.print(x.go("NY-01-02", "parent"));<br /><br />*** Script: CIEnum.go: No more CIs to check. Stopping<br />*** Script: e7a094f40a0a0aa7006c0f702c1b75fd,d8565cac1b1110009141928f3d071365,d055d4ac1b1110009141928f3d0713e3,4157da14ef1010002d4274341b225680,8cc17ba0ef1010002d4274341b2256db,bec0fba0ef1010002d4274341b22566c,b45610ec1b1110009141928f3d0713b2,d8565cac1b1110009141928f3d071365,9dc2bfa0ef1010002d4274341b22560a,5f9ba346c0a8010e00158183aaa1eb24,5fd1aa38c0a8010e014f2ef246f3eba3<br /></pre><br /><br />The output is a comma separated list of sys_id values that we can use in list filters, reports and so on.<br /><br />The guts of the script include is an iterator that eats Configuration Items until it runs out. At that point it returns the string value for us.<br /><br />Lets have a look at the script<br /><br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />var CIEnum = Class.create();<br /><br />CIEnum.prototype = {<br /><br />   initialize : function() {<br />   },<br /><br />   go: function(ci_name, direction) {<br /><br />      // Take a  ci_name and return a comma<br />      // separated list of sys_ids.<br />      //<br />      // The sys_ids represent all of the CIs that have a<br />      // dependancy on ci_name<br />      // @param {String} ci_name   The name of the root CI<br />      // @param {String} direction either "parent" or "child" - which direction to walk the relationship tree<br /><br />      this.direction = direction;<br />      if (this.direction != 'parent' &amp;amp;&amp;amp; this.direction != 'child') {<br />         gs.log("FATAL: CIEnum: Invalid choice of direction. Exiting");<br />         return "ERROR";<br />      }<br /> <br />      this.maximum_iteration_count = 1000;<br />      this.seen_cis = [];<br />      this.need_to_check = [];<br /><br />      // Get the initial object<br />      var gr = new GlideRecord('cmdb_ci');<br />      gr.addQuery('name', ci_name);<br />      gr.query();<br /><br />      if (gr.getRowCount() &gt; 1) {<br />     gs.log("WARN: CIEnum: Multiple CIs with the name"  + ci_name);<br />     //return "ERROR"; Maybe if we have multiple CIs at this stage we should return nothing?<br />      }<br /><br />      // If there are multiple records with the name ci_name we just logged an error.<br />      // Only work on the first one in the recordset<br />      gr.next();<br /><br />      // Here we go!<br />      // Add the root CI sys_id to need_to_check and get the next level down.<br />      // Add those CIs to seen_cis and keep going until we hit the end, or start to see duplicates<br /><br />      this.need_to_check.push(gr.getValue('sys_id'));<br />      var keep_on_looping = true;<br />      var x = 0;<br /><br />      while (keep_on_looping) {<br />         if (x&gt;this.maximum_iteration_count) {<br />            gs.print('CIEnum.go: maximum_iteration_count exceeded. Stopping');<br />            break;<br />         }<br />         x++;<br /><br />         sys_id = this.need_to_check.pop();<br /><br />         if (!sys_id) {<br />            gs.print('CIEnum.go: No more CIs to check. Stopping');<br />            break;<br />         }<br /><br />         this.get_next_level_cis(sys_id);<br />      }<br /><br />      return this.seen_cis.toString();<br /><br />   },<br />   get_next_level_cis: function(sys_id){<br />  <br />      // Given a CI get the list of downstream CIs<br />      // @param {String} sys_id   The sys_id of the object to check up or down<br /><br />      var gr = new GlideRecord('cmdb_rel_ci');<br />     <br />      if (this.direction == 'parent') {<br />         gr.addQuery('child', sys_id);<br />      } else if (this.direction == 'child') {<br />     gr.addQuery('parent', sys_id);    <br />      }<br />      gr.query();<br /><br /><br />      // Loop through the relationship records<br />      while (gr.next()){<br /><br />         // Have we seen this CI before? If not we can explore the relationships and add<br />         // it to the return value<br /><br />         if (this.seen_cis.toString().search(sys_id) == -1) {<br /><br />            // Add this CI into the queue to be explored    <br />            this.need_to_check.push(gr.getValue(this.direction));<br />          }<br />      }<br /><br />      this.seen_cis.push(sys_id);<br /><br />   },<br />   type: CIEnum<br />};<br /></pre><br /><br /><br />Couple of things to note:<br /><br /><ul><li>This is a fairly expensive operation at the database level. Although it runs quickly on the instances we tested it on I wouldn't recommend using it as part of a chart or homepage widget. Depending on how many CIs you have you might end up doing a fair bit of data crunching that isnt suitable for a chart on a 1 minute refresh</li><li>The script should protect itself against looping relationships (CI A depends on CI B depends on CI A), but there is a safety check in there that stops after 1000 loops. You don't have a relationship structure 1000 levels deep right??</li><li>We typically use the list of sys_id values to generate a filter in a URL. Depending on how many sys_id values you are going to return I suppose you might end up confusing some browsers that don't handle very very long URLs. This shouldn't be a problem for most people</li></ul><br /><br /><br /><h2>The Business Rule</h2><br /><br />The Script Include does all of the working out for us, but it requires a few lines of code to kick it into action. We created a Global Business Rule that can be used in filters that is a little more convienent<br /><br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />var GetParentRelationships = function(ci_name) {<br />   var x = new CIEnum();<br />   var ret = x.go(ci_name, 'parent');<br />   return ret;<br />};<br /><br />var GetChildRelationships = function(ci_name) {<br />   var x = new CIEnum();<br />   var ret = x.go(ci_name, 'child');<br />   return ret;<br />};<br /></pre><br /><br />Having these wrappers around the CIEnum script include means that we can generate list filters and reports easily.<br /><br /><img  alt="" class="jive-image" src="f7f8810adb90d344e9737a9e0f9619f9.iix" width="900" /><br /><br /><img  alt="" class="jive-image" src="b1210c46db585fc03eb27a9e0f961921.iix" width="900" /><br /><br />To use the Business Rule in a list filter you construct a filter like "<b>"Sys ID" "is one of" "javascript:GetChildRelationships("NY-01-02")</b>"<br /><br />You can also filter the Task table using a filter like "<b>"Configuration item.Sys ID" "is one of" "javascript:GetChildRelationships("NY-01-02")</b>"<br /><br /><img  alt="" class="jive-image" src="1ea22f35dbd01fc068c1fb651f961912.iix" width="900" /><br /><br /><h2>The Record Producer</h2><br /><br />And lastly we wanted an easy way to generate a list of tasks that are open against a CI. We created a Record Producer to take the CI name from the user with the direction and to redirect to a list of tasks that are currently open against that CI.<br /><br /><img  alt="" class="jive-image" src="9c35744adb9c57049c9ffb651f96198f.iix" /><br /><br /><h2>In summary</h2><br /><br />When managing Configuration Items, especially within the Change Management process, it is great to be able to easily get a list of all CIs that have an upstream or downstream dependancy on a given CI.<br /><br />You might want to know what Incidents are open that might affect a Business Service or what Change Requests are pending against it.<br /><br />The Update Set attached to this blog post contains some example code to help you do that.<br /><br />2012-05-11 Update: Both the Business Rules need to be configured to run Globally - that is the table should be set to Global. Additionally both the Business Rules and the Script include should be "Client Callable"<br /><br /><a href="http://www.flickr.com/photos/soyunterrorista/44731269/" title="walk street sign by kate at yr own risk, on Flickr">Photo Credit</a></p>