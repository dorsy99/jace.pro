---
title: "Portfolio to Project Relationship MM"
date: 2012-07-25T23:53:33.000Z
authors: ["mkaufman"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=299d2e69dbd0dbc01dcaf3231f961901"
---
<p>In the base ServiceNow application, Portfolios to Projects is a 1:M relationship. To allow a M:M relationship (project can be in many portfolios, portfolio can be part of many projects), you can customize ServiceNow to allow this. <br /><br /><!--break--><br /><strong>Add Many-to-Many Relationship (sys_m2m.list)</strong><br /><br />Wiki Article: http://wiki.servicenow.com/index.php?title=Creating_a_Many-to-Many_Relationship<br /><br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />From Table: Project [pm_project]<br />To Table: Portfolio [pm_portfolio]<br />Many to Many Table: u_m2m_portfolios_projects<br />From Field: u_project<br />To Field: u_portfolio<br /></pre><br /><br /><a href="http://i.imgur.com/8vfCF.jpg" rel="lightbox"><img src="http://i.imgur.com/8vfCF.jpg" alt="M2M Setup" rel="lightbox" width="450px" /></a><br /><br /><strong>Set Related Lists</strong><br /><br />Wiki Article: http://wiki.servicenow.com/index.php?title=Personalizing_Forms#Adding_a_Related_List<br /><br /><ol><li>Project &gt; Personalize &gt; Related Lists<br />Add Portfolio</li><li>Project &gt; Personalize &gt; Form Layout<br />Remove Portfolio Field (if existing)</li><li>Portfolio &gt; Personalize &gt; Related Lists<br />Remove Projects -&gt; Portfolio</li><li>Portfolio &gt; Personalize &gt; Related Lists<br />Add Projects</li></ol><br /><br /><strong>Add Business Rules</strong><br /><br />Wiki Article: http://wiki.servicenow.com/index.php?title=Business_Rules<br /><br /><ol><li>Name: Add to Portfolio<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />Table: u_m2m_portfolios_projects<br />When: after<br />Insert/Update: true<br />Condition: current.u_project.changes() &amp;amp;&amp;amp; !previous.u_project.nil()<br />Script:<br />var pp = new GlideRecord("pm_portfolio_project");<br />pp.pm_project = current.u_project;<br />pp.pm_portfolio = current.u_portfolio;<br />pp.insert();<br />var ppu = new ProjectPortfolioUtils();<br />ppu.refreshProject(pp);<br /></pre></li><li>Name: Remove From Portfolio<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />Table: u_m2m_portfolios_projects<br />When: after<br />Update/Delete: true<br />Condition: (current.u_portfolio.changes() &amp;amp;&amp;amp; !previous.u_portfolio.nil()) || current.operation() == "delete"<br />Script:<br />var pp = new GlideRecord("pm_portfolio_project");<br />   pp.addQuery("pm_project", current.u_project);<br />if (current.operation() == "delete") {<br />   pp.addQuery("pm_portfolio", current.u_portfolio);<br />}<br />else {<br />   pp.addQuery("pm_portfolio", previous.u_portfolio);<br />}<br />pp.query();<br />if (pp.next()) {<br />   pp.deleteRecord();<br />}<br /></pre></li></ol><br /><br /><strong>List Control</strong><br /><br />Wiki Article: http://wiki.servicenow.com/index.php?title=Personalizing_Lists#List_Control<br /><br /><ol><li>u_m2m_portfolios_projects.u_portfolio, Omit New Button: true<br /><br /><a href="http://i.imgur.com/AAWXt.jpg" rel="lightbox"><img src="http://i.imgur.com/AAWXt.jpg" alt="Portfolio Related Lists" rel="lightbox" width="450px" /></a></li><li>u_m2m_portfolios_projects.u_project, Omit New Button: true<br /><br /><a href="http://i.imgur.com/cwkZl.jpg" rel="lightbox"><img src="http://i.imgur.com/cwkZl.jpg" alt="Portfolio Related Lists" rel="lightbox" width="450px" /></a></li></ol><br /><br /><strong>Script Includes</strong><br /><br />Adjust the <strong>TimelinePortfolioGanttPage</strong> Script Includes to allow M:M Timeline.<br /><br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br /><br />// Class Imports<br />var TimelineItem = Packages.com.glide.schedules.TimelineItem;<br />var StringUtil = Packages.com.glide.util.StringUtil;<br /><br />var ERROR_TITLE = 'Error';<br />var GANTT_REQUIREMENT = 'This is required for displaying a gantt chart.';<br />var ERROR_NO_TASK_ID = 'No "sysparm_timeline_portfolio_id" specified in the original Url. ' + GANTT_REQUIREMENT;<br />var ERROR_NO_GR_TASK = 'Unable to find a matching portfolio record with the specified system Id.';<br />var START_LABEL = gs.getMessage('Start');<br />var END_LABEL = gs.getMessage('End');<br />var MESSAGES = [ERROR_TITLE, ERROR_NO_TASK_ID, ];<br /><br />var TimelinePortfolioGanttPage = Class.create();<br />TimelinePortfolioGanttPage.prototype = Object.extendsObject(AbstractTimelineSchedulePage, {<br />  <br />   milestoneIds: {}, // milestone ids in form of<br />   // milestonIds[projectid] = (array of milestoneIds)<br />  <br />   // ////////////////////////////////////////////////////////////////////////////////////////////////<br />   // GET_ITEMS<br />   // ////////////////////////////////////////////////////////////////////////////////////////////////<br />  <br />   getItems: function () {<br />      var port_id = this.getParameter("sysparm_timeline_portfolio_id");<br />     <br />      if (port_id == null) return this.setStatusError(gs.getMessage(ERROR_TITLE), gs.getMessage(ERROR_NO_TASK_ID));<br />        <br />      var portfolio = new GlideRecord('pm_portfolio');<br />      if (!portfolio.get(port_id)) return this.setStatusError(gs.getMessage(ERROR_TITLE), gs.getMessage(ERROR_NO_GR_TASK) + ' ' + gs.getMessage(GANTT_REQUIREMENT));<br />        <br />      // Specify the page title<br />      this.setPageTitle(StringUtil.escapeHTML(portfolio.getDisplayValue()) + gs.getMessage(' Portfolio Gantt Chart'));<br />      this._getProjects(portfolio);<br />   },<br />  <br />   _getProjects: function (portfolio) {<br />     <br />      var portfolioRLGr = new GlideRecord("u_m2m_portfolios_projects");<br />      portfolioRLGr.addQuery("u_portfolio", portfolio.getUniqueValue());<br />      portfolioRLGr.query();<br />      while (portfolioRLGr.next()) {<br />         // get project records<br />         var projectGr = new GlideRecord("pm_project");<br />         projectGr.addQuery("sys_id", portfolioRLGr.u_project.sys_id);<br />         projectGr.query();<br />         while (projectGr.next()) {<br />            var projectId = projectGr.getUniqueValue();<br />            // create project items<br />            var projItem = new TimelineItem("pm_project", projectId);<br />            projItem.setLeftLabelText(projectGr.getValue("short_description"));<br />            // project span<br />            var projSpan = projItem.createTimelineSpan("pm_project", projectId);<br />            var planStart = projectGr.start_date.getGlideObject().getNumericValue();<br />            var workStart = projectGr.work_start.getGlideObject().getNumericValue();<br />            var planEnd = projectGr.end_date.getGlideObject().getNumericValue();<br />            var workEnd = projectGr.work_end.getGlideObject().getNumericValue();<br />            //use actuals if we have them<br />            var projStart = planStart;<br />            if (workStart &gt; 0) var projStart = workStart;<br />              <br />            var projEnd = planEnd;<br />            if (workEnd &gt; 0) projEnd = workEnd;<br />              <br />            projSpan.setTimeSpan(projStart, projEnd);<br />           <br />            // add percent complete span<br />            var pc = parseFloat(projectGr.percent_complete, 10) / 100;<br />            if (pc &gt; 0) {<br />               projSpan.setInnerSegmentTimeSpan(projStart, projSpan.getStartTimeMs() + ((projSpan.getEndTimeMs() - projSpan.getStartTimeMs()) * pc));<br />               projSpan.setInnerSegmentClass('silver');<br />            }<br />            projSpan.setSpanColor("#333333");<br />           <br />            this._getChildMilestones(projectId, projectGr);<br />           <br />            if (!this.milestoneIds[projectId]) {<br />               this.add(projItem);<br />               continue;<br />            }<br />           <br />            var projectMilestoneIds = this.milestoneIds[projectId];<br />           <br />            // add project milestones<br />            var milestoneGr = new GlideRecord("planned_task");<br />            milestoneGr.addQuery("sys_id", "IN", projectMilestoneIds);<br />            milestoneGr.query();<br />            var milestonesMissed = 0;<br />            while (milestoneGr.next()) {<br />               var msStatus = "";<br />               var msItem = new TimelineItem("planned_task");<br />               msItem.setParent(projectGr.getUniqueValue());<br />               msItem.setLeftLabelText(milestoneGr.getValue("short_description"));<br />              <br />               var planEnd = milestoneGr.end_date.getGlideObject().getNumericValue();<br />               var workEnd = milestoneGr.work_end.getGlideObject().getNumericValue();<br />               var msSpan = msItem.createTimelineSpan("planned_task", milestoneGr.getUniqueValue());<br />               if (workEnd &gt; 0) {<br />                  msSpan.setTimeSpan(workEnd, workEnd);<br />                  msSpan.setPointIconClass("black_circle");<br />                  msStatus = "Completed";<br />               } else {<br />                  msSpan.setTimeSpan(planEnd, planEnd);<br />                  if (milestoneGr.end_date.getGlideObject().compareTo(new GlideDateTime()) &gt; 0) {<br />                     msSpan.setPointIconClass("green_circle");<br />                     msStatus = "Planned";<br />                  } else {<br />                     msSpan.setPointIconClass("red_circle");<br />                     milestonesMissed++;<br />                     msStatus = "Missed";<br />                  }<br />               }<br />               msSpan.setTooltip(this._generateMilestoneTooltip(milestoneGr, msStatus));<br />              <br />               //if project has started set project span color based on milestone missed<br />               if (workStart &gt; 0) {<br />                  if (milestonesMissed &gt; 0) projSpan.setSpanColor("red");<br />                     else projSpan.setSpanColor("green");<br />                  }<br />              <br />               this.add(msItem);<br />            }<br />            projSpan.setTooltip(this._generateProjectTooltip(projectGr, milestonesMissed));<br />            this.add(projItem);<br />         }<br />      }<br />   },<br />  <br />   _getChildMilestones: function (projectId, task) {<br />      if (task.rollup != true) return;<br />        <br />      // get children<br />      var children = new GlideRecord("planned_task");<br />      children.addQuery("parent", task.getUniqueValue());<br />      children.query();<br />      while (children.next()) {<br />         // capture milestones<br />         if (children.duration.getGlideObject().getNumericValue() == 0) {<br />            if (!this.milestoneIds[projectId]) this.milestoneIds[projectId] = [];<br />              <br />            this.milestoneIds[projectId].push(children.getUniqueValue());<br />         } else if (children.rollup == true) this._getChildMilestones(projectId, children);<br />      }<br />   },<br />  <br />   _generateProjectTooltip: function (task, msMissed) {<br />      var tt = '&lt;div style="padding:2px;"&gt;&lt;div style="font-size:10pt;border-bottom:1px solid #ccc;padding-bottom:5px;"&gt;&lt;strong&gt;' + StringUtil.escapeHTML(task.short_description) + '&lt;/strong&gt;&lt;br /&gt;';<br />      tt += task.number + '&lt;/div&gt;';<br />      tt += '&lt;div style="padding-top:5px;"&gt;';<br />      tt += '&lt;strong&gt;State: &lt;/strong&gt;' + task.state.getDisplayValue() + '<br />';<br />      if (task.assigned_to != '') tt += '&lt;strong&gt;Assigned To: &lt;/strong&gt;' + task.assigned_to + '&lt;br /&gt;';<br />        <br />      tt += "&lt;strong&gt;Time Constraint: &lt;/strong&gt;" + (task.time_constraint == 'start_on' ? 'Specified' : 'ASAP') + '&lt;br /&gt;';<br />     <br />      if (!JSUtil.nil(task.work_start)) {<br />         tt += "&lt;i&gt;Planned Start: " + task.start_date.getDisplayValue() + '&lt;/i&gt;&lt;br /&gt;';<br />         tt += "&lt;strong&gt;Actual End: &lt;/strong&gt;" + task.work_start.getDisplayValue() + '&lt;br /&gt;';<br />      } else tt += "&lt;strong&gt;Planned End: &lt;/strong&gt;" + task.start_date.getDisplayValue() + '&lt;br /&gt;';<br />     <br />     <br />      if (!JSUtil.nil(task.work_end)) {<br />         tt += "&lt;i&gt;Planned End: " + task.end_date.getDisplayValue() + '&lt;/i&gt;&lt;br /&gt;';<br />         tt += "&lt;strong&gt;Actual End: &lt;/strong&gt;" + task.work_end.getDisplayValue() + '&lt;br /&gt;';<br />      } else tt += "&lt;strong&gt;Planned End: &lt;/strong&gt;" + task.end_date.getDisplayValue() + '&lt;br /&gt;';<br />     <br />      if (!JSUtil.nil(task.percent_complete) &amp;amp;&amp;amp; parseInt(task.percent_complete, 10) &gt; 0) tt += "&lt;strong&gt;% Complete: &lt;/strong&gt;" + task.percent_complete + '%&lt;br /&gt;';<br />        <br />      if (msMissed &gt; 0) tt += "&lt;strong&gt;Milestones Missed: &lt;/strong&gt;" + msMissed + '&lt;br /&gt;';<br />        <br />      tt += '&lt;/div&gt;&lt;/div&gt;';<br />      return tt;<br />   },<br />  <br />   _generateMilestoneTooltip: function (task, status) {<br />      var tt = '&lt;div style="padding:2px;"&gt;&lt;div style="font-size:10pt;border-bottom:1px solid #ccc;padding-bottom:5px;"&gt;&lt;strong&gt;' + StringUtil.escapeHTML(task.short_description) + '&lt;/strong&gt;&lt;br /&gt;';<br />      tt += task.number + '&lt;/div&gt;';<br />      tt += '&lt;div style="padding-top:5px;"&gt;';<br />      tt += '&lt;strong&gt;State: &lt;/strong&gt;' + task.state.getDisplayValue() + '<br />';<br />      tt += "&lt;strong&gt;Time Constraint: &lt;/strong&gt;" + (task.time_constraint == 'start_on' ? 'Specified' : 'ASAP') + '&lt;br /&gt;';<br />     <br />      if (!JSUtil.nil(task.work_end)) {<br />         tt += "&lt;i&gt;Planned End: " + task.end_date.getDisplayValue() + '&lt;/i&gt;&lt;br /&gt;';<br />         tt += "&lt;strong&gt;Actual End: &lt;/strong&gt;" + task.work_end.getDisplayValue() + '&lt;br /&gt;';<br />      } else tt += "&lt;strong&gt;Planned End: &lt;/strong&gt;" + task.end_date.getDisplayValue() + '&lt;br /&gt;';<br />     <br />      tt += "&lt;strong&gt;Status: &lt;/strong&gt;" + status + '&lt;br /&gt;';<br />      tt += '&lt;/div&gt;&lt;/div&gt;';<br />      return tt;<br />   },<br />  <br />   _noSpanTaskId: function () {<br />      return this.setStatusError(gs.getMessage(ERROR_TITLE), gs.getMessage(ERROR_NO_GR_TASK));<br />   },<br />  <br />});<br /><br /></pre><br /><br /><a href="http://i.imgur.com/jx6pT.jpg" rel="lightbox"><img src="http://i.imgur.com/jx6pT.jpg" alt="Portfolio Gantt Chart" rel="lightbox" width="450px" /></a></p>