---
title: "Regex Slightly Obscure Madness"
date: 2011-10-30T03:10:11.000Z
authors: ["SlightlyLoony"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=377de269dbd0dbc01dcaf3231f961943"
---
<p><span class="asset-asset_lightbox-Small asset-align-right"></span>Today's example is one that someone threw at me a couple of years ago. They had a set of data that was <em>sort of</em> comma-separated values. It did have several columns of data values, each separated by commas. What was odd about it was that instead of using Microsoft's quoting convention, they'd invented their own. In their coding convention, any one of five different characters could be used for quoting the value: a quote, a dollar sign, an apostrophe, a percent sign, or an at sign (any of <span style="font-family=courier;color: FireBrick;">"$'%@</span>). Apparently the idea was to eliminate the need to escape values inside the quotes — I guess they figured it wasn't very likely that you'd have a string with all five of those characters in it!</p><p></p><p>So imagine you had some sample helpdesk ticket data, encoded with this wild scheme:</p><pre style="margin-left: 20px; line-height: 1; color: firebrick;"><br/>from,title<br/>$Pelosi, Nancy$,"Please, right now, stop people from posting hateful photos of me!"<br/>%Moore, Michael%,'@&amp;!%$!!!'<br/>@Plumber, Joe@,"Some Drano, applied creatively, would do wonders for Congress!   Wanna help?"</pre><p><br/>What sort of a regex would it take to extract the bits we really want?</p><p></p><p>The fellow who gave me the problem (at right) thought long and hard about it, and finally came up with this ginormous brain-bender:</p><pre style="margin-left: 20px; line-height: 1; color: firebrick;"><br/>/^(?:"(.*?)"|'(.*)'|\$(.*)\$|%(.*)%|@(.*)@),(?:"(.*?)"|'(.*)'|\$(.*)\$|%(.*)%|@(.*)@)$/m</pre><p><br/>That's 88 characters of madness — but it worked. I'll leave it to you to puzzle out how it works. My friend challenged me to beat it. I couldn't run away from that!</p><p></p><p>Here's what I came up with:</p><pre style="margin-left: 20px; line-height: 1; color: firebrick;"><br/>/^([$"%'@])(.*?)\1,([$"%'@])(.*?)\3$/m</pre><p><br/>Just 38 characters, and much easier to understand if you know the slightly obscure little regex feature called <em>backreferences</em>. Let's pick it apart...</p><p></p><p>There are two sections that are nearly duplicates of each other. The first one of these is <span style="font-family=courier;color: FireBrick;">([$"%'@])(.*?)\1</span>. What's going on in there?</p><p></p><p>The first bit captures a single character that is one of our quote characters: <span style="font-family=courier;color: FireBrick;">([$"%'@])</span>. That's only going to match if the string has one of those characters at the beginning.</p><p></p><p>The next bit captures any character, reluctantly: <span style="font-family=courier;color: FireBrick;">(.*?)</span>.</p><p></p><p>Next is the obscure part: <span style="font-family=courier;color: FireBrick;">\1</span>. That's our new best friend, the backreference. A backslash followed by a number means "substitute the matching capture group" — in this case, capture group 1. That would be the capture group that captured the leading quote character. So if the leading quote character happened to be a dollar sign, this backreference would be turned into a dollar sign, and we'll match the <em>trailing</em> dollar sign. Holy obscure obscentities, Batman!</p><p></p><p>Just to complete the thought, there are two nearly identical sections there. The first one has a backreference to capture group 1, for the reasons given above. The second section has a backreference to capture group 3, because <em>its</em> leading quote character was captured by that capture group. If I call the first one of these sections "a", and the second "b", then this is what whole regex looks like: <span style="font-family=courier;color: FireBrick;">/^a,b$/m</span>. That's pretty easy to understand: look for beginning of line, one quoted string, a comma, another quoted string, and the end of line. Easy peasey lemon squeezy!</p><p></p><p>Now you've joined the sparse ranks of those who can explain a regex backreference — and what it's good for. That and $5 will get you a fine cup o'joe at your neighborhood <a title=".wikipedia.org/wiki/Spoonerism" href="http://en.wikipedia.org/wiki/Spoonerism">Barstucks</a>...</p>