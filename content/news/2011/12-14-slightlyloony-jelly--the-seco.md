---
title: "Jelly The Second Phase of Madness"
date: 2011-12-14T03:03:07.000Z
authors: ["SlightlyLoony"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=6cecea65dbd0dbc01dcaf3231f961961"
---
<p><span class="asset-asset_lightbox-Small asset-align-right"><a href="/files/SlightlyLoony/crazy-baby2.jpg" rel="lightbox"><img rel="lightbox" src="http://community.service-now.com/files/imagecache/Small/SlightlyLoony/crazy-baby2.jpg" alt="" title="" class="imagecache imagecache-Small" /></a></span>Now that you're expert on Jelly's two phases, and the differences between Jelly and JavaScript variables, you're probably thinking "Hey, my Jelly education is done! Where's my diploma?"<br /><br />Well, not so fast, grape jelly breath. There's still a <i>lot</i> to learn!<br /><!--break--><br />First, a commenter asked an important question, which I managed to forget to address: "What's the whole point of the multi-phase Jelly system, anyway?" Answer: it's <i>all</i> about performance. There isn't any other reason for it. Because the phase 1 output is cached (in memory), there is potentially (exactly how much varies from page to page) quite a large amount of work that is done just once, instead of every time a page is requested.<br /><br />Next, let's look at an example that illustrates a few things I want to talk about:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />&lt;?xml version="1.0" encoding="utf-8"?&gt;<br />&lt;j:jelly&gt;<br />    &lt;g:evaluate&gt;<br />        var title = 'Users for ' + gs.getUser().getFirstName() + ' ' + gs.getUser().getLastName();<br />        title;<br />    &lt;/g:evaluate&gt;<br />    &lt;g2:evaluate&gt;<br />        var users = new GlideRecord('sys_user');<br />        users.query();<br />    &lt;/g2:evaluate&gt;<br /><br />   <br /><b>$[jvar_title]</b><br />    &lt;j2:while&gt;<br />       <br />User: ${users.first_name} ${users.last_name}<br />    &lt;/j2:while&gt;<br />&lt;/j:jelly&gt;</pre><br />Oh, my. Where should I start? If you run this little gem, you'll get a gloriously blank screen. Absolutely nothing is displayed. Why is this? We'll tackle it one item at a time. First, consider these parts:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />    &lt;g:evaluate&gt;<br />        var title = 'Users for ' + gs.getUser().getFirstName() + ' ' + gs.getUser().getLastName();<br />        title;<br />    &lt;/g:evaluate&gt;<br /><br />   <br /><b>$[jvar_title]</b><br /></pre><br />We thought we were being <i>soooo</i> clever here! In the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag, we're building the title for our page. We're doing it in Phase 1 because it only needs to be done once for any given user. But...look at the last line, where we're actually rendering the title into HTML. There we used the JEXL expression <span style="font-family=Courier;color:FireBrick;">$[jvar_title]</span> — and those square brackets tell it to evaluate the JEXL in Phase 2. In Phase 2, the <span style="font-family=Courier;color:FireBrick;">jvar_title</span> variable isn't even defined, and so it has nothing in it (which is exactly what renders: <i>nothing</i>). Oops. There are two possible fixes for this that work equally well. The first fix is to simply change the JEXL expression to <span style="font-family=Courier;color:FireBrick;">${jvar_title}</span> so that it renders on Phase 1. The second is slightly trickier: there's an attribute you can add to the evaluate expression to tell Jelly to copy the value of the variable calculated in Phase 1 to the same variable in Phase 2. That would look like this:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />    &lt;g:evaluate&gt;<br />        var title = 'Users for ' + gs.getUser().getFirstName() + ' ' + gs.getUser().getLastName();<br />        title;<br />    &lt;/g:evaluate&gt;<br /><br />   <br /><b>$[jvar_title]</b><br /></pre><br />Now if you run it, you'll see a title — but nothing else. So what else did we do wrong? Take a look at these pieces of the puzzle:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />    &lt;g2:evaluate&gt;<br />        var users = new GlideRecord('sys_user');<br />        users.query();<br />    &lt;/g2:evaluate&gt;<br /><br />    &lt;j2:while&gt;<br /></pre><br />This is an example of phase mis-match — the <span style="font-family=Courier;color:FireBrick;">j2:while</span> tag gets evaluated in Phase 2, but the JEXL expression <span style="font-family=Courier;color:FireBrick;">${users.next()}</span> is evaluated in Phase 1. The JavaScript variable <span style="font-family=Courier;color:FireBrick;">users</span> was defined in the <span style="font-family=Courier;color:FireBrick;">g2:evaluate</span> tag, so in Phase 1 it doesn't even exist for the JEXL expression to evaluate. What ends up happening is that in Phase 1 the <span style="font-family=Courier;color:FireBrick;">while</span> tag gets turned into this:  — and in Phase 2 the test always returns false. That means that the inside of the while loop <i>never</i> executes. Bummer, dude. The fix is easy: change the JEXL test expression to <span style="font-family=Courier;color:FireBrick;">$[users.next()]</span> so that it evaluates in Phase 2. Now when you run it...it's still screwed up. But slightly less so: now we've got a column of "User:" down the left side of our screen. Now what? Maybe by now you can spot the problem:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />       <br />User: ${users.first_name} ${users.last_name}<br /></pre><br />It's another Phase mixup — we've used a Phase 1 JEXL expression to render the first and last name — but the script that queries the database to retrieve the user records is running in Phase 2. Again, the fix is simple: change the JEXL expressions to Phase 2, like <span style="font-family=Courier;color:FireBrick;">$[users.next()]</span>. Now when you run it...it works! A nice, ugly, dumb report. But it works!<br /><br />If it seems like I'm harping on this topic of Phase 1/Phase 2 mixups, well, it's because I am — and because it's one of the more common sources of problems with Jelly templates. When I build a Jelly template and the danged thing doesn't work on the first try (that would be <i>every</i> time), then the first thing I do is to look for some place where I got the Phases wrong. Maybe it's just me — could easily be! But you might want to check for those mixups in your own Jelly templates, too...</p>