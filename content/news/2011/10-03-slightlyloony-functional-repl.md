---
title: "Functional Replacements"
date: 2011-10-02T06:43:16.000Z
authors: ["SlightlyLoony"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=357d2269dbd0dbc01dcaf3231f961914"
---
<p><img  alt="" class="jive-image" src="ccb0e739db9c9fc0b322f4621f9619e9.iix" style="width: auto; height: 126px;" />The young lady at right is quite pleased with herself. Why, you ask? It's because she just discovered that JavaScript (by far her favorite programming language) lets you replace matches of a regular expression with the results of a function that returns a string — and the function has full access to the string, the matches, and any capture groups in the match.<br /><br />She's a precocious young lady, isn't she? Imagine knowing what a capture group was at her age!<br /><br />This is one of those things that's best explained by example. Let's suppose you wanted your program to format a column of numbers you've received in an array. You want the result to be right-justified, and you want commas to separate each group of three digits from the right. How might you write a program to do this, and why on earth would a replacement function be of use in doing so?<br /><br />Here's how we implemented it:<br /><!--break--><br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />// call our formatter with an array of arbitrary numbers...<br />formatter( [5,375,4982,2347023,47632,6128,724592] );<br /><br />// format the given array of numbers into a column of right-justified (in a field 12 characters wide), comma-grouped numbers...<br />function formatter(nums) {<br />    var text = nums.join('\n');<br />    var ans = text.replace(/(\d+)/g, nfRep);   // MAGIC: the replacement function nfRep() in use...<br />    gs.log('Unformatted:\n' + text);<br />    gs.log('Formatted:\n' + ans);<br />}<br /><br />// the replacement function<br />// the second parameters is all we care about; it contains the first capture group when we're invoked<br />// that has the number string we need to format...<br />function nfRep(match, num) {<br />    // first we put our commas in...<br />    var x = num;<br />    var same = false;<br />    while (!same) {<br />        var x1 = x.length;<br />        x = x.replace(/(\d)(\d\d\d)(?=(,|$))/, '$1,$2');<br />        same = (x1 == x.length);<br />    }<br />    // now we right-justify it, and we're done...<br />    x  = '           ' + x;<br />    return x.substr(x.length - 12);<br />}<br /></pre><br />Please don't run screaming from the room! It's not all <i>that</i> bad!<br /><br />The first thing this code does is to invoke the <i>formatter()</i> function with the array of numbers we want to format. The function turns the array into a string with a number on each line, then does the magic part by replacing each number with the results of the <i>nfRep()</i> function — the replacement function. The rest just prints out the before and after strings so you can see what they look like.<br /><br />Replacement functions are called once for each match of the regular expression. In this case, our regular expression <i>/(\d+)/g</i> matches strings of one or more digits. It's global, so it will match every occurrence of a string of digits. In our example we have 7 numbers in the array, so this regular expression will match 7 times, once for each number. That means the replacement function will also be called 7 times, once for each number.<br /><br />When replacement functions are called, the number and meaning of the arguments passed in depends on the regular expression. <br /><br />The first argument is always present, and it contains the string that was matched. In our example, the first time the replacement function was called, the first argument would contain a '5', the second time a '375', and so on for all 7 numbers.<br /><br />Next there is one argument for every parenthesized capture group in the regular expression. Our example has one such capture group (the <i>(\d+)</i>), so there's only one of these arguments in our case. Because our example's capture group is exactly the same as the entire matched text in the regular expression, the second argument's value is the same as the first argument's value. Silly, I know — but I wanted to show you how these capture group arguments work. If you use a more complex regular expression, with multiple capture groups, these capture group arguments are extremely useful.<br /><br />Finally, there is one last argument, after all the capture group arguments: this one is always the entire string being matched. In our example, we don't use this argument — but if we did, it would contain the seven numbers separated by newlines.<br /><br />Then at last there's our replacement function: <i>nfRep()</i>. <br /><br />The first bit inside the while loop looks trickier than it really is. JavaScript's regular expressions don't support look-behinds, so we worked around this by repeatedly looking for stretches of four digits followed by either the end of the line or a comma (that's what the <i>/(\d)(\d\d\d)(?=(,|$))/</i> is all about). If we find a match on that, then we know we need a comma between the first and second digits of our match, so we use a simple replacement to do that. We simply repeat that until there's no change in the string's length, which tells us that we didn't find any more places to stuff in a comma.<br /><br />The last bit is trivial: we just prepend 11 spaces to our number string (in case we had a short number) and return the 12 righthand-most characters. That returned string replaces the originally matched string of digits found by the regular expression in <i>formatter()</i>.<br /><br /><i>Voila!</i> You are now either drooling at your desk, with glazed eyes rotating independently of each other — or you're a certified replacement function expert! Our young lady is definitely in the latter category...<br /><br />So what happens when we run this puppy? I thought you'd never ask:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />Unformatted:<br />5<br />375<br />4982<br />2347023<br />47632<br />6128<br />724592<br /><br />Formatted:<br />           5<br />         375<br />       4,982<br />   2,347,023<br />      47,632<br />       6,128<br />     724,592<br /></pre><br />Now isn't that just the cutest thing you ever did see?</p>