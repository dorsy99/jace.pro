---
title: "Mass ADDPASTE Affected CIs into a change"
date: 2011-08-12T16:33:37.000Z
authors: ["mguy"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=5cfc62a5dbd0dbc01dcaf3231f961922"
---
<p>A customer recently asked me to implement a solution whereby they could grab a list of CIs from an excel spreadsheet and paste them straight into the affected CIs list within a change, as you know you could use the EDIT button to go find the CIs but if you have a big list that could take a while, so I went off and found a way to do this using a few pieces:<br /><br />1. a field on the change (can be hidden VIA UI policy) called Mass CIs (u_mass_cis)<br /><br />2. A UI Action (Add Mass CIs) which is going to be calling our old friend a UI Page (mass_add_cis)<br />Name: Add Mass CIs<br />Action: mass_add_cis<br />Onclick: massaddcis()<br />Client - True<br />Condition: define your own condition as to whom can do this and when<br /><br />Script:<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />function massaddcis() {<br />   //Get any values to pass into the dialog<br />   var number = g_form.getValue("number");<br /><br />   //Initialize and open the Dialog Window<br />var dialog = new GlideDialogWindow("mass_add_cis"); //Render the dialog containing the UI Page<br />dialog.setTitle("Add Affected CIs to " + number); //Set the dialog title<br />dialog.setSize(500,1000); //Set the dialog size<br />dialog.render(); //Open the dialog<br />}<br /></pre><br /><br /><br />3. A UI Page which is going to present the user with a large text box for them to paste the CIs into.<br />One thing I did notice is that I had to replace line breaks with commas so that in our next phase which is a business rule we can easily split the CIs:<br />I have attached the UI page html code as I noticed it disappears here (will fix this later)<br />Name: mass_add_cis<br />HTML:<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />&lt;g:ui_form&gt;<br />   &lt;!-- Set up form fields and labels --&gt;<br />   &lt;table width="100%"&gt;<br />     &lt;tr id="description_row" valign="top"&gt;<br />        &lt;td colspan="2"&gt;<br />           &lt;!-- Short description value used as a label --&gt;<br />           Use the box below to add or paste CIs into the box below in the following format:<br />        &lt;/td&gt;<br />     &lt;/tr&gt;<br />     &lt;tr id="description_row2" valign="top"&gt;<br />        &lt;td colspan="2"&gt;<br />           CI1<br />        &lt;/td&gt;<br />     &lt;/tr&gt;<br />     &lt;tr id="description_row3" valign="top"&gt;<br />        &lt;td colspan="2"&gt;<br />           CI2<br />        &lt;/td&gt;<br />     &lt;/tr&gt;<br />     &lt;tr&gt;<br />       &lt;td&gt;<br />         &lt;!-- Comments text field (Contains comments from originating record as a default) --&gt;<br />         &lt;g:ui_multiline_input_field name="dial_comments" id="dial_comments" label="Add or Paste CIs below" value="" mandatory="true" /&gt;<br />       &lt;/td&gt;<br />     &lt;/tr&gt;<br />     &lt;tr&gt;<br />       &lt;td colspan="2"&gt;<br />       &lt;/td&gt;<br />     &lt;/tr&gt;<br />     &lt;tr id="dialog_buttons"&gt;<br />        &lt;td colspan="2" align="right"&gt;<br />           &lt;!-- Pull in 'dialog_buttons_ok_cancel' UI Macro for submit/cancel buttons.<br />          'ok' option will call the 'validateComments' Client script function from the UI Page--&gt;<br />           &lt;g:dialog_buttons_ok_cancel ok="return validateCIs()" /&gt;<br />        &lt;/td&gt;<br />     &lt;/tr&gt;<br />  &lt;/table&gt;<br />&lt;/g:ui_form&gt;<br /></pre><br /><br />CLIENT SCRIPT in the UI Page:<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />function validateCIs() {<br />   //Gets called if the 'OK' dialog button is clicked<br />   //Make sure dialog comments are not empty<br />   var comments = gel("dial_comments").value;<br />   comments = trim(comments);<br />   if (comments == "") {<br />      //If comments are empty stop submission<br />      alert("Please provide comments to submit the dialog.");<br />      return false;<br />   }<br />   //If comments are not empty do this...<br />   GlideDialogWindow.get().destroy(); //Close the dialog window<br />var cis = comments.replace(/(\r\n|\n|\r)/gm,",");  //this turns line breaks into commas which are easier to split in the upcoming business rule<br />   g_form.setValue("u_mass_cis", cis); //Set the 'mass CIs' field with the values in the dialog<br />}<br /></pre><br /><br /><br />OK so now we have our CIs (comma seperated) in our field on the change form and next we will call a business rule next time the change is saved to convert these values into the affected CIs list:<br />We also check the CIs actually exist and if they don't then give them an error message<br /><br />Business Rule<br />Name: Add Mass CIs to CIs affected<br />when: before - insert or update<br />condition: current.u_mass_cis.changes()<br />script:<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />/*<br />Created to automatically add any list of Mass CIs added via the 'Add Mass CIs' action to the affected CIs related list<br />*/<br />addaffectedcis();<br /><br />function addaffectedcis(){<br />var chg = current.sys_id;<br />var cis = current.u_mass_cis;<br />var array = cis.split(",");  //split the cis into an array this is why we used commas<br />for (var i=0; i &lt; array.length; i++) {  //start going through each one<br />var cmdb = new GlideRecord('cmdb_ci'); //Indicate the table to query from<br />if(cmdb.get('name', array&lt;i&gt;))  //if CI is found in the cmdb database, n.b. We should not need to query as name should be unique so when we find it stop the query<br />{<br />//check to see its not already on the affected cis list<br />var gr = new GlideRecord('task_ci'); //Indicate the table to query from<br />//The 'addQuery' line allows you to restrict the query to the field/value pairs specified (optional)<br />gr.addQuery('task', current.sys_id);<br />gr.addQuery('ci_item.name', array&lt;i&gt;);<br />gr.query(); //Execute the query<br />if (gr.next()) { //While the recordset contains records, iterate through them<br />   //Do something with the records returned<br />gs.addErrorMessage('CI already in Affected CIs list: '  + array&lt;i&gt;);<br />}<br />else {<br />//Create a new Affected CI record on the task_ci table and populate the fields with the values below I.e. The change number and the ci itself<br />var taskci = new GlideRecord('task_ci');<br />taskci.initialize();<br />taskci.task = chg;<br />taskci.ci_item = cmdb.sys_id;<br />taskci.insert();<br />}<br /><br />}<br />else<br />{<br />gs.addErrorMessage('CI not found in CMDB!: ' + array&lt;i&gt;); //inform user ci cannot be found and show as error message does not stop submission though<br />}<br />}<br />current.u_mass_cis = '';  //empty the field out<br />}<br /></pre><br /><br />And that's it! so 1 new field, 1 UI Action, 1 UI Page and 1 Business rule later we have a solution, here are some screenshots attached of it in action!<br />unfortunately I've had to x out the names to protect CI names.</p>