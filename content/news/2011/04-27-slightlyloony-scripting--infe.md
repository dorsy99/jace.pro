---
title: "Scripting Inferring ManytoMany MM Relationships"
date: 2011-04-26T18:30:27.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=9cac2225dbd0dbc01dcaf3231f9619e5"
---
<p><img  alt="" class="jive-image" src="e6c288c2db18db048c8ef4621f961927.iix" style="width: auto; height: 113px;" />Yesterday I showed you how you could make a method that could be called like this (assuming, again, that <i>gr</i> contains a user record):<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />var gru = new GRUtil();<br />var roles = gru.getM2MList(gr, 'sys_user_has_role',<br />                           'user', 'role', 'sys_user_role');<br />while (roles.next())<br />   gs.log(roles.name);</pre><br /><br />That code works just fine, but it requires you (the code's author) to know several little details that are annoying to have to go look up: the many-to-many table name, and the parent and child references within that many-to-many table. Wouldn't it really be nice if you could just write this instead?<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />var gru = new GRUtil();<br />var roles = gru.getM2MList(gr, 'sys_user_role');<br />while (roles.next())<br />   gs.log(roles.name);</pre><br /><br />Well, you can — by <i>inferring</i> the many-to-many table name and reference fields. <br /><!--break--><br />The "trick" here is to realize that the <i>sys_collection</i> table (navigate to <i>System Maintenance â†’ Collections</i>) has all the information a piece of script would need to infer the rest. All you need to do is find a pair of records in the <i>sys_collection</i> table that were both for the same many-to-many table, and where one points to the parent table and the other to the child table. Then you know the many-to-many table and can read the reference fields directly from <i>sys_collection</i>. Woo hoo! The code below is a modified version of the method I showed you yesterday:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />   /*<br />    * Returns a GlideRecord instance containing the records related to the given parent (a GlideRecord)<br />    * in the given child table related through the given m2m_table with the given parent reference and<br />    * child reference fields.  If only the parent and the child table are given, the other parameters<br />    * are inferred from the sys_collection table.  Returns null if no collection could be inferred.<br />    */<br />   getM2MList: function(parent, some_table, parent_reference, child_reference, child_table) {<br />      if (arguments.length == 5)<br />         return this._getM2MList(parent, some_table, parent_reference, child_reference, child_table);<br /><br />      // if we just have the parent and the target table, infer the rest from the collection table...<br />      else if (arguments.length == 2) {<br />         var col_gr = new GlideRecord('sys_collection');<br />         var tables = this.getTables(parent.getTableName());<br />         tables = tables.concat(this.getTables(some_table)); // some_table is really the child table!<br />         col_gr.addQuery('name', tables);<br />         col_gr.query();<br />         var pairer = {};<br />         while (col_gr.next()) {<br />            var tbl = '' + col_gr.collection;<br />            if (pairer[tbl]) {<br />               // figure out which reference is to our parent and which is to our child...<br />               var parent_ref = '' + col_gr.join_field;<br />               var child_ref = pairer[tbl];<br />               if (this._array_has(this.getTables(some_table), '' + col_gr.name)) {<br />                  parent_ref = pairer[tbl];<br />                  child_ref = '' + col_gr.join_field;<br />               }<br />               return this._getM2MList(parent, tbl, parent_ref, child_ref, some_table);<br />            }<br />            pairer[tbl] = '' + col_gr.join_field;<br />         }<br />         return null;  // we couldn't infer a collection...<br />      }<br />   },<br /><br />   /*<br />    * Returns a GlideRecord instance containing the records related to the given parent (a GlideRecord)<br />    * in the given child table related through the given m2m_table with the given parent reference and<br />    * child reference fields.<br />    */<br />   _getM2MList: function(parent, m2m_table, parent_reference, child_reference, child_table) {<br />      var m2m_gr = new GlideRecord(m2m_table);<br />      m2m_gr.addQuery(parent_reference, parent.sys_id);<br />      m2m_gr.query();<br />      var kids = [];<br />      while (m2m_gr.next())<br />         kids.push('' + m2m_gr.getValue(child_reference));<br />      var kids_gr = new GlideRecord(child_table);<br />      kids_gr.addQuery('sys_id', kids);<br />      kids_gr.query();<br />      return kids_gr;<br />   },<br /><br />   /*<br />    * Returns true if the given array contains the given value.<br />    */<br />   _array_has: function(array, val) {<br />      for (var i = 0; i &lt; array.length; i++)<br />         if (val == array<i>)<br />            return true;<br /><br />      return false;<br />   },</i></pre><i><br /><br />You'll see that there are now two additional methods: _array_has() and _getM2MList(). The former is just a simply little utility method to see if a value appears in a list. The latter is the getM2MList() method from yesterday, just renamed. The leading underscore ("_") is a convention that we use to indicate a "private" method — that is, a method that we only expect to use within the same class.<br /><br />The new getM2MList method has some things in it worth understanding. First, note the use of the <a href="https://developer.mozilla.org/en/Core_JavaScript_1.5_Guide/Functions#Using_the_arguments_object"><i>arguments</i> object</a>. We check its length to see how many arguments someone actually called our method with. If we got five arguments, then it's a call exactly like the one I showed you yesterday, and we simply call the _getM2MList to do exactly what we did yesterday. On the other hand, if we're called with two arguments, then we're going to try to infer the missing arguments from the sys_collection table. That's what the code after the else if (arguments.length == 2) does.<br /><br />With this change, the getM2MList method can be called with either five arguments (just as in yesterday's blog post) or with two arguments, and it will do the right thing in both cases!</i></p>