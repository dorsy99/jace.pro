---
title: "Why Doesnt This Work  Or A Puzzle Explained"
date: 2011-10-21T18:50:50.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=d60deaa5dbd0dbc01dcaf3231f961979"
---
<p><span class="asset-asset_lightbox-Small asset-align-right"><a href="/files/SlightlyLoony/oldmanwtf.jpg" rel="lightbox"><img rel="lightbox" src="http://community.service-now.com/files/imagecache/Small/SlightlyLoony/oldmanwtf.jpg" alt="" title="" class="imagecache imagecache-Small" /></a></span>I'm told that just a few weeks ago, our correspondent at right looked like the young man he actually is. Then he tried to write what he thought was a simple little script on his company's ServiceNow instance. After a few days that involved facepalms, banging his head against the wall, banging other people's heads against the wall, screaming, and some possibly licit intoxicants … he looked like this.<br /><br />He should have contacted me earlier. He was doing <i>almost</i> everything correctly. All he was missing was one key piece of understanding, and the answer would have been obvious.<br /><br />He needed to understand composite tables.<br /><!--break--><br />First, let's look at his code that didn't work. He was trying to write a function which, given the IP address of a computer, would return its name. His function worked fine for workstations and laptops, but not for servers. Here's what he had:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />gs.log(findName('10.0.10.69'));<br /><br />function findName(ip) {<br />    var gr = new GlideRecord('cmdb_ci_ip_address');<br />    gr.addQuery('ip_address', ip);<br />    gr.query();<br />    if (!gr.next())<br />        return null;<br /><br />    var nic_id = '' + gr.nic;<br />    gr = new GlideRecord('cmdb_ci_network_adapter');<br />    if (!gr.get(nic_id))<br />        return null;<br /><br />    var computer_id = '' + gr.cmdb_ci;<br />    gr = new GlideRecord('cmdb_ci_computer');<br />    if (!gr.get(computer_id))<br />        return null;<br /><br />    var kind = '' + gr.sys_class_name;<br />    if (kind == 'cmdb_ci_computer')<br />        return '' + gr.name;<br /><br />    return '' + gr.host_name;<br />}</pre><br />Most of this is quite straightforward code that navigates through the CMDB database. First it finds the IP address table record with the desired IP address, then it uses that record's reference (<i>nic</i>) to locate the NIC (network adapter) record that is provisioned for that IP address. Once it has the NIC, it uses that record's CI reference (<i>cmdb_ci</i>) to locate the computer that the NIC is installed in. If any of this logic fails, it simply returns a null. So far, this is all just fine.<br /><br />Right near the end is where our prematurely old friend goes horribly wrong. His code looks at the class name (<i>sys_class_name</i>) of the computer record to see if it's a plain old computer (which would mean it was a workstation or laptop) or something else (which would mean it was some kind of server). If it's a computer, it returns the contents of the name field — this is the part the works just fine. But if it's a server, it tries to return the host name (a field that only servers have). This fails miserably, returning an 'undefined'. Our aged friend can go look at the record for the server with that IP address, and the host name is staring him right in the face. It's <i>there</i>, dang it! What's up with the undefined?<br /><br />The problem is that his code queried <i>cmdb_ci_computer</i>, not the actual server table. So what? Well, that's where you really need to understand composite tables...<br /><br />When you query the <i>cmdb_ci_computer</i> table, under the covers the ServiceNow instance is actually joining three tables together to produce the results you find in your GlideRecord instance:<br /><div style="margin-left:20px;margin-bottom:10px;line-height:1;color:FireBrick;">cmdb_ci â‰¡ cmdb_ci_hardware â‰¡ cmdb_ci_computer</div><br />All of the columns in all three of those tables are available to your GlideRecord instance. Our wizened friend's problem is that the <i>host_name</i> column is not in any of those tables — hence the undefined. Facepalm time.<br /><br />The fix is very straightforward — just "re-get" the record in question using a glide record for the actual class:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />gs.log(findName('10.0.10.69'));<br /><br />function findName(ip) {<br />    var gr = new GlideRecord('cmdb_ci_ip_address');<br />    gr.addQuery('ip_address', ip);<br />    gr.query();<br />    if (!gr.next())<br />        return null;<br /><br />    var nic_id = '' + gr.nic;<br />    gr = new GlideRecord('cmdb_ci_network_adapter');<br />    if (!gr.get(nic_id))<br />        return null;<br /><br />    var computer_id = '' + gr.cmdb_ci;<br />    gr = new GlideRecord('cmdb_ci_computer');<br />    if (!gr.get(computer_id))<br />        return null;<br /><br />    var kind = '' + gr.sys_class_name;<br />    if (kind == 'cmdb_ci_computer')<br />        return '' + gr.name;<br /><br />    gr = new GlideRecord(kind);<br />    if (!gr.get(computer_id))<br />        return null;<br /><br />    return '' + gr.host_name;<br />}</pre><br /><i>Voila!</i> This produces exactly the results that our antique friend wanted. Why? Well, in the case of our example, the computer in question was a Linux server. By using a query against <i>cmdb_ci_linux_server</i>, our GlideRecord joined five tables together to give us the results:<br /><div style="margin-left:20px;margin-bottom:10px;line-height:1;color:FireBrick;">cmdb_ci â‰¡ cmdb_ci_hardware â‰¡ cmdb_ci_computer â‰¡ cmdb_ci_server â‰¡ cmdb_ci_linux_server</div><br />The first three tables are the same as before, but the last two hold the key to the mystery: the <i>host_name</i> column is part of the <i>cmdb_ci_server</i> table. By querying (in this case) the Linux server table, the <i>cmdb_ci_server</i> table is automatically included in the query.<br /><br />How can you tell what attributes are in what table? Very easily! Just navigate to a list or form with examples of the table you're wondering about, right click on the bar, and select <i>Personalize â†’ Dictionary</i>. You'll get a list of all the columns available to that table, including all those columns that are joined together when you query that table through GlideRecord. The <i>Table</i> column tells you which table any particular column is in.<br /><br />Now we just need to find the fountain of youth for our old goat...</p>