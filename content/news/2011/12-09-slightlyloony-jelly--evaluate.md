---
title: "Jelly Evaluate  the Rest of the Story"
date: 2011-12-08T21:09:32.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=cafce2a5dbd0dbc01dcaf3231f9619c4"
---
<p><span class="asset-asset_lightbox-Small asset-align-right"><a href="/files/SlightlyLoony/funny-face5.jpg" rel="lightbox"><img rel="lightbox" src="http://community.service-now.com/files/imagecache/Small/SlightlyLoony/funny-face5.jpg" alt="" title="" class="imagecache imagecache-Small" /></a></span>I warned you yesterday that I'd have more to say about the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag, and today I'm here to deliver on that <del>threat</del>promise.<br /><br />Isaac doesn't look exactly <i>thrilled</i> at that prospect. But he should be!<br /><!--break--><br />The <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag has a few special features, all worth understanding. They're the kinds of things that you won't <i>always</i> need, but when you need 'em you'll be glad they're there...<br /><br />First up: the <span style="font-family=Courier;color:FireBrick;">var</span> attribute. Here's a sample that I'll explain in a second:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />&lt;?xml version="1.0" encoding="utf-8"?&gt;<br />&lt;j:jelly&gt;<br />    &lt;g:evaluate&gt;<br />        var random = 1 + (Math.floor((new Date().getTime() ${AMP} 0xffff) * Math.random()) % 6);<br />        random;<br />    &lt;/g:evaluate&gt;<br />   <br />Your rolled: ${jvar_die}<br />&lt;/j:jelly&gt;<br /></pre><br />Each time you run this page, it will roll a "virtual die" for you, and tell you the result. First, note that we've added the <span style="font-family=Courier;color:FireBrick;">var="jvar_die"</span> attribute to the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag. That attribute tells Jelly to assign the <i>result</i> (more on that in a second) of the JavaScript inside the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag to the Jelly variable named in the <span style="font-family=Courier;color:FireBrick;">var</span> attribute (in our case, <span style="font-family=Courier;color:FireBrick;">jvar_die</span>. <br /><br />The <i>result</i> is simply the value of the last statement in the JavaScript. The style you see here (where we made the last statement simply be the variable containing our result) is a simple, readable way to ensure that the result is what you want it to be. Try taking that statement out to see what happens! In this example, we could just as well have left that <span style="font-family=Courier;color:FireBrick;">var</span> out altogether, and just referenced the <span style="font-family=Courier;color:FireBrick;">random</span> JavaScript variable directly with the JEXL (<span style="font-family=Courier;color:FireBrick;">${random}</span>). But sometimes it's useful to have the result of an expression in a Jelly variable, and this is how you do it.<br /><br />In this example, if you'll look closely, I did something that just yesterday I told you to avoid like the plague: I used JEXL inside the JavaScript! Bad Loony, bad Loony! Wait a minute...not so fast. This is actually an example of an exception to my rule. Let me 'splain... The general problem with using JEXL inside an expression is that (usually) the result of a JEXL expression is potentially different every time you execute it. That's the actual cause of the problem we're trying to avoid when I tell you "Don't use JEXL inside the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag!" But in <i>this</i> case (and darned few others!), the JEXL expression will evaluate to exactly the same thing, each and every time. And in this solitary case, it's actually ok to use JEXL inside an <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag. Whew! Loony is off the hook!<br /><br />Next you might be wondering why on earth we have that JEXL in the first place. Here's why: that math expression needs to use the <i>bitwise AND</i> operator in JavaScript. That operator happens to be an "&amp;" — and that is a reserved character in XML. We're not allowed to write it directly inside an XML document. So instead, we created a constant (<span style="font-family=Courier;color:FireBrick;">AMP</span>) that you can access with JEXL <span style="font-family=Courier;color:FireBrick;">${AMP}</span> that renders the complicated-looking stuff you'd otherwise have to type in directly (that's <span style="font-family=Courier;color:FireBrick;">&amp;amp;</span>, in case you're wondering — a doubly-encoded HTML entity).<br /><br />Next up: the <span style="font-family=Courier;color:FireBrick;">expression</span> attribute. Our example:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />&lt;?xml version="1.0" encoding="utf-8"?&gt;<br />&lt;j:jelly&gt;<br />    &lt;g:evaluate/&gt;<br />   <br />Your rolled: ${jvar_die}<br />&lt;/j:jelly&gt;</pre><br />This one's easy. All I did was to move the code from the body of the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag up into the <span style="font-family=Courier;color:FireBrick;">expression</span> attribute. Well, that's <i>almost</i> all I did — I also eliminated the <span style="font-family=Courier;color:FireBrick;">random</span> variable altogether, as I never actually needed in the first place (I just wanted to show you how you could use the variable name as the last statement). The expression all by itself serves quite nicely as the <i>result</i> of the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag. Putting it in the <span style="font-family=Courier;color:FireBrick;">expression</span> attribute is a nice shorthand when the expression is small, simple, and (preferably) a single line. It wouldn't work so well for a larger script, like the one we used for yesterday's example.<br /><br />Next up: the <span style="font-family=Courier;color:FireBrick;">jelly</span> attribute. Our example:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />&lt;?xml version="1.0" encoding="utf-8"?&gt;<br />&lt;j:jelly&gt;<br />    &lt;g:evaluate/&gt;<br />    &lt;g:evaluate/&gt;<br />   <br />Your rolled: ${jvar_die}<br />&lt;/j:jelly&gt;<br /></pre><br />For this example, I broke the expression used to calculate the die into two parts. The first part just gets a number based on the current time (in milliseconds). The result of that first <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag is assigned to a Jelly variable — which then I want to use in the second <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag. By default, the Jelly variables are <i>not</i> visible to the JavaScript inside an <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag. By adding the <span style="font-family=Courier;color:FireBrick;">jelly="true"</span> attribute to an <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag, that changes: now the Jelly variables <i>are</i> available, using the syntax you see in my example: <span style="font-family=Courier;color:FireBrick;">jelly.</span> followed by the Jelly variable's name.<br /><br />Last up: the <span style="font-family=Courier;color:FireBrick;">object</span> attribute. Example:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />&lt;?xml version="1.0" encoding="utf-8"?&gt;<br />&lt;j:jelly&gt;<br />    &lt;g:evaluate&gt;<br />        var dice = new Packages.java.util.ArrayList();<br />        for (var i = 0; 10 &gt; i; i++) {<br />            var die = 1 + (Math.floor((new Date().getTime() ${AMP} 0xffff) * Math.random()) % 6);<br />            dice.add(die.toFixed(0));<br />        }<br />        dice;<br />    &lt;/g:evaluate&gt;<br />   <br />Your rolled:<br />       &lt;j:foreach&gt;${jvar_die} &lt;/j:foreach&gt;<br />   <br />&lt;/j:jelly&gt;</pre><br />This slight modification rolls our virtual die 10 times, then reports the results all at once. Inside the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag, the script creates an instance of the Java class <i>ArrayList</i>, then adds the 10 rolls of the die to it. We want the result of this <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag to be that <i>object</i> (the <i>ArrayList</i> instance) so that we can iterate over it with a <span style="font-family=Courier;color:FireBrick;">forEach</span> tag down a couple lines in the Jelly template. This is where the <span style="font-family=Courier;color:FireBrick;">object</span> attribute comes in. By default, the <span style="font-family=Courier;color:FireBrick;">object</span> attribute is false. In this mode, the result of the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag is converted to a string. If the result happens to be an object of some kind, that object's <span style="font-family=Courier;color:FireBrick;">toString()</span> method will be called to make the string. The result of this is, of course, just a string — and the <span style="font-family=Courier;color:FireBrick;">forEach</span> tag couldn't iterate over it. To deal with these situations, just set the <span style="font-family=Courier;color:FireBrick;">object</span> attribute to <i>true</i>, as in our example here. Then the result of the <span style="font-family=Courier;color:FireBrick;">evaluate</span> will be the actual object instance (in our case, the <i>ArrayList</i> instance), and the <span style="font-family=Courier;color:FireBrick;">forEach</span> tag will be a happy camper.<br /><br />One little quirk of the <span style="font-family=Courier;color:FireBrick;">forEach</span> tag that I forgot to mention yesterday: the collection that you iterate over (the one in the <span style="font-family=Courier;color:FireBrick;">items</span> attribute) <i>must</i> be a Java Collection — it does not work with JavaScript arrays, in particular — annoying, but unfortunately true...<br /><br />Well, that's about enough Jelly for one day, don't you think, Isaac?</p>