---
title: "Jelly Its Not Just Preserved Fruit"
date: 2011-12-07T22:07:23.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=a83eea6ddbd0dbc01dcaf3231f9619da"
---
<p><span class="asset-asset_lightbox-Small asset-align-right"><a href="/files/SlightlyLoony/evaluate-face.jpg" rel="lightbox"><img rel="lightbox" src="http://community.service-now.com/files/imagecache/Small/SlightlyLoony/evaluate-face.jpg" alt="" title="" class="imagecache imagecache-Small" /></a></span>Yesterday I introduced the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag, but didn't really say much about it. This post (and one or two more) we're going to spend some time understanding just what the heck that tag does. <br /><br />My young friend Whazzup (at right) is intensely interested in this, but I think I detect a little skepticism there. "So what if I can evaluate a script?" he asks. "What good is that gonna do <i>me</i>?"<br /><br />Well, Wazzup, it's like this: the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag is one of the wonders of the ServiceNow Jelly world, and it can do a <i>lot</i> for you...<br /><!--break--><br />Let's start with yesterday's example:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />&lt;?xml version="1.0" encoding="utf-8"?&gt;<br />&lt;j:jelly&gt;<br />    &lt;g:evaluate&gt;<br />        var colors = ['Red', 'Black', 'Blue', 'Brown', 'CadetBlue', 'DarkGreen', 'DeepPink'];<br />    &lt;/g:evaluate&gt;<br />    &lt;j:foreach&gt;<br />       <br />Color: $[SP] <span style="color:${jvar_color};">${jvar_color}</span><br />    &lt;/j:foreach&gt;<br />&lt;/j:jelly&gt;<br /></pre><br />The first thing to understand is <i>where</i> that script is running: it's running on the ServiceNow instance, <i>not</i> in the web browser. There are lots of implications to that. Scripts inside <span style="font-family=Courier;color:FireBrick;">evaluate</span> tags have full access to the information and resources on your ServiceNow instance. On the other hand, they do <i>not</i> have access to the web browser (client) environment: you can't look up HTML elements, show or hide things, etc.<br /><br />The second thing to understand is <i>when</i> that script gets executed: while the Jelly engine is processing this template. Here's an example that should make that clear:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />&lt;?xml version="1.0" encoding="utf-8"?&gt;<br />&lt;j:jelly&gt;<br />    &lt;g:evaluate&gt;<br />        var user = gs.getUser();<br />        var gr = new GlideRecord('sys_user_has_role');<br />        gr.addQuery('user', user.getID());<br />        gr.query();<br />        var roleIDs = [];<br />        while (gr.next())<br />           roleIDs.push('' + gr.role);<br />        gr = new GlideRecord('sys_user_role');<br />        gr.addQuery('sys_id', roleIDs);<br />        gr.query();<br />    &lt;/g:evaluate&gt;<br />   <br />Hello, ${user.getFirstName()} ${user.getLastName()}<br />   <br />Your user ID is: ${user.getID()}<br />   <br />You have these roles:<br />    &lt;j:while&gt;<br />       <br style="margin-left:15px;" />${gr.name}<br />    &lt;/j:while&gt;<br />&lt;/j:jelly&gt;<br /></pre><br />When I try out this UI Page, here's what I get:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />Hello, Completely Loony<br />Your user ID is: 0e8085600a0005896f731eba56151fe4<br />You have these roles:<br />    itil_admin<br />    knowledge_admin<br />    admin<br />    content_admin<br />    discovery_admin<br />    knowledge<br />    itil<br />    asset<br /></pre><br />What's going on here? <br /><br />Well, inside the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag you see a piece of ordinary-looking server-side script, the kind you might find in a business rule or a script include. This script is getting the current user from GlideSystem (the <span style="font-family=Courier;color:FireBrick;">gs</span> reference). It then uses this information to query the <span style="font-family=Courier;color:FireBrick;">sys_user_has_role</span> table, which is the many-to-many table that associates roles with users. Then it queries the roles table to find just those roles that the current user has. But it stops at the <span style="font-family=Courier;color:FireBrick;">gr.query()</span> statement, and you don't see the usual <span style="font-family=Courier;color:FireBrick;">while (gr.next())</span>, nor is it <i>doing</i> anything with the information it just queried the database for. Stupid script!<br /><br />But wait just a second. Look down at the Jelly <span style="font-family=Courier;color:FireBrick;">while</span> tag, in the <span style="font-family=Courier;color:FireBrick;">test</span> attribute. Here's where we're making use of that query: in the <span style="font-family=Courier;color:FireBrick;">while</span> tag we're testing to see if there's another record, and in the line following (the HTML <span style="font-family=Courier;color:FireBrick;">p</span> tag), we're getting and rendering the name of the role. That little "while loop", written in a mix of Jelly, HTML, and JEXL referencing our JavaScript variables does the trick of rendering the HTML we wanted. Well, <i>I</i> wanted it, anyway!<br /><br />By the way, pay no attention to what my traitorous computer thinks my name is!<br /><br />I'll leave you today with one word of caution: don't <i>ever</i> use JEXL expressions inside of an <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag. While it works, it has a very nasty side-effect: it consumes lots of a scarce resource (called "PermGen memory") on your instances Java Virtual Machine. There's nothing good about this, so you should avoid it at all costs. There's <i>always</i> another way to get the same job done, and we'll dig into those more in a later post. For now (and forever!) just remember this equation:<br /><br />evaluate + JEXL == BAD!<br /><br />So, Whazzup â€” do you see ways you could use the <span style="font-family=Courier;color:FireBrick;">evaluate</span> tag?</p>