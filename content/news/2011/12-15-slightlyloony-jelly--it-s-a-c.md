---
title: "Jelly Its a Crazy MixedUp World"
date: 2011-12-14T23:17:28.000Z
authors: ["SlightlyLoony"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=91ada2a9dbd0dbc01dcaf3231f961914"
---
<p>There's another aspect of Jelly that can easily confuse just about anybody. I've deliberately avoided showing it to this point, because I wanted you to have a solid understanding of the Jelly <span style="font-family=courier;color: FireBrick;">evaluate</span> tag, and Phase 1 and Phase 2 behavior first. If you're not clear on these things, <em>then don't click on the link below</em>, for that way lies madness. Instead, go back and review the earlier posts in this series until those things make sense.</p><p></p><p>If you're ready, then...</p><p></p><p>Take a look at the Jelly template below. It's a contrived example, but it concisely demonstrates the high confusion factor:</p><pre style="margin-left: 20px; line-height: 1; color: firebrick;"><br/>&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;j:jelly&gt;<br/>       &lt;g2:evaluate&gt;<br/>               var y = Math.random() * 100;<br/>               y;<br/>       &lt;/g2:evaluate&gt;<br/>       &lt;g:evaluate&gt;<br/>               color = 'Red';<br/>       &lt;/g:evaluate&gt;<br/>     <br style="margin-top: $[jvar_top]px; margin-left: $[jvar_left]px;"/><strong><br/>               This is a dumb test made just for you, $[gs.getUser().getFirstName()] $[gs.getUser().getLastName()].<br/>   </strong><br/> 

               $('ack').onclick = function(event){<br/>                       var e = $('ack');<br/>                       e.style.color = '${color}';<br/>               }<br/>     <br/>       &lt;g2:evaluate/&gt;<br/>&lt;/j:jelly&gt;</pre><p><br/>This Jelly template <em>almost</em> works. It puts up a message customized to the logged-in user, and if the user clicks on the message, it turns red. Woo hoo! The only part that's not working is that it's supposed to have a randomly-selected vertical and horizontal offset, and only the vertical is working. In addition to this functional problem, there's also a coding problem. We'll figure out what's wrong as we work our way through this thing.</p><p></p><p>One thing that makes this Jelly template confusing is that there are JavaScript bits that are running at three different times (Phase 1, Phase 2, and when the user clicks) and in two different places (the ServiceNow instance and the client's browser). That's a lot for a Jelly-head to keep track of — but keep track of it you <em>must</em> if you want to be able to understand (and create) Jelly templates that do useful things. Let's take it from the top:</p><pre style="margin-left: 20px; line-height: 1; color: firebrick;"><br/>       &lt;g2:evaluate&gt;<br/>               var y = Math.random() * 100;<br/>               y;<br/>       &lt;/g2:evaluate&gt;<br/><br/>     <br style="margin-top: $[jvar_top]px; margin-left: $[jvar_left]px;"/><strong><br/>               This is a dumb test made just for you, $[gs.getUser().getFirstName()] $[gs.getUser().getLastName()].<br/>   </strong></pre><p><br/>These are easy when you consider them one-at-a-time. Here a Phase 2 script is evaluted by the Jelly engine on the ServiceNow instance, computing a random vertical offset, putting the result into <span style="font-family=courier;color: FireBrick;">jvar_top</span>. Just below, a Phase 2 JEXL expression puts the value of <span style="font-family=courier;color: FireBrick;">jvar_top</span> into the <span style="font-family=courier;color: FireBrick;">margin-top</span> piece of the style attribute. Piece of cake! But look what's <em>also</em> in that style attribute: another Phase 2 JEXL expression that's putting the value of <span style="font-family=courier;color: FireBrick;">jvar_left</span> into the <span style="font-family=courier;color: FireBrick;">margin-left</span> piece. That's a problem, because <span style="font-family=courier;color: FireBrick;">jvar_left</span> hasn't even been defined at this point. Down a little further in the Jelly template, you can find this:</p><pre style="margin-left: 20px; line-height: 1; color: firebrick;"><br/>     <br style="margin-top: $[jvar_top]px; margin-left: $[jvar_left]px;"/><strong><br/>               This is a dumb test made just for you, $[gs.getUser().getFirstName()] $[gs.getUser().getLastName()].<br/>   </strong><br/><br/>       &lt;g2:evaluate/&gt;<br/>&lt;/j:jelly&gt;</pre><p><br/>Note that the Phase 2 evaluate tag that defines <span style="font-family=courier;color: FireBrick;">jvar_left</span> appears <em>after</em> the Phase 2 JEXL expression that tried to use it. Jelly processes the templates from top-to-bottom, so this just plain will not work. But the fix is trivial: just move that <span style="font-family=courier;color: FireBrick;">evaluate</span> tag to somewhere <em>before</em> the JEXL expression. Then it will work just fine.</p><p></p><p>Now let's look at the next part:</p><pre style="margin-left: 20px; line-height: 1; color: firebrick;"><br/>       &lt;g:evaluate&gt;<br/>               color = 'Red';<br/>       &lt;/g:evaluate&gt;<br/><br/>     <br style="margin-top: $[jvar_top]px; margin-left: $[jvar_left]px;"/><strong><br/>               This is a dumb test made just for you, $[gs.getUser().getFirstName()] $[gs.getUser().getLastName()].<br/>   </strong><br/><br/> 

               $('ack').onclick = function(event){<br/>                       var e = $('ack');<br/>                       e.style.color = '${color}';<br/>               }<br/>     </pre><p><br/>The Phase 1 <span style="font-family=courier;color: FireBrick;">evaluate</span> tag sets the JavaScript variable <span style="font-family=courier;color: FireBrick;">color</span> to 'Red' (hey, I warned you that this was a contrived example!). Spot the coding problem? We didn't put a <span style="font-family=courier;color: FireBrick;">var</span> at the start of it — and that means <span style="font-family=courier;color: FireBrick;">color</span> will be a <em>global</em> variable (possibly accidently changing the value of a global value that already exists). That's generally considered to be a very bad practice; just get in the habit of putting that <span style="font-family=courier;color: FireBrick;">var</span> in there. That Phase 1 <span style="font-family=courier;color: FireBrick;">evaluate</span> tag is evaluated on the ServiceNow instance. Now look in the <span style="font-family=courier;color: FireBrick;">script</span> tag toward the bottom. That tag is defining some JavaScript that will run in the <em>client browser</em> — but right in the middle of it there's a Phase 1 JEXL expression (<span style="font-family=courier;color: FireBrick;">${color}</span>). When Phase 1 is finished, that script tag will look like this:</p><pre style="margin-left: 20px; line-height: 1; color: firebrick;"><br/> 

               $('ack').onclick = function(event){<br/>                       var e = $('ack');<br/>                       e.style.color = 'Red';<br/>               }<br/>     </pre><p><br/>That is, of course, what actually gets sent to the browser. So...a Phase 1 script that ran on the ServiceNow instance <em>modified</em> a script that runs on the client browser. All totally normal in the land of Jelly!</p><p></p><p>Whew. If you actually understand everything we've talked about in this series, you're getting dangerously close to being a Jelly-head. Soon you will feel an unnatural attraction to the jelly aisle in your local grocery store. Any questions?</p>