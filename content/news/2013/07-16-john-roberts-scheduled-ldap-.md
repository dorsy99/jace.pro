---
title: "Scheduled LDAP Server Connection Test"
date: 2013-07-16T02:31:06.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=e79c2225dbd0dbc01dcaf3231f961921"
---
<p>Recently community user <a title="57948" href="/community?id=community_question&sys_id=6e668be1db1cdbc01dcaf3231f9619e9">pmendoza was looking</a> for a way to be notified whenever the instance was unable to connect to one of the LDAP servers. We do have plans for better LDAP diagnostics and monitoring in a future release but there are other options today. The first one I thought of was run a recurring scheduled script to perform the action of "test connection" that's currently available as a UI action on the LDAP server form.<br /><br /><b>** This script was designed for Calgary instances. To use pre-Calgary, try replacing "new GlideLDAP()" with<br /> "new Packages.com.glide.sys.ldap.LDAP()". I haven't tested the entire script in a pre-Calgary instance yet.</b><br /><br />Here's the setup:<br />Create an <a title="ki.servicenow.com/index.php?title=Event_Registry" href="http://wiki.servicenow.com/index.php?title=Event_Registry">event registry</a> so we can trigger an email when a test fails.<br />1. Go to the System Policy -&gt; Events -&gt; Registry module<br />2. Create a new Event Registry record with the following fields:<br /> Event name: ldap.connection_failed<br /> Table: LDAP Server [ldap_server_config]<br /> Fired by: LDAP Connection Test scheduled job<br /><br />Create an <a title="ki.servicenow.com/index.php?title=Email_Notifications" href="http://wiki.servicenow.com/index.php?title=Email_Notifications">email notification</a> to alert the admin(s).<br />1. Set the following field values (customize subject, message and recipients to fit your needs)<br /> Name: LDAP connection failed<br /> Table: LDAP Server<br /> Send when: Event is fired<br /> Event name: ldap.connection_failed<br /> Users: <i>whoever you want to let know about the failure</i><br /> Subject: LDAP Server ${name}: Failed test connection<br /> Message: LDAP Server ${name} failed connection test<br /> ${event.parm2}<br /> Link: ${URI_REF}<br /><br />Create a <a title="ki.servicenow.com/index.php?title=Creating_a_Scheduled_Job#Scheduling_Script_Execution" href="http://wiki.servicenow.com/index.php?title=Creating_a_Scheduled_Job#Scheduling_Script_Execution">scheduled script execution</a>.<br />1. Go to System Definition -&gt; Scheduled Jobs module<br />2. Create a new "Automatically run a script of your choosing"<br /> Name: LDAP Connection Test<br /> Run: Periodically<br /> Repeat interval: whatever interval you want<br /> Starting: now<br /> Run this script<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br />testLDAPServers();<br /><br />function testLDAPServers() {<br />     var ldapServer = new GlideRecord("ldap_server_config");<br />     ldapServer.addActiveQuery();<br />     ldapServer.query();<br />     while (ldapServer.next()) {<br />          var ldap = new GlideLDAP();<br />          //get ldap server config<br />          ldap.setConfigID(ldapServer.getUniqueValue());<br />          //setup connection<br />          var env = ldap.setup();<br />          if (env == null) {<br />               errMsg = "Failed environment setup, missing URL";<br />               gs.eventQueue("ldap.connection_failed",  ldapServer, ldapServer.getDisplayValue(), errMsg);<br />               gs.logError("LDAP server " + ldapServer.getDisplayValue() + " failed scheduled connection test: " + errMsg, "LDAP");   <br />               continue;<br />          }<br />          //try connection<br />       try {<br />          var context = new Packages.javax.naming.ldap.InitialLdapContext(env, null);<br />          context.close();<br />          //no exception so we're good on this one<br />       } catch(e) {<br />         errMsg = "Go to LDAP server record and perform a manual connection test for additional information.";<br /><br />          //fire event to trigger email notification<br />          //TODO - you need to create event registy and notification records<br />          gs.eventQueue("ldap.connection_failed",  ldapServer, ldapServer.getDisplayValue(), errMsg);<br />          gs.logError("LDAP server " + ldapServer.getDisplayValue() + " failed scheduled connection test. " + errMsg, "LDAP");   <br />          }<br />     }<br />}<br /></pre></p>