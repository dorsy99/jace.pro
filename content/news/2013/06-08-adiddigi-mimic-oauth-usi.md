---
title: "Mimic oAuth using HTTPClient  Post "
date: 2013-06-07T22:26:30.000Z
authors: ["adiddigi"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=cffc66a5dbd0dbc01dcaf3231f96199b"
---
<p>If you are new to oAuth, Please read these links first : http://oauth.net/2/ and http://en.wikipedia.org/wiki/OAuth. Go ahead, I'll wait.<br /><br /><em>Why are we talking about oAuth today?</em> Most of the services these days, are moving away from Basic Authentication for various reasons into oAuth. Twitter, Citrix Goto Meeting etc..<br /><br />Service Now doesn't exactly "support" oAuth. But Service Now is so extensible with HTTP Client, that you can mimic oAuth and its 3 - legged dance.<br /><br />For demonstrating this, I will do an oAuth authentication with Twitter. To make it more readable, I will do this in two posts. I chose twitter 'coz most of us use it, and there is a lot of help around.<br /><br /><br />Twitter oAuth flow is described in detail here : https://dev.twitter.com/docs/auth/implementing-sign-twitter<br /> It involves 3 steps:<br /><br />1. Obtaining a request token - You will use this token to re-direct your user to a page where he can gives access to your application. You must have seen this page often, where when you try to sign in using twitter, you will be redirected to a page which asks you if you grant permission. <br /><br />2. Once the user grants permission, collecting the token - Which says - the user Approved your application.<br /><br />3. Now this is the final step - In this step, we convert the token into a access token( remember the work "access" ) we, store this access token and we use it to make calls to Twitter API, on behalf of user. <br /><br />That in a nutshell is 3-legged dance.<br /><br /><br /><br /><br />We will not do anything fancy like the 3-legged dance today, but we will talk about the basic blocks of any oAuth authorization. i.e., We will start our communication from the Step 3 above. Twitter will allow the Author of the application to make calls to his own account. i.e., If I've created a Twitter app, and I want to only pull the data from my Twitter Account, I can simply skip the first two steps. Twitter gives me an Access Token when I create my app, which I can use to directly make calls to API. I know you must be wondering how this is oAuth. Its not, What we see today is the signing process and Percentage encoding process.<br /><br />We will be doing two things today:<br /> 1) Creating a new Twitter Application <br /> 2) Getting the tweets on your time line.<br /><br /> <em>Creating a new Twitter Application:</em> We need to create a Twitter App, so that any requests that go from Service Now to Twitter will be made from this application. Creating this Application is simple - Go to developers page here : https://dev.twitter.com/apps and create an app. You should note down 4 important things for today:<br /><br />1. Consumer Key of your application<br />2. Consumer Secret of your application<br />3. Access token <br />4. Access token Secret<br /><br /> <em>Getting tweets</em> <br /><br />Before going through the script, Please take some time to understand how Sign In is implemented in Twitter from here : https://dev.twitter.com/docs/auth/implementing-sign-twitter<br />https://dev.twitter.com/docs/auth/creating-signature<br />https://dev.twitter.com/docs/auth/authorizing-request <br /><br />Now, here's the Script to get the tweets from your timeline- Comments inline.<br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />var TwitterHelper = Class.create();<br />TwitterHelper.prototype = {<br />   initialize: function() {<br /><br /><br />      this.user = 'abhididdigi';<br />     <br />      // This should be the same callback which we specified while creating the app.   <br /><br />      this.callBack = 'http://www.servicenowdiary.com';<br /><br />      // Consumer key of your Twitter Application<br />      this.consumerKey = 'M3HO0VL55555555UnTA'; //dummy<br /><br />      // This is the random alphanumeric string that needs to be generated. Twitter needs this<br />      // to keep track of your requests<br />      this.nounce = this.getNonce();<br />     <br />      // This is the Algorithm that needs to be used to sign your requests to twitter.<br />      this.signature_method = "HMAC-SHA1";<br /><br />      // The time stamp is the amount of time in seconds since UNIX epoch<br />      this.timeStamp = this.getTimeStamp();<br /><br />      //Version of oAuth to be used.<br />      this.version = "1.0";<br />      this.encodedString = '';<br />      //Any other parameters that you want to set when you initialize this Script Include.<br />      this.method = 'POST';<br />      this.baseURL = "https://api.twitter.com/oauth/request_token";<br />     <br />     <br />     <br />     <br />     <br />   },<br />  <br />  <br />  <br />  <br />  <br />   getNonce:function(){<br />      // using generateGUID you can generate a sys_id, which is a random 32 &lt;strike&gt;bit &lt;/strike&gt; character  string.<br />      // We will use this to set nounce. <br />      return gs.generateGUID('');<br />     <br />   },<br />  <br />   // Simple - Using Packages.java.lang you get your time in seconds.<br />   //Note - Packages.java.&lt;&gt; are still supported. Thank God!<br />   getTimeStamp:function(){<br />      var a =Packages.java.lang.System.currentTimeMillis() / 1000;<br />      a = a.toString();<br />      a= a.split('.')[0];<br />      a = a*1;<br />      gs.log("TimeStamp" + a);<br />      return a;<br />     <br />   },<br />  <br />   <br /><br />   // Now this is the important part. Creating a Signature.You have to collect<br />   // all the parameters that you are sending and then, sign them. So that twitter<br />   // can confirm that its you sending the request, and not somebody else.<br /><br />   //This function takes 3 parameters.<br />   createGenericSignature:function(params,URL,method){<br /><br /><br />      var ts =  this.timeStamp+ '';<br />      var o = {};<br />     <br />     <br />      // We percent encode all the parameters, and then get them in the format<br />      // that twitter accepts.<br /><br />      o[this.percentEncode('oauth_consumer_key')] = this.percentEncode(this.consumerKey);<br />      o[this.percentEncode('oauth_nonce')] = this.percentEncode(this.nounce);<br />      o[this.percentEncode('oauth_signature_method')] = this.percentEncode(this.signature_method);<br />      o[this.percentEncode('oauth_timestamp')] = this.percentEncode(ts);<br />      o[this.percentEncode('oauth_version')] = this.percentEncode(this.version);<br />     <br />      for(var i in params){<br /><br />        o[this.percentEncode(i)] =  this.percentEncode(params&lt;i&gt;);<br /><br />     }<br /><br /><br />     var paramString  = this.percentEncode(o);<br /><br /><br /><br />    <br />     var baseString = method+"&amp;"+this.percentEncode(URL)+"&amp;"+this.percentEncode(paramString);<br /><br />     var MAC_ALG = "HmacSHA1";<br /><br /><br />    /* ! Important !*/<br />    // Here the key is generate using Consumer secret and the Access token Secret that you<br />    // collected above. So the format is &lt;b&gt;consumer_secret&amp;access_token_secret&lt;/b&gt;<br /><br /><br />     key = this.percentEncode('DNiwawdawdawddddddddddddddHgMe61DYhZw1pI')+'&amp;'+'cyVKrbpFQ8cw5iTSawdDTGuwdawdawdawdzpOtxWi5sz09Ig'; //dummies<br />     // We sign it using HMACSHA1<br /><br />     var signat =  Packages.com.snc.authentication.digest.Authentication.encode(baseString,key, MAC_ALG);<br />    <br />     // Here comes the subtlety of Javascript, signat stores a Java.lang.String object! <br />     // Hence typecasting it into a Javascript string.<br />     signat = signat+'';<br />     return signat;<br /><br /><br /><br /><br /><br />  },<br /><br />  //This function makes all the POST and GET calls.<br />  //Today we look at GET because we are getting our time line.<br />  makeCall:function(params,signature,method,URL,body){<br /><br />//Get HTTP Client instance.<br />   var client = new Packages.org.apache.commons.httpclient.HttpClient();<br />   var arr = [];<br /><br /><br /><br />  //Prepare as per the format needed.<br />   var prep = {};<br /><br /><br />   prep[this.percentEncode('oauth_consumer_key')] = '"' + this.percentEncode(this.consumerKey) +'"';<br />   prep[this.percentEncode('oauth_nonce')] = '"' + this.percentEncode(this.nounce) +'"';<br />   prep[this.percentEncode('oauth_signature')] = '"' + this.percentEncode(signature) +'"';<br />   prep[this.percentEncode('oauth_signature_method')] = '"' + this.percentEncode(this.signature_method) +'"';<br />   prep[this.percentEncode('oauth_timestamp')] = '"' + this.percentEncode((this.timeStamp+'')) +'"';<br />   prep[this.percentEncode('oauth_version')] = '"' + this.percentEncode(this.version) +'"';<br />   for(var i in params){<br />      prep[this.percentEncode(i)] = '"' + this.percentEncode(params&lt;i&gt;+'') +'"';<br /><br /><br />   }<br /><br /><br />   for(var i in prep){<br />      if (prep.hasOwnProperty(i)) {<br /><br />         arr.push(i+"="+prep&lt;i&gt;);<br /><br />      }<br /><br />   }<br />   arr.sort();<br />   var strA = ', ';<br />   var finalStr = arr.join(strA);<br />   finalStr = "OAuth "+ finalStr;<br />   gs.log(finalStr);<br /><br /><br /><br /><br />   if(method == 'GET'){<br />     var get =<br />     new Packages.org.apache.commons.httpclient.methods.GetMethod(URL);<br />    <br />     //Set the request header.<br />     get.setRequestHeader("Authorization",finalStr);<br />     get.setRequestHeader("Content-Type","application/x-www-form-urlencoded");<br />     var status = client.executeMethod(get);<br />     gs.log(status);<br />     //Execute.<br />     gs.log("Response"+ get.getResponseBodyAsString());<br />     var json = new JSON();<br />     var obj = json.decode(get.getResponseBodyAsString());<br />     //Logging your time line.You have the JSON object now. Send it to client side, Display it/Store it.<br /><br />     JSUtil.logObject(obj);<br /><br /><br />     get.releaseConnection();<br /><br />  }<br /><br /><br /><br /><br />},<br /><br />// Place where it all starts...<br /><br />own:function(){<br /><br />   var ts =  this.timeStamp+ '';<br /><br /><br />   var o = {};<br />    /*! Important !*/<br /><br />// Here is the Access Token that you collected above.<br />   o['include_entities'] = 'true';<br />   o['oauth_token'] = '58825564-l9gngrh4nAswUawdawdawdawdawdbZAFZuaQffD3GOjFg'; //dummy<br />  <br />   var signat = this.createGenericSignature(o,'https://api.twitter.com/1.1/statuses/home_timeline.json','GET')<br />   var s = {};<br />  <br />   /*! Important !*/<br /><br />// Here is the Access Token that you collected above.<br />   s['oauth_token'] = '58825564-l9gngrh4nAsxdfsdfsdfsdfsdfA5bZAFZuaQffD3GOjFg';//dummy<br /><br /><br />   this.makeCall(s,signat,'GET','https://api.twitter.com/1.1/statuses/home_timeline.json?include_entities=true','');<br /><br />},<br /><br /><br /><br /><br />//Utility functions.<br /><br /><br /><br />// Percentage Encode function - Encodes the given parameters in UTF-8.<br />percentEncode:function(params){<br /><br />   if(typeof params =='string'){<br /><br />      var ENCODING = "UTF-8";<br />      var s = params;<br />      s= s.toString();<br />      //URLEncoder still works!<br /><br />      // Replacing characters like +,* as they need to be encoded differently as per oAuth<br />      var a = Packages.java.net.URLEncoder.encode(s, ENCODING).replace("+", "%20").replace("*", "%2A").replace("%7E", "~");<br /><br />      var a = a+'';<br /><br />      return a;<br /><br />   }<br /><br />   if(typeof params == 'object'){<br />      var arr = [];<br /><br /><br />      for(var i in params){<br />         if (params.hasOwnProperty(i)) {<br /><br />            arr.push(this.percentEncode(i)+"="+this.percentEncode(params&lt;i&gt;));<br /><br />         }<br /><br />      }<br />      arr.sort();<br />      return arr.join('&amp;');<br /><br /><br />   }<br /><br /><br />},<br /><br /><br /><br /><br /><br />type: 'TwitterHelper'<br />};<br /><br /></pre><br /><br />Usage:<br /><br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />new TwitterHelper().own();<br /></pre><br /><br />We will dance in the next post! <br /><br />Note 1: More information on Percentage Encode : http://servicenowdiary.com/2013/06/a-server-side-function-to-percent-encode/<br />Note 2: Folks on Calgary, I'm sorry. I don't know how to replace HTTPClient Package call. <br />Raised a <a title="57541" href="/community?id=community_question&sys_id=a2498725db5cdbc01dcaf3231f961909">forum topic</a> too, Keep an eye on it if you are interested.<br />Its not mentioned here too : http://wiki.servicenow.com/index.php?title=Packages_Call_Replacement_Script_Objects , But you will find replacements for all other Package calls used in this post in the above link.</p>