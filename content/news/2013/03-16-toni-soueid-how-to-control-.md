---
title: "How to control the available choices of a choice list in a ServiceNow form"
date: 2013-03-15T20:14:24.000Z
authors: ["toni.soueid"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=9b3d6ee5dbd0dbc01dcaf3231f961927"
---
<p>In this blog post I show how one can control the list of available choices in a ServiceNow form depending on the current choice of a record.<br /><br /><h2>Setting the context</h2><br />For a practical illustration, we will be controlling the list of available choices of the State field of an incident.<br />In the out of the box installation of ServiceNow (for example on demo.service-now.com), an Incident can have the following states:<br /><br /><img  alt="" class="jive-image" src="047d733ddb501344e9737a9e0f9619b0.iix" style="width: 365px; height: auto;" /><br /><br />We will be controlling the list of choices for the incident state as per the following state diagram:<br /><br /><img __jive_id="7339" alt="incidents fsm" class="jive-image" style="width: tsoueid/screen-shot-2013-01-28-at-15-05-07.png; height: auto;" /><br /><br />As per the diagram, we can only move into the Active state either from the New state or if the incident is just being created.<br /><br /><h2>Step 1: creating a states transition table</h2><br /><br />In order to make the solution as dynamic as possible we create a new table in ServiceNow named incident_state_matrix having two columns (source_state, destination_state).<br /><br />This table has two choice fields 'Source State' and 'Destination State' that allow inserting valid transitions. These fields are choice lists that are are based on the incident states from the Incident [incident] table as per the screenshot below.<br /><br /><img  alt="" class="jive-image" src="6a4fb086db909f048c8ef4621f961909.iix" style="width: 439px; height: auto;" /><br /><br />In this table we insert rows that represent the allowed transitions in the above diagram. Below is a screenshot of the populated table:<br /><br /><img  alt="" class="jive-image" src="2bfb5c4adb9c17049c9ffb651f9619c9.iix" style="width: 797px; height: auto;" /><br /><br /><h2>Step 2: Business rule that propagates the allowed states of an incident to the client browser</h2><br /><br />Create the following business rule:<br /><br /><b>Name:</b> Allowed Incident States<br /><b>Table:</b> Incident<br /><b>When:</b> display<br /><b>Active:</b> true<br /><br />In the script section paste the following:<br /><br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />getAllowedStates();<br /><br />function getAllowedStates() {<br />  var current_state = current.state;<br />  var ismgr = new GlideRecord('u_incident_states_matrix');<br />  ismgr.addQuery('u_source_state', current_state);<br />  ismgr.query();<br /><br />  var allowed_states = [];<br />  var index = 0;<br /><br />  while (ismgr.next()) {<br />    allowed_states[index++] = ismgr.u_destination_state.toString();<br />  }<br /><br />  g_scratchpad.allowed_states = allowed_states;<br />}<br /></pre><br /><br />What is the above business rule does is generate an array of allowable states that is sends to the client browser as a scratchpad object.<br />A client script on the client side will have to process the propagated array and control the list of selectable choices.<br /><br /><h2>Step 3: Create a helper UI Script that facilitates enabling/disabling choice list options</h2><br /><br />Note: this script is inspired from a post that appeared on the SNCGuru blog at http://www.servicenowguru.com/scripting/client-scripts-scripting/removing-disabling-choice-list-options/<br /><br />Create the following UI Script:<br /><br /><b>Name:</b> DisableEnableOptions<br /><b>Active:</b> true<br /><b>Global:</b> true<br />Paste the following script:<br /><br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />function disableAllOptions(fieldName) {<br />  fieldName = g_form.removeCurrentPrefix(fieldName);<br />  var control = g_form.getControl(fieldName);<br />  if (control &amp;amp;&amp;amp; !control.options) {<br />    var name = 'sys_select.' + this.tableName + '.' + fieldName;<br />    control = gel(name);<br />  }<br />  if (!control)<br />    return;<br /><br />  if (!control.options)<br />    return;<br /><br />  var options = control.options;<br />  for (var i = 0; i &lt; options.length; i++) {<br />    var option = options&lt;i&gt;;<br />    control.options&lt;i&gt;.disabled = 'true';<br />  }<br />}<br /><br />function disableOption(fieldName, choiceValue) {<br />  fieldName = g_form.removeCurrentPrefix(fieldName);<br />  var control = g_form.getControl(fieldName);<br />  if (control &amp;amp;&amp;amp; !control.options) {<br />    var name = 'sys_select.' + this.tableName + '.' + fieldName;<br />    control = gel(name);<br />  }<br />  if (!control)<br />    return;<br /><br />  if (!control.options)<br />    return;<br /><br />  var options = control.options;<br />  for (var i = 0; i &lt; options.length; i++) {<br />    var option = options&lt;i&gt;;<br />    if (option.value == choiceValue) {<br />      control.options&lt;i&gt;.disabled = 'true';<br />      break;<br />    }<br />  }<br />}<br /><br />function enableOption(fieldName, choiceValue) {<br />  fieldName = g_form.removeCurrentPrefix(fieldName);<br />  var control = g_form.getControl(fieldName);<br />  if (control &amp;amp;&amp;amp; !control.options) {<br />    var name = 'sys_select.' + this.tableName + '.' + fieldName;<br />    control = gel(name);<br />  }<br />  if (!control)<br />    return;<br /><br />  if (!control.options)<br />    return;<br /><br />  var options = control.options;<br />  for (var i = 0; i &lt; options.length; i++) {<br />    var option = options&lt;i&gt;;<br />    if (option.value == choiceValue) {<br />      control.options&lt;i&gt;.disabled = '';<br />      break;<br />    }<br />  }<br />}<br /></pre><br /><br /><h2>Step 4: Client script that controls the list of choices</h2><br /><br />Create the following client script:<br /><br /><b>Name:</b> Allowed Incident States<br /><b>Active:</b> true<br /><b>Global:</b> true<br /><b>Type:</b> onLoad<br /><b>Table:</b> Incident<br /><br />In the script section paste the following:<br /><br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />function onLoad() {<br />  try {<br />    var current_state = g_form.getValue('state');<br />    disableAllOptions('state');<br />    enableOption('state', current_state);<br />    var allowed_states = g_scratchpad.allowed_states;<br />    var nb_states = allowed_states.length;<br />    for (var index = 0; index &lt; nb_states; index++) {<br />      enableOption('state', allowed_states[index]);<br />    }<br />  }<br />  catch (err) {<br />    jslog(err.message);<br />  }<br />}<br /></pre><br /><br /><h2>Step 5: Business rule that checks if a state is allowed before saving a record</h2><br /><br />Create the following business rule:<br /><br /><b>Name:</b> Check If Incident State Allowed<br /><b>Table:</b> Incident<br /><b>Active:</b> true<br /><b>When:</b> before<br /><b>Insert:</b> true<br /><b>Update:</b> true<br /><br />Paste the following script:<br /><br /><pre __default_attr="plain" __jive_macro_name="code" class="jive_text_macro jive_macro_code"><br /><br />checkIfStateAllowed();<br /><br />function checkIfStateAllowed() {<br /> var bad_state = true;<br /> //If the record is being inserted then previous.state is null<br />var previous_state = previous.state.toString() == 0 ? 1 : previous.state.toString();<br /> var current_state = current.state.toString();<br /><br /> if (previous_state != current_state) {<br /><br /> var ismgr = new GlideRecord('u_incident_states_matrix');<br /> ismgr.addQuery('u_source_state', previous_state);<br /> ismgr.query();<br /><br /> while (ismgr.next()) {<br /> if (current_state == ismgr.u_destination_state.toString()) {<br /> bad_state = false;<br /> break;<br /> }<br /> }<br /><br /> if (bad_state == true) {<br /> //If current.state did not match any destination state then we have to abort<br /> gs.addErrorMessage('Incident State Not Allowed');<br /> current.setAbortAction(true);<br /> }<br /> }<br />}<br /></pre><br /><br /><h2>Testing</h2><br /><br />To test the solution create a new incident as per the below screenshot:<br /><br /><img  alt="" class="jive-image" src="cb2a773ddb50db048c8ef4621f9619c6.iix" style="width: 234px; height: auto;" /><br /><br />On the form you will notice that only the New and Active states are available:<br /><br /><img  alt="" class="jive-image" src="eb2ba10edb901744e9737a9e0f961973.iix" style="width: 337px; height: auto;" /><br /><br />If we set the incident state to Active and save the form then the list of available choices changes:<br /><br /><img  alt="" class="jive-image" src="7dc34506db149f048c8ef4621f961920.iix" style="width: 300px; height: auto;" /><br /><br />I hope this blog post has been useful for you.<br /><br /><b>Toni Soueid</b><br />Technical Consultant<br /><b>Service<font color="red">Now</font></b><br />France</p>