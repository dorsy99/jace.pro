---
title: "Using PrePost Processing Scripts to handle reference fields via Discovery Pattern"
date: 2018-02-12T20:36:04.000Z
authors: ["Patrick DeCarlo"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=c0ac2225dbd0dbc01dcaf3231f96198d"
---
<p>For those who have made the jump to creating new discovery patterns to replace you probes/sensors or new patterns in general you will find its hard to set a reference field value via the pattern for fields that are not CI base. Ex: location, company, Assigned to and etc.</p><p></p><p>However, there is a feature that is not on the doc site nor developer site call Pre/Post Processing Scripts. In the nav menu under Pattern Designer -&gt; Pre Post Processing you will see 20 plus OOTB scripts already in use for OOTB patterns. The script allows you to select when the code needs to execute by three options.</p><p></p><p><strong>1. Pre Execution:</strong></p><p>Pre execution: This script will run before the execution of the assigned pattern/sit allows the user to add data that can be accessed by the running the pattern this is done by adding variables to the scriptable PrePatternExecutionData object below is an example of the possible variables that can be added.</p><p></p><p><strong>2. Pre sensor: </strong></p><p>You can change payload before it will be processed by Identification Engine. Use IEJsonUtility in order to add relevant information to the payload Input parameters in Pre sensor mode: payload, patternId</p><p></p><p><strong>3. Post sensor:</strong></p><p>You can update/add missing info to the DB based on result (Json) from Identification Engine Output parameters in Post sensor mode: payload</p><p></p><p><strong>So why is this important? </strong></p><p>When you use pattern step to set a reference field value you will not have a sys_id of the reference record. For example, I want to sent location field during my discovery(Outside the Discovery Schedule options)of devices or application. The devices/app only knows the location value by the string form and doesnt know anything about SN and sys_ids. In the pattern you set the field value with the string value seen below, but when record gets updated all you have is a reference field with blank value but via the xml you see the string value. So what can you do to fix this issue?</p><p></p><p><img   alt="Identification_for_HTTP_S__entry_point_type_s__for_IIS7_and_above_-_IIS_and_Inbox_•_Evergreensys.png" class="image-1 jive-image" src="1a8a237ddbd0df04e9737a9e0f961977.iix" style="width: 620px; height: 463px;"/></p><p>(<em>Yes, I know this is probably a bad example but it gets the job done.</em>)</p><p></p><p>For this example, I choose to make a Pre Sensor executed script. My goal is to update the payload to replace string value with sys_id of location record before the identification engine runs to create/update CI record within SN.</p><p>Before we take action to update the payload you will see in below screenshot the location data coming over as string value.</p><p></p><p><img   alt="https___dev31064_service-now_com_ecc_queue_do_sys_id_4561e5ffdb0c13002a98d740cf96195c_sys_target_payload_XML__sysparm_domain_restore_false_sysparm_stack_no_and_HorizontalDiscoveryProbe___ServiceNow.png" class="image-2 jive-image" src="c9239d46dbd89f048c8ef4621f96197a.iix" style="width: 620px; height: 335px;"/></p><p></p><p>Create new pre/post script. Make sure you select the pattern(s) it needs to run after and when to run. </p><p></p><p><img  alt="TEST_Location___ServiceNow.png" class="image-4 jive-image" src="630e4402db1417041dcaf3231f96195e.iix" style="width: 620px; height: 327px;"/></p><p></p><p>In the script(below) we need to read payload and update the location value(lines 18 thru 36) with sys_id that matches the location record within SN.</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_15184454550007440 jive_macro_code jive_text_macro" data-renderedposition="1940_8_1192_784" jivemacro_uid="_15184454550007440"><p>/*</p><p> *   1. Pre sensor:   You can change payload before it will be proccesed by Identification Engine.</p><p> *     Use IEJsonUtility in order to add relevant information to the payload</p><p> *         Input parameters in Pre sensor mode: payload, patternId</p><p> *   2. Post sensor: You can update/add missing info to the DB based on result (Json) from</p><p> *         Identification Engine</p><p> *         Output parameters in Post sensor mode: payload</p><p> *</p><p> */</p><p>var rtrn = {};</p><p></p><p>//parsing the json string to a json object</p><p>var payloadObj = JSON.parse(payload);</p><p></p><p>//put your business logic here</p><p>var handleLocationdata = function(){</p><p>//gs.info('PD: handleLocationdata = Running');</p><p>var location = '';</p><p>var payloadItems = payloadObj.items;</p><p>for(var i=0; i &lt; payloadItems.length; i++) {</p><p>if (payloadItems[i].className === 'cmdb_ci_microsoft_iis_web_server') { //Get location key under the class</p><p>var currentItem = payloadItems[i];</p><p>location = currentItem.values.location;</p><p>// gs.info('PD: handleLocationdata = location   == '+location);</p><p>if(location &amp;&amp; location.length){</p><p>var loc = new GlideRecord('cmn_location');</p><p>if(loc.get('name', location)){ //look up location sys_id by location name field. </p><p>//gs.info('PD: handleLocationdata = location   == '+loc.sys_id);</p><p>currentItem.values.location = loc.sys_id+''; // need to fix.</p><p>}</p><p>}</p><p>}</p><p>}</p><p>};</p><p></p><p>handleLocationdata();</p><p></p><p>//gs.info('PD: handleLocationdata =   JSON'+ JSON.stringify(payloadObj)); //output of the new payload</p><p></p><p>//you can return a message and a status, on top of the input variables that you MUST return.</p><p>//returning the payload as a Json String is mandatory in case of a pre sensor script, and optional in case of post sensor script.</p><p>//if you want to terminate the payload processing due to your business logic - you can set isSucess to false.</p><p>rtrn = {'status':{</p><p>'message':'Enter your message here',</p><p>'isSuccess':true</p><p>},</p><p>'patternId':patternId,</p><p>'payload':JSON.stringify(payloadObj)</p><p>};</p></pre><p></p><p>After script runs you can see in the log output(below) on line 38, the script updated the payload value with sys_id of location record within SN.</p><p></p><p><img   alt="Log___ServiceNow.png" class="image-3 jive-image" src="005da00edb185f048c8ef4621f9619e8.iix" style="width: 620px; height: 144px;"/></p><p></p><p>I hope above example helps. I will make updates to my post when I get more information.</p>