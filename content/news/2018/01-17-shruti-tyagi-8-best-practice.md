---
title: " Best Practices for Supporting Domain Separation"
date: 2018-01-16T06:14:07.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=e36caea1dbd0dbc01dcaf3231f961991"
---
<p><a title="ocs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/reference/domain-sep-landing-page.html" href="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/reference/domain-sep-landing-page.html">Domain separation</a> is a way to separate data, processes, and administrative tasks into logically defined domains. It is best suited for Managed Service Providers (MSPs) or for companies that have a global presence with unique and varying business requirements for different parts of the world.</p><p></p><p>Before implementing domain separation, you need to carefully consider whether or not it is well suited for your organization's business requirements. <em>Once domain separation is enabled, there is no simplified way to disable it.</em> While it can be disabled by turning off some properties and applying some additional changes, the process of disabling it is not so clean. So surely determine whether or not it is the right approach for the organization before enabling it.</p><p></p><p>There can be several other alternatives to domain separation, such as before query business rules, ACLs to limit data visibility among users and groups, filters, form layout views, view rules to limit form view, and fields by users and groups.</p><p></p><p>In the next few sections, I will explain some best practices for admins to consider when supporting domain separation.</p><p></p><h1>8 Best Practices for supporting domain separation</h1><ol><li><p>Performance Considerations</p></li><li><p>Domain Hierarchy</p></li><li>Domain logs</li><li>Default Domains</li><li>Contains and User/Group Visibility</li><li>Domain Query Method</li><li>Debug SQL</li><li>Contains and User/Group Visibility</li></ol><p></p><h2>1. Performance Considerations</h2><p><strong>Limit the number of domains</strong></p><p>Admins have the ability to create as many domains as needed, but it is important to make sure unnecessary domains are not created on the instance. Why? Because everything comes with a price, and a large number of domains on the instance can cause a performance impact. For example, it can slow down the domain picker and hence slow down the overall user experience. Specifically, if you are loading domain picker on the header and have a large number of domains, the domain picker has to load all domains before giving the user control on their session. This could lead to an outage situation as the user is unable to access anything on the instance until the domain picker is done rendering its results.</p><p></p><p>Before creating new domains, check the domain hierarchy under Domain Admin --&gt; Domain Map and make sure you actually need to create a new domain or existing Domain Hierarchy will work.</p><p></p><p><strong>Use the UI16 Domain Picker </strong></p><p><strong><a title="ocs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/task/t_EnableDomainReferencePickerProperty.html" href="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/task/t_EnableDomainReferencePickerProperty.html">Domain Reference Picker</a> </strong>available in UI16. With the reference picker, you are not loading all the domains all at once, but rather the domain will be searched as the user types into the domain picker. This will give better performance when the user logs in to the instance.</p><p></p><p><a title="ocs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/task/t_EnableDomainReferencePickerProperty.html" href="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/task/t_EnableDomainReferencePickerProperty.html">Enable the domain reference picker in UI16</a> by following the steps below:</p><ol><li>Enter sys_properties.list in the application navigator.</li><li>Set the following property to true: <strong>glide.ui.domain_reference_picker.enabled</strong></li><li>Refresh the browser.</li></ol><pre __default_attr="warning" __jive_macro_name="alert" alert="warning" class="jive_text_macro jive_macro_alert" data-renderedposition="910.5625_8_1177_43"><span style="font-size: 10pt; color: #3d3d3d;">Note: Don't ever upload a large number of domains via integration or import sets as it can bring down your instance.</span></pre><p></p><h2>2. Domain Hierarchy</h2><p>Implement changes to the existing domain hierarchy only when absolutely needed. Unless there is a genuine need, it is not recommended to keep changing the domain hierarchy once it is created.</p><p></p><p>When you update the parent of a domain, the system will perform re-parenting of all the related domains that change the domain hierarchy. When the domain hierarchy is updated, the system triggers a cascade update on all domain aware tables for the records created on that domain. As a result, it is not just one table you are updating, but rather a large number of other tables in the backend too.</p><p></p><p>In light of the same reasons mentioned above, even if it is absolutely critical to change the domain hierarchy, never do a mass update. Imagine the number of queries the system has to run if a mass update is performed to change the domain hierarchy. Always do it in small batches, and before starting the next batch of domain updates, make sure DWR (Domain Work Request) records are processed.</p><h2></h2><p><strong>How to track DWR records</strong></p><ul><li><p>In the <strong>syslog_domain</strong> table, there is an information entry for <strong>DWR execution completed. </strong>Always look for this entry as it provides confirmation that DWR is completed.</p></li></ul><p><span style="color: #505050; font-size: 10pt;"><img   alt="Screen Shot 2018-01-03 at 10.51.19 AM.png" class="image-2 jive-image" height="182" src="b0646779db50dfc0b322f4621f961963.iix" style="height: 182px; width: 767.709px; display: block; margin-left: auto; margin-right: auto;" width="768"/></span></p><ul style="text-align: left;"><li style="text-align: left;"><span style="color: #505050; font-size: 10pt;">In <strong>domain_work_request</strong>, make sure all records are reached to State =3 (Processed). This table captures information when you do long operations like changing domain hierarchy.</span></li></ul><p></p><h2>3. Domain Logs</h2><p>Always check domain logs for any errors or warnings. Domain logs are stored in the syslog_domain table. When the domain hierarchy is updated, the system triggers a scheduled job to recalculate the domain paths. The results of the job are captured in this domain logs table. The system also captures the logs in this table when the domain validator runs and domain paths get recalculated. Look for any errors and warnings in this table. If there are any errors encountered during domain path validation, that information will be stored in the syslog_domain table and, after reviewing this table, admins will need to take action to resolve these errors and re-run the domain path validator.</p><p>Here is an example:&gt;</p><p><img   alt="Screen Shot 2017-12-29 at 4.11.11 PM.png" class="image-1 jive-image" src="6d45e042dbd0dfc03eb27a9e0f9619ea.iix" style="width: 620px; height: 161px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p>As you can see in this screenshot, 10 orphan records in the sys_ui_list table are detected. An admin needs to fix these records in order to run the domain path validator successfully. These are the kinds of details you can look for in domain logs. Check out this documentation on <a href="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/reference/r_TroubleshootDomainSeparationError.html" title="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/reference/r_TroubleshootDomainSeparationError.html">troubleshooting domain separation errors</a>.<a _jive_internal="true" href="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/reference/r_TroubleshootDomainSeparationError.html" target="_blank"><span style="color: #3778c7;"><br/></span></a></p><p></p><h2>4. Default Domain</h2><p>Always have one default domain set for the domain records on your instance. The default domain is the domain to which the system automatically assigns task and user records that are not already assigned to a domain. Create a default domain with the name Default to differentiate it from other domains and check the default checkbox. Here is how your default domain configuration will look like:</p><p><img   alt="Screen Shot 2018-01-15 at 3.55.04 PM.png" class="image-3 jive-image" src="6110a379db901fc03eb27a9e0f961943.iix" style="width: 620px; height: 113px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p>If you do not set a default domain, then new tasks and user records are placed in the global domain. Records in the global domain are visible from any domain, so users in any other domain can see data that they may otherwise should not see, since it is wrongly placed in the global domain due to domain misconfiguration. If you set the default domain, records that don't belong to any domain will be placed in the default domain and will not be visible to any user other than an admin. Admins will need to keep looking for records created in default domain, move them to the correct domain, and may also need to investigate why records are getting created in the default domain.</p><p></p><p>Ideally, you should ensure all records are created in their appropriate domains (no global/default domains). If records are getting created in default domain this is something admin will need to look and fix.</p><p></p><h2>5. Contains and User/Group Visibility</h2><p>You should not have too many domain contains and domain-visibility set up on the instance. Use of domains-contains or user/group visibility should be used in special cases and only when absolutely needed for situations where a user or a group needs to see the data from a domain that they don't have visibility to, and moving those users/group is not an option. Using a large number of domain contains/visibility generates queries with too many OR conditions, which are slow and impact performance.</p><p></p><p>Instead of using too many contain relationships, make sure you have set up your domain hierarchy correctly. Check out this query:</p><p></p><pre __default_attr="sql" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_15145941073594283 jive_text_macro" data-renderedposition="2534.15625_8_1177_16" jivemacro_uid="_15145941073594283"><p><span style="color: #3d3d3d; font-size: 10pt;">SELECT <span data-original-title="task0.`sys_id`" title="">...</span> FROM task task0 ignore index(number) WHERE <span class="sql_where" style="font-weight: bold;">task0.`sys_class_name` = 'incident' AND (task0.`sys_domain_path` = '/' OR task0.`sys_domain_path` LIKE '!!$/!!(/%' OR task0.`sys_domain_path` LIKE '!!$/!!$/!!&amp;/%') ORDER BY task0.`number` DESC limit 0,20</span>     </span></p></pre><p style="text-align: left;"></p><p>This query is just for one contain relationship. If you have domain contains, a domain that is the parent of a number of other domains you will have many more OR condition like this. A best practice is to carefully create a <a title="ocs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/task/t_ViewDomainRelationships.html" href="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/task/t_ViewDomainRelationships.html">Domain Map</a>, and before moving the user to the domain, make sure the domain is appropriate for the user so that he/she will have all necessary visibility. Creating domain contains and user/group visibility for the domain should be exceptions and used only when absolutely needed.</p><p></p><h2>6. Domain Query Method</h2><p>Use <strong><em>domain paths</em></strong> instead of domain spooling (sys_domain) or domain numbering. Domain spooling and domain numbering are replaced by domain path. Queries using domain path are much faster than spooling/numbering.</p><p></p><p>Domain path is the default query method for instances that had enabled domain separation recently, so you need not worry about it. It is the default for instances that enabled domain separation in Eureka and above.</p><p></p><p>However, if you are an older customer on domain separation and want to verify the query method on your instance, look for the following system properties:</p><ul><li>If domain path is enabled:<br/>In the System Properties table, you will see <strong><em>glide.sys.domain.provider=domain_paths</em></strong><em> and <strong>glide.sys.domain.paths.installed=true</strong>.</em></li><li>If domain path is not enabled:<br/>Check the sys_properties table for these property values: <strong><em>glide.sys.domain.provider != domain_paths, glide.sys.domain.paths.installed=false</em></strong></li></ul><p>These properties will confirm the query method you are using.</p><pre __default_attr="info" __jive_macro_name="alert" alert="info" class="jive_text_macro jive_macro_alert" data-renderedposition="2962.546875_8_1177_43"><p style="text-align: left;">Note: If you confirmed you are not using domain path query method, create a ticket with Customer Support and look for your options to switch to domain path</p></pre><p style="text-align: left;"></p><h2>7. Debug SQL</h2><p>Admins have the ability to perform debugging on the instance. If there is any slowness reported, enable SQL Debugging and look for any slow queries while you replicate the slowness. Another way to look for slow queries is to check the <strong>sys_query_pattern</strong> (slow queries) table by navigating to <strong>System Diagnostics &gt; Stats &gt; Slow Queries</strong>. This table stores slow queries in your instance.</p><p></p><p>In this table, you can search, for example, queries that contain <strong>domain_path</strong> to determine if there are any slow queries due to domain path in your instance. If you are able to find slow queries, try to analyze why the query is slow.</p><p></p><h3>Common reasons for the cause of slow queries</h3><ul><li>Too many <strong>OR</strong> Conditions (discussed in #5): In order to resolve this you will need to look at the domain hierarchy and see if you can place the user or a domain at a hierarchy level where contains/visibility will not be needed.</li><li><strong>Query method</strong> is not domain path (discussed in #6): If you are not using domain path query method, contact customer support.</li><li>Query needs <strong>Indexing: </strong>If you are able to identify the slow query, run the explain plan and see if options for indexing are available.</li></ul><p></p><p style="text-align: center;"><em>Check out this blog by <a title="ankitkpal" __default_attr="36310" __jive_macro_name="user" class="jive_macro jive_macro_user" data-orig-content="ankitkpal" data-renderedposition="3364.734375_261.421875_74_16" href="/community?id=community_user_profile&user=a5301ea5db581fc09c9ffb651f9619a6">ankitkpal</a> for details on improving queries using database indexing: <a title="Improve performance: database indexes and slow queries" __default_attr="5262" __jive_macro_name="blogpost" class="jive_macro jive_macro_blogpost" data-orig-content="Improve performance: database indexes and slow queries" data-renderedposition="3364.734375_697.09375_378_16" href="/community?id=community_blog&sys_id=6b4da229dbd0dbc01dcaf3231f9619ad">Improve performance: database indexes and slow queries</a><span style="color: #505050;"><br/></span></em></p><p style="text-align: center;"></p><h2>8. Don't use domain path in scripts</h2><p>Your script should not be dependent on the domain path. This is because, if at some point you have a requirement to change the domain hierarchy, the domain path will be recalculated and its value will change. Once this happens, your scripts will be useless or may throw errors. The best strategy is not to write your scripts on the basis of domain path. Always use the <strong>sys_domain</strong> field in your scripts to determine or evaluate the domain. Look for base system business rules which use the <strong>sys_domain</strong> field to get some ideas before creating your own scripts.</p><p></p><p style="text-align: left;">Additional resources for Domain Separation</p><ul><li><a href="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/reference/domain-separated-apps.html" title="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/reference/domain-separated-apps.html">Application support for domain separation</a></li><li><a href="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/task/t_ActivateDomainSeparation.html#t_ActivateDomainSeparation" title="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/task/t_ActivateDomainSeparation.html#t_ActivateDomainSeparation">Request domain separation</a></li><li><a href="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/task/t_ValidateTheDomainTree.html#t_ValidateTheDomainTree" title="https://docs.servicenow.com/bundle/kingston-servicenow-platform/page/administer/company-and-domain-separation/task/t_ValidateTheDomainTree.html#t_ValidateTheDomainTree">Validate domain hierarchy</a></li></ul>