---
title: "Some Unexpected Behavior"
date: 2010-12-20T20:09:29.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=8edde6e9dbd0dbc01dcaf3231f961976"
---
<p><img __jive_id="4968" alt="" class="jive-image" src="limit.png" style="width: auto; height: 113px;" />One of my colleagues (Aleck Lin) brought an interesting phenomenon to my attention on Friday: sometimes JavaScript instance variables behave exactly like class variables. What's up with that?!? It turns out to be a result of a slightly subtle aspect of the <a title="w.prototypejs.org/" href="http://www.prototypejs.org/">Prototype.js library</a>, which we use extensively (both on the server and in the browser). Here's an example of the unexpected behavior — and an easy way to work around it (also an explanation for how that photo is related to "unexpected behavior":<br /><!--break--><br />First, here's a code example that demonstrates the issue (copy to Scripts - Background and try it!):<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />var MyObj = Class.create();<br />MyObj.prototype = {<br />   myNumber: 1,<br />   myArray: [],<br />   initialize: function(n, s) {<br />      this.myNumber += n;<br />      this.myArray.push(s);<br />   }<br />}<br /><br />var a = new MyObj(1, 'a');<br />var b = new MyObj(2, 'b');<br />gs.log('a.myNumber: ' + a.myNumber);<br />gs.log('a.myArray: ' + a.myArray);<br />gs.log('b.myNumber: ' + b.myNumber);<br />gs.log('b.myArray: ' + b.myArray);</pre><br />What's so evil about this? Well, take a close look at the results:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />*** Script: a.myNumber: 2<br />*** Script: a.myArray: a,b<br />*** Script: b.myNumber: 3<br />*** Script: b.myArray: a,b</pre>The instance variable <i>myNumber</i> is different in the two instances: each of them had a different value added in the <i>initialize()</i> method, just as you'd expect. They're <i>instance</i> variables, after all — so each instance should have its own copy. But take a look at the <i>myArray</i> instance variable: it's the same in both instances, and the values from both instance's <i>initialize()</i> method were pushed into it. What the $#%&amp;!&amp;? is going on here? That instance variable is acting exactly as if it was a <i>class</i> variable!<br /><br />Well, it turns out that way in which Prototype.js creates the constructor function ends up evaluating what you assign to the <i>prototype</i> property just once. That means, in turn, than any objects you assign to properties are evaluated just once — and then a reference to that object is created for each instance. This is <i>not</i> the same thing that ordinarily happens in a constructor function (without using Prototype.js); normally the prototype property is evaluated as <i>each instance</i> is created. Slightly subtle, and problematic if you really wanted instance objects!<br /><br />Fortunately, there's a very simple way to get rid of this problem — and this works both with and without Prototype.js:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />var MyObj = Class.create();<br />MyObj.prototype = {<br />   myNumber: 1,<br />   myArray: null,<br />   initialize: function(n, s) {<br />      this.myArray = [];<br />      this.myNumber += n;<br />      this.myArray.push(s);<br />   }<br />}<br /><br />var a = new MyObj(1, 'a');<br />var b = new MyObj(2, 'b');<br />gs.log('a.myNumber: ' + a.myNumber);<br />gs.log('a.myArray: ' + a.myArray);<br />gs.log('b.myNumber: ' + b.myNumber);<br />gs.log('b.myArray: ' + b.myArray);</pre><br />Results:<br /><pre style="margin-left:20px;line-height:1;color:FireBrick;"><br />*** Script: a.myNumber: 2<br />*** Script: a.myArray: a<br />*** Script: b.myNumber: 3<br />*** Script: b.myArray: b</pre><br />Ah, that's more like it! <br /><br />All I did was to move the initialization of <i>myArray</i> into the <i>initialize()</i> method, and <i>voila!</i> the problem is gone.<br /><br />How is that photo related to "unexpected behavior"? Consider: <a title="timesblogs.latimes.com/babylonbeyond/2008/12/iran-tis-the-se.html" href="http://latimesblogs.latimes.com/babylonbeyond/2008/12/iran-tis-the-se.html">it was taken in Iran!</a></p>