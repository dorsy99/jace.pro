---
title: "Expanding Cloud Discovery for custom property collection"
date: 2016-06-01T20:24:12.000Z
authors: ["amittell"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=b11d22e5dbd0dbc01dcaf3231f96192a"
---
<p>Out of the box ServiceNow platform does a great job of collecting the important data from cloud platforms, as you can see from the breakdown of <a title="ocs.servicenow.com/product/discovery/reference/r_DataCollectedOnAWSCloud.html" href="https://docs.servicenow.com/product/discovery/reference/r_DataCollectedOnAWSCloud.html">data we collect from AWS</a>.</p><p class="p2"></p><p class="p1">However, new properties are always being added to CMPs, and sometimes we need just need a specific lesser used property to be collected to enrich our CMDB with the data needed to generate a certain report or drive some orchestration use case.</p><p class="p2"></p><p class="p1">Fortunately, the ServiceNow platform is extensible and dynamic, so it's easy to extend the out-of-the-box properties to discover that property you need!</p><p class="p2"></p><p class="p1">For AWS two tables are used to specify how Discovery will process properties, the first is the AWS Datasource type mapping table, this tells discovery how to process the properties returned and map them to an object, and the second is the Normalized Object to DB Mapping table, which tells the system how to map that object to a specific field in the CMDB.</p><p class="p2"></p><p class="p1">Lets cover a specific example of using these tables to collect an additional property; I want to be able to tell at a glance when my EBS volumes were attached to my instances, and run reports on this based on data in the CMDB. In general, this can also give a good indication of Instance creation time (even if the instance was not created from the ServiceNow platform) as more often than not the root device is attached on creation and never changed (and AWS does not store instance creation time), but the platform doesn't collect this data out of the box….so lets expand the collection to add it to our AWS Discovery process.</p><p class="p2"></p><p class="p1">First we need to create a field to store our new property. Type Table in the search box and select System Definition &gt; Tables. On the tables page, search for "cmdb_ci_aws_ebs_volume"</p><p class="p2"></p><p class="p2"><img   alt="Pasted Graphic 6.jpg" class="image-1 jive-image" src="ad114402db98d3041dcaf3231f961934.iix" style="width: 620px; height: 203px;"/></p><p class="p3"></p><p class="p1">Open the table definition by clicking the <span __jive_emoticon_name="info" __jive_macro_name="emoticon" class="jive_emote jive_macro" data-renderedposition="718_259.8125_16_16" src="/8.0.1.35b65d4/images/emoticons/info.png"></span>, and then click "New" to create a new table column.</p><p class="p2"></p><p class="p3"><img   alt="Pasted Graphic.jpg" class="image-2 jive-image" src="f470a98edb5c13043eb27a9e0f961935.iix" style="width: 620px; height: 412px;"/></p><p class="p2"></p><p class="p1">Then we define our new volume Attach Time field on the EBS Volumes table with the following properties.</p><p class="p2"></p><p class="p2"><img   alt="Pasted Graphic 1.jpg" class="image-3 jive-image" src="d31ef48edb509f048c8ef4621f9619b0.iix" style="width: 620px; height: 125px;"/></p><p class="p3"></p><p class="p2"></p><p class="p1">Now we have our table configured with our new property we need to add our datasource mappings to map the data we want discovery to capture from the AWS payload and store in the field we just created.</p><p class="p2"></p><p class="p1">In the tables page, search for "aws_datasource_type_mapping" and open the table by clicking the <span __jive_emoticon_name="info" __jive_macro_name="emoticon" class="jive_emote jive_macro" data-renderedposition="1514_623.875_16_16" src="/8.0.1.35b65d4/images/emoticons/info.png"></span>.</p><p class="p2"></p><p class="p3"><img   alt="Pasted Graphic 26.jpg" class="image-6 jive-image" src="8bcabbbddb145fc03eb27a9e0f96198e.iix" style="width: 620px; height: 146px;"/></p><p class="p2"></p><p class="p1">Scroll down and select "Show List" from the related links section.</p><p class="p1"></p><p class="p1"><img   alt="Pasted Graphic 28.jpg" class="image-5 jive-image" src="4c8bdc42db185344e9737a9e0f96190e.iix" style="width: 620px; height: 839px;"/></p><p class="p1"></p><p></p><p class="p1">Now from the list search for the Normalized Property "blockDeviceMapping". Select the entry for resource type Instance and open this entry using the <span __jive_emoticon_name="info" __jive_macro_name="emoticon" class="jive_emote jive_macro" data-renderedposition="2716_69.203125_16_16" src="/8.0.1.35b65d4/images/emoticons/info.png"></span> for the row.</p><p class="p2"></p><p class="p3"><img   alt="Pasted Graphic 8.jpg" class="image-7 jive-image" src="b1c66986db501744e9737a9e0f9619f5.iix" style="width: 620px; height: 150px;"/></p><p class="p2"></p><p class="p1">This particular mapping uses a script to build an object representing the volume and is used to process the block devices returned to us from AWS, we will modify it to add processing for the attach time of the EBS volumes.</p><p class="p2"></p><p class="p1">Add the following line to the script after line 20</p><p class="p1"></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14647564206111324 jive_text_macro" data-renderedposition="3059_8_887_16" jivemacro_uid="_14647564206111324"><p class="p1">vol.attachTime = items[i].ebs.attachTime;</p></pre><p class="p1"></p><p class="p1">I also added a comment above to highlight the change but this is optional. Click "Update" to save your changes.</p><p class="p3"></p><p class="p3"><img   alt="Pasted Graphic 16.jpg" class="image-8 jive-image" src="0fc40546dbd013043eb27a9e0f96197a.iix" style="width: 620px; height: 402px;"/></p><p class="p2"></p><p class="p1">Now that we have expanded the payload processing to include the Attach Time information, we need to map this to our Attach Time field, this is done using the normalized mapping table.</p><p class="p2"></p><p class="p1">Search for "normalizedobject_db_mapping" in the Tables view and open the table using the <span __jive_emoticon_name="info" __jive_macro_name="emoticon" class="jive_emote jive_macro" data-renderedposition="3648_582.375_16_16" src="/8.0.1.35b65d4/images/emoticons/info.png"></span>.</p><p class="p2"></p><p class="p3"><img   alt="Pasted Graphic 29.jpg" class="image-9 jive-image" src="7391a4c6db5c5304b322f4621f96194a.iix" style="width: 620px; height: 154px;"/></p><p class="p2"></p><p class="p1">Scroll down to the Related Links section and select "Show List" again, then search for the Normalized Property blockDeviceMapping and click the blue <span __jive_emoticon_name="info" __jive_macro_name="emoticon" class="jive_emote jive_macro" data-renderedposition="3911_94.609375_16_16" src="/8.0.1.35b65d4/images/emoticons/info.png"></span> to open the record.</p><p class="p2"></p><p class="p2"><img   alt="Pasted Graphic 30.jpg" class="image-10 jive-image" src="29000c82db58d3041dcaf3231f9619ea.iix" style="width: 620px; height: 158px;"/></p><p class="p2"></p><p class="p2">The EBS volume properties are stored in an object, so mapping a new volume property is a two step process. First, we need to update the attachmentSet object to include our new Attach Time value.</p><p class="p2"></p><p class="p1">Edit the script and add the following after line 22</p><p class="p1"></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_14647563527791528" data-renderedposition="4262_8_887_16" jivemacro_uid="_14647563527791528"><p class="p1">"attachTime": volumes[i].attachTime, </p></pre><p class="p2"></p><p class="p3">so that it looks like the following (again the comment is optional).</p><p class="p3"></p><p class="p3"><img   alt="Pasted Graphic 23.jpg" class="image-11 jive-image" src="55846942db18d7041dcaf3231f961900.iix" style="width: 620px; height: 380px;"/></p><p class="p3"></p><p class="p1">Click update to save your changes.</p><p class="p2"></p><p class="p1">Now that the EBS attachmentSet contains our Attach Time property, we need to map that property to the field we created on the EBS volumes table.</p><p class="p2"></p><p class="p1">Go back to the Normalized Object to DB Mapping table and click "Show List" under related links, from this view click "New" to create a new entry.</p><p class="p2"></p><p class="p3"><img   alt="Pasted Graphic 17.jpg" class="image-12 jive-image" src="24cf3cc6db10130468c1fb651f9619d2.iix" style="width: 620px; height: 45px;"/></p><p class="p2"></p><p class="p1">In the form that opens, fill out the new record as per below.</p><p class="p1"></p><p class="p1"><img   alt="Pasted Graphic 14.jpg" class="image-13 jive-image" src="120e1c46db1057041dcaf3231f961979.iix" style="width: 620px; height: 415px;"/></p><p class="p2"></p><p class="p1">Check the "Use script box" and replace everything below line 13 with the following script.</p><p class="p2"></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_14647562766645364" data-renderedposition="5568_8_887_352" jivemacro_uid="_14647562766645364"><p class="p1">function getOutputData(params) {</p><p class="p1">   var s = params.normalizedObject.attachmentSet.attachTime;</p><p class="p1">   var attachTime = '';</p><p class="p2"></p><p class="p1">   // Process the date/time into an SN acceptable format</p><p class="p1">   if (s !== undefined) {</p><p class="p1">   var bits = s.split(/[-TZ:+\.]/g);</p><p class="p1">   attachTime += bits[0];</p><p class="p1">   attachTime += "-";</p><p class="p1">   attachTime += bits[1];</p><p class="p1">   attachTime += "-";</p><p class="p1">   attachTime += bits[2];</p><p class="p1">   attachTime += " ";</p><p class="p1">   attachTime += bits[3];</p><p class="p1">   attachTime += ":";</p><p class="p1">   attachTime += bits[4];</p><p class="p1">   attachTime += ":";</p><p class="p1">   attachTime += bits[5];</p><p class="p1">   }</p><p class="p2"></p><p class="p1">   return attachTime;</p><p class="p1">}</p></pre><p class="p2"></p><p class="p1">And we're done! After the next AWS discovery runs each entry in the EBS Volumes table will start having the Attach Time field populated, as long as the attachment time exists in AWS (obviously the volume needs to be attached to something!).</p><p class="p2"></p><p class="p1">If you want to kick off a discovery immediately to check things are working, you can kick off a manual discovery run by clicking "Discover now" under AWS Discover &gt; Discovery Schedules &gt; Your AWS account.</p><p class="p2"></p><p class="p2"><img   alt="Pasted Graphic 24.jpg" class="image-14 jive-image" src="414fb7fddb585704ed6af3231f9619c2.iix" style="width: 620px; height: 375px;"/></p><p class="p2"></p><p class="p1">Once we have this data stored in the CMDB we can make some tweaks to the views make it show up in useful places.</p><p class="p2"></p><p class="p1">For example, to make the property show in the list view of EBS Volumes, browse to the EBS Volumes page and click the gear icon.</p><p class="p2"></p><p class="p2"><img   alt="Pasted Graphic 25.jpg" class="image-15 jive-image" src="efffff71db94db048c8ef4621f96192c.iix" style="width: 620px; height: 133px;"/></p><p class="p2"></p><p class="p1">This will present you with the option to personalize the columns you see in the list view. In this case I have selected our new Attach Time property and clicked the right arrow to move it into the Selected properties list, then using the up arrow I have made the property appear directly after volume ID.</p><p class="p2"></p><p class="p2"><img   alt="Pasted Graphic 19.jpg" class="image-16 jive-image" src="1b742d0adb101744e9737a9e0f9619d5.iix" style="width: 620px; height: 559px;"/></p><p class="p2"></p><p class="p1">This gives us a view that looks like this:</p><p class="p2"></p><p class="p3"><img   alt="Pasted Graphic 20.jpg" class="image-17 jive-image" src="6dbf3442db9c9304b322f4621f9619a4.iix" style="width: 620px; height: 125px;"/></p><p class="p2"></p><p class="p1">You can also view this information in the EC2 instances views directly, which is handy, as we originally mentioned, to get an idea of when a VM was created as AWS does not store creation time for an instance, only last start/launch time, but quite often creation time is the same as the attach time of the root block device (unless you've replaced the root device without recreating the instance for some reason).</p><p class="p2"></p><p class="p1">When viewing an EC2 instance details, right click the header and select Configure &gt; Form Layout</p><p class="p2"></p><p class="p3"><img   alt="Pasted Graphic 21.jpg" class="image-18 jive-image" src="900ed402db1057049c9ffb651f9619da.iix" style="width: 620px; height: 202px;"/></p><p class="p2"></p><p class="p1">This will bring you up a list of properties again. Scroll down the list of available properties and select "AWS EBS Volume-&gt;Instance" then use the right arrive to add it to the selected properties list.</p><p class="p2"></p><p class="p2"><img   alt="Pasted Graphic 2.jpg" class="image-19 jive-image" src="033f73fddb585704ed6af3231f9619fa.iix" style="width: 620px; height: 299px;"/></p><p class="p2"></p><p class="p1">You will now see details of the EBS volumes related to the Instance directly on the EC2 instance form, including our new Attach Time property.</p><p class="p2"></p><p class="p2"><img   alt="Pasted Graphic 18.jpg" class="image-20 jive-image" src="ddb6e182db58d7041dcaf3231f961984.iix" style="width: 620px; height: 437px;"/></p><p class="p2"></p><p class="p1">NOTE: if you don't see Attach Time in the list, click the gear icon and add it to the selected properties list again as we did for the EBS volumes list view, this will save the selected properties for this particular view context so you should then see it on every EC2 instance form.</p><p class="p2"></p><p class="p1">You can expand your collection to collect any property returned by the API of AWS/Azure in this way, it's simply a matter of creating a field to store it and then adding the property to the mappings tables, and if it's a single property not a subset property no scripting is required. Hope this was useful, thanks for reading!</p>