---
title: "Scripted Audits   Orchestration   An approach to run compliance audits on your virtual assets"
date: 2016-12-21T03:11:15.000Z
authors: ["muralidingari"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=430e2e2ddbd0dbc01dcaf3231f96197f"
---
<p><span style="font-family: arial, helvetica, sans-serif; color: #303030; font-size: 12pt;"><span style="background: white;"><strong>Virtualization</strong></span><span style="background: white;"> became one of the biggest game-changers in the IT industry, Across the world, organizations of every size are making the move to virtual, cloud-based and hybrid systems that cut down their costs while improving business continuity and IT management processes. </span>Virtual assets need to be secured and audited exactly as they are in physical network-server environments. Such measures include the familiar procedures and checklists that we've used all along: System hardening and security, change control, blocking of unauthorized equipment and applications, network segmentation, monitoring, logging, alerting, and documentation that supports audits of these processes.</span></p><p></p><p><span style="font-family: arial, helvetica, sans-serif; color: #303030; font-size: 12pt;"><span style="background: white;">There are many commercial and open source tools available to audit change control in a virtual infrastructure that will generally audit against the main regulatory framework requirements as well. They also include their view of compliance to several frameworks, including: VMware Hardening Guide, PCI-DSS, SOX, HIPAA, GLBA and ISO 17799 (in short, most frameworks except for JSOX). </span><span style="background: white;">It is a common practice to create new virtual machines from gold images(Templates). These are VM images that are completely installed and customized to a particular environment and security standard, which promotes a consistent, auditable server environment. However, there is a hidden risk in this approach, which is the potential for misconfiguration of servers and systems as they replicate, spin up, spin down and move around in the dynamic virtual environment.</span><span style="background: white;">A carefully implemented change control process along with these commercial tools helps the organizations to keep track of the changes and keep their virtual asset as compliant as possible. Often these tools fall short of one's needs and eventually organization will fall back to manual audits which involves a document based audit and remediation process.</span></span></p><p></p><p></p><p><span style="font-family: arial, helvetica, sans-serif; font-size: 12pt;"><span style="color: #111111; background: white;">This blog post will introduce an approach to eliminate those manual audits and leverage orchestration to automate some of those compliance audit tasks and remediation procedures.</span><span style="color: #111111; background: white;">Compliance is a tool set that enables administrators to certify ServiceNow data for correctness and fix any discrepancies found in the data. You can read more about the <a title="ocs.servicenow.com/bundle/geneva-it-business-management/page/product/compliance/concept/c_Compliance.html" href="https://docs.servicenow.com/bundle/geneva-it-business-management/page/product/compliance/concept/c_Compliance.html">Compliance Module </a>in docs wiki page</span></span></p><p></p><p></p><p><span style="font-size: 12pt; color: #111111; background: white; font-family: arial, helvetica, sans-serif;">In this blog post we will see how we can extend <strong>Scripted Audits </strong>feature of the compliance to integrate orchestration to conduct compliance audit.</span></p><p></p><p><span style="font-size: 12pt; color: #111111; background: white; font-family: arial, helvetica, sans-serif;"><img   class="image-1 jive-image" height="362" src="cd922b31db9c9f04e9737a9e0f9619e0.iix" style="width: 208px; height: 362.12px;" width="208"/></span></p><p><span style="font-family: arial, helvetica, sans-serif; font-size: 12pt;">To explain the approach let us study the following use case and see how we can adopt the process to address the business problem.</span></p><p></p><p><span style="font-family: arial, helvetica, sans-serif; font-size: 12pt;"><strong>Use Case:</strong></span></p><ul><li><span style="font-family: arial, helvetica, sans-serif; font-size: 12pt;">Infrastructure team receives a request to provision a VM.</span></li><li><span style="font-family: arial, helvetica, sans-serif; font-size: 12pt;">Corporate security policies mandates VM to adhere to a few custom registry settings</span><ul><li><span style="font-family: arial, helvetica, sans-serif; font-size: 12pt;">For example : Autoplay should be disabled on each drive that is connected to the System.</span></li></ul></li><li><span style="font-family: arial, helvetica, sans-serif; font-size: 12pt;">End of every month a   report is generated with list of VMs that deviate from the above settings</span></li><li><span style="font-family: arial, helvetica, sans-serif; font-size: 12pt;">IT team need to make sure that all VMs adhere to this security settings all the time by setting the value to the desired state.</span></li></ul><p><span style="font-family: arial, helvetica, sans-serif; font-size: 12pt;">In the absence of commercial tools IT team need to spend hours to make sure all VMS are adhering to such above custom settings. In this blog we will see how our approach can address some of the issues by automating the process   using scripted audits and orchestration.</span></p><p></p><p></p><p><span style="color: #111111; background: white; font-size: 12pt; font-family: arial, helvetica, sans-serif;"><strong>Step 1: Create Filter for selecting the desired audit targets.</strong></span></p><p></p><p><span style="font-size: 12pt; color: #111111; background: white; font-family: arial, helvetica, sans-serif;">Using the <strong>Filters</strong> menu create a filter to select the Audit targets</span></p><p></p><p><span style="font-size: 12pt; color: #111111; background: white; font-family: arial, helvetica, sans-serif;">Example 1:   A filter created on Virtual Machine Instance ( cmdb_ci_vm_instance)</span></p><p></p><p><span style="font-size: 12pt; color: #111111; background: white; font-family: arial, helvetica, sans-serif;"><img   class="image-2 jive-image" height="294" src="de43418adbdc9304b322f4621f96194d.iix" style="width: 941px; height: 294.442px;" width="941"/> </span></p><p></p><p><span style="font-size: 12pt; color: #111111; background: white; font-family: arial, helvetica, sans-serif;">Example 2:   A filter is created on MSFT SQL Instance( cmdb_ci_db_msssql_instance) </span></p><p></p><p><img   class="image-3 jive-image" height="222" src="7c72e402db9c5304b322f4621f961903.iix" style="width: 940px; height: 221.659px;" width="940"/></p><p></p><p></p><p><span style="color: #111111; background: white; font-size: 12pt; font-family: arial, helvetica, sans-serif;"><strong>Step 2: Create   a new Scripted Audit Record and attach your Orchestration Flow.</strong></span></p><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">Create a new <strong>Scripted Audit</strong> record using the <strong>Audits</strong> menu and Scripted Audits module.</span></p><ul style="list-style-type: disc;"><li><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">Select the filter created in step 1 as the target for the audit.</span></li><li><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">Select how frequently you want to run this Audit (On Demand, Periodically, Monthly etc…)</span></li><li><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">Select Checkbox to create tasks after the Audit is finished and select the group to whom the tasks will be assigned to.</span></li><li><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">In the script area create a new Certification Processing task as show in the below diagram. </span></li><li><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">Create an orchestration workflow which will conduct the Audit process and call the workflow from the script area and pass the certification glide record to the workflow as input.</span></li></ul><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;"><img   class="jive-image image-4" height="467" src="0f65488edb1c5fc068c1fb651f961953.iix" style="width: 974px; height: 466.592px;" width="974"/></span></p><p></p><p><span style="color: #111111; background: white; font-size: 12pt; font-family: arial, helvetica, sans-serif;"><strong>Step 3: Automate your audit process using orchestration workflow.</strong></span></p><p></p><p><span style="font-size: 12pt; color: #111111; background: white; font-family: arial, helvetica, sans-serif;">Automate your audit process using orchestration workflow. Now at this point you can call external auditing tools using REST/SOAP Activities or you can run your own customized audit scripts using Run Script activity, the following example show running a PowerShell based audit to check a registry record for a given VM.</span></p><p></p><p><img   class="image-5 jive-image" height="390" src="f4ef5b7ddb1093041dcaf3231f96197e.iix" style="height: 390px; width: 848.421px;" width="848"/></p><p></p><p><img   class="image-6 jive-image" height="379" src="080059cadb94130468c1fb651f961990.iix" style="width: 874px; height: 379.389px;" width="874"/></p><p></p><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">For both Audit fail and pass conditions record the result by updating the Audit record and creating related tasks.</span></p><p></p><p><img   class="image-7 jive-image" height="369" src="c3ca288edb94dfc03eb27a9e0f9619ca.iix" style="height: 369px; width: 953.25px;" width="953"/></p><p><span style="font-family: arial, helvetica, sans-serif; font-size: 12pt;"><strong>Step 4: Run the Audit</strong></span></p><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">Run the security audit at your desired interval and it will create Audit records and their status as shown in the following example.</span></p><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;"><img   class="jive-image image-8" height="291" src="67a804cadb109704ed6af3231f961957.iix" style="width: 897px; height: 290.771px;" width="897"/> </span></p><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">Additional tasks will be created for the assigned group for additional remediation or change to bring the target CI (here in this example it is a virtual machine instance) back into compliance mode.</span></p><p></p><p><img   class="image-9 jive-image" height="425" src="3bf82b39dbd41fc068c1fb651f961941.iix" style="width: 902px; height: 425.281px;" width="902"/></p><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">The Dashboard View of the corresponding CI record will also reflect the status of the Audit.</span></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;"><img   class="jive-image image-10" height="190" src="ee0b0d0edb941b04ed6af3231f9619a8.iix" style="width: 898px; height: 189.664px;" width="898"/> </span></p><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">The Asset owner/ Admin/ Operator will also get to know the compliance status of the asset.</span></p><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">A detailed report of such audits can also be configured for reporting purposes</span></p><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;"><img   class="image-11 jive-image" height="447" src="f837e046db9457049c9ffb651f96194d.iix" style="max-width: 1200px; max-height: 900px; width: 800px; height: 446.667px;" width="800"/></span></p><p></p><p></p><p><span style="font-family: arial, helvetica, sans-serif; font-size: 12pt;"><strong>Step 5: Remediation to bring the Asset back into compliance mode.</strong></span></p><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;"> Once you Identify an Asset as audit failed, you can apply all the ITSM based processes such as Change Management etc… and finally you can remediate the same using a custom orchestration flow to remediate the issue. After the remediation workflow is successfully run, if you run the audit again it will update the status of the record to audit compliance mode.</span></p><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">In this example, the remediation workflow sets the registry settings to the desired value to bring the VM back into compliance mode.</span></p><p></p><p><span style="font-family: arial, helvetica, sans-serif; font-size: 12pt;">   </span></p><p><img   class="image-12 jive-image" height="397" src="1d95800adb9c5704ed6af3231f961952.iix" style="width: 866px; height: 396.879px;" width="866"/></p><p></p><p><img   class="image-13 jive-image" height="122" src="25466b31dbd0dfc0b322f4621f961940.iix" style="width: 862px; height: 122.366px;" width="862"/></p><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">To conclude, this approach will leverage the CMDB data to conduct scripted audits on your asset but also have the following advantages</span></p><ul style="list-style-type: disc;"><li><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">Integrate custom orchestration for audits</span></li><li><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">Create Master orchestration flow to have a combination of external audits and custom audits</span></li><li><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">Build gaps where commercial auditing tools or custom manual processes are not yielding a faster audit results.</span></li><li><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">A Closed Loop Automation and Remediation process to keep your assets always in compliance mode.</span></li></ul><p></p><p><span style="font-size: 12pt; font-family: arial, helvetica, sans-serif;">This is one of the many approaches you can build on top ServiceNow platform, feel free to share your thoughts.</span></p>