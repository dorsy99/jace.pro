---
title: "GQL Glide Query Language Part  The Processor"
date: 2016-10-27T00:42:32.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=ce2ee66ddbd0dbc01dcaf3231f961990"
---
<p><a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=52fd662ddbd0dbc01dcaf3231f96198b">Last time</a>, we derived the JSAN (JavaScript Array Notation) data format from JSON and saw how the GQL class from the Script Include can return result sets in either JSON or JSAN data format. This time, we'll look at the processor and see how it handles the requests coming from the browser and consumes the result sets from the Script Include, encoding them for transmission.</p><p></p><p>We have a choice between two ServiceNow tools when it comes to processing inbound web requests:</p><p></p><ol><li><a title="ki.servicenow.com/?title=Scoped_GlideScriptedProcessor_API_Reference" href="http://wiki.servicenow.com/?title=Scoped_GlideScriptedProcessor_API_Reference">Scoped GlideScriptedProcessor</a></li><li><a title="ocs.servicenow.com/bundle/helsinki-servicenow-platform/page/integrate/custom-web-services/concept/c_CustomWebServices.html" href="https://docs.servicenow.com/bundle/helsinki-servicenow-platform/page/integrate/custom-web-services/concept/c_CustomWebServices.html">Scripted REST APIs</a></li></ol><p></p><p>While Scripted REST APIs provide a nice UI with nifty features, let's use Scoped GlideScriptedProcessor since our processor will be simple. The processor handles the following tasks:</p><p></p><ol style="list-style-type: lower-alpha;"><li>Receive GET requests from the browser or other sources.</li><li>Extract parameters from the query string.</li><li>Instantiate and execute the GQL class from the Script Include.</li><li>Receive the result set from the GQL class in JSAN or JSON data format (the return value is a JavaScript object and it's not yet encoded in JSON).</li><li>Based on the requested format, encode (stringify) the result set into JSON or convert to CSV or HTML table.</li><li>Transmit the result via response.</li></ol><p></p><p>Please note that JSAN is an object data format and is still encoded as JSON for transmission.</p><p></p><p>Below is the processor script that captures the above:</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14774412961697067 jive_text_macro" data-renderedposition="518.96875_8_998_1120" jivemacro_uid="_14774412961697067"><p>/** </p><p>* GQL (Glide Query Language) processor</p><p><span style="font-size: 9pt;">*/</span></p><p></p><p>(function process(g_request, g_response, g_processor) {</p><p></p><p>   try {</p><p><span style="font-size: 9pt;">       var gql = g_request.getParameter('gql');</span></p><p>       var format = g_request.getParameter('format');</p><p>       var result = new GQL().query(gql, format);</p><p></p><p><span style="font-size: 9pt;">       g_response.setHeader('cache-control', 'no-cache');   // </span><span>disable page caching to avoid stale result</span></p><p></p><p>       if (/CSV/i.test(format)) {</p><p>           var filename = result.query &amp;&amp; result.query.table || 'gql';</p><p>           g_response.setHeader('Content-Disposition', 'attachment;filename=' + filename + '.csv');</p><p>           g_processor.writeOutput('text/csv', getCSV());</p><p>       }</p><p>       else if (/HTML/i.test(format)) g_processor.writeOutput('text/html', getHTML());</p><p>       else g_processor.writeJSON(result);</p><p>   } catch (e) { g_processor.writeOutput('text/plain', 'ERROR: ' + e + '\r' + e.stack); }</p><p></p><p>   function getCSV() {</p><p></p><p>       var columns = [], rows = [];</p><p>       result.labels.forEach(function(label) { columns.push(escapeCSV(label)); });</p><p>       rows.push(columns.join(','));</p><p></p><p>       for (var i = 0; i &lt; result.records.length; i++) {</p><p>           columns = [];</p><p>           result.records[i].forEach(function(column) { columns.push(escapeCSV(column)); });</p><p>           rows.push(columns.join(','));</p><p>       }</p><p>       return rows.join('\r\n');</p><p></p><p>     /** </p><p>       * Takes raw field value and returns CSV escaped value </p><p>       * based on RFC 4180 Common Format and MIME Type for CSV Files</p><p><span>       * October 2005 </span><a title="" _jive_internal="true" href="http://tools.ietf.org/html/rfc4180" rel="nofollow" target="_blank">http://tools.ietf.org/html/rfc4180</a><span> </span></p><p>       * </p><p>       * @param {string} raw - raw field value </p><p>       * @return {string} escaped CSV field value, if applicable per RFC 4180 </p><p>       */   </p><p>       function escapeCSV(raw) {</p><p>           var out = (raw + '').replace(/"/g,'""');   // escape all double quotes   </p><p>           if (/[\r\n",]/.test(out)) out = '"' + out + '"';   // if it has special characters, enclose in double quotes</p><p>           return out;</p><p>       }   </p><p>   }</p><p></p><p>   function getHTML() {</p><p></p><p><span style="font-size: 9pt;">       var columns = [], rows = ['&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;'];</span></p><p>       result.labels.forEach(function(label) { columns.push(escapeHTML(label)); });</p><p>       rows.push(columns.join('&lt;/th&gt;&lt;th&gt;'), '&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;');</p><p></p><p>       for (var i = 0; i &lt; result.records.length; i++) {</p><p>           columns = [];</p><p>           result.records[i].forEach(function(column) { columns.push(escapeHTML(column)); });</p><p>           rows.push('&lt;tr&gt;&lt;td&gt;', columns.join('&lt;/td&gt;&lt;td&gt;'), '&lt;/td&gt;&lt;/tr&gt;');</p><p>       }</p><p>       rows.push('&lt;/tbody&gt;&lt;/table&gt;');</p><p>       return rows.join('');</p><p></p><p><span style="font-size: 9pt;">       function escapeHTML(raw) {   // escape reserved HTML characters</span></p><p>           var MAP = { '&amp;':'&amp;amp;','&lt;':'&amp;lt;','&gt;':'&amp;gt;'};</p><p>           return (raw + '').replace(/[&amp;&lt;&gt;]/g, function(c) { return MAP[c]; });</p><p>       }</p><p>   }</p><p>})(g_request, g_response, g_processor);</p></pre><p></p><p>Lines 8 and 9 extracts the two parameters <span style="font-family: 'courier new', courier;">gql</span> and <span style="font-family: 'courier new', courier;">format</span> from the request object <span style="font-family: 'courier new', courier;">g_request</span>.</p><p></p><p>Line 10 instantiates the GQL class, executes the <span style="font-family: 'courier new', courier;">query()</span> method using the two parameters extracted, and saves the result set.</p><p></p><p>Lines 14 through 20 encodes the result set into CSV, HTML, or JSON (for both JSAN and JSON formats) and transmits it back to the requester; notice the content types are set according to the encoding type. The <span style="font-family: 'courier new', courier;">writeJSON()</span> method handles the JSON encoding and also sets the content type.</p><p></p><p>This sums up what the processor does; it doesn't get much simpler. The rest lines are for the CSV and HTML encoders. These don't really need to be part of the processor, but I wanted to illustrate how JSAN data can be easily turned into other formats. The arrays used in JSAN can be quickly converted to a formatted row using the <span style="font-family: 'courier new', courier;">forEach()</span> array method. Both CSV and HTML encoders work very similarly, iterating over records and columns as row and column delimiters are inserted. HTML tables can be as easily generated on the client side from JSAN data using AngularJS, for example; this may be the preferred approach if you want tighter interactions with the tables in the browser.</p><p></p><p>Let's now take a look at the Processor configuration page whose screenshot is shown below:</p><p></p><p><img   class="image-5 jive-image" src="e2db0c4edbd017049c9ffb651f961962.iix" style="border: 1px solid #ccc; max-width: 1200px; max-height: 900px;"/></p><p></p><p>I'd like to point out a few things:</p><p></p><ol><li><strong>Application</strong> is read-only and automatically set to "<strong>gql</strong>".</li><li>Set <strong>Type</strong> to "<strong>script</strong>" since we're using JavaScript in the <strong>Script</strong> section.</li><li>Set <strong>Path</strong> to "<strong>proc</strong>", short for "processor".</li><li><strong>Path Endpoint</strong> is read-only and is automatically set to "<strong>x_64935_gql_proc</strong>". Here, "<strong>64935</strong>" is the "Vendor prefix", which, in this case, is a numeric id automatically assigned based on the personal developer instance being used. "<strong>gql</strong>" is the application name and "<strong>proc</strong>" is the Path.</li></ol><p></p><p>Using the <strong>Path Endpoint</strong>, a web service call can be made using a URL similar to (replace "instance" with your own instance)</p><p></p><pre style="white-space: pre-wrap; color: #2873ee;">https://instance.service-now.com/x_64935_gql_proc.do?gql=SELECTnumber[Number],short_description[Title],dv_state[State],caller_id.email[Caller%20Email],dv_cmdb_ci[CI],cmdb_ciFROMincidentWHEREactive=true^priority&lt;2^EQ^ORDERBYpriority^ORDERBYDESCnumberLIMIT10&amp;format=HTML</pre><p></p><p>This returns an HTML table similar to this (from Incident demo data):</p><p></p><table style="font: 9pt Arial; border-collapse: collapse; border: 1px solid #ccc;"><thead style="background-color: #eee;"><tr><th><strong>Number</strong></th><th><strong>Title</strong></th><th><strong>State</strong></th><th><strong>Caller Email</strong></th><th><strong>CI</strong></th><th><strong>cmdb_ci</strong></th></tr></thead><tbody><tr><td>INC0000055</td><td>SAP Sales app is not accessible</td><td>In Progress</td><td><a title="k-email-small" class="jive-link-email-small" href="mailto:carol.coughlin@example.com">carol.coughlin@example.com</a></td><td>SAP Sales and Distribution</td><td>26e494480a0a0bb400ad175538708ad9</td></tr><tr><td>INC0000054</td><td>SAP Materials Management is slow or there is an outage</td><td>On Hold</td><td><a title="k-email-small" class="jive-link-email-small" href="mailto:christen.mitchell@example.com">christen.mitchell@example.com</a></td><td>SAP Materials Management</td><td>26e44e8a0a0a0bb40095ff953f9ee520</td></tr><tr><td>INC0000053</td><td>The SAP HR application is not accessible</td><td>In Progress</td><td><a title="k-email-small" class="jive-link-email-small" href="mailto:margaret.gray@example.com">margaret.gray@example.com</a></td><td>SAP Human Resources</td><td>26e51a2f0a0a0bb4008628d2254c42db</td></tr><tr><td>INC0000052</td><td>SAP Financial Accounting application appears to be down</td><td>In Progress</td><td><a title="k-email-small" class="jive-link-email-small" href="mailto:bud.richman@example.com">bud.richman@example.com</a></td><td>SAP Financial Accounting</td><td>26e426be0a0a0bb40046890d90059eaa</td></tr><tr><td>INC0000051</td><td>Manager can't access SAP Controlling application</td><td>In Progress</td><td><a title="k-email-small" class="jive-link-email-small" href="mailto:employee@example.com">employee@example.com</a></td><td>SAP Controlling</td><td>26e46e5b0a0a0bb4005d1146846c429c</td></tr><tr><td>INC0000050</td><td>Can't access Exchange server - is it down?</td><td>In Progress</td><td><a title="k-email-small" class="jive-link-email-small" href="mailto:jerrod.bennett@example.com">jerrod.bennett@example.com</a></td><td>EXCH-SD-05</td><td>281190e3c0a8000b003f593aa3f20ca6</td></tr><tr><td>INC0000031</td><td>When can we get off Remedy? UI is killing us</td><td>In Progress</td><td><a title="k-email-small" class="jive-link-email-small" href="mailto:employee@example.com">employee@example.com</a></td><td></td><td></td></tr><tr><td>INC0000025</td><td>I need more memory</td><td>In Progress</td><td><a title="k-email-small" class="jive-link-email-small" href="mailto:don.goodliffe@example.com">don.goodliffe@example.com</a></td><td>IBM-T42-DLG</td><td>469facd7a9fe1981015830c43428ca2d</td></tr><tr><td>INC0000018</td><td>Sales forecast spreadsheet is READ ONLY</td><td>In Progress</td><td><a title="k-email-small" class="jive-link-email-small" href="mailto:taylor.vreeland@example.com">taylor.vreeland@example.com</a></td><td></td><td></td></tr><tr><td>INC0000017</td><td>How do I create a sub-folder</td><td>On Hold</td><td><a title="k-email-small" class="jive-link-email-small" href="mailto:employee@example.com">employee@example.com</a></td><td></td><td></td></tr></tbody></table><p></p><p>At the end of the URL is the <strong>format</strong> parameter, which is set to "<strong>HTML</strong>" in the above example. This can be changed to "<strong>JSAN</strong>" or "<strong>JSON</strong>" to get the JSON encoded object, which opens up as a file in the browser that you can inspect. When the format is set to "<strong>CSV</strong>", a CSV-formatted file downloads and opens up in Microsoft Excel, if you have it set as the default application for CSV files.</p><p></p><p>I'm sure you can think of some use cases where a simple GET command via URL returns data you can easily consume. How about an email notification template with an embedded table listing stale tickets assigned to the individual recipients? Again, GQL can be used as a web service, as we just saw, or in any server-side scripts, just like what the above processor is doing. Either way, you pass a GQL statement and get back a result set without having to work with GlideRecords directly.</p><p></p><p>With this, we have now completed what we set out to do in <a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=f04ee2addbd0dbc01dcaf3231f961902">Part 2</a>:</p><p></p><ol><li><strong>GQL syntax</strong> - define GQL syntax to be used</li><li><strong>Processor</strong> - handle bidirectional HTTP traffic</li><li><strong>Parser</strong> - parse GQL query for processing</li><li><strong>Retriever</strong> - query and retrieve result set</li><li><strong>Encoder</strong> - encode result set for output</li></ol><p></p><p>addressing all of the requirements from <a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=a63eee6ddbd0dbc01dcaf3231f96194e"> Part 1</a>:</p><p></p><ol start="5" style="list-style-type: lower-alpha;"><li>Focus on SELECT for now.</li><li>Don't need complex Subqueries or CTEs (Common Table Expressions) for now.</li><li>Select the raw and/or display value of a field.</li><li>Be able to rename column headings.</li><li>Support dot walking of reference fields.</li><li>Be able to filter the result set.</li><li>Be able to sort by one or more columns.</li></ol><p></p><p>I haven't covered the use of the asterisk or calculated columns in the SELECT clause; these will be covered in the future.</p><p></p><p><a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=8d2e266ddbd0dbc01dcaf3231f9619ef">Next time</a>, we'll look at GQL Pad, an interactive GQL statement editor and executor built using a very simple UI Page with a touch of AngularJS; this will be a small "app" that's built on top of what we have seen so far. I'll also show you how to get the entire working app from GitHub in another blog. We're almost there, so please stay tuned!</p><p></p><p><em>Please feel free to connect, follow, post feedback / questions / comments, share, like, bookmark, endorse.</em></p><p>John Chun, <span style="font-size: 8pt;">PhD PMP</span> <a href="http://linkedin.com/in/DrJohnChun"><img alt="see John's LinkedIn profile" class="image-2 jive-image" src="http://megaicons.net/static/img/icons_sizes/182/456/16/linkedin-icon.png" style="height: auto; vertical-align: -13px;" title="see John's LinkedIn profile"/></a></p><p><a href="http://snowaid.com/"><img alt="visit snowaid" class="image-1 jive-image" src="http://snowaid.com/images/signature.png" style="height: auto; margin-top: -9px;" title="visit snowaid"/></a></p>