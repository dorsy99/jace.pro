---
title: "ServiceAware Incident Notifications"
date: 2016-07-11T19:21:23.000Z
authors: ["Mike Buckner"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=dcbc2a25dbd0dbc01dcaf3231f96192e"
---
<p>One of the major goals of the ServiceNow IT Operations Management portfolio is bringing business context to IT tools and processes. Service Mapping is one of the main ways this is achieved. By mapping a business service with our automated "top-down-approach," we are able to discover all the components that are strictly related to a particular service. This enables us to do a number of very powerful things. All of the relationship data between the CI's are stored in a table ("svc_ci_assoc") and we can query, report on, and visualize many aspects of the relationship between them. This offers us a number of powerful ways to think about IT (this is by no means an inclusive list):</p><p></p><ol style="list-style-type: decimal;"><li>Understanding the impact of various types of tasks such as incidents, problems, or changes. We can see not only what components are being affected, but also can see ancillary services being affected by shared CI's.</li><li>Leveraging this data in conjunction with Event Management to view the current state of their environment through a business-centric heat map of the mapped services.</li><li>Understanding the total cost of ownership for delivering a business service. By automating the mapping of all CI's in a service, we can report on a number of different aspects of that infrastructure. For example reporting on all CI's within a business service that extend from the hardware class (check out this excellent blog post by my colleagues Vinh and Richard on how to achieve this: <a title="" _jive_internal="true" href="/community/blogs/blog/2016/06/06/database-views-for-cmdb-reports)">https://community.servicenow.com/community/blogs/blog/2016/06/06/database-views-for-cmdb-reports)</a></li></ol><p></p><p>One of the things customers often ask me is "how can I include all of this rich service-aware metadata in our incident email notifications?" They assume if they've mapped their business services with Service Mapping already there must be a way to include information like the affected business services in the email notification.</p><p></p><p>Well, of course there is! What we need to look at are Email Notification Scripts which will let us query the CMDB for all the necessary relationships to feed into the email templates.</p><p></p><p>Let's take a look at the out-of-the-box email for an incident.</p><p><img   alt="Screen Shot 2016-07-11 at 8.19.22 AM.png" class="image-1 jive-image" src="cfb1680adb5c5304b322f4621f961949.iix" style="width: 620px; height: 382px;"/></p><p>This happens to be an incident spawned through Event Management, but will work regardless of how the incident is created. We can see a few important fields are included: Caller, Category, Severity, and Priority. We also have a link to go directly to the incident â€” that's neat, we should see if we can leverage that for our use case.</p><p></p><p>If we take a look at the out-of-the-box email template for incident_additional_details we see the following:</p><p><img   alt="Screen Shot 2016-07-11 at 8.25.12 AM.png" class="image-2 jive-image" src="2c31c402dbd4db048c8ef4621f961950.iix" style="width: 620px; height: 183px;"/></p><p>This is a fairly simple format. We can see that we have the ability to reference incident fields by using the ${field} syntax. Let's start with something simple and add the affected CI in the email template. All we need to do is add a line in the function to reference the cmdb_ci field.</p><p><img   alt="Screen Shot 2016-07-11 at 8.29.29 AM.png" class="image-5 jive-image" src="572a9cc2db5c17041dcaf3231f961982.iix" style="width: 620px; height: 192px;"/></p><p>Now let's see what the email looks like:</p><p></p><p><img   alt="Screen Shot 2016-07-11 at 8.30.30 AM.png" class="image-6 jive-image" src="797e3fb1db185fc068c1fb651f96193b.iix" style="width: 620px; height: 416px;"/></p><p>Great! Now we will have our CI's added to all new incidents being created. What we ultimately want is to add a list of all the business services being affected by a particular incident. It would also be nice if each list element were a URL that took us straight to our service map. Let's look at the data model to better understand how we might go about achieving this.</p><p></p><p>Here is a screenshot of the svc_ci_assoc table, which holds the relationship data for CI's and the business services they participate in.</p><p></p><p><img   alt="Screen Shot 2016-07-11 at 8.37.45 AM.png" class="image-4 jive-image" src="10f3e94edb5c130468c1fb651f961993.iix" style="width: 620px; height: 276px;"/></p><p></p><p>Pretty straightforward. What we need to do is query the table with the CI from the incident. Then we can get both the business service name for the URL &lt;a&gt; tag, and the sys_id to compose the URL for the service map.</p><p><img   alt="Screen Shot 2016-07-11 at 8.43.50 AM.png" class="image-7 jive-image" src="712529cedb90df048c8ef4621f9619e4.iix" style="width: 620px; height: 226px;"/></p><p>First we create some empty arrays to store the values we are retrieving. Then we query the svc_ci_assoc table passing in the CI value we said we would need. Since this email script applies to <em>incidents</em>, <em>current</em> is the current incident being processed, and current.cmdb_ci will give us the CI within the incident. From here loop through all the records and push the appropriate values into the arrays (take note that we are coercing the values into strings).</p><p></p><p>Now it should just be a simple matter of composing the URL for the service map. Let's take a look at a sample URL for one.</p><p></p><p><span style="background: lime;"><a title="" _jive_internal="true" href="https:" rel="nofollow" target="_blank">https://</a></span><span style="background: yellow;">my-instance</span><span style="background: lime;">.service-now.com/$sw_topology_map.do?sysparm_bsid=</span><span style="background: aqua;">f2df02b0d711120035ae23c7ce6103a0</span><span style="background: lime;">&amp;sysparm_bsname=</span><span style="background: aqua;">Inventory%20Management</span><span style="background: lime;">&amp;sysparm_plugin_mode=assurance</span></p><p></p><p>If we break down the composition of this URL we have a few things.</p><ul style="list-style-type: disc;"><li><span style="background: lime;">The protocol</span></li><li><span style="background: yellow;">The ServiceNow instance</span></li><li><span style="background: lime;">Some static URL information</span></li><li><span style="background: aqua;">The sys_id of the business service</span></li><li><span style="background: lime;">The key for the business service name key value pair</span></li><li><span style="background: aqua;">The value (name) of the business service, URI encoded</span></li><li><span style="background: lime;">A static key value pair (for our case at least)</span></li></ul><p></p><p>We should have all this information from the earlier query so let's put it all together.</p><p><img   alt="Screen Shot 2016-07-11 at 9.00.45 AM.png" class="image-8 jive-image" src="ec03090adbdc9304b322f4621f9619ff.iix" style="width: 620px; height: 238px;"/></p><p>Here, we loop through all the business service sys_id's we added to one our initial array, and for each one we compose the URL and push it to another array affectedServiceUrls. By using the gs.getProperty function, we can dynamically retrieve the name of our instance. We are also calling the encodeURI function to encode the name of the business service since it contains spaces.</p><p></p><p>From here it's as simple as printing out a new line in the email template just as we did earlier with the single CI, except now we should have a list of URLs for all our affected services!</p><p></p><p>Take a look at what our email looks like now.</p><p><img   alt="Screen Shot 2016-07-11 at 9.05.31 AM.png" class="image-9 jive-image" src="f3b1a8c6dbdc1f048c8ef4621f961943.iix" style="width: 620px; height: 218px;"/></p><p>Great! This seems to be exactly what we were looking for. Let's test the URL and make sure it works correctly.</p><p><img   alt="Screen Shot 2016-07-11 at 9.06.45 AM.png" class="image-10 jive-image" src="8d31880adb141344e9737a9e0f9619a9.iix" style="width: 620px; height: 337px;"/></p><p>It sure does! Now users can be brought right to the affected business service straight from the incident notification. This should definitely help drive lower MTTR!</p><p></p><p>Enjoy!</p>