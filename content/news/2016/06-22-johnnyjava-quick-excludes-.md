---
title: "Quick Excludes for Discovery Schedules"
date: 2016-06-21T22:44:27.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=1ffda62ddbd0dbc01dcaf3231f9619af"
---
<p>Discovery is a flexible and powerful tool for building a robust and trustworthy CMDB. If you've spent any time troubleshooting or enhancing Discovery, you may share my impression that Discovery Logs take a while to get used to reading. You may have <a href="https://docs.servicenow.com/bundle/geneva-it-operations-management/page/product/discovery/task/t_RunNetworkDiscovery.html" title="https://docs.servicenow.com/bundle/geneva-it-operations-management/page/product/discovery/task/t_RunNetworkDiscovery.html">Run network Discovery</a> to add your IP Ranges, or you may have chosen to <a href="https://docs.servicenow.com/bundle/geneva-it-operations-management/page/product/discovery/task/t_ImportIPRanges.html" title="https://docs.servicenow.com/bundle/geneva-it-operations-management/page/product/discovery/task/t_ImportIPRanges.html">Import IP ranges into Discovery schedules with import sets</a> . In either case, you probably have IP Addresses in your Discovery Schedules for devices that you cannot authenticate to.</p><p></p><p>There are many reasons you would see these in your Discovery Logs:</p><p>         </p><table border="0" cellpadding="0" cellspacing="0" height="189.77778" style="height: 101.778px; width: 1180.78px;"><tbody><tr><td class="xl65" height="17" width="126">Created</td><td class="xl65" width="70">Level</td><td class="xl65" width="91">Short Message</td><td class="xl65" width="105">Source</td><td class="xl65" width="70">Device</td></tr><tr><td align="left" class="xl63" height="68">2016-06-17 23:59:29</td><td class="xl64" width="70">Warning</td><td class="xl64" width="91">SSH authentication or connection failure</td><td class="xl64" width="70">UNIX Classify</td><td class="xl64" width="140">172.21.120.12</td></tr><tr><td align="left" class="xl63" height="85">2016-06-17 23:58:35</td><td class="xl64" width="70">Warning</td><td class="xl64" width="91">Authentication failure with the local MID server service credential.</td><td class="xl64" width="70">Windows Classify</td><td class="xl64" width="140">172.21.120.132</td></tr></tbody></table><p></p><p>In my case, these devices - and thousands more - are things like workstations or network devices that I already have in my CMDB through an integration source like SCCM or CiscoWorks. Sometimes they are Security appliances that Discovery isn't allowed to have Credentials for. On rare occasions they are devices where authentication is failing even though Discovery should have access. With 30k+ of these authentication failures happening daily, a few issues can be observed:</p><p></p><ul><li>Security and Systems Administrators take issue with something failing to authenticate to these devices every day. Especially if more than one credential is attempted. (rightfully so!)</li><li>Configuration Management and Service Now Administrators have messy logs to comb through when working with Discovery.</li><li>Discovery Schedules take longer than needed and they can already take all night to run if you have a large CMDB.</li></ul><p></p><p>Out of the box, excludes can be done manually but it's a tedious process to do it and then later maintain them. The question was asked <a title="Can discovery ranges exclude IP addresses dynamically?" __default_attr="865173" __jive_macro_name="message" class="jive_macro jive_macro_message" data-orig-content="Can discovery ranges exclude IP addresses dynamically?" data-renderedposition="514.6181030273438_7.986111640930176_1152_36" href="/community?id=community_question&sys_id=edbd076ddb9cdbc01dcaf3231f9619c3">Can discovery ranges exclude IP addresses dynamically?</a> I decided to work on it and the attached Update Set is what I came up with.</p><p></p><p></p><table border="1" class="jiveBorder" style="border: 1px solid #c6c6c6; width: 100%;"><tbody><tr><td style="padding: 6px;"><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;"><span style="font-size: 18pt;">Discovery Status</span></p><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;">Here is an example Discovery Status where upon completion, a Business Rule has processed the Discovery Logs looking for Authentication Failures.</p><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;">If authentication failures exist, QuickExcludes will query the CMDB looking for Hardware Configuration Items matching those IP Addresses which have Discovery Sources other than Service-Now.</p><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;">When a match is found, an Exclude Parent for the Discovery Source is created within the Discovery IP Range. Any matching IP Addresses with the same Discovery Source will be added to that Exclude Parent.</p></td><td style="padding: 6px;"><img   alt="discovery status with excludes.png" class="image-7 jive-image" src="82dd914edb5c1b04ed6af3231f9619fc.iix" style="width: 620px; height: 366px;"/></td></tr><tr><td style="padding: 6px;"><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;"><span style="font-size: 18pt;">Discovery Schedule</span></p><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;">Here is the resulting Discovery Schedule with Excludes added as a Related List to the form view.</p><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;">Note that the Discovery Source "MS SMS" (SCCM) appears multiple times, as does CiscoWorks. This is because the Discovery Schedule is comprised of multiple IP Ranges. Each of these Ranges must have an Exclude Parent to hold any IP Address Excludes within that IP Range. To logically separate the Excludes, an Exclude Parent for each integration source holds all the Exclude Range Item IP's for that Discovery Source.</p></td><td style="padding: 6px;"><img   alt="discovery schedule with excludes.png" class="image-6 jive-image" src="124ffbf9db185fc068c1fb651f9619e4.iix" style="width: 620px; height: 369px;"/></td></tr><tr><td style="padding: 6px;"><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;"><span style="font-size: 18pt;">Manual Excludes</span></p><p></p><p></p><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;">From time to time it may be required that IP Addresses should be excluded for reasons other than their presence in the CMDB through another Data Source. In this case, a person with the cmdb_admin role can list select the IP in the Discovery Logs to Manually Exclude those IP addresses. These Excludes will be contained as the others, with the Exclude Parent being the UID of the user who excluded them.</p></td><td style="padding: 6px;"><img   alt="manual quick exclude UI action.png" class="image-5 jive-image" src="65c8bff9db10db048c8ef4621f9619e1.iix" style="width: 620px; height: 335px;"/></td></tr><tr><td style="padding: 6px;"><p><span style="color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 18pt;">Maintenance</span></p><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;">Once we exclude an IP Address from Discovery, it becomes necessary to know when to expire that exclusion so that if the IP Address is re-assigned, we will again Discover any device using that IP Address. A scheduled job can be ran nightly to verify that each Exclude still has an Operational Hardware Configuration Item that matches.</p><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;"></p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_14665310139794596 jive_macro_code jive_text_macro" data-renderedposition="1964.947998046875_14.097223281860352_520_40" jivemacro_uid="_14665310139794596"><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;">var qe = new QuickExcludes();</p><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;">qe.verifyExcludes();</p></pre><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;"></p><p style="margin-bottom: 9px; color: #343d47; font-family: SourceSansPro, 'Helvetica Neue', Arial; font-size: 13px;">Note: Manual QuickExcludes are not checked for hardware records before creation and not removed by the scheduled job.</p></td><td style="padding: 6px;"><img   alt="manual quick excludes created.png" class="image-4 jive-image" src="81bb5806db1c9fc068c1fb651f961906.iix" style="width: 620px; height: 362px;"/></td></tr></tbody></table>