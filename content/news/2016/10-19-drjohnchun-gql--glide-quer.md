---
title: "GQL Glide Query Language Part  The Retriever"
date: 2016-10-18T21:44:26.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=235e2eaddbd0dbc01dcaf3231f961929"
---
<p><a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=71ed6ee9dbd0dbc01dcaf3231f96197e">Last time</a>, we designed the parser that decomposes a GQL statement into the four main parts:</p><p></p><pre __default_attr="sql" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_14767148004715302" data-renderedposition="50_8_1192_64" jivemacro_uid="_14767148004715302"><p>SELECT column_list</p><p>FROM table</p><p>WHERE encoded_query_string</p><p>LIMIT [offset,] row_count</p></pre><p></p><p>We saw how the SELECT column_list would be parsed and which <a title="ki.servicenow.com/?title=Scoped_GlideRecord_API_Reference" href="http://wiki.servicenow.com/?title=Scoped_GlideRecord_API_Reference">Scoped GlideRecord</a> methods we might use for the FROM, WHERE, and LIMIT clauses. This time, let's work on the retriever that runs the query and retrieves the resultset.</p><p></p><p>Let's take a look at how we may put this together:</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_14768046733574090 jive_macro_code jive_text_macro" data-renderedposition="240_8_1192_128" jivemacro_uid="_14768046733574090"><p>// run query &amp; retrieve data</p><p>var records = [];   // array of rows</p><p>var gr = new GlideRecord(table);</p><p>if (encodedQuery) gr.addEncodedQuery(encodedQuery);</p><p>if (offset) gr.chooseWindow(offset, offset + limit);</p><p>else if (limit) gr.setLimit(limit);</p><p>gr.query();</p><p>while (gr.next()) records.push(getRow());</p></pre><p></p><p>This gets quite simple with the help of Scoped GlideRecord; it iterates over all glide records and returns an array of record objects. The <span style="font-family: 'courier new', courier;">getRow()</span> function returns the columns, either in raw or display values (if the field name is prefixed with "dv_"):</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_1476805835751720 jive_text_macro" data-renderedposition="452.8999938964844_8_1192_144" jivemacro_uid="_1476805835751720"><p>function getRow() {</p><p>   var row = {};</p><p>   for (var i = 0; i &lt; columns.length; i++) {</p><p>       var field = columns[i].field, isDV = /(^|\.)dv_/.test(field);</p><p>       var value = isDV ? gr.getDisplayValue(field.replace('dv_', '')) || '' : gr.getElement(field).toString();</p><p>       row[columns[i].label] = value;</p><p>   }</p><p>   return row;</p><p>}</p></pre><p></p><p>The <span style="font-family: 'courier new', courier;">gr.getDisplayValue()</span> and <span style="font-family: 'courier new', courier;">gr.getElement()</span> methods handle dot-walking for us. <span style="font-family: 'courier new', courier;">gr.getElement()</span> returns <tt><a href="http://wiki.servicenow.com/index.php?title=Scoped_GlideElement_API_Reference" title="Scoped GlideElement API Reference">GlideElement</a></tt> so we need to convert it to string to get the raw value (if not converted, the JSON encoder will treat it as an object, which is not what we want). The <span style="font-family: 'courier new', courier;">columns</span> array is obtained from the <span style="font-family: 'courier new', courier;">column_list</span> and each array element is an object representing a column with field and label (column heading) properties:</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14768061261254964 jive_text_macro" data-renderedposition="703.7000122070312_8_1192_96" jivemacro_uid="_14768061261254964"><p>// parse column_list</p><p>columns = columns.split(/\s*,\s*/);   // split column_list column_1, column_2 [column_2_heading], column_3</p><p>for (var i = 0; i &lt; columns.length; i++) {   // parse column heading</p><p>   matches = /([.\w]+)\s*(?:\[(.+)\])?/.exec(columns[i]);</p><p>   columns[i] = { field: matches[1], label: matches[2] || matches[1] };   // if no label, use field name</p><p>}</p></pre><p></p><p>Putting everything together, we have a <a title="ki.servicenow.com/?title=Script_Includes" href="http://wiki.servicenow.com/?title=Script_Includes">Script Include</a> with the GQL class:</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_14768076089584287" data-renderedposition="862.699951171875_8_1192_992" jivemacro_uid="_14768076089584287"><p>/** </p><p>* GQL (Glide Query Language) class</p><p>*/   </p><p></p><p>var GQL = Class.create();</p><p>GQL.prototype = {</p><p>   initialize: function() { },</p><p>   type: 'GQL'</p><p>};</p><p></p><p>/** </p><p>* Takes a GQL statement and returns the resultset in an array of records</p><p>* </p><p>* @param {string} gql - GQL statement </p><p>* @return {object} resultset in an array of records</p><p>*/   </p><p></p><p>GQL.prototype.query = function(gql) {</p><p></p><p>   // parse gql</p><p>   gql = gql.replace(/\s*--.*/g, '');         // remove comments</p><p>   var rxParser = /SELECT\s*([^]+?)\s*FROM\s*(.+?)\s*(?:WHERE\s*([^]+?(?=\s*LIMIT)|[^]+?)\s*)?(?:LIMIT\s*([,\d\s]+?)\s*)?$/;</p><p>   var matches = rxParser.exec(gql);</p><p>   var columns = matches[1] || '';               // SELECT column_list</p><p>   var table = matches[2] || '';                   // FROM table name</p><p>   var encodedQuery = matches[3] || '';     // WHERE encoded_query_string</p><p>   var limit = matches[4] || '';                   // LIMIT [offset,] row_count</p><p>   var offset = 0;</p><p>   if (limit) {   // parse offset, row_count</p><p>       limit = limit.split(',');</p><p>       if (limit.length &gt; 1) offset = parseInt(limit[0], 10) || 0;</p><p>       limit = parseInt(limit[limit.length &gt; 1 ? 1 : 0], 10) || 0;</p><p>   }</p><p></p><p>   // parse column_list</p><p>   columns = columns.split(/\s*,\s*/);   // split column_list column_1, column_2 [column_2_heading], column_3</p><p>   for (var i = 0; i &lt; columns.length; i++) {   // parse column heading</p><p>       matches = /([.\w]+)\s*(?:\[(.+)\])?/.exec(columns[i]);</p><p>       columns[i] = { field: matches[1], label: matches[2] || matches[1] };   // if no label, use field name</p><p>   }</p><p></p><p>   // run query &amp; retrieve data</p><p>   var records = [];   // array of rows</p><p>   var gr = new GlideRecord(table);</p><p>   if (encodedQuery) gr.addEncodedQuery(encodedQuery);</p><p>   if (offset) gr.chooseWindow(offset, offset + limit);</p><p>   else if (limit) gr.setLimit(limit);</p><p>   gr.query();</p><p>   while (gr.next()) records.push(getRow());</p><p></p><p>   return { records: records };</p><p></p><p>   function getRow() {</p><p>       var row = {};</p><p>       for (var i = 0; i &lt; columns.length; i++) {</p><p>           var field = columns[i].field, isDV = /(^|\.)dv_/.test(field);</p><p>           var value = isDV ? gr.getDisplayValue(field.replace('dv_', '')) || '' : gr.getElement(field).toString();</p><p>           row[columns[i].label] = value;</p><p>       }</p><p>       return row;</p><p>   }</p><p>};</p></pre><p></p><p>This doesn't yet have any GQL syntax checking or run-time error handling, but will give us a good starting point. By having this in a Script Include, we can use it not only for web services, but also in any server-side scripts.</p><p></p><p><a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=52fd662ddbd0dbc01dcaf3231f96198b">Next time</a>, we'll take a look at the encoder.</p><p></p><p><em>Please feel free to connect, follow, post feedback / questions / comments, share, like, bookmark, endorse.</em></p><p>John Chun, <span style="font-size: 8pt;">PhD PMP</span> <a href="http://linkedin.com/in/DrJohnChun"><img alt="see John's LinkedIn profile" class="image-2 jive-image" src="http://megaicons.net/static/img/icons_sizes/182/456/16/linkedin-icon.png" style="height: auto; vertical-align: -13px;" title="see John's LinkedIn profile"/></a></p><p><a href="http://snowaid.com/"><img alt="visit snowaid" class="image-1 jive-image" src="http://snowaid.com/images/signature.png" style="height: auto; margin-top: -9px;" title="visit snowaid"/></a></p>