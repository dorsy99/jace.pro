---
title: "Validating the order of execution for transform map scripts"
date: 2016-06-03T21:08:07.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=69ada2a9dbd0dbc01dcaf3231f961996"
---
<p>What do <a title="ocs.servicenow.com/bundle/geneva-servicenow-platform/page/script/server_scripting/reference/r_MapWithTransformationEventScripts.html" href="https://docs.servicenow.com/bundle/geneva-servicenow-platform/page/script/server_scripting/reference/r_MapWithTransformationEventScripts.html">Transform Map Scripts</a> and algebra have in common? Not much, except the order of execution (precedence) is very important to the final result.   Transform maps provide many opportunities for scripting, but do you know which order they will be executed when data is processed through the mapping?</p><p></p><p>I was recently involved with an import project that needed some fine-tuning.   During this exercise, we found that we were making multiple GlideRecord calls to find the same pieces of data, and this was being done through the various transform map scripts.   Of course, we decided the best option was to make the call once, then store the returned data in variables.   Even though this was the best approach, the results were not exactly what we expected.</p><p></p><p>After some trial-and-error, we found that the order in which we expected the scripts to execute was not the order in which they actually ran.   To make sure we all know exactly what to expect, I created some data to process, and wrote a few different types of scripts (with log.info() statements) to help capture some details.   The log statements will show us which scripts executed, and which order they were processed.</p><p></p><h2>Here is an exercise to validate the exact order of execution for the various types of transform map scripts.</h2><p>First, let's define the types of <a title="ocs.servicenow.com/bundle/geneva-servicenow-platform/page/script/server_scripting/reference/r_MapWithTransformationEventScripts.html" href="https://docs.servicenow.com/bundle/geneva-servicenow-platform/page/script/server_scripting/reference/r_MapWithTransformationEventScripts.html">transform map scripts</a>:</p><ul><li>onStart - The onStart event script is processed at the start of an import run, before any data rows are read.</li><li>onBefore - The onBefore event script is processed at the start of a row transformation, before the source row is transformed into the target row.</li><li>onAfter - The onAfter event script is processed at the end of a row transformation, after the source row has been transformed into the target row and saved.</li><li>onComplete - The onComplete event script is processed at the end of an import run, after all data rows are read and transformed.</li><li><a title="ocs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/import_sets/reference/r_FieldMapScriptVars.html" href="https://docs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/import_sets/reference/r_FieldMapScriptVars.html">FieldMap</a> - Available in the Source script field.</li><li>"Run script" - the script which is displayed when the "Run script" checkbox is selected.</li></ul><p></p><p>To make sure we exercised the majority of options, with an eye on keeping the output log manageable, here are the tests I've decided to run.</p><ol><li>Successful insert.</li><li>Update the record.</li></ol><p></p><p>The import set will contain four rows. The third row will ignore, and the fourth row will error (ignore and error will be set in the onBefore script).   Each row will contain three columns.   The first will be the <a title="ocs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/managing_data/reference/r_CoalesceOptions.html" href="https://docs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/managing_data/reference/r_CoalesceOptions.html">coalesce</a> field, and the next two will each have field map scripts.</p><p></p><p>I will have log.info statements in each of the scripts, printing some details about the script, and some row details being processed.   I also added the date/time (in milliseconds) to the start of each log statement so we can sort A-Z on the Message column, so it will be in the correct order of execution.</p><p></p><p>Here's what I used:</p><p>var gdt = new GlideDateTime();</p><p>var info = gdt.getNumericValue()+</p><p></p><p>DATA:</p><table border="1" class="jiveBorder" style="border: 1px solid #c6c6c6; width: 100%;"><tbody><tr><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px;" valign="middle"><strong>RecNumber</strong></th><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px;" valign="middle"><strong>Field1<br/></strong></th><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px;" valign="middle"><strong>Field2</strong></th></tr><tr><td style="padding: 6px;">1</td><td style="padding: 6px;">Rec1Field1</td><td style="padding: 6px;">Rec1Field2</td></tr><tr><td style="padding: 6px;">1</td><td style="padding: 6px;">Rec2Field1</td><td style="padding: 6px;">Rec2Field2</td></tr><tr><td style="padding: 6px;">3</td><td style="padding: 6px;">Rec3Field1</td><td style="padding: 6px;">Rec3Field2</td></tr><tr><td style="padding: 6px;">4</td><td style="padding: 6px;">Rec4Field1</td><td style="padding: 6px;">Rec4Field2</td></tr></tbody></table><p></p><p>I know it is not very exciting, but hopefully it will make reading the log statements clear.</p><p></p><p>I created a .csv file with this set of data.   Using a "File" data source, I attached the file, and performed a test load of 20 records. </p><p><img  alt="DataSource.jpg" class="image-5 jive-image" src="5b9a80cedb9017049c9ffb651f961918.iix" style="width: 620px; height: 230px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p>This created an import set table called u_transformscriptlogger.   I was then able to create the transform map so I could call the scripts.   The scripts I used (provided below) used log.info() statements so I could capture some output in the transform log (found in the navigator).</p><p><img  alt="ImportLog_Filter.jpg" class="image-6 jive-image" height="461" src="54bd27fddb9893041dcaf3231f961941.iix" style="height: 461px; width: 275.892583120205px; display: block; margin-left: auto; margin-right: auto;" width="276"/></p><p>Which then provides the import log messages that were printed through the log statements. </p><p></p><p>For example:</p><p><img  alt="LogSamples.jpg" class="image-7 jive-image" height="419" src="01f21d06dbd89f048c8ef4621f9619e3.iix" style="width: 379px; height: 419.345161290323px; display: block; margin-left: auto; margin-right: auto;" width="379"/></p><p></p><p><span style="font-size: 14pt;"><strong>After running the transform map to process the data, this was the message output: <span style="color: #eb7a3d;"><br/></span></strong></span></p><p>1462763686601 onStart</p><p>1462763686610 onBefore 1 Ignore: false Error: false</p><p>1462763686612 Field Map Rec1Field1</p><p>1462763686614 Field Map Rec1Field2</p><p>1462763686616 Run script</p><p>1462763686637 onAfter 1</p><p>1462763686641 onBefore 1 Ignore: false Error: false</p><p>1462763686644 Field Map Rec2Field1</p><p>1462763686646 Field Map Rec2Field2</p><p>1462763686648 Run script</p><p>1462763686653 onAfter 1</p><p>1462763686656 onBefore 3 Ignore: true Error: false</p><p>1462763686659 onAfter 3</p><p>1462763686663 onBefore 4 Ignore: false Error: true</p><p style="padding-left: 30px;">com.glide.db.impex.transformer.TransformerScriptException: onBefore script error.</p><p style="padding-left: 30px;">at com.glide.db.impex.transformer.TransformerScript.checkErrorCondition(TransformerScript.java:79)</p><p style="padding-left: 30px;">at com.glide.db.impex.transformer.TransformerScript.runScript(TransformerScript.java:63)</p><p style="padding-left: 30px;">at com.glide.db.impex.transformer.TransformerScript.runWhenScript(TransformerScript.java:122)</p><p style="padding-left: 30px;">at com.glide.db.impex.transformer.Transformer.runOnBeforeScript(Transformer.java:269)</p><p style="padding-left: 30px;">at com.glide.db.impex.transformer.Transformer.transformBatch(Transformer.java:142)</p><p style="padding-left: 30px;">at com.glide.db.impex.transformer.Transformer.transform(Transformer.java:76)</p><p style="padding-left: 30px;">at com.glide.system_import_set.ImportSetTransformerImpl.transformEach(ImportSetTransformerImpl.java:237)</p><p style="padding-left: 30px;">at com.glide.system_import_set.ImportSetTransformerImpl.transformAllMaps(ImportSetTransformerImpl.java:91)</p><p style="padding-left: 30px;">at com.glide.system_import_set.ImportSetTransformerWorker.startWork(ImportSetTransformerWorker.java:40)</p><p style="padding-left: 30px;">at com.glide.worker.AbstractProgressWorker.startAndWait(AbstractProgressWorker.java:86)</p><p style="padding-left: 30px;">at com.glide.worker.ProgressWorker.startAndWait(ProgressWorker.java:52)</p><p style="padding-left: 30px;">at com.glide.worker.ProgressWorkerThread.run(ProgressWorkerThread.java:50)</p><p>onBefore script error.</p><p></p><p>The expectation was that the "run script" would execute either just before, or just after the onBefore script for each row, but this testing shows that this is not the case. The <strong>onStart</strong> script executed first, as expected. Then, the <strong>onBefore</strong> script for the first inserted record executed. Followed by the <strong>field map</strong> scripts, and then the "<strong>run script</strong>" executed after the field mapping scripts. Finally, the <strong>onAfter</strong> script for the first record executed.</p><p></p><p>The next row was executed in the same order, so it didn't matter if the record was inserted or updated (based on the coalesce value).</p><p></p><p>The third row may not have executed as expected.</p><p></p><p>The log shows:</p><p>1462763686656 onBefore 3 Ignore: true Error: false</p><p>1462763686659 onAfter 3</p><p></p><p>So, even though the 3rd record   set the "ignore" variable to "true", the   <strong>onAfter</strong> script executed.   The field map scripts and the "run script" obeyed the "ignore" but the <strong>onAfter</strong> script executed.   As I was working on this blog post, I see this tweet by fellow Support engineer <a title="jonnyseymour" __default_attr="45437" __jive_macro_name="user" class="jive_macro jive_macro_user" data-orig-content="jonnyseymour" data-renderedposition="3219.23291015625_570.096435546875_106_16" href="/community?id=community_user_profile&user=b0035ee1db1c1fc09c9ffb651f9619d1">jonnyseymour</a> which helped explain exactly why this happened.   Here's the tweet and KB number:</p><p><img   alt="transform map tweet.jpg" class="image-1 jive-image" src="bc63900adb141f048c8ef4621f9619a1.iix" style="width: 620px; height: 346px; display: block; margin-left: auto; margin-right: auto;"/></p><p style="padding-left: 30px; text-align: center;">Linking to <a href="https://hi.service-now.com/kb_view.do?sysparm_article=KB0563524" title="https://hi.service-now.com/kb_view.do?sysparm_article=KB0563524">ServiceNow KB: Import Set onAfter script runs for ignored rows during transformation (KB0563524)</a></p><p></p><p>Finally, for row 4, I set error = true, and processing was terminated. Not just processing for that row, but for the entire import set. I ran it again, without setting any errors, and after the onAfter of the last row was executed, the onComplete script ran.</p><p></p><h2>This gives us three take-aways:</h2><ol><li>The correct order of execution for transform map scripts are:<ol><li><strong>onStart</strong></li><li><strong>onBefore</strong> executes on each row before any other processing is performed</li><li>then we process the <strong>field mapping</strong> scripts</li><li>the "<strong>run script</strong>" script follows the field map scripts</li><li>we then process the <strong>onAfter</strong> script</li><li>and finally, after all of the data has been processed, we finish with the <strong>onComplete</strong> script.</li></ol></li><li>Setting "ignore" to true will not prevent the <strong>onAfter</strong> script from executing.   It only prevents the "<strong>run script</strong>" and <strong>field mappings</strong> from being processed for the record being ignored.</li><li>When "error" is set to true, all processing for that import set will stop.   No additional scripts will be processed, including <strong>onComplete</strong>.</li></ol><p></p><p>Happy Mapping!</p><p></p><p>PS: For completeness here are the scripts:</p><table border="1"><tbody><tr><td><strong>"run script"</strong></td><td><p>var gdt = new GlideDateTime();</p><p>var info = gdt.getNumericValue()+" Run script";</p><p>log.info(info);</p></td></tr><tr><td><strong>onStart</strong></td><td><p>var gdt = new GlideDateTime();</p><p>var info = gdt.getNumericValue()+" onStart";</p><p>log.info(info);</p></td></tr><tr><td><strong>onBefore</strong></td><td><p>if (source.u_recnumber == 3)</p><p>   ignore = true;</p><p>if (source.u_recnumber == 4)</p><p>   error = true;</p><p></p><p>var gdt = new GlideDateTime();</p><p>var info = gdt.getNumericValue() + " onBefore " + source.u_recnumber + " Ignore: " + ignore + " Error: " + error;</p><p></p><p>log.info(info);</p></td></tr><tr><td><strong>onAfter</strong></td><td><p>var gdt = new GlideDateTime();</p><p>var info = gdt.getNumericValue()+" onAfter "+source.u_recnumber;</p><p>log.info(info);</p></td></tr><tr><td><strong>onComplete</strong></td><td><p>var gdt = new GlideDateTime();</p><p>var info = gdt.getNumericValue()+" onComplete ";</p><p>log.info(info);</p><p></p><p><strong>Field Map:</strong></p><p>var gdt = new GlideDateTime();</p><p>var info = gdt.getNumericValue()+" Field Map "+source.u_field1</p><p>log.info(info);</p><p></p><p>and</p><p></p><p>var gdt = new GlideDateTime();</p><p>var info = gdt.getNumericValue()+" Field Map " +source.u_field2;</p><p>log.info(info);</p></td></tr><tr><td><strong>Field Map</strong></td><td><p>var gdt = new GlideDateTime();</p><p>var info = gdt.getNumericValue()+" Field Map "+source.u_field1</p><p>log.info(info);</p><p></p><p>and</p><p>var gdt = new GlideDateTime();</p><p>var info = gdt.getNumericValue()+" Field Map " +source.u_field2;</p><p>log.info(info);</p></td></tr></tbody></table><p></p><p></p><p><em>My testing was performed with Fuji and Geneva.</em></p>