---
title: "Using utilities in Scoped Applications to replace inaccessible APIs"
date: 2016-04-16T03:01:14.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=5f1ea26ddbd0dbc01dcaf3231f961909"
---
<p>In November, I wrote a blog post called <a __default_attr="4957" __jive_macro_name="blogpost" class="jive_macro jive_macro_blogpost" data-orig-content="Background and Philosophy of Scoped Applications" data-renderedposition="10_256.65625_347_16" href="/community?id=community_blog&sys_id=801e6e2ddbd0dbc01dcaf3231f9619d8" modifiedtitle="true" title="Background and Philosophy of Scoped Applications">Background and Philosophy of Scoped Applications</a>. It recently generated an interesting discussion about the limits of the available APIs for scoped apps, with focus on one specific function: <em>gs.dateGenerate</em>. This post will hopefully help you figure out how to work within the available APIs to achieve the same goals in a scoped application that you could achieve in a global one.</p><p></p><h2>The scoped API</h2><p>The scoped API is mostly a subset of the existing Glide API that we all know and love. Both the legacy and the scoped API set are documented on our <a href="https://developer.servicenow.com/app.do#!/api_doc?v=geneva&amp;type=server&amp;scoped=true" title="https://developer.servicenow.com/app.do#!/api_doc?v=geneva&amp;type=server&amp;scoped=true">ServiceNow Developers</a>   site. Since the scoped API is essentially a subset of the legacy API, there will necessarily be some classes and functions which are not available. One such method is "<em>gs.dateGenerate</em>". The scoped API includes GlideDateTime and GlideDuration, and is capable of doing all of the same calculations that <em>gs.dateGenerate</em> can do, but we have to do a little bit of work to make that happen.</p><p></p><h3>Utility classes</h3><p>I'm a fan of writing utility classes. I like making tools, probably more than I like making things with those tools. A utility class is typically the first thing I start with when I make a new scoped application. It starts out empty, and I add to it as I find myself needed the same generic functions multiple times during the course of development. When I find myself using the same things across multiple applications, I'll pull those out into a new application, and make my app depend on <em>that</em>. I don't want to reinvent the wheel every time I need to make a wagon.</p><p></p><h4>Creating the Utility</h4><p>The most basic utility class is really just an object. This is a good pattern to use, because it prevents you from having to <span style="color: #e23d39;"><em><strong>new</strong></em><span style="color: #303030;"> it every time you need to use it. For our example, we're going to create an object with a single function. We'll give it a short name so it's easy to use, and we won't be using the default template it auto-generates for us.</span></span></p><p><span style="color: #303030;"><img   alt="Screen Shot 2016-04-15 at 11.38.49 AM.PNG" class="image-1 jive-image" src="f8e0304edbd49344e9737a9e0f961917.iix" style="width: 620px; height: 358px;"/></span></p><p><span style="color: #303030;">I named my include "Tools" and marked it "Client callable" and "Accessible from: All application scopes". Client-callable enables us to use this include in URLs, which is important for our use-case. Making it available to other application scopes means that I am committing to making this an API point for my application. I won't introduce breaking changes without prior notification to my potential users, and the code I am providing should be side-effect-free. You don't need to make your tools available to other scopes unless you are writing an application specifically to provide a toolset to other applications.</span></p><p></p><p><span style="color: #303030;">I've also changed the Script. By default the Script Include form auto-generates a template for our include based on the anme we provided it. The template looked like this:</span></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14607458675904358 jive_text_macro" data-renderedposition="886_8_1192_64" jivemacro_uid="_14607458675904358"><p>var Tools = Class.create();</p><p>Tools.prototype = Object.extendsObject(global.AbstractAjaxProcessor, {</p><p>       type: 'Tools'</p><p>});</p></pre><p></p><p><span style="color: #303030;">I've decided that this particular set of tools doesn't need to maintain state internally, so there is no reason to use Class.create(). If multiple people want to work with the methods on this object, they can do so without colliding. That's why we're starting with an empty object:</span></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14607477642938102 jive_text_macro" data-renderedposition="1013_8_1192_16" jivemacro_uid="_14607477642938102"><p>var Tools = {};</p></pre><p></p><p><span style="color: #303030;">The first function we want to add is a replacement for <em>gs.dateGenerate</em>. It helps to know that the original dateGenerate function is really just a convenience method that works on GlideDateTime objects. If we were to convert the function from Java to JavaScript, it would look like this:</span></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_14607478726694012" data-renderedposition="1092_8_1192_176" jivemacro_uid="_14607478726694012" modifiedtitle="true"><p>gs.dateGenerate = function(date, range) {</p><p>     var gdt = new GlideDateTime();</p><p>     if (range.equals("start"))</p><p>           gdt.setDisplayValueInternal(date + " 00:00:00");</p><p>     else if (range.equals("end"))</p><p>           gdt.setDisplayValueInternal(date + " 23:59:59");</p><p>     else</p><p>           gdt.setDisplayValueInternal(date + " " + range);</p><p></p><p>     return gdt.getValue();</p><p>}</p></pre><p></p><p><span style="color: #303030;">That is pretty simple. We'll copy that nearly verbatim into our Tools include, since every object type it access and every option it does is supported within the scoped API. When we copy that into our include, it looks like this:</span></p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_1460753309874144 jive_macro_code jive_text_macro" data-renderedposition="1331_8_1192_272" jivemacro_uid="_1460753309874144" modifiedtitle="true"><p>var Tools = {};</p><p></p><p></p><p>Tools.dateGenerate = function(date, range) {</p><p>       if (!range)</p><p>               range = '12:00:00';</p><p>       </p><p>       var gdt = new GlideDateTime();</p><p>       if (range.equals("start"))</p><p>               gdt.setDisplayValueInternal(date + " 00:00:00");</p><p>       else if (range.equals("end"))</p><p>               gdt.setDisplayValueInternal(date + " 23:59:59");</p><p>       else</p><p>               gdt.setDisplayValueInternal(date + " " + range);</p><p>       </p><p>       return gdt.getValue();</p><p>}</p></pre><p></p><p>We added a default value for the range. The original Java function doesn't supply a default value and returns an empty result if you call it that way:</p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_146075389070070 jive_text_macro" data-renderedposition="1645_8_1192_32" jivemacro_uid="_146075389070070"><p>var generatedDate = gs.dateGenerate('2016-04-14');</p><p>gs.print(generatedDate);</p></pre><p></p><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="1708_8_1192_64" modifiedtitle="true"><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="1728_30_1150_24" modifiedtitle="true"><p><span style="color: #000000; font-family: Times; font-size: medium;">[0:00:00.001] Script completed in scope global: script</span></p></pre></pre><hr style="color: #000000; font-family: Times; font-size: medium;"/><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="1794_8_1192_69" modifiedtitle="true"><pre style="color: #000000;">*** Script: </pre></pre><p>If we left out the default, we would have the same result. That's up to you- it's your utility.</p><p></p><h3>Using the utility</h3><p>Now that we have our replacement for <em>dateGenerate</em>, we want to make use of it. There is one part of the system that relies on <em>dateGenerate</em> pretty heavily: encoded queries. If you open the Incident list and filter between two dates you can see this happen:</p><p><img  alt="Screen Shot 2016-04-15 at 2.02.46 PM.PNG" class="image-2 jive-image" src="0050f7b1dbd8dfc0b322f4621f96190c.iix" style="width: 620px; height: 384px;"/></p><p>The encoded query being run on this list is:</p><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="2420_8_1192_41"><p>opened_atBETWEENjavascript:gs.dateGenerate('2016-02-01','12:00:00')@javascript:gs.dateGenerate('2016-03-31','12:00:00')</p></pre><p></p><p>If we attempted to run that same query in a script in our application, we would get an error:</p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14607543709765102 jive_text_macro" data-renderedposition="2513_8_1192_96" jivemacro_uid="_14607543709765102" modifiedtitle="true"><p>var enq = "opened_atBETWEENjavascript:gs.dateGenerate('2016-02-01','12:00:00')@javascript:gs.dateGenerate('2016-03-31','12:00:00')";</p><p>var inc = new GlideRecord('incident');</p><p>inc.addEncodedQuery(enq);</p><p>inc.query();</p><p></p><p>gs.info(inc.getRowCount());</p></pre><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="2619_8_1192_1049"><p>[0:00:00.248] Script completed in scope sn_custom_app: script</p><p>Security restricted: Read operation against 'incident' from scope 'sn_custom_app' was granted and added to 'sn_custom_app' cross-scope privileges</p><p>Evaluator: com.glide.script.fencing.MethodNotAllowedException: Function dateGenerate is not allowed in scope sn_custom_app</p><p>     Caused by error in script at line 1</p><p></p><p></p><p>==&gt;     1: var enq = "opened_atBETWEENjavascript:gs.dateGenerate('2016-02-01','12:00:00')@javascript:gs.dateGenerate('2016-03-31','12:00:00')";</p><p>           2: var inc = new GlideRecord('incident');</p><p>           3: inc.addEncodedQuery(enq);</p><p>           4: inc.query();</p><p></p><p></p><p>Evaluator: com.glide.script.fencing.MethodNotAllowedException: Function dateGenerate is not allowed in scope sn_custom_app</p><p>     Caused by error in script at line 4</p><p></p><p></p><p>           1: var enq = "opened_atBETWEENjavascript:gs.dateGenerate('2016-02-01','12:00:00')@javascript:gs.dateGenerate('2016-03-31','12:00:00')";</p><p>           2: var inc = new GlideRecord('incident');</p><p>           3: inc.addEncodedQuery(enq);</p><p>==&gt;     4: inc.query();</p><p>           5: </p><p>           6: gs.info(inc.getRowCount());</p><p></p><p></p><p>Background message, type:error, message: Function dateGenerate is not allowed in scope sn_custom_app</p><p>Evaluator: com.glide.script.fencing.MethodNotAllowedException: Function dateGenerate is not allowed in scope sn_custom_app</p><p>     Caused by error in script at line 1</p><p></p><p></p><p>==&gt;     1: var enq = "opened_atBETWEENjavascript:gs.dateGenerate('2016-02-01','12:00:00')@javascript:gs.dateGenerate('2016-03-31','12:00:00')";</p><p>           2: var inc = new GlideRecord('incident');</p><p>           3: inc.addEncodedQuery(enq);</p><p>           4: inc.query();</p><p></p><p></p><p>Evaluator: com.glide.script.fencing.MethodNotAllowedException: Function dateGenerate is not allowed in scope sn_custom_app</p><p>     Caused by error in script at line 4</p><p></p><p></p><p>           1: var enq = "opened_atBETWEENjavascript:gs.dateGenerate('2016-02-01','12:00:00')@javascript:gs.dateGenerate('2016-03-31','12:00:00')";</p><p>           2: var inc = new GlideRecord('incident');</p><p>           3: inc.addEncodedQuery(enq);</p><p>==&gt;     4: inc.query();</p><p>           5: </p><p>           6: gs.info(inc.getRowCount());</p><p></p><p></p><p>Background message, type:error, message: Function dateGenerate is not allowed in scope sn_custom_app</p><p>sn_custom_app: 0</p></pre><p></p><p>But when we substitute in our dateGenerate function, the query returns the right value:</p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_14607548244371196 jive_macro_code jive_text_macro" data-renderedposition="3720_8_1192_96" jivemacro_uid="_14607548244371196"><p>var enq = "opened_atBETWEENjavascript:Tools.dateGenerate('2016-02-01','12:00:00')@javascript:Tools.dateGenerate('2016-03-31','12:00:00')";</p><p>var inc = new GlideRecord('incident');</p><p>inc.addEncodedQuery(enq);</p><p>inc.query();</p><p></p><p>gs.info(inc.getRowCount());</p></pre><p></p><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="3847_8_1192_103" modifiedtitle="true"><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="3847_8_1192_103" modifiedtitle="true"><p><span style="color: #000000; font-family: Times; font-size: medium;">[0:00:00.005] Script completed in scope sn_custom_app: script</span></p></pre></pre><hr style="color: #000000; font-family: Times; font-size: medium;"/><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="3847_8_1192_103" modifiedtitle="true"><pre style="color: #000000;">*** Script: 8</pre></pre><p></p><p>Manually substituting "Tools" for "gs" in encoded queries is fine, but we can make this a bit more user-friendly. We can write a second utility function to do it for us:</p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14607555645422207 jive_text_macro" data-renderedposition="4002_8_1192_496" jivemacro_uid="_14607555645422207"><p>var Tools = {};</p><p></p><p>Tools.dateGenerate = function(date, range) {</p><p>       if (!range)</p><p>               range = '12:00:00';</p><p></p><p>       var gdt = new GlideDateTime();</p><p>       if (range.equals("start"))</p><p>               gdt.setDisplayValueInternal(date + " 00:00:00");</p><p>       else if (range.equals("end"))</p><p>               gdt.setDisplayValueInternal(date + " 23:59:59");</p><p>       else</p><p>               gdt.setDisplayValueInternal(date + " " + range);</p><p></p><p>       return gdt;</p><p>}</p><p></p><p></p><p>Tools.fixFilter = function(filterString) {</p><p>       if (!filterString)</p><p>               return filterString;</p><p></p><p>       //lets ensure we are working on a string:</p><p>       filterString = filterString + '';</p><p></p><p>       //fix dateGenerate</p><p>       var dateGenerateRegex = /gs\.dateGenerate/gm;</p><p>       var ourDateFunction = "Tools.dateGenerate";</p><p></p><p>       return filterString.replace(dateGenerateRegex, ourDateFunction);</p><p>}</p></pre><p></p><p>Then we can use our fixFilter utility on our encoded query:</p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_1460755637490259" data-renderedposition="4540_8_1192_96" jivemacro_uid="_1460755637490259"><p>var enq = "opened_atBETWEENjavascript:gs.dateGenerate('2016-02-01','12:00:00')@javascript:gs.dateGenerate('2016-03-31','12:00:00')";</p><p>var inc = new GlideRecord('incident');</p><p>inc.addEncodedQuery(Tools.fixFilter(enq));</p><p>inc.query();</p><p></p><p>gs.info(inc.getRowCount());</p></pre><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="4646_8_1192_103"><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="4646_8_1192_103"><p><span style="color: #000000; font-family: Times; font-size: medium;">[0:00:00.004] Script completed in scope sn_custom_app: script</span></p></pre></pre><hr style="color: #000000; font-family: Times; font-size: medium;"/><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="4646_8_1192_103"><pre style="color: #000000;">sn_custom_app: 8</pre></pre><p></p><p>And because we made this open to all application scopes, other applications can take advantage of them too:</p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14607558079785423 jive_text_macro" data-renderedposition="4801_8_1192_128" jivemacro_uid="_14607558079785423"><p>var enq = "opened_atBETWEENjavascript:gs.dateGenerate('2016-02-01','12:00:00')@javascript:gs.dateGenerate('2016-03-31','12:00:00')";</p><p>var inc = new GlideRecord('incident');</p><p>var Tools = sn_custom_app.Tools;</p><p></p><p>inc.addEncodedQuery(Tools.fixFilter(enq));</p><p>inc.query();</p><p></p><p>gs.info(inc.getRowCount());</p></pre><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="4939_8_1192_103" modifiedtitle="true"><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="4939_8_1192_103" modifiedtitle="true"><p><span style="color: #000000; font-family: Times; font-size: medium;">[0:00:00.004] Script completed in scope sn_other_app: script</span></p></pre></pre><hr style="color: #000000; font-family: Times; font-size: medium;"/><pre __jive_macro_name="quote" class="jive_macro_quote jive_text_macro" data-renderedposition="4939_8_1192_103" modifiedtitle="true"><pre style="color: #000000;">sn_other_app: 8</pre></pre><p></p><p>We are expanding the scoped API with each release, and <em>gs.dateGenerate</em> should be natively available in the feature release that comes after Helsinki. Until then, a utility script like the one above can provide the same functionality.</p><p></p><p>I hope this has been a useful primer on Utility scripts. They are a great way to provide reusable, encapsulated code for all of your applications.</p>