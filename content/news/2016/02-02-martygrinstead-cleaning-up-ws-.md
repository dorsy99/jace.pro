---
title: "Cleaning Up WSSecurity With SOAP"
date: 2016-02-02T01:48:51.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=99fde22ddbd0dbc01dcaf3231f96191a"
---
<p>SOAP based communication allows us to secure the message (end-to-end security) not just at the transport level (HTTPS).   If you want to protect inbound SOAP requests, at the message level, you can use <a title="ocs.servicenow.com/integrate/inbound_soap/concept/c_WS-Security.html" href="https://docs.servicenow.com/integrate/inbound_soap/concept/c_WS-Security.html">WS-Security.</a>   If you have not attempted this in your ServiceNow instance yet, John Anderson's blog post on <a title="SOAP into ServiceNow via x509 WS-Security" __default_attr="2279" __jive_macro_name="blogpost" class="jive_macro jive_macro_blogpost" data-orig-content="SOAP into ServiceNow via x509 WS-Security" data-renderedposition="31_805.3831176757812_302_16" href="/community?id=community_blog&sys_id=a3ed222ddbd0dbc01dcaf3231f9619fb">SOAP into ServiceNow via x509 WS-Security</a> has a helpful tutorial providing all of the steps necessary to configure your instance, and SoapUI.</p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';">As a quick summary of John's post:</p><ol><li>Add your certificate to the key store.</li><li>Configure SoapUI to use the key store.</li><li>Create an x509 Certificate record in ServiceNow using the PEM encoded certificate.</li><li>Create a Security Profile that uses the new x509 Certificate.</li></ol><p></p><p style="font-family: 'Helvetica Neue';">Submitting your request through SoapUI should return a valid XML payload.</p><p style="font-family: 'Helvetica Neue';"><img   alt="soapui.jpg" class="image-9 jive-image" src="8fa76c06db14dfc068c1fb651f961960.iix" style="width: 620px; height: 375px; display: block; margin-left: auto; margin-right: auto;"/></p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';">What happens when you need more than one <a title="ocs.servicenow.com/integrate/inbound_soap/concept/c_WS-SecurityProfiles.html" href="https://docs.servicenow.com/integrate/inbound_soap/concept/c_WS-SecurityProfiles.html">Security Profile?</a></p><p style="font-family: 'Helvetica Neue';"><img   alt="Screen Shot 2016-01-15 at 3.54.55 PM.JPG" class="image-1 jive-image" src="1fe7c9c6db1413043eb27a9e0f96196f.iix" style="font-family: 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif; line-height: 19.0909080505371px; height: auto; float: none; display: block; margin-left: auto; margin-right: auto;"/></p><p style="font-family: 'Helvetica Neue';">You guessed it, use a <a href="https://docs.servicenow.com/integrate/inbound_soap/concept/c_SOAPSecurityPolicies.html">Securit<span style="line-height: 1.5;">y Policy</span></a><span style="line-height: 1.5;"><a title="ocs.servicenow.com/integrate/inbound_soap/concept/c_SOAPSecurityPolicies.html" href="https://docs.servicenow.com/integrate/inbound_soap/concept/c_SOAPSecurityPolicies.html">.</a> A Security Policy allows the ServiceNow administrator to define how the Security Profiles will be used. Let's assume that you have already configured 2 different Security Profiles (using the knowledge from John's Blog).</span></p><p style="font-family: 'Helvetica Neue';"><img   alt="WS_Sec_Profile_page.jpg" class="image-10 jive-image" src="97164c4edb9c5704ed6af3231f961954.iix" style="width: 620px; height: 146px; display: block; margin-left: auto; margin-right: auto;"/></p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';">Testing the same web service call from our SoupUI project will now fail.   SoapUI (Raw) will show:</p><p style="font-family: 'Helvetica Neue';"><img   alt="Bad_Raw_Response.jpg" class="image-11 jive-image" src="b0d6a771db941fc068c1fb651f9619a7.iix" style="width: 620px; height: 293px; display: block; margin-left: auto; margin-right: auto;"/></p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';">and the XML response payload will be:</p><p style="font-family: 'Helvetica Neue';"></p><pre __default_attr="xml" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14539976542297869 jive_text_macro" data-renderedposition="1469.984375_8_1192_160" jivemacro_uid="_14539976542297869"><p><span>&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="</span><a title="" _jive_internal="true" href="/schemas.xmlsoap.org/soap/envelope" rel="nofollow" target="_blank">http://schemas.xmlsoap.org/soap/envelope/</a><span>"&gt;</span></p><p>     &lt;SOAP-ENV:Header/&gt;</p><p>     &lt;SOAP-ENV:Body&gt;</p><p>           &lt;SOAP-ENV:Fault&gt;</p><p>                 &lt;faultcode&gt;wsse:InvalidSecurity&lt;/faultcode&gt;</p><p>                 &lt;faultstring&gt;An error was discovered processing the WS-Security header&lt;/faultstring&gt;</p><p>                 &lt;detail&gt;No profiles to authenticate&lt;/detail&gt;</p><p>           &lt;/SOAP-ENV:Fault&gt;</p><p>     &lt;/SOAP-ENV:Body&gt;</p><p>&lt;/SOAP-ENV:Envelope&gt;</p></pre><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';">Looking through the log file, we will find the following exception:</p><p style="font-family: 'Helvetica Neue';"></p><pre __default_attr="plain" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14539991664528738 jive_text_macro" data-renderedposition="1713.984375_8_1192_176" jivemacro_uid="_14539991664528738"><p>SOAP-thread-40 369921984F955E00DF448DF07310C757 WebServiceSecurity: Retrieving Profiles to authenticate</p><p>SOAP-thread-40 369921984F955E00DF448DF07310C757 WebServiceSecurity: Authenticating against: First Profile</p><p>SOAP-thread-40 369921984F955E00DF448DF07310C757 WebServiceSecurity: Authenticating against: Second Profile</p><p>SOAP-thread-40 369921984F955E00DF448DF07310C757 WebServiceSecurity: Authentication failed against: Second Profile</p><p>SOAP-thread-40 369921984F955E00DF448DF07310C757 WARNING *** WARNING *** WSSecurity login failed</p><p>SOAP-thread-40 369921984F955E00DF448DF07310C757 WARNING *** WARNING *** WS-Security request rejected</p><p>SOAP-thread-40 369921984F955E00DF448DF07310C757 Sending response</p><p>SOAP-thread-40 369921984F955E00DF448DF07310C757 WARNING *** WARNING *** SOAP Fault: &lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="<a title="" _jive_internal="true" href="/schemas.xmlsoap.org/soap/envelope" rel="nofollow" target="_blank">http://schemas.xmlsoap.org/soap/envelope/</a>"&gt;</p><p>&lt;faultcode&gt;wsse:FailedAuthentication&lt;/faultcode&gt;&lt;faultstring&gt;The security token could not be authenticated or authorized&lt;/faultstring&gt;</p><p>&lt;detail&gt;WSSecurity login failed&lt;/detail&gt;&lt;/SOAP-ENV:Fault&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt;</p><p>2016-01-27 11:18:46 (043) SOAP-thread-40 369921984F955E00DF448DF07310C757 Response bytes sent: 218</p></pre><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';">The next step will be to configure a Security Policy.   The Security Policy will define how the Security Profiles should be used.</p><p style="font-family: 'Helvetica Neue';"><img   alt="New_Sec_Policy.jpg" class="image-12 jive-image" src="0327c5c2db1413043eb27a9e0f961910.iix" style="width: 620px; height: 171px; display: block; margin-left: auto; margin-right: auto;"/></p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';">Then populate the form.   In this example, we will use the two Security Profiles listed, and we must authenticate against either one of these.</p><p style="font-family: 'Helvetica Neue';"><img   alt="Sec_Policy_Input.jpg" class="image-13 jive-image" height="356" src="72352c8adb90dfc068c1fb651f96192a.iix" style="display: block; margin-left: auto; margin-right: auto; height: 356px; width: 422.840816326531px;" width="423"/></p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';">The last piece of the puzzle is to update the system property "glide.soap.default_security_policy" to let the instance know which policy to use.</p><p style="font-family: 'Helvetica Neue';"><img   alt="sys_property.jpg" class="image-14 jive-image" height="360" src="66134c8adb985fc03eb27a9e0f961928.iix" style="display: block; margin-left: auto; margin-right: auto; width: 435px; height: 359.927419354839px;" width="435"/></p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';">Once the property has been updated to point to the desired security policy, SoapUI can, once again, process the request.</p><p style="font-family: 'Helvetica Neue';"><img   alt="Good_Response.jpg" class="image-15 jive-image" src="20a1eb35db5c9f04e9737a9e0f96196f.iix" style="width: 620px; height: 375px; display: block; margin-left: auto; margin-right: auto;"/></p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';"><span style="color: #303030;">To wrap up, we have seen that when we have only one Security Profile, ServiceNow is able to process inbound SOAP requests that require end-to-end security, with no additional configuration.   When several Security Profiles exist in your ServiceNow instance, you can manage these different profiles with a Security Policy.   The policy defines how these different profiles should be used to authenticate the messages received.</span></p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';"></p><p style="font-family: 'Helvetica Neue';"><span style="color: #e23d39; font-size: 14pt;"><strong>Related Articles:</strong></span></p><p style="font-family: 'Helvetica Neue';"><a href="https://hi.service-now.com/kb_view.do?sysparm_article=KB0546239" title="https://hi.service-now.com/kb_view.do?sysparm_article=KB0546239">ServiceNow KB: Inbound Web service Security Configuration (KB0546239)</a></p><p style="font-family: 'Helvetica Neue';"><a title="ocs.servicenow.com/integrate/inbound_soap/concept/c_WS-Security.html" href="https://docs.servicenow.com/integrate/inbound_soap/concept/c_WS-Security.html">Inbound SOAP Web Service Security</a></p><p style="font-family: 'Helvetica Neue';"><a title="w.john-james-andersen.com/blog/service-now/tutorial-soap-into-servicenow-via-x509-ws-security.html" href="http://www.john-james-andersen.com/blog/service-now/tutorial-soap-into-servicenow-via-x509-ws-security.html">Tutorial: SOAP into ServiceNow via x509 WS-Security</a></p>