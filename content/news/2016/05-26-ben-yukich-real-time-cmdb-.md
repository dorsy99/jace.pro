---
title: "Realtime CMDB Disco as a Service"
date: 2016-05-25T20:38:16.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=bacda2e9dbd0dbc01dcaf3231f961942"
---
<p>Very often, my esteemed colleague <a title="aleck.lin" __default_attr="2222" __jive_macro_name="user" class="jive_macro jive_macro_user" data-orig-content="aleck.lin" data-renderedposition="10_231.015625_70_16" href="/community?id=community_user_profile&user=0183d2e9db1c1fc09c9ffb651f9619fc">aleck.lin</a> and I are asked how to make the CMDB closer to being a real-time repository. As service architectures evolve and become more dynamic, running a broad subnet discovery once a day might not be anywhere near often enough to capture the data you need (particularly when you use your CMDB like we do: to make real operational decisions). Towards this end, it can be very useful to drive discovery in a more event-driven way. Wouldn't it be nice if every new system just kicked off a discovery of itself after being provisioned? The ServiceNow platform already does this for services like vCenter and AWS (there are turn-key integrations for registering as a vCenter event listener and integrating with AWS Config <span style="color: #eb7a3d;">[edit 7/6: Check out my colleague's great <a __default_attr="5697" __jive_macro_name="blogpost" class="jive_macro jive_macro_blogpost" data-orig-content="how-to" data-renderedposition="94_348.375_64_16" href="/community?id=community_blog&sys_id=002ee26ddbd0dbc01dcaf3231f961923" modifiedtitle="true" title="how-to">how-to</a>]</span>), but what about plain old fashioned system discovery?</p><p></p><p>Fortunately, ServiceNow provides a simple mechanism to do just about anything with a simple REST call. I'm not just talking about the standard APIs that are available over REST... I'm talking about <a title="ocs.servicenow.com/bundle/helsinki-servicenow-platform/page/integrate/custom-web-services/task/t_CreateAScriptedRESTService.html" href="https://docs.servicenow.com/bundle/helsinki-servicenow-platform/page/integrate/custom-web-services/task/t_CreateAScriptedRESTService.html">Scripted REST APIs</a>! This was probably my favorite platform feature introduced in Geneva. These allow you to unleash any corner of the platform with a simple REST request.</p><p></p><p>So, let's get started, but where to begin? Well, we already know that we can do an ad-hoc system discovery by clicking the <strong>Quick Discovery</strong> UI action on the <strong>Discovery Schedules</strong> page:</p><p><img   alt="Screen Shot 2016-05-24 at 3.37.42 PM.png" class="image-2 jive-image" height="107" src="c8391802db581f048c8ef4621f9619a6.iix" style="width: 258px; height: 107.361px;" width="258"/></p><p>... so let's just re-use the same logic! Looking at the UI action itself, is a little disappointing:</p><p><img   alt="Screen Shot 2016-05-24 at 2.27.37 PM.png" class="image-1 jive-image" height="128" src="41f6bc82db5cdfc068c1fb651f961955.iix" style="line-height: 1.5; width: 292px; height: 127.632px;" width="292"/></p><p></p><p>Because we ordinarily display some nice modal windows to go through the quick discovery process, we need to dig a little bit deeper. First, let's step into the referenced UI page (quick_discovery), which calls the <strong>DiscoveryAjax</strong> script include, which calls the <strong>Discovery</strong> script include's <strong>discoveryFromIP</strong> function. Pay dirt!</p><p></p><p>Now we have everything we need. Just create a new <strong>Scripted REST API</strong>, define a <strong>Scripted REST Resource</strong>, add a couple <strong>Query Parameter Associations</strong> (if you want to get fancy), and take it for a spin in the <strong>REST API Explorer</strong>. Here's an example Scripted REST Resource script where we're relying on the query parameters <em>mid_server</em> and <em>target_ip</em>, and returning a URL that will take us to the discovery status record:</p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_14641292178824317 jive_macro_code jive_text_macro" data-renderedposition="672.984375_8_1192_112" jivemacro_uid="_14641292178824317"><p>(function process(/*RESTAPIRequest*/ request, /*RESTAPIResponse*/ response) {</p><p></p><p>   var statusId = new Discovery().discoveryFromIP(request.queryParams.target_ip + '', request.queryParams.mid_server + '', '');</p><p>   var statusUrl = gs.getProperty('glide.servlet.uri') + 'discovery_status.do?sys_id=' + statusId;</p><p>   return {'status_url': statusUrl};</p><p></p><p>})(request, response);</p></pre><p></p><p><span style="color: #eb7a3d;"><strong>EDIT 1/12/18:</strong></span> Beginning in Kingston, line 3 above can be changed to take advantage of the new Discovery API which simplifies things by using the MID server selection algorithm (meaning it's no longer a necessary request parameter):</p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_1515797489686131 jive_text_macro" data-renderedposition="848.984375_8_1192_16" jivemacro_uid="_1515797489686131"><p><span style="color: rgba(0, 0, 0, 0); font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px;">   var statusId = sn_discovery.DiscoveryAPI.discoverIpAddress(request.queryParams.target_ip + '');</span></p></pre><p></p><p>Now from your REST API Explorer you can easily test. Just populate the query parameters, and hit <strong>Send</strong>:</p><p><img   alt="Screen Shot 2016-05-24 at 3.45.21 PM.png" class="image-3 jive-image" src="1c57f3b9db905fc068c1fb651f961914.iix" style="width: 620px; height: 349px;"/></p><p>With any luck, you got a 200 response with a link back to the discovery status record (note that instance names have been removed to protect the innocent):</p><p><img   alt="Screen Shot 2016-05-24 at 3.45.48 PM.png" class="image-4 jive-image" src="df6ad502db1cd344e9737a9e0f96195d.iix" style="width: 620px; height: 389px;"/></p><p>Just like that, with a few lines of code, you can perform discovery on-demand with a simple REST call! To top it off, the REST API Explorer will give you code samples to make this call from a number of scripting languages, making it easy to have systems kick off a discovery against themselves e.g. as the last step in your new system bootstrap process. This same approach will work anywhere you can use script within the ServiceNow platform. Enjoy!</p>