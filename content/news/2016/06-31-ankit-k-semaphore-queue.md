---
title: "Semaphore queue leaking due to RESTAPIProcessor exception"
date: 2016-06-30T19:49:32.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=ba7d6269dbd0dbc01dcaf3231f9619f4"
---
<p>The semaphore queue depth reaches the max queue depth (150 or 50, depending on the respective semaphore pool) and the system doesn't allow anymore requests to come in, thereby by throwing HTTP 429 "Rejecting request" errors. These requests don't get served in spite of the semaphores being available to execute them and the ServletTransaction does not account for recycled requests and leaves sessions in session sync.</p><p></p><p>You could be affected by the issue if you are on certain patches of Eureka, Fuji, and early patches of Geneva. The severity may depend on the usage of the ServiceNow instance by customers.</p><p></p><p>Here are a few customer scenarios that may help determine if you are are experiencing a semaphore queue leak.</p><ol><li>HTTP 429 "Rejecting request"</li><li>Errors in the localhost logs</li><li>Increasing session wait times</li></ol><p></p><table border="1" class="jiveBorder" style="border: 1px solid #c6c6c6; width: 100%;"><tbody><tr><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px;" valign="middle"><span style="color: #000000; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 16px;"><strong>Customer Symptom 1: HTTP 429 "Rejecting request"</strong></span></th></tr><tr><td style="padding: 6px;"><p>Your users will experience HTTP 429 "Rejecting request" errors on the browser while trying to access or load a page within a ServiceNow instance. The affected node's stats.do will show transactions waiting in the the queue that are not processing. In a worst case scenario, the "affected" semaphore pool reaches its maximum queue depth and is no longer taking any more requests nor is being served.</p><p></p><p>Consider the following example of the affected default semaphore queue:</p><ul><li>Available semaphores: 16</li><li><span style="font-size: 10.5pt; font-family: 'Helvetica Neue'; background: lime;">Queue depth: 150</span></li><li>Max queue depth: 150</li><li>Maximum transaction concurrency: 16<br/>Maximum concurrency achieved: 12</li></ul><p style="padding-left: 60px;"><em><strong>Note this can affect any pool (AMB, Presence, etc.)</strong></em></p></td></tr></tbody></table><table border="1" class="jiveBorder" style="border: 1px solid #c6c6c6; width: 100%;"><tbody><tr><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px;" valign="middle"><span style="color: #000000; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 16px; background-color: #f2f2f2;"><strong>Customer Symptom 2: Errors in the localhost logs</strong></span></th></tr><tr><td style="padding: 6px;"><p>Error messages in the localhost logs with a similar stack trace</p><p style="padding-left: 60px;"></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">2016-04-12 05:06:24 (094) Default-thread-9 SYSTEM SEVERE *** ERROR *** Problem processing asynchronous servlet request</span><br/><span style="font-family: 'andale mono', times;">java.lang.RuntimeException: Stream not closed properly</span><br/><span style="font-family: 'andale mono', times;">at com.glide.rest.serializer.impl.ResponseSerializerImpl.closeOutputStream(ResponseSerializerImpl.java:153)</span><br/><span style="font-family: 'andale mono', times;">at com.glide.rest.processors.RESTAPIProcessor.endRequestProcessing(RESTAPIProcessor.java:261)</span><br/><span style="font-family: 'andale mono', times;">at com.glide.rest.processors.RESTAPIProcessor.handleException(RESTAPIProcessor.java:256)</span><br/><span style="font-family: 'andale mono', times;">at com.glide.processors.ProcessorRegistry.process(ProcessorRegistry.java:172)</span><br/><span style="font-family: 'andale mono', times;">at com.glide.ui.GlideServletTransaction.process(GlideServletTransaction.java:32)</span><br/><span style="font-family: 'andale mono', times;">at com.glide.sys.ServletTransaction.run(ServletTransaction.java:34)</span><br/><span style="font-family: 'andale mono', times;">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</span><br/><span style="font-family: 'andale mono', times;">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</span><br/><span style="font-family: 'andale mono', times;">at java.lang.Thread.run(Thread.java:745)</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">2016-04-12 05:06:24 (094) Default-thread-9 SYSTEM Transaction.getHttpSession() caught IllegalStateException</span><br/><span style="font-family: 'andale mono', times;">2016-04-12 05:06:24 (095) Default-thread-9 SYSTEM SEVERE *** ERROR *** java.lang.reflect.UndeclaredThrowableException</span><br/><span style="font-family: 'andale mono', times;">java.lang.reflect.UndeclaredThrowableException</span><br/><span style="font-family: 'andale mono', times;">at com.sun.proxy.$Proxy27.getSession(Unknown Source)</span><br/><span style="font-family: 'andale mono', times;">at com.glide.ui.GlideHttpRequestContext.getHTTPSessionID(GlideHttpRequestContext.java:205)</span><br/><span style="font-family: 'andale mono', times;">at com.glide.ui.GlideHttpRequestContext$HTTPSessionMethods.getHTTPSession(GlideHttpRequestContext.java:238)</span><br/><span style="font-family: 'andale mono', times;">at com.glide.ui.GlideHttpRequestContext.getHTTPSession(GlideHttpRequestContext.java:199)</span></p><p style="padding-left: 60px;"><span style="background: lime; font-size: 10.5pt; font-family: 'andale mono', times;">at com.glide.sys.Transaction.getHttpSession(Transaction.java:1373) Â  ----&gt; This specific call MUST be present in the stack</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">at com.glide.sys.ServletTransaction.finishTransaction(ServletTransaction.java:44)</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">at com.glide.sys.util.FixedQueueThreadPoolExecutor.afterExecute(FixedQueueThreadPoolExecutor.java:259)</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1150)</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)at java.lang.Thread.run(Thread.java:745)</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">Caused by: java.lang.reflect.InvocationTargetException</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">at sun.reflect.GeneratedMethodAccessor245.invoke(Unknown Source)</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">at java.lang.reflect.Method.invoke(Method.java:497)</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">at com.glide.ui.GlideServletRequest.invoke(GlideServletRequest.java:121)</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">... 10 more</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">Caused by: java.lang.IllegalStateException: The request object has been recycled and is no longer associated with this facade</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">at org.apache.catalina.connector.RequestFacade.getSession(RequestFacade.java:905)</span></p><p style="padding-left: 60px;"><span style="font-family: 'andale mono', times;">... 14 more</span></p><p style="padding-left: 60px;"></p><p style="padding-left: 60px;"><strong><em>Note: If you are seeing a similar error but different stack trace, then this is a different problem. <a href="http://www.servicenow.com/support/contact-support.html" target="_blank" title="Contact ServiceNow"><br/></a></em></strong></p></td></tr></tbody></table><table border="1" class="jiveBorder" style="border: 1px solid #c6c6c6; width: 100%;"><tbody><tr><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px;" valign="middle"><span style="color: #000000; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 16px; background-color: #f2f2f2;"><strong>Customer Symptom 3: Increasing session wait times</strong></span></th></tr><tr><td style="padding: 6px;"><p>If you were to investigate the ServiceNow <a title="ocs.servicenow.com/bundle/helsinki-it-service-management/page/administer/platform-performance/concept/c_PerformanceMetrics.html" href="https://docs.servicenow.com/bundle/helsinki-it-service-management/page/administer/platform-performance/concept/c_PerformanceMetrics.html">performance graphs</a> for your instance, for the primary nodes you would see a gradual spike in the thread concurrency and session wait times. Consider the following graph, where you can see the session wait increasing due to requests not being processed and waiting in the queue because of sessions "leaking" in the queue.<img   alt="seassion_wait.png" class="image-1 jive-image" src="98c1ec06db10dfc068c1fb651f9619cd.iix" style="width: 620px; height: 195px;"/></p></td></tr></tbody></table><p style="text-align: justify;"></p><p>We recommend that you upgrade to one of the releases, mentioned here <a href="https://hi.service-now.com/kb_view.do?sysparm_article=KB0594813" title="https://hi.service-now.com/kb_view.do?sysparm_article=KB0594813">ServiceNow KB: ServletTransaction does not account for recycled requests and leaves sessions in session sync (KB0594813)</a>, where the fix is found. Upgrading to one of these releases will <span style="line-height: 1.5;">prevent or improve performance caused by this particular issue:</span></p><p></p><ul><li>Geneva Patch 5 Hotfix 6</li><li>Geneva Patch 6 Hotfix 2</li><li>Geneva Patch 7</li><li>Helsinki Patch 0 Hotfix 3</li><li>Helsinki Patch 1</li></ul><p></p><p>You can also contact <a title="w.servicenow.com/support/contact-support.html" href="http://www.servicenow.com/support/contact-support.html">ServiceNow</a> <span style="font-size: 10pt;">to re</span>start the affected application node to clear the queue.</p>