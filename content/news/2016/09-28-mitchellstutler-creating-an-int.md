---
title: "Creating an interactive United States Map"
date: 2016-09-27T19:21:06.000Z
authors: ["mitchellstutler"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=225ce6a1dbd0dbc01dcaf3231f9619d7"
---
<p>In this post we're going to create a Service Portal widget that displays a United States map that colors the individual states based on the amount of incidents opened in that state relative to the other states. We are going to use D3js to accomplish this. If you are unfamiliar with D3, check out this previous <a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=f01daea5dbd0dbc01dcaf3231f961981">post</a> introducing D3 to ServiceNow. This post will follow an example from the D3 community which can be found <a title=".ocks.org/NPashaP/a74faf20b492ad377312" href="http://bl.ocks.org/NPashaP/a74faf20b492ad377312">here</a>.</p><p></p><p>To create our state map we will need to grab our incident data in our server script, create a dependency to a new UI script that contains the coordinates for the state map, and pass our data to the UI script from our client script.</p><p></p><h1>Server script</h1><p></p><p>In our server script, we will create an array of objects within the data object. This array will contain 50 objects; each representing a state. Once that array of objects is created, we will use a pair of GlideAggregate calls to retrieve the counts of open and closed incidents by location. We'll use these calls to populate our array of objects with the counts for each state.</p><p></p><p>Below is a screenshot of the server script along with the pasted script:</p><p></p><p><img   alt="Post 3 Server Script.png" class="image-1 jive-image" src="01bc004adbdcdb048c8ef4621f961989.iix" style="width: 620px; height: 686px;"/></p><p></p><p></p><p>(function() {</p><p>                       // Create an array of state abbreviations in the same order as our UI script</p><p>                       var states = ["HI", "AK", "FL", "SC", "GA", "AL", "NC", "TN", "RI", "CT", "MA",</p><p>                       "ME", "NH", "VT", "NY", "NJ", "PA", "DE", "MD", "WV", "KY", "OH",</p><p>                       "MI", "WY", "MT", "ID", "WA", "DC", "TX", "CA", "AZ", "NV", "UT",</p><p>                       "CO", "NM", "OR", "ND", "SD", "NE", "IA", "MS", "IN", "IL", "MN",</p><p>                       "WI", "MO", "AR", "OK", "KS", "LA", "VA"];</p><p>                 </p><p>                       // Create an array of objects in our data object with placeholder properties</p><p>                       data.states = [];</p><p>                       for (i=0;i&lt;states.length;i++) {</p><p>                                               data.states.push({state: states[i], open: 0, closed: 0});</p><p>                       }</p><p>                 </p><p>                       // Find counts of open incidents by location</p><p>                       var openCount = new GlideAggregate('incident');</p><p>                       openCount.addQuery('active', 'true');</p><p>                       openCount.addAggregate('COUNT', 'location');</p><p>                       openCount.query();</p><p>                       while (openCount.next()) {</p><p>                                               var openState = openCount.location.state;</p><p>                                               var openStateCount = openCount.getAggregate('COUNT', 'location')*1;</p><p>                                               for (i=0; i&lt;data.states.length; i++) {</p><p>                                                                       // Increase the open property if there is a match with a state</p><p>                                                                       if (openState == data.states[i].state) {</p><p>                                                                                               data.states[i].open += openStateCount;</p><p>                                                                                               break;</p><p>                                                                       }</p><p>                                               }</p><p>                       }</p><p>                 </p><p>                       // Find counts of closed incidents by location</p><p>                       var closedCount = new GlideAggregate('incident');</p><p>                       closedCount.addQuery('active', 'false');</p><p>                       closedCount.addAggregate('COUNT', 'location');</p><p>                       closedCount.query();</p><p>                       while (closedCount.next()) {</p><p>                                               var closedState = closedCount.location.state;</p><p>                                               var closed<span>StateCou</span>nt = closedCount.getAggregate('COUNT', 'location')*1;</p><p>                                               for (i=0; i&lt;data.states.length; i++) {</p><p>                                                                       // Increase the closed property if there is a match with a state</p><p>                                                                       if (closedState == data.states[i].state) {</p><p>                                                                                               data.states[i].closed += closedStateCount;</p><p>                                                                                               break;</p><p>                                                                       }</p><p>                                               }</p><p>                       }</p><p>                 </p><p>})();</p><p></p><h1>UI script</h1><p></p><p>Similar to the widget dependency we created in the previous posts, we will create dependencies to call D3 and also to call a UI script that we will create. The code for our new UI script can be found <a title="ist.githubusercontent.com/NPashaP/a74faf20b492ad377312/raw/7a990ccbfc279824c3ce6084bf1255400a06f0d2/uStates.js" href="https://gist.githubusercontent.com/NPashaP/a74faf20b492ad377312/raw/7a990ccbfc279824c3ce6084bf1255400a06f0d2/uStates.js">here</a>. It doesn't matter what you name this UI script as long as you remember what you name it; I named mine u_states. Once you have created this UI script, reference it with a widget script dependency.</p><p></p><h1>Client Script</h1><p></p><p>Our client script will be used to determine what color each state should be, define the HTML template that will be used as a tooltip, and make the call to our new UI script to actually draw our state map.</p><p></p><p>We will loop through the array of objects that we created in our server script and use the D3 interpolate to determine each state's color. The D3 interpolate allows us to define a range of two colors: one for the lowest incident density and one for the highest incident density. Based on a given state's incident count, its color will fall somewhere in this range. For this example we will use #ffffcc as our low color and #800026 as our high color, but you can use any colors you want.</p><p></p><p>Below is a screenshot of my client script along with the pasted script:</p><p></p><p><img   alt="Post 3 Client Script.png" class="image-2 jive-image" src="0b392379db54dfc0b322f4621f961914.iix" style="width: 620px; height: 319px;"/></p><p></p><p>function() {</p><p>                       /* widget controller */</p><p>                       var c = this;</p><p>                 </p><p>                       // Find the max number of open incidents in a single state</p><p>                       var maxOpen = d3.max(c.data.states, function(d) { return d.open; });</p><p></p><p>                       // Create object containing the state data and determine what color</p><p>                       // each state should be</p><p>                       var mapData ={};</p><p>                 </p><p>                       c.data.states</p><p>                       .forEach(function(d){</p><p>                                               mapData[d.state] = {color: d3.interpolate("#ffffcc", "#800026")(d.open/maxOpen), open: d.open, closed: d.closed};</p><p>                       });</p><p>                 </p><p>                       // Define the HTML for the tooltip</p><p>                       function tooltipHtml(n, d){</p><p>                       return "&lt;h4&gt;"+n+"&lt;/h4&gt;&lt;table&gt;"+</p><p>                       "&lt;tr&gt;&lt;td&gt;Open &lt;/td&gt;&lt;td&gt;"+(d.open)+"&lt;/td&gt;&lt;/tr&gt;"+</p><p>                       "&lt;tr&gt;&lt;td&gt;Closed &lt;/td&gt;&lt;td&gt;"+(d.closed)+"&lt;/td&gt;&lt;/tr&gt;"+</p><p>                       "&lt;tr&gt;&lt;td&gt;Total &lt;/td&gt;&lt;td&gt;"+(d.open + d.closed)+"&lt;/td&gt;&lt;/tr&gt;"+</p><p>                       "&lt;/table&gt;";</p><p>                       }</p><p></p><p>                       // Calls the draw function from our u_states UI script which uses</p><p>                       // D3 to draw our map</p><p>                       uStates.draw("#statesvg", mapData, tooltipHtml);</p><p></p><p>                       d3.select(self.frameElement).style("height", "800px");</p><p>}</p><p></p><h1>HTML</h1><p></p><p>Below is the pasted HTML I used for this widget:</p><p></p><p>&lt;div id="tooltip"&gt;&lt;/div&gt;</p><p>&lt;div style="text-align: center;"&gt;</p><p>                       &lt;h2&gt;Incident State Map&lt;/h2&gt;</p><p>                       &lt;svg width="960" height="600" id="statesvg"&gt;&lt;/svg&gt;</p><p>&lt;/div&gt;</p><p></p><h1>CSS</h1><p></p><p>Below is the pasted CSS I used for this widget:</p><p></p><p>.state{</p><p>                       fill: none;</p><p>                       stroke: #a9a9a9;</p><p>                       stroke-width: 1;</p><p>}</p><p>.state:hover{</p><p>                       fill-opacity:0.5;</p><p>}</p><p>#tooltip {</p><p>                       position: absolute;               </p><p>                       text-align: center;</p><p>                       padding: 20px;                   </p><p>                       margin: 10px;</p><p>                       font: 12px sans-serif;         </p><p>                       background: lightsteelblue;</p><p>                       border: 1px;     </p><p>                       border-radius: 2px;               </p><p>                       pointer-events: none;           </p><p>}</p><p>#tooltip h4{</p><p>                       margin:0;</p><p>                       font-size:14px;</p><p>}</p><p>#tooltip{</p><p>                       background:rgba(0,0,0,0.9);</p><p>                       border:1px solid grey;</p><p>                       border-radius:5px;</p><p>                       font-size:12px;</p><p>                       width:auto;</p><p>                       padding:4px;</p><p>                       color:white;</p><p>                       opacity:0;</p><p>}</p><p>#tooltip table{</p><p>                       table-layout:fixed;</p><p>}</p><p>#tooltip tr td{</p><p>                       padding:0;</p><p>                       margin:0;</p><p>}</p><p>#tooltip tr td:nth-child(1){</p><p>                       width:50px;</p><p>}</p><p>#tooltip tr td:nth-child(2){</p><p>                       text-align:center;</p><p>}</p><p></p><h1>Final product</h1><p></p><p><span style="font-size: 12.0pt; font-family: Calibri;">Below is a screenshot of my finished widget. Now that we have the basic framework for a map widget, we can theoretically create a widget with any map and use any data from ServiceNow. The main part that we skipped for this post is the actual creation of the SVG map coordinates, but there are plenty of online resources that help with that process (potentially a future post?).</span></p><p></p><p><span style="font-size: 12.0pt; font-family: Calibri;"><img   alt="Post 3 Map.png" class="image-3 jive-image" src="978e0d42db54d344e9737a9e0f961989.iix" style="width: 620px; height: 418px;"/></span></p><p></p><p></p><p></p><p>Mitch Stutler</p><p>VividCharts Founder</p><p><a title="vidcharts.com/" href="http://vividcharts.com/">vividcharts.com</a></p><p><a title="nkedin.com/in/mitchellstutler/" href="http://linkedin.com/in/mitchellstutler/">linkedin.com/in/mitchellstutler</a></p><p><a title="itter.com/mitchstutler" href="http://twitter.com/mitchstutler">twitter.com/mitchstutler</a></p><h1></h1><h1>Sources</h1><p></p><p>- <a href="https://d3js.org/" title="https://d3js.org/">https://d3js.org/</a></p><p>- <a title=".ocks.org/NPashaP/a74faf20b492ad377312" href="http://bl.ocks.org/NPashaP/a74faf20b492ad377312">US State Map</a></p>