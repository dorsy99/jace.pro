---
title: "Treemaps Tiling Your Hierarchical Data"
date: 2016-12-20T18:43:27.000Z
authors: ["mitchellstutler"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=3d3e6e6ddbd0dbc01dcaf3231f9619bf"
---
<p>In this post, I will outline how I was able to create a treemap in a Service Portal widget using D3.js. Treemaps convert hierarchical data into a conglomeration of nested rectangles that represent the data values.</p><p></p><p>This particular widget example will query the ServiceNow catalog categories and catalog items that are in my personal developer instance to generate the data object that will be visually expressed in my D3 treemap. As a business use case, you would probably want to query the Requested Item table to display which items and categories are the most frequently ordered. My developer instance doesn't have much Requested Item data, so I generated random numbers to better display the treemap functionality.</p><p></p><p>Below is a screenshot of my treemap widget in action:</p><p><img   alt="D3 Treemap.png" class="image-1 jive-image" height="633" src="29ce3c42db10130468c1fb651f961910.iix" style="height: 633px; width: 953.159px;" width="953"/></p><p>Each color represents a single catalog category and each rectangle represents a catalog item. The size of the catalog item rectangle is scaled according to how many times that item has been ordered. The bigger the rectangle, the more that item has been ordered. I also added the ability to resize the rectangles to equal sizes to display category sizes based on how many items live under it. To change between these two views, I set up radio buttons to trigger the transition. Below is a screenshot of the second view:</p><p></p><p><img   alt="D3 Treemap Categories.png" class="image-2 jive-image" height="629" src="f70ed48edb5c9fc068c1fb651f96197e.iix" style="height: 629px; width: 955.96px;" width="956"/></p><p></p><p>Since there are <a title="" _jive_internal="true" href="/people/mitchellstutler/content">previous posts</a> giving a more in-depth introduction to using D3 and Service Portal together, I won't go into much detail with the code. Here is the pasted code for my HTML, CSS, Client Script, and Server Script:</p><p></p><h1>HTML</h1><p></p><p>&lt;div class="centered-chart"&gt;</p><p>         &lt;h1&gt;D3 Treemap&lt;/h1&gt;</p><p>         &lt;svg width="960" height="570"&gt;&lt;/svg&gt;</p><p>&lt;/div&gt;</p><p>&lt;form&gt;</p><p>         &lt;label&gt;&lt;input type="radio" name="mode" value="sumBySize" checked&gt; Ordered Count&lt;/label&gt;</p><p>         &lt;label&gt;&lt;input type="radio" name="mode" value="sumByCount"&gt; Category Size&lt;/label&gt;</p><p>&lt;/form&gt;</p><p></p><h1>CSS</h1><p></p><p><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black; background: white;">form {</span><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"><br/> <span style="background: white;">     padding-left: 150px;</span><br/> <span style="background: white;">     font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;</span><br/> <span style="background: white;">}</span><br/> <br/> <span style="background: white;">.centered-chart {</span><br/> <span style="background: white;">     text-align: center;</span><br/> <span style="background: white;">     font: 10px sans-serif;</span><br/> <span style="background: white;">}</span></span></p><p></p><h1>Client Script</h1><p></p><p>function() {</p><p>                       /* widget controller */</p><p>                       var c = this;</p><p>                   </p><p>                       // Grab our category object from the data object</p><p>                       var categories = c.data.categories;</p><p>                   </p><p>                       var svg = d3.select("svg"),</p><p>                       width = +svg.attr("width"),</p><p>                       height = +svg.attr("height");</p><p>                   </p><p>                       var fader = function(color) { return d3.interpolateRgb(color, "#fff")(0.2); },</p><p>                       color = d3.scaleOrdinal(d3.schemeCategory20.map(fader)),</p><p>                       format = d3.format(",d");</p><p>                                           </p><p>                       // Define our D3 treemap object</p><p>                       var treemap = d3.treemap()</p><p>                       .tile(d3.treemapResquarify)</p><p>                       .size([width, height])</p><p>                       .round(true)</p><p>                       .paddingInner(1);</p><p>                   </p><p>                       // Define function that draws treemap based on the data parameter</p><p>                       function loadData(data) {</p><p>                                           </p><p>                                               var root = d3.hierarchy(data)</p><p>                                               .eachBefore(function(d) {</p><p>                                                                       d.data.id = (d.parent ? d.parent.data.id + "." : "") + d.data.name;</p><p>                                                                       d.data.title = (d.parent ? d.parent.data.name + " &gt; " : "") + d.data.name;</p><p>                                               })</p><p>                                               .sum(sumBySize)</p><p>                                               .sort(function(a, b) { return b.height - a.height || b.value - a.value; });</p><p>                                           </p><p>                                               treemap(root);</p><p>                                           </p><p>                                               var cell = svg.selectAll("g")</p><p>                                               .data(root.leaves())</p><p>                                               .enter().append("g")</p><p>                                               .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; });</p><p>                                           </p><p>                                               cell.append("rect")</p><p>                                               .attr("id", function(d) { return d.data.id; })</p><p>                                               .attr("width", function(d) { return parseInt(d.x1 - d.x0); })</p><p>                                               .attr("height", function(d) { return parseInt(d.y1 - d.y0); })</p><p>                                               .attr("fill", function(d) { return color(d.parent.data.id); });</p><p>                                           </p><p>                                               cell.append("clipPath")</p><p>                                               .attr("id", function(d) { return "clip-" + d.data.id; })</p><p>                                               .append("use")</p><p>                                               .attr("xlink:href", function(d) { return "#" + d.data.id; });</p><p>                                           </p><p>                                               cell.append("text")</p><p>                                               .attr("clip-path", function(d) { return "url(#clip-" + d.data.id + ")"; })</p><p>                                               .selectAll("tspan")</p><p>                                               .data(function(d) { return d.data.name.split(/(?=[A-Z][^A-Z])/g); })</p><p>                                               .enter().append("tspan")</p><p>                                               .attr("x", 4)</p><p>                                               .attr("y", function(d, i) { return 13 + i * 10; })</p><p>                                               .text(function(d) { return d; });</p><p>                                           </p><p>                                               cell.append("title")</p><p>                                               .text(function(d) { return d.data.title + "\n" + format(d.value) + " Requested"; });</p><p>                                           </p><p>                                               d3.selectAll("input")</p><p>                                               .data([sumBySize, sumByCount], function(d) { return d ? d.name : this.value; })</p><p>                                               .on("change", changed);</p><p>                                           </p><p>                                               // Set timeout that will automatically change our treemap to demonstrate transitions</p><p>                                               var timeout = d3.timeout(function() {</p><p>                                                                       d3.select("input[value=\"sumByCount\"]")</p><p>                                                                       .property("checked", true)</p><p>                                                                       .dispatch("change");</p><p>                                               }, 2000);</p><p>                                           </p><p>                                               function changed(sum) {</p><p>                                                                       timeout.stop();</p><p>                                                                   </p><p>                                                                       treemap(root.sum(sum));</p><p>                                                                   </p><p>                                                                       cell.transition()</p><p>                                                                       .duration(750)</p><p>                                                                       .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; })</p><p>                                                                       .select("rect")</p><p>                                                                       .attr("width", function(d) {</p><p>                                                                                               var width = parseInt(d.x1 - d.x0);</p><p>                                                                                               console.log(typeof width);</p><p>                                                                                               return width;</p><p>                                                                       })</p><p>                                                                       .attr("height", function(d) {</p><p>                                                                                               var height = parseInt(d.y1 - d.y0);</p><p>                                                                                               console.log(typeof height);</p><p>                                                                                               return height;</p><p>                                                                       });</p><p>                                               }</p><p>                       }</p><p>                   </p><p>                       // Call our data load function to initially draw the treemap with our data object</p><p>                       loadData(categories);</p><p>                   </p><p>                       function sumByCount(d) {</p><p>                                               return d.children ? 0 : 1;</p><p>                       }</p><p>                   </p><p>                       function sumBySize(d) {</p><p>                                               return d.size;</p><p>                       }</p><p>                   </p><p>}</p><p></p><h1>Server Script</h1><p></p><p style="margin-bottom: .0001pt; background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;">(function() {</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> /* populate the 'data' object */</span></p><p></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> // Query catalog items in the Service Catalog</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> var catGR = new GlideRecord('sc_cat_item');</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> catGR.addActiveQuery();</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> // I hardcoded the sys_id of the Service Catalog here. This could definitely</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> // be dynamically set up as a widget option.</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> catGR.addQuery('sc_catalogs', 'e0d08b13c3330100c8b837659bba8fb4');</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> catGR.addNotNullQuery('category.title');</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> catGR.orderBy('category');</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> catGR.query();</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;">                     </span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> // Declare our object that will contain the item data</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> var cats = {</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> "name": "Service Catalog",</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> "children": []</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> }</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;">                     </span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> var previousCat = '';</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> var tempArray = [];</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;">                     </span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> // Loop through items and populate our cats object according to the</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> // category structure. I don't have great RITM data in my personal</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> // dev instance, so I used random numbers to imitate the counts.</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> while (catGR.next()) {</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> var category = catGR.category.title+'';</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;">                                             </span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> if (previousCat == category)</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> tempArray.push({"name": catGR.name+'', "size": Math.floor((Math.random() * 100) + 1)});</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> else {</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> cats.children.push({"name": previousCat, "children": tempArray});</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> tempArray = [];</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> }</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> previousCat = category;</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> }</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;">                     </span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> // Pass our category object to the data object to be used client side</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;"> data.categories = cats;</span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;">                     </span></p><p style="background: white;"><span style="font-size: 10.5pt; font-family: 'Open Sans','serif'; color: black;">})();</span></p><p></p><p></p><p>Mitch Stutler</p><p>VividCharts Founder</p><p><a title="vidcharts.com/" href="http://vividcharts.com/">vividcharts.com</a></p><p><a title="nkedin.com/in/mitchellstutler/" href="http://linkedin.com/in/mitchellstutler/">linkedin.com/in/mitchellstutler</a></p><p><a title="itter.com/mitchstutler" href="http://twitter.com/mitchstutler">twitter.com/mitchstutler</a></p><p></p><p></p><h1>Sources</h1><p>- <a title="js.org/" href="http://d3js.org/">d3js.org</a></p><p>- <a title=".ocks.org/mbostock/4063582" href="http://bl.ocks.org/mbostock/4063582">Treemap</a></p>