---
title: "Powershell Orchestration Tips  Tricks"
date: 2016-10-18T04:14:21.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=705e2aaddbd0dbc01dcaf3231f961982"
---
<p><a title="ocs.servicenow.com/bundle/helsinki-it-operations-management/page/product/orchestration/reference/r-orchestration.html" href="https://docs.servicenow.com/bundle/helsinki-it-operations-management/page/product/orchestration/reference/r-orchestration.html" style="line-height: 1.5; font-family: Arial;">Orchestration</a> is becoming one of the most popular applications to use for automating processes, especially outside of the ServiceNow instance. You can use Orchestration activities to <a title="ocs.servicenow.com/bundle/helsinki-it-operations-management/page/product/orchestration/task/t_ActiveDirUserMgmtExample.html" href="https://docs.servicenow.com/bundle/helsinki-it-operations-management/page/product/orchestration/task/t_ActiveDirUserMgmtExample.html">Update Active Directory accounts</a>, <a title="ocs.servicenow.com/bundle/helsinki-it-operations-management/page/product/orchestration/task/t_CreateTheOrchestrationWorkflow.html" href="https://docs.servicenow.com/bundle/helsinki-it-operations-management/page/product/orchestration/task/t_CreateTheOrchestrationWorkflow.html">restart a Linux server</a>, and much more. One of the most common uses of Orchestration is with running Powershell-related commands and scripts against Windows servers.</p><p></p><p>Some applications, when you install them (e.g. Password Reset), come with Powershell Orchestration activities that you can use. You also have the option of creating your own Powershell activities.</p><p></p><p>As mentioned in this other great Community article <a title="" _jive_internal="true" href="/community/operations-management/orchestration/blog/2016/07/13/helsinki-release-deprecates-run-powershell-activity">here</a>, as of our Helsinki release, we have deprecated using our general "Run Powershell" activity and require you to use our <a title="ocs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/orchestration_activity_designer/concept/c_WorkflowActivityDesigner.html" href="https://docs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/orchestration_activity_designer/concept/c_WorkflowActivityDesigner.html">Orchestration Activity Designer</a> to build out new Powershell activities (although, if you have old workflows still using the old "Run Powershell" activities, these will still work). By using this new Orchestration Activity Designer to build custom Powershell activities, you have much more control of most of the aspects of this activity, from the inputs, to the script/commands you wish to run, to the outputs as well.</p><p></p><p>Overall, however, when using these Powershell activities (whether custom created or out-of-box), there are also some limitations and issues you can run into if you are not careful with how you are setting this up.</p><p></p><p>Here are a few quick tips of issues I have personally come across that may be good to be aware of as you are setting up these Powershell activities on your instances.</p><p></p><p>----------------------------------------------------------------</p><p></p><h2>1. MID Server selection</h2><p>A very common issue I have seen is understanding how/when a particular MID Server is selected to run these Orchestration activities.</p><p></p><p>While there is an article <a title="ocs.servicenow.com/bundle/helsinki-it-operations-management/page/product/mid-server/concept/mid-server-auto-mid.html#c_MIDServerAutofinderForOrch" href="https://docs.servicenow.com/bundle/helsinki-it-operations-management/page/product/mid-server/concept/mid-server-auto-mid.html#c_MIDServerAutofinderForOrch">here</a> that details the criteria of what is being checked against with regards to selecting a MID Server, this can even be a little confusing with regards to "Capabilities" and "IP Ranges," and even with selecting the "Default MID Server."</p><p></p><p>Let me try to break down what you should be looking for when trying to select a MID Server to use for these activities.</p><p></p><p><strong>a)</strong> First, you will need to set up any necessary <a title="ocs.servicenow.com/bundle/helsinki-it-operations-management/page/product/mid-server/reference/r_MIDServerCapabilities.html#r_MIDServerCapabilities" href="https://docs.servicenow.com/bundle/helsinki-it-operations-management/page/product/mid-server/reference/r_MIDServerCapabilities.html#r_MIDServerCapabilities">capabilities</a> for the MID Server(s) that you wish to use.</p><p></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">These can be set up on the MID Server records themselves in the Related List appropriately titled "Capabilities" (or, if you go to the "ecc_agent_capability" table and open the particular Capability you want, then there will be a Related List of "Mid Servers" for which you can link any of your MID Servers to this Capability).</p><p></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">Now, the Capabilities that you decide to link to the MID Servers you wish to use need to match with the "Required MID Server capabilities" value that are defined in your Orchestration activity under the "Execution Command" section, as seen in this screenshot below.</p><p></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"><img  alt="MID server selection.jpg" class="image-6 jive-image" src="7484c14adb149f048c8ef4621f96192d.iix" style="width: 620px; height: 292px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">For Powershell activities, typically what is already included is this "Powershell" capability, so you will want to make sure that any MID Servers you want to use for this activity have this "Powershell" Capability linked to it.</p><p></p><p><strong>b)</strong> Secondly, you also need to specify which MID Server to use based on the IP or Hostname that you declare for this activity.</p><p></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">As you can see also in the screenshot above, for the "Target host" variable, this is where you decide the IP or hostname that you want this Powershell command or script to run against.</p><p></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">If you put a direct IP address value here, this makes it simple as all you would need is to create a record in your "ecc_agent_ip_range" table that has this IP (or a range that includes this IP) and then (again) there will be a Related List for this record called "MID Server" where you can link your MID Servers to this IP Range.</p><p></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">If you put a hostname value (like the "mycomputer" example I have above), then you would need an additional "cmdb_ip_address_dns_name" record that associates this hostname to a specific IP address, and then again, this IP address can be included in this IP Range record to be used.</p><p></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">Once you have both of these in place, then whatever MID Server(s) match both these criteria can be used to run your Powershell activity.</p><p></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">If you have more than 1 MID Server that meets these criteria, then the MID will be chosen at random.</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">However, if for example you don't have any MID Servers setup with the Capability defined in the activity, or if you don't have an IP range record linked to any of your MID Server with the IP you are targeting, then we will default to use the <a title="ocs.servicenow.com/bundle/helsinki-it-operations-management/page/product/mid-server/concept/c_MIDServerSelectionCriteria.html" href="https://docs.servicenow.com/bundle/helsinki-it-operations-management/page/product/mid-server/concept/c_MIDServerSelectionCriteria.html">Default MID Server</a>.</p><p></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">Please be aware of this when setting up your Orchestration activities in case you are not seeing a specific MID Server being used that you are expecting to be used for these activities.</p><p></p><h2>2. Make sure your "Target" Server and MID Server are different</h2><p>Another common "mistake" that people make, especially while testing their Powershell activities is that for the "Target host," is choosing the same hostname/IP as the MID Server they want to use to execute the script. For example, you choose a MID Server that is on the IP "10.123.47.8" and the "Target host" for your activity is also "10.123.47.8".</p><p></p><p>The issue that occurs here has to do with the credentials that you may need to use to run the commands that you are specifying in your activity.</p><p></p><p>If the command or script you are trying to execute requires you to use a specific credential, then you will have issues when trying to run this Powershell activity against the same IP as your MID Server because there appears to be a Windows restriction where you can't pass in a "Credential" value when executing these commands locally.</p><p></p><p>What will happen from a ServiceNow perspective (based on default settings) is that we may try to use your Windows credentials to execute this command, but since those will fail, we will end up trying using the "MID Server Service Account" credential (which in most cases is just a "Local System Account"). If this account can't run the script accordingly, then your activity will fail.</p><p></p><p>The best and easiest way to see how this is occurring is to do manually follow these steps on one of your MID Server hosts:</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"><strong>a)</strong> Log in to a Windows machine as an admin (or a user with admin privileges) and open the "Windows Powershell" command window, or open a regular "cmd" window and launch Powershell.</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">       <img  alt="mid server powershell.JPG" class="image-7 jive-image" src="6175ecc2db14d704ed6af3231f961900.iix" style="width: 620px; height: 75px; display: block; margin-left: auto; margin-right: auto;"/></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"><strong>b)</strong> Next, type in a simple command like "gwmi win32_operatingsystem" and you should get an output like below:</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">       <img  alt="mid server powershell 2.JPG" class="image-8 jive-image" src="50540c06db58db048c8ef4621f9619f7.iix" style="width: 620px; height: 215px; display: block; margin-left: auto; margin-right: auto;"/></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"><strong>c)</strong> Try adding these following parameters in your command as well:</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="padding-left: 60px;">Computer -&gt; This is where you can declare the IP/Hostname of the target device you want to run this command against.</p><p style="padding-left: 60px;">Credential -&gt; This is where you can type in the username of an account to use to login to this target device.</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">In this next example, my computer name is "wvmsancthompson", so when I try running this command passing in my current computer name and my currently logged in user ID, I will first be prompted to type the password for this id, but after doing that, I will end up getting this error:</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"> <img  alt="mid server powershell 3.JPG" class="image-9 jive-image" src="9632637ddbdc9fc0b322f4621f961987.iix" style="width: 620px; height: 103px; display: block; margin-left: auto; margin-right: auto;"/></p><pre __default_attr="info" __jive_macro_name="alert" alert="info" class="jive_text_macro jive_macro_alert" data-renderedposition="2583.79248046875_7.997159004211426_1192_42"><p>If you remove the "-Computer" parameter from here and just have the additional "-Credential" parameter, you will still get this error to occur as well.</p></pre><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"><strong>d)</strong> However, just to prove that this works if scanning against a different computer, if I pass in an IP of a different device in my network, I get this result:</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">   <img  alt="mid server powershell 4.JPG" class="image-10 jive-image" src="21bbc9cadbd49f048c8ef4621f96192a.iix" style="width: 620px; height: 112px; display: block; margin-left: auto; margin-right: auto;"/></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">If you are executing some specific script or commands that are required to be ran as a specific user, you can see how trying to pass in the Credential of that user to try to run this script locally will throw this "User credential cannot be used for local connections" error, and thus cause your activity to error out as well.</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">Therefore, I would advise you should always set up to have your Powershell activities be ran against different devices other than the server that is hosting your MID Server.</p><p></p><h2>3. Be careful of special characters</h2><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">Finally, what you may notice on our platform with regards to inputs and outputs for some of these activities is that we sometimes pass in or receive values in a "JSON" format.</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">For example, in a few of our default AD-related activities like <a title="ocs.servicenow.com/bundle/geneva-it-operations-management/page/administer/orchestration_activities/reference/r_CreateADObject.html" href="https://docs.servicenow.com/bundle/geneva-it-operations-management/page/administer/orchestration_activities/reference/r_CreateADObject.html">Create AD Object</a> and <a title="ocs.servicenow.com/bundle/geneva-it-operations-management/page/administer/orchestration_activities/reference/r_UpdateADObject.html" href="https://docs.servicenow.com/bundle/geneva-it-operations-management/page/administer/orchestration_activities/reference/r_UpdateADObject.html">Update AD Object</a> where we have a parameter called "ObjectData" that are expecting values to be included in a JSON format.</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">While normally this doesn't cause any problems, if you are including values that may have special characters (like a comma, a quotation mark, or even a backslash), it can create some issues when being converted to be used for Powershell.</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">So, for example, let's say you are including an "Update AD Object" activity in a workflow and you want to update a Manager AD field to put a manager's name here, like "Murphy, John." Ideally, you would expect to just put this value in the "ObjectData" field as a JSON String like this below:</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"><span style="; color: #000000; font-size: 13.3333330154419px; font-family: 'courier new', courier;"><strong>{"manager" : "Murphy, John"}</strong></span></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">However, you would likely get an error to occur with this value because this comma character is not being escaped properly by the time we are trying to pass in this value to the AD Server.</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">Instead, you need to add backslashes to escape this "comma" character so it can be passed once it's converted in the Powershell script. In fact, in this scenario, you likely would need to add two backslashes to make this look like below:</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"><span style="color: #303030; font-size: 10pt; font-family: 'courier new', courier;"><strong>{"manager" : "Murphy\\, John"}</strong></span></p><p style="padding-left: 30px;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">This is because you need one backslash to escape the comma character, and then you need a second backslash to escape the first backslash character (since the backslash itself is a special character as well).</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">Also, another issue is that if you are not directly putting the value in the "ObjectData" field itself, but instead grabbing this from a variable or field on a record from the instance, then you may need to use as many as four backslashes to escape a character, because you will likely need two backslashes for escaping when converting the "Javascript" definition of the character to JSON.</p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">You can read this Community article with more details: <a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=77dd6ae9dbd0dbc01dcaf3231f9619e9">Constraint Violation with Orchestration when creating an account - the manager attribute has a backslash \ character in the DN</a></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;"></p><p style="margin-bottom: 0.0001pt; padding-left: 30px; background: white;">Now, I'm not sure overall which characters would have this condition occur for them, but if you are seeing issues occurring with using other characters like ampersand (&amp;), asterisks (*), etc., please check and see if adding these backslashes can help for those characters as well.</p><p></p><p>----------------------------------------------------------------</p><p></p><p>I hope this can be helpful to anyone if you are seeing any of these common types of issues or errors arising when setting up your own Powershell Orchestration activities and workflows.</p><p></p><p>If there are any other common issues that you come across, and if you have some suggestions about how to handle these types of situations, please feel free to comment below. I would love to hear feedback and more ways to fix these types of problems.</p>