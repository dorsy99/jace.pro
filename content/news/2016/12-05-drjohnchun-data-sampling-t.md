---
title: "Data Sampling Techniques Part  Sampling Using Scripted Filter"
date: 2016-12-04T07:27:05.000Z
authors: ["drjohnchun"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=757d2269dbd0dbc01dcaf3231f961917"
---
<p><a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=bfddaae9dbd0dbc01dcaf3231f961947">Last time</a>, we saw how statistical sampling can be used with <strong><a title="ki.servicenow.com/?title=Control_Test_Definitions" href="http://wiki.servicenow.com/?title=Control_Test_Definitions">Control Test Definitions</a></strong> (<strong><a title="ocs.servicenow.com/bundle/helsinki-it-business-management/page/product/grc-indicators/task/t_CreateAnIndicator2.html" href="https://docs.servicenow.com/bundle/helsinki-it-business-management/page/product/grc-indicators/task/t_CreateAnIndicator2.html">Indicators</a></strong> in Helsinki) in the <a title="ki.servicenow.com/?title=Governance,_Risk,_and_Compliance" href="http://wiki.servicenow.com/?title=Governance,_Risk,_and_Compliance">GRC application</a>; although we had to calculate the sample size manually, we were able to leverage the built-in random sampling feature. This time, we'll take a look at how we can build a tool that calculates a sample size for us and retrieves sample data using a ServiceNow feature called <a title="ki.servicenow.com/?title=Using_Filters_and_Breadcrumbs#Scripted_Filters" href="http://wiki.servicenow.com/?title=Using_Filters_and_Breadcrumbs#Scripted_Filters">Scripted Filter</a> (NOTE: this requires admin role).</p><p></p><p><img __jive_macro_name="toc" class="jive_macro_toc jive_macro" data-renderedposition="113_8_61_72" src="/8.0.4.21bdc7e/images/tiny_mce3/plugins/jiveemoticons/images/spacer.gif"/></p><h3>SCRIPT INCLUDE statSample()</h3><p></p><p>First, we need to create a <a title="ki.servicenow.com/?title=Script_Includes" href="http://wiki.servicenow.com/?title=Script_Includes">Script Include</a> with a function that performs statistical sampling; let's call the function <span style="font-family: 'courier new', courier;">statSample</span>, short for statistical sampling. At a high level, here's what <span style="font-family: 'courier new', courier;">statSample<span style="font-family: 'courier new', courier;">()</span></span> does:</p><p></p><ol><li>Takes the <em>table name</em> and <em>encoded query string</em> needed for querying.</li><li>Optionally, it also takes <em>margin of error</em> and <em>confidence level</em>; if omitted, they default to 5% <em>margin of error</em> and 95% <em>confidence level</em>.</li><li>Query the table and get the <em>population size</em> using<span style="font-family: 'courier new', courier;"> .getRowCount()</span>.</li><li>Determine the <em>sample size</em> from the <em>population size</em>, <em>margin of error</em> and <em>confidence level</em>.</li><li>Pick a random row from the record set and save the <span style="font-family: 'courier new', courier;">sys_id</span>; repeat until the <em>sample size</em> number of unique records are collected.</li><li>Return the saved <span style="font-family: 'courier new', courier;">sys_id</span>s in an array.</li></ol><p></p><p>To create a new Script Include,</p><p></p><ol><li><span style="text-align: left; color: #3d3d3d; text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif; font-size: 14px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">Log in with admin role.</span></li><li>Navigate to <strong>System Definition &gt; Script Includes</strong>.</li><li>Click on <strong>New</strong> button to create a new <strong>Script Include</strong>.</li><li>Fill the form as in the screenshot below:<br/><img   class="jive-image image-4" height="303" src="a9087b35db101304b322f4621f961988.iix" style="height: 303px; width: 776.281px; border: 1px solid #ccc;" width="776"/></li><li>This can be either Global or Scoped; if Scoped, make sure to jot down the <strong>API Name</strong> to be used later in Scripted Filter.</li><li>Since we want to use this from other applications, set <strong>Accessible from</strong> to <strong>All application scopes</strong>.</li><li>For this to be used as a Scripted Filter, <strong>Client callable</strong> must be <strong>checked</strong>.</li><li>In the Script field, paste the below script (also attached below as a file).</li><li>Finally, click on <strong>Submit</strong>.</li></ol><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14811470234613811 jive_text_macro" data-renderedposition="1073.0999755859375_8_915_1392" jivemacro_uid="_14811470234613811"><p>/** </p><p> * Performs statistical sampling against a filtered list of GlideRecords.</p><p> * Takes table name and encoded query string then returns an array of sys_id of sample records.</p><p> *</p><p> * Version 0.1.2 2016-12-06</p><p> * </p><p> * SCRIPTED FILTER EXAMPLES</p><p> *</p><p> * EXAMPLE 1: SHOW DEBUG DATA</p><p> * [Sys ID] [is] [javascript:statSample('incident', '', 3, 99, true)]</p><p> * returns Sys ID = {"confidenceLevel":99,"encodedQuery":"","marginOfError":3,"population":7255,"sampleSize":1474,"tableName":"incident","zValue":2.58}</p><p> *</p><p> * EXAMPLE 2: GET STATISTICAL SAMPLE USING ENCODED QUERY STRING, AT DEFAULT 95% CONFIDENCE LEVEL AND 5% MARGIN OF ERROR</p><p> * [Sys ID] [is] [javascript:statSample('incident', 'active=1')]</p><p> * returns 382 sample records from the population size of 54,939 at 95% confidence level with 5% margin of error</p><p> *</p><p> * NOTE: Scripted Filter runs in rhino.sandbox context so not all classes/objects are available for scripting</p><p> * NOTE: The function is run twice in Scripted Filter somehow, so use randomSampleRecords to run only once.</p><p> *</p><p><span> * MIT License </span><a title="" _jive_internal="true" href="http://tldrlegal.com/l/mit" rel="nofollow" target="_blank">http://tldrlegal.com/l/mit</a></p><p> * Copyright (c) 2016 John.Chun @snowaid.com</p><p> *</p><p> * @param {string} tableName - name of table for GlideRecord </p><p> * @param {string} encodedQuery - encoded query string </p><p> * @param {int} marginOfError - margin of error in percent (for example, 5 for 5% margin of error) </p><p> * @param {int} confidenceLevel - confidence level in percent (for example, 95 for 95% confidence level) </p><p> * @param {boolean} debug - if true, returns debug data (input and derived values) </p><p> * @return {string[]} array of sys_id of statistical sample records</p><p> */</p><p></p><p>var statSampleRecords = [];   // this is in rhino.sandbox context in Scripted Filter; otherwise in global</p><p></p><p>function statSample(tableName, encodedQuery, marginOfError, confidenceLevel, debug) {</p><p></p><p>   if (statSampleRecords.length) return statSampleRecords;   // in Scripted Filter, force to run only once</p><p>   try {</p><p>       //var gr = new GlideRecordSecure(tableName);   // enforce ACL; GlideRecordSecure undefined in Scripted Filter in Helsinki</p><p>       var isScriptedFilter = !this.GlideRecordSecure;   // use the fact that GlideRecordSecure is undefined in Scripted Filter</p><p>       var gr = new GlideRecord(tableName);</p><p>       if (!gr.isValid()) throw 'Invalid table name "' + tableName + '".';</p><p>       if (!gr.canRead()) throw 'No permission to read from "' + tableName + '".';   // test ACL for table</p><p></p><p>       // get population</p><p>       if (encodedQuery) gr.addQuery(encodedQuery);</p><p>       gr.query();   // to getRowCount()</p><p>       var population = gr.getRowCount();</p><p>       if (!population) return [];</p><p></p><p>       // get sample size</p><p>       marginOfError = marginOfError || 5;   // default to 5%</p><p>       confidenceLevel = confidenceLevel || 95;   // default to 95%</p><p>       var zValues = { 80: 1.28, 85: 1.44, 90: 1.65, 95: 1.96, 99: 2.58 };</p><p>       var zValue = zValues[confidenceLevel] || 1.96;   // default to 1.96 == confidenceLevel of 95%</p><p>       var sampleSize = Math.ceil(1 / (1 / population + Math.pow(0.02 * marginOfError / zValue, 2)));</p><p></p><p>       // show debug data (input and derived values)</p><p>       if (debug) return JSON.stringify({</p><p>           tableName: tableName,</p><p>           encodedQuery: gr.getEncodedQuery(),</p><p>           marginOfError: marginOfError,</p><p>           confidenceLevel: confidenceLevel,</p><p>           zValue: zValue,</p><p>           population: population,</p><p>           sampleSize: sampleSize,</p><p>       });</p><p></p><p>       // throw dice and get a random sample</p><p>       var records = [], offsets = [];</p><p>       while (records.length &lt; sampleSize &amp;&amp; offsets.length &lt; population) {</p><p>           var offset = Math.floor(Math.random() * population);   // 0 &lt;= offset &lt; population</p><p>           if (indexOf(offsets, offset) &gt;= 0) continue;   // dupe offset, so rethrow dice</p><p>           offsets.push(offset);</p><p>           gr.chooseWindow(offset, offset + 1);   // works in global &amp; scoped</p><p>           gr.query();</p><p>           if (gr.next()) records.push(gr.sys_id.toString());</p><p>       }</p><p></p><p>       if (isScriptedFilter) statSampleRecords = records;   // in Scripted Filter, save statSampleRecords</p><p>       return records;</p><p>   }</p><p>   catch (e) {</p><p>       return 'ERROR: ' + e;   // return error message</p><p>   }</p><p></p><p>   // emulates Array.prototype.indexOf() in older JavaScript</p><p>   function indexOf(arr, val) { for (var i = 0; i &lt; arr.length; i++) if (arr[i] == val) return i; return -1; }</p><p>}</p></pre><p></p><h3><span style="font-size: 16px; font-weight: bold;">SCRIPTED FILTER IN CONTROL TEST DEFINITION</span></h3><p></p><p><a title="ki.servicenow.com/?title=Using_Filters_and_Breadcrumbs#Scripted_Filters" href="http://wiki.servicenow.com/?title=Using_Filters_and_Breadcrumbs#Scripted_Filters">Scripted Filters</a> are used in <a title="ki.servicenow.com/?title=Condition_Builder" href="http://wiki.servicenow.com/?title=Condition_Builder">Condition Builders</a> to add custom conditions. They can be used wherever Condition Builders are used, such as list views, related lists, reports, and some forms, like the Control Test Definition form we saw last time. They run <a title="ki.servicenow.com/?title=Script_Includes" href="http://wiki.servicenow.com/?title=Script_Includes">Script Includes</a> that return an array of <span style="font-family: 'courier new', courier;">sys_id</span>s, which is then used to retrieve the corresponding records.</p><p></p><p>Let's go back to the same Control Test Definition we used in <a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=bfddaae9dbd0dbc01dcaf3231f961947">Part 4: GRC</a> and modify a few fields to use <span style="font-family: 'courier new', courier;">statSample</span><span style="font-family: 'courier new', courier;">()</span>. As shown in the screenshot below, we only need to</p><p></p><ol><li>Set <strong>Sample size</strong> to <strong>0</strong>, that is, all records resulting from <strong>Control test condition</strong>.</li><li>Set <strong>Control test condition</strong> to <strong>[Sys ID] [is] [javascript:statSample('cmdb_ci')]</strong> (the value field is obscured in the screenshot; in case you defined <span style="font-family: 'courier new', courier;">statSample<span style="font-family: 'courier new', courier;">()</span></span> in a scoped app, make sure to prefix <span style="font-family: 'courier new', courier;">statSample<span style="font-family: 'courier new', courier;">()</span></span> with the <strong>API name</strong>, like <span style="font-family: 'courier new', courier;">x_12345_myapp.statSample</span>). We're only passing the table name in <span style="font-family: 'courier new', courier;">statSample<span style="font-family: 'courier new', courier;">()</span></span>; in most cases, you'll also pass the second parameter, encoded query string, to refine the query.</li></ol><p><img   class="image-5 jive-image" height="334" src="303b950edb9c9f048c8ef4621f96197a.iix" style="height: 334px; width: 713.597px; border: 1px solid #ccc;" width="714"/></p><p></p><p>When you click on <strong>Execute Now</strong>, it'll add a new <strong>Control Test</strong> with the sample as <strong>Supporting Data</strong>. So now, you don't have to manually calculate the <em>sample size</em> and enter into the <strong>Sample size</strong> field.</p><p></p><h3>THE GOOD, THE BAD, AND THE UGLY</h3><p></p><p>By utilizing a Scripted Filter, now we can use statistical sampling wherever Condition Builders are used (and there are quite a few places), without having to manually calculate the sample size. Now, that's great. The bad part is that it's not very efficient, since it has to evaluate the query twice; first time in <span style="font-family: 'courier new', courier;">statSample()</span> to select the <span style="font-family: 'courier new', courier;">sys_id</span>s of the sample records, then the same query has to run again to collect the same records outside of <span style="font-family: 'courier new', courier;">statSample<span style="font-family: 'courier new', courier;">()</span></span>. The random selection algorithm inside <span style="font-family: 'courier new', courier;">statSample<span style="font-family: 'courier new', courier;">()</span></span> is not very efficient either; there are more efficient ways to do the same using pure SQL, but we are confined to using <span style="font-family: 'courier new', courier;">GlideRecord</span> here. You'll notice the slow performance when the population size is large. Luckily, statistical sampling is not something we use often so the performance should be acceptable in most cases.</p><p></p><p>Now to the ugly part; when we call <span style="font-family: 'courier new', courier;">statSample<span style="font-family: 'courier new', courier;">()</span></span>, we have to pass table name and encoded query string as parameters. If you look at the above screenshot, the table name "cmdb_ci" is already on the form, in the <strong>Table</strong> field. However, <span style="font-family: 'courier new', courier;">statSample<span style="font-family: 'courier new', courier;">()</span></span>, being a Script Include, is unaware of it, so we have to explicitly pass it using the raw name of the table "cmdb_ci" and not the more friendly "Configuration Item". It gets worse with the encoded query string; we can't use the Condition Builder field <strong>Control test condition</strong> to add more conditions (technically we can, but it may alter the sample, invalidating the results). Any encoded query to be applied to the table must be passed to <span style="font-family: 'courier new', courier;">statSample<span style="font-family: 'courier new', courier;">()</span></span> as a string parameter. Again, <span style="font-family: 'courier new', courier;">statSample<span style="font-family: 'courier new', courier;">()</span></span> has no knowledge of the Condition Builder on the form. So you need to define the encoded query in a List View and use <strong>Copy query</strong> context menu to copy the string and then pass it on to <span style="font-family: 'courier new', courier;">statSample<span style="font-family: 'courier new', courier;">()</span></span> as the second parameter; not ideal. Luckily, in most cases, these queries won't change often once defined.</p><p></p><p>So while not the most elegant solution, it'll be useful in many cases where statistical sampling can be used. If you know of better ways of doing this, I'd like to know.</p><p></p><h3>ROW-LEVEL ACL (ACCESS CONTROL LIST)</h3><p></p><p>While we're on this topic, I'd like to briefly touch upon row-level ACLs that may keep some records from displaying if the user doesn't have the permission to see them. <span style="font-family: 'courier new', courier;">statSample<span style="font-family: 'courier new', courier;">()</span></span> uses GlideRecord, which doesn't respect ACLs; however, once the <span style="font-family: 'courier new', courier;">sys_id</span>s are returned and used to retrieve the records the second time, ACLs are typically enforced so some rows may not display. This impairs sampling (unless it is done purposefully to find out how many "hidden" rows are present in a population). Although these cases should be rare, it's something to be aware of. My recommendation is to apply filters appropriately so the entire result set (population) is readable and available for sampling.</p><p></p><h3>OTHER USE CASES</h3><p></p><p>Because <span style="font-family: 'courier new', courier;">statSample</span>() is a Script Include that can be called from the server as well as the client, it can be used beyond Scripted Filter. It returns only an array of<span style="font-family: 'courier new', courier;"> sys_id</span>s, but it can be easily modified to return an array of GlideRecods by changing Line 75 to</p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_1480778201666256 jive_macro_code jive_text_macro" data-renderedposition="3972_8_915_16" jivemacro_uid="_1480778201666256"><p>           if (gr.next()) records.push(gr);</p></pre><p></p><p>so the entire GlideRecord is added to the <span style="font-family: 'courier new', courier;">records</span> array. This may be more useful in some cases.</p><p></p><p>Next time, we'll continue looking at other related features from ServiceNow.</p><p></p><h3>UPDATES</h3><p></p><p>2016-12-07 updated script to Version 0.1.2</p><p>2016-12-05 revised script to run only once when called from Scripted Filters; for reasons unknown, the function is run twice. Also updated the attached script file. This improved the performance by about two folds. See <a title="And the winner is... Randomly Selecting GlideRecords" __default_attr="6267" __jive_macro_name="blogpost" class="jive_macro jive_macro_blogpost" data-orig-content="And the winner is... Randomly Selecting GlideRecords" data-renderedposition="4183.35009765625_475.78997802734375_355_16" href="/community?id=community_blog&sys_id=2f0e6e2ddbd0dbc01dcaf3231f961925">And the winner is... Randomly Selecting GlideRecords</a> for more details.</p><p></p><p><em>Please feel free to connect, follow, post feedback / questions / comments, share, like, bookmark, endorse.</em></p><table><tbody><tr><td>John Chun, <span style="font-size: 8pt;">PhD PMP</span> <a href="http://linkedin.com/in/DrJohnChun"><img alt="see John's LinkedIn profile" class="image-2 jive-image" src="http://megaicons.net/static/img/icons_sizes/182/456/16/linkedin-icon.png" style="height: auto; vertical-align: -13px;" title="see John's LinkedIn profile"/></a><p><a href="http://snowaid.com/"><img alt="visit snowaid" class="image-1 jive-image" src="http://snowaid.com/images/signature.png" style="height: auto; margin-top: -9px;" title="visit snowaid"/></a></p></td><td><a _jive_internal="true" href="/people/drjohnchun/content"><img alt="ServiceNow Advocate" class="image-3 jive-image" src="http://snowaid.com/images/sn_advocate_135x48.png" style="margin-top: -3px;"/></a></td></tr></tbody></table>