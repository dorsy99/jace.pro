---
title: "D Meets Service Portal  Part "
date: 2016-09-21T19:55:00.000Z
authors: ["mitchellstutler"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=f01daea5dbd0dbc01dcaf3231f961981"
---
<p>This post is going to build on my previous post. If you are wanting to follow along in your own instance you will probably have an easier time if you work through the first post before beginning this one.</p><p></p><p>In this post we will learn how to set up widget options and retrieve data from the server script. By the end of this we will have the tools we need to build configurable and dynamic widgets.</p><p></p><h1>Widget options</h1><p></p><p>Widget options allow you to set up configurable properties for individual instances of your widget. This gives you the ability to use the same widget across multiple pages or even portals while still giving you the flexibility to customize those instances of the widget.</p><p></p><p>To set our widget options up there will be 3 main steps: create the option schema, set default values for these options in our server script, and using these options in our client script.</p><p></p><p>From the widget editor, click the hamburger menu near the top right and select 'Edit option schema'. This gives us a modal that allows to create, modify, or delete options for our widget. In this example we will set up 3 options: Width, Bar Height, and Left Margin. Click the "+" button to add a new option and then give each of these options a type of "integer". Here is a screenshot of my option schema:</p><p></p><p><img   alt="Post 2 Option Schema.png" class="image-1 jive-image" src="ec126bb5db9093041dcaf3231f961946.iix" style="width: 620px; height: 168px;"/></p><p></p><p>Now that we have these options, we will use our server script to set default values in case the user doesn't need to customize their widget instance. Below is the portion of our server script that accomplishes the default values. Later in this post I will post the complete server script, but for now we will just enter this code at the beginning of our server script function.</p><p></p><p>// Set default options</p><p>options.width = options.width || 600;</p><p>options.bar_height = options.bar_height || 20;</p><p>options.left_margin = options.left_margin || 100;</p><p></p><p>These 3 lines check if there is a value for these options and sets to our default values if not.</p><p></p><p>Now that we have an option schema configured and are protected with default values, we can reference these options in our client script. The data and options objects are available to us in the client script by prefixing them with c like this "c.options.width". I will paste the full client script in a later section. For now, here are the lines that set our variables to our options so that we can easily reference them later.</p><p></p><p>// Set the width of the chart along with the height of each bar</p><p>var width = c.options.width,</p><p>barHeight = c.options.bar_height,</p><p>leftMargin = c.options.left_margin;</p><p></p><h1>Server script</h1><p></p><p></p><p>Now that we have properties set up let's work on dynamically pulling data from ServiceNow. In the previous post, we used hard-coded data to generate our bar chart. This time we will use a GlideAggregate call to grab the number of incidents in each category. If you aren't familiar with GlideAggregate check out its page on the <a title="ocs.servicenow.com/bundle/helsinki-servicenow-platform/page/script/glide-server-apis/reference/r_GlideAggregateExamples.html" href="https://docs.servicenow.com/bundle/helsinki-servicenow-platform/page/script/glide-server-apis/reference/r_GlideAggregateExamples.html">Product Documentation Site</a>.</p><p></p><p>The first thing we'll do is declare an array of objects within the data object:</p><p></p><p>data.categories = [];</p><p></p><p>Next, we'll make our GlideAggregate call and create an object within the array for each of the incident categories that are returned.</p><p></p><p>var count = new GlideAggregate('incident');</p><p>count.addQuery('active', 'true');</p><p>count.addAggregate('COUNT', 'category');</p><p>count.query();</p><p>while (count.next()) {</p><p>                       var category = count.category.getDisplayValue();</p><p>                       var categoryCount = count.getAggregate('COUNT', 'category') * 1.0;</p><p>                       data.categories.push({"category": category, "value": categoryCount});</p><p>}</p><p></p><p>We now have an array of objects that we can reference in our client script. Here is a screenshot of our server script along with the complete script pasted.</p><p></p><p><img   alt="Post 2 Server Script.png" class="image-2 jive-image" src="76a4cd06db90130468c1fb651f9619f6.iix" style="width: 620px; height: 261px;"/></p><p></p><p></p><p>(function() {</p><p>                       /* populate the 'data' object */</p><p>                 </p><p>                       // Set default options</p><p>                       options.width = options.width || 600;</p><p>                       options.bar_height = options.bar_height || 20;</p><p>                       options.left_margin = options.left_margin || 100;</p><p>                 </p><p>                       // Create an array of objects containing the categories along with</p><p>                       // the number of objects in each</p><p>                       data.categories = [];</p><p>                 </p><p>                       var count = new GlideAggregate('incident');</p><p>                       count.addQuery('active', 'true');</p><p>                       count.addAggregate('COUNT', 'category');</p><p>                       count.query();</p><p>                       while (count.next()) {</p><p>                                               var category = count.category.getDisplayValue();</p><p>                                               var categoryCount = count.getAggregate('COUNT', 'category') * 1.0;</p><p>                                               data.categories.push({"category": category, "value": categoryCount});</p><p>                       }</p><p>})();</p><p></p><h1>Client script</h1><p></p><p>In the last post we had a variable named "data" that we had set equal to a hard-coded array of objects in our client script. This time we will set that same variable equal to our array of objects that we created in our server script. Here is the line of code that accomplishes this:</p><p>// Define our hard-coded data</p><p>var data = c.data.categories;</p><p></p><p>Other than that and the options that we set up earlier, the main new piece introduced is the bottom axis. We add that in with these lines:</p><p></p><p>// Create the x-axis and append it to the bottom of the chart</p><p>var xAxis = d3.axisBottom().scale(x);</p><p>                 </p><p>chart.append("g")</p><p>.attr("class", "x axis")</p><p>.attr("transform", "translate(0," + (barHeight * data.length) + ")")</p><p>.attr("x", leftMargin)</p><p>.call(xAxis);</p><p></p><p>Below is a screenshot of our client script as well as the pasted script.</p><p></p><p><img   alt="Post 2 Client Script.png" class="image-3 jive-image" src="6f12ac4edb10dfc03eb27a9e0f9619c8.iix" style="width: 620px; height: 645px;"/></p><p></p><p>function() {</p><p>                       /* widget controller */</p><p>                       var c = this;</p><p>                 </p><p>                       // Define our hard-coded data</p><p>                       var data = c.data.categories;</p><p>                 </p><p>                       // Set the width of the chart along with the height of each bar</p><p>                       var width = c.options.width,</p><p>                       barHeight = c.options.bar_height,</p><p>                       leftMargin = c.options.left_margin;</p><p>                 </p><p>                       var chart = d3.select(".chart")</p><p>                       .attr("width", width)</p><p>                       .attr("height", barHeight * data.length + 50);</p><p>                 </p><p>                       // Set the domain and range of the chart</p><p>                       var x = d3.scaleLinear()</p><p>                       .range([leftMargin, width])</p><p>                       .domain([0, d3.max(data, function(d) { return d.value; })]);</p><p>                 </p><p>                       // Add a g container for each row from our data</p><p>                       var bar = chart.selectAll("g")</p><p>                       .data(data)</p><p>                       .enter().append("g")</p><p>                       .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });</p><p>                 </p><p>                       // Add a rectangle element with the width based off of the value from that row of data</p><p>                       bar.append("rect")</p><p>                       .attr("width", function(d) { return x(d.value) - leftMargin; })</p><p>                       .attr("height", barHeight - 1)</p><p>                       .attr("x", leftMargin);</p><p>                 </p><p>                       // Add text elements to serve as labels of our categories</p><p>                       bar.append("text")</p><p>                       .attr("x", leftMargin - 5)</p><p>                       .attr("y", barHeight / 2)</p><p>                       .attr("width", leftMargin)</p><p>                       .attr("dy", ".35em")</p><p>                       .style("fill", "black")</p><p>                       .style("text-anchor", "end")</p><p>                       .text(function(d) { return d.category; });</p><p>                 </p><p>                       // Create the x-axis and append it to the bottom of the chart</p><p>                       var xAxis = d3.axisBottom().scale(x);</p><p>                 </p><p>                       chart.append("g")</p><p>                       .attr("class", "x axis")</p><p>                       .attr("transform", "translate(0," + (barHeight * data.length) + ")")</p><p>                       .attr("x", leftMargin)</p><p>                       .call(xAxis);</p><p>                 </p><p>}</p><p></p><h1>CSS</h1><p></p><p>We also have a couple of updates to our CSS this time. Here is what I have in my widget's CSS:</p><p></p><p>.chart rect {</p><p>   fill: steelblue;</p><p>}</p><p></p><p>.chart text {</p><p>   font: 10px sans-serif;</p><p>}</p><p></p><p>.centered-chart {</p><p>   text-align: center;</p><p>}</p><p></p><p>.axis text {</p><p>   font: 10px sans-serif;</p><p>}</p><p></p><p>.axis path,</p><p>.axis line {</p><p>   fill: none;</p><p>   stroke: #000;</p><p>   shape-rendering: crispEdges;</p><p>}</p><p></p><h1>Trying it out</h1><p></p><p>Now that we have everything in place we will go ahead and test our updated widget out. The first thing we'll do is view our page in the page designer and hover over our widget. You should see a pencil icon in the top right corner of your widget. If you click that pencil you will get a modal that has your options in it.</p><p></p><p>Here is a screenshot of how I configured my widget instance:</p><p><img   alt="Post 2 Option Configuration.png" class="image-4 jive-image" src="6e1504cadb1c5fc068c1fb651f961909.iix" style="width: 620px; height: 231px;"/></p><p></p><p></p><p>Here is what those options give me in action:</p><p><img   alt="Post 2 Bar Chart.png" class="image-5 jive-image" src="4a21e3b5db585b048c8ef4621f961974.iix" style="width: 620px; height: 198px;"/></p><p></p><h1>Next time</h1><p></p><p>In the next post, we will explore how to use multiple datasets with D3 and how to make our chart interactive.</p><p></p><p>Mitch Stutler</p><p>VividCharts Founder</p><p><a title="vidcharts.com/" href="http://vividcharts.com/">vividcharts.com</a></p><p><a title="nkedin.com/in/mitchellstutler/" href="http://linkedin.com/in/mitchellstutler/">linkedin.com/in/mitchellstutler</a></p><p><a title="itter.com/mitchstutler" href="http://twitter.com/mitchstutler">twitter.com/mitchstutler</a></p><p></p><h1>Sources</h1><p>- <a title=" data-attached-link=" class="wz-link" data-attached-link="{&quot;type&quot;:&quot;Web&quot;,&quot;url&quot;:&quot;https://docs.servicenow.com/bundle/helsinki-servicenow-platform/page/script/glide-server-apis/reference/r_GlideAggregateExamples.html&quot;,&quot;title&quot;:&quot;https://docs.servicenow.com/bundle/helsinki-servicenow-platform/page/script/glide-server-apis/reference/r_GlideAggregateExamples.html&quot;}" href="https://docs.servicenow.com/bundle/helsinki-servicenow-platform/page/script/glide-server-apis/reference/r_GlideAggregateExamples.html" style="color: #1968d3; text-decoration: underline; font-family: 'Open Sans';">ServiceNow GlideAggregate</a></p><p>- <a title=" data-attached-link=" class="wz-link" data-attached-link="{&quot;type&quot;:&quot;Web&quot;,&quot;url&quot;:&quot;https://github.com/service-portal/documentation&quot;,&quot;title&quot;:&quot;https://github.com/service-portal/documentation&quot;}" href="https://github.com/service-portal/documentation" style="color: #1968d3; text-decoration: underline; font-family: 'Open Sans';">Service Portal Documentation</a></p><p>- <a data-attached-link="{&quot;type&quot;:&quot;Web&quot;,&quot;url&quot;:&quot;https://d3js.org/&quot;,&quot;title&quot;:&quot;https://d3js.org/&quot;}" href="https://d3js.org/" style="color: #1968d3; text-decoration: underline; font-family: 'Open Sans';" title="https://d3js.org/">https://d3js.org/</a></p>