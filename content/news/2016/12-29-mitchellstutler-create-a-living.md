---
title: "Create a Living Listening Widget"
date: 2016-12-28T20:54:45.000Z
authors: ["mitchellstutler"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=26cd62e9dbd0dbc01dcaf3231f9619c0"
---
<p>The Service Portal has an extremely useful feature called Record Watch. Record Watch allows you to configure a listener function that notifies your widget when certain database actions take place. When you have a Record Watch function configured, your widget can automatically adjust itself accordingly.</p><p></p><p>In this example, I am going to explain how I added a Record Watch listener function that automatically increases the size of a bar in a bar chart when a matching record is added. This will build on a previous post of mine which can be found <a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=0e6dea29dbd0dbc01dcaf3231f96199d">here</a>, so this post will strictly focus on the Record Watch portion.</p><p></p><h1>Record Watch Function</h1><p></p><p>First, you'll want to inject spUtil into your client script function parameters. I'll post my full client script at the end in case you aren't sure where to put this.</p><p></p><p>Here is my Record Watch function which I will walk through:</p><p></p><p>spUtil.recordWatch($scope, "incident", "active=true", function(name, d) {                                         </p><p>                       if (d.action == 'entry') {</p><p>                                               for (i=0; i &lt; $scope.activeData.length; i++) {</p><p>                                                                       if (d.record.category.display_value == $scope.activeData[i].category) {</p><p>                                                                                               $scope.activeData[i].value++;</p><p>                                                                                               break;</p><p>                                                                       }</p><p>                                               }</p><p>                                               $scope.updateBars($scope.activeData);</p><p>                       }</p><p>});</p><p></p><p>In the first line, we call the Record Watch function from spUtil. The second parameter we pass is the table that we want to listen to and the third parameter is the filter so we only get notifications for the specific types of records we want. Lastly, we create an anonymous function that will allow us to make sense of the notification we receive from our Record Watch function.</p><p></p><p>We are passing the parameters of name and d to our anonymous function. The name will provide information about the update. The d parameter contains information about the action type as well as the information from the record that was updated. I encourage you to log these 2 objects to your console so you can explore them to get a better feel for what we get back from Record Watch.</p><p>   </p><p>You can see that inside of my anonymous function I am only looking for inserted records by using if (d.action == 'entry'). When I get a matching notification, I check the newly created incident's category and increment the bar that has a matching category.</p><p></p><p>This is just one example out of infinite possibilities of how you can use the Record Watch functionality. My specific thought behind this example is that you could create a dashboard that doesn't need to be refreshed because the widgets automatically adjust according to the Record Watch notifications.</p><p></p><p><img   alt="Listening Bar Chart.png" class="image-1 jive-image" height="367" src="fa07648edbd0dfc068c1fb651f9619f5.iix" style="width: 789px; height: 366.579px;" width="789"/></p><h1>Client Script</h1><p></p><p>function(spUtil, $scope) {</p><p>                       /* widget controller */</p><p>                       var c = this;</p><p>                 </p><p>                       // Grab our category counts from our Server Script</p><p>                       $scope.activeData = c.data.active;</p><p>                       $scope.inactiveData = c.data.inactive;</p><p>                       $scope.allData = c.data.all;</p><p>                 </p><p>                       // Set the width of the chart along with the height of each bar</p><p>                       var width = c.options.width,</p><p>                       barHeight = c.options.bar_height,</p><p>                       leftMargin = c.options.left_margin;</p><p>                 </p><p>                       $scope.updateBars = function(data) {               </p><p>                                               // Set the dimensions of our chart</p><p>                                               var chart = d3.select(".chart").attr("width", width)</p><p>                                               .attr("height", barHeight * data.length + 50);</p><p></p><p></p><p>                                               // Remove existing axis and tooltip</p><p>                                               d3.select(".x.axis").remove();</p><p>                                               chart.select(".counter").remove();</p><p>                                         </p><p>                                               // Add a placeholder text element for our tooltip</p><p>                                               var counter = chart.append("text").attr("class", "counter")</p><p>                                                                       .attr("y", 10)</p><p>                                                                       .attr("x", width-20);</p><p>                                         </p><p>                                               // Set the domain and range of the chart</p><p>                                               var x = d3.scaleLinear()</p><p>                                                                       .range([leftMargin, width])</p><p>                                                                       .domain([0, d3.max(data, function(d) { return d.value * 1; }) + 10]);</p><p></p><p></p><p>                                               // Bind our new data to our g elements</p><p>                                               var bar = chart.selectAll("g").data(data, function(d) { return d.category;});</p><p>                                         </p><p>                                               // Remove existing bars that aren't in the new data</p><p>                                               bar.exit().remove();</p><p>                                         </p><p>                                               // Create new g elements for new categories in our new data</p><p>                                               var barEnter = bar.enter().append("g")</p><p>                                                                       .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });</p><p>                                         </p><p>                                               // Enter new rect elements</p><p>                                               barEnter.append("rect")</p><p>                                                                       .on("mouseover", highlightBar)</p><p>                                                                       .on("mouseout", unhighlightBar)</p><p>                                                                       .attr("class", "chart-bar")</p><p>                                                                       .attr("height", barHeight - 1)</p><p>                                                                       .attr("x", leftMargin)</p><p>                                                                       .transition().duration(750)</p><p>                                                                       .attr("width", function(d) { return x(d.value) - leftMargin; });</p><p>                                                                 </p><p>                                               // Enter new text labels</p><p>                                               barEnter.append("text")</p><p>                                                                       .attr("x", leftMargin - 5)</p><p>                                                                       .attr("y", barHeight / 2)</p><p>                                                                       .attr("width", leftMargin)</p><p>                                                                       .attr("dy", ".35em")</p><p>                                                                       .style("fill", "black")</p><p>                                                                       .style("text-anchor", "end")</p><p>                                                                       .transition()</p><p>                                                                       .delay(750)</p><p>                                                                       .text(function(d) { return d.category; });</p><p>                                         </p><p>                                               // Update existing bars</p><p>                                               bar.transition().duration(750)</p><p>                                                                       .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });</p><p>                                                                                         </p><p>                                               bar.selectAll('rect')</p><p>                                                                       .on("mouseover", highlightBar)</p><p>                                                                       .on("mouseout", unhighlightBar)</p><p>                                                                       .data(data, function(d) { return d.category;})</p><p>                                                                       .transition().duration(750)</p><p>                                                                       .attr("width", function(d) { return x(d.value) - leftMargin; });</p><p>                                         </p><p>                                               // Create the x-axis and append it to the bottom of the chart           </p><p>                                               var xAxis = d3.axisBottom().scale(x);</p><p>                 </p><p>                                               chart.append("g")</p><p>                                                                       .attr("class", "x axis")</p><p>                                                                       .attr("transform", "translate(0," + (barHeight * data.length) + ")")</p><p>                                                                       .attr("x", leftMargin)</p><p>                                                                       .call(xAxis);</p><p>                                         </p><p>                                               // Define functions for our hover functionality</p><p>                                               function highlightBar(d,i) {</p><p>                                                                       d3.select(this).style("fill", "#b0c4de");                                     </p><p>                                                                       counter.text(d.category + ' ' + d.value);           </p><p>                                               }</p><p>                                         </p><p>                                               function unhighlightBar(d,i) {</p><p>                                                                       d3.select(this).style("fill", "#4682b4");</p><p>                                                                       counter.text("");</p><p>                                               }</p><p>                                         </p><p>                       }</p><p>                 </p><p>                       spUtil.recordWatch($scope, "incident", "active=true", function(name, d) {                                         </p><p>                                               if (d.action == 'entry') {</p><p>                                                                       for (i=0; i &lt; $scope.activeData.length; i++) {</p><p>                                                                                               if (d.record.category.display_value == $scope.activeData[i].category) {</p><p>                                                                                                                       $scope.activeData[i].value++;</p><p>                                                                                                                       break;</p><p>                                                                                               }</p><p>                                                                       }</p><p>                                                                       $scope.updateBars($scope.activeData);</p><p>                                               }</p><p>   });</p><p>                 </p><p>                       $scope.updateBars($scope.activeData);</p><p>                 </p><p>}</p><p></p><p></p><p>Mitch Stutler</p><p>VividCharts Founder</p><p><a title="vidcharts.com/" href="http://vividcharts.com/">vividcharts.com</a></p><p><a title="nkedin.com/in/mitchellstutler/" href="http://linkedin.com/in/mitchellstutler/">linkedin.com/in/mitchellstutler</a></p><p><a title="itter.com/mitchstutler" href="http://twitter.com/mitchstutler">twitter.com/mitchstutler</a></p><p></p><p></p><h1>Sources</h1><p>- <a title="ithub.com/service-portal/documentation/blob/master/documentation/widget_record_watch.md" href="https://github.com/service-portal/documentation/blob/master/documentation/widget_record_watch.md">Record Watch</a></p><p>- <a title="3js.org/" href="https://d3js.org/">d3js.org</a></p>