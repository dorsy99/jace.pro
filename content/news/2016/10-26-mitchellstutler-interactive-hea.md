---
title: "Interactive Heat Map When Are Your Customers Most Active"
date: 2016-10-25T21:55:01.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=840ee62ddbd0dbc01dcaf3231f9619e8"
---
<p>In this post, I am going to outline how I created an interactive heat map in a Service Portal widget by leveraging D3.js. This heat map displays a matrix of colored blocks that indicate how many incidents were created at a given time on a given week day. This could help you forecast service desk scheduling needs, plan when to implement changes, or even identify your highest risk periods.</p><p></p><p><img   alt="Post 5 Total.png" class="image-1 jive-image" height="357" src="125e2806db58dfc03eb27a9e0f9619cc.iix" style="height: 357px; width: 766.136px;" width="766"/></p><p></p><p>Given that this post is using incident data from my instance, I also added in the capability to click a button and transition the heat map to only focus on a particular incident priority. I'm sure that you can imagine multiple use cases for this heat map, so I suggest you view this post as a framework which you can modify to your own needs.</p><p></p><p>Since there are <a title="" _jive_internal="true" href="/people/mitchellstutler/content">previous posts</a> giving a more in-depth introduction to using D3 and Service Portal together, I won't go into much detail with the code. Here are screenshots and/or pasted code for my HTML, CSS, Client Script, and Server Script:</p><p></p><h1>HTML</h1><p></p><p><img   alt="Post 5 HTML.png" class="image-2 jive-image" height="175" src="19bd48cedb509fc03eb27a9e0f961974.iix" style="width: 730px; height: 175.44px;" width="730"/></p><p></p><p>&lt;div class="centered-chart row"&gt;</p><p>         &lt;div id="chart"&gt;&lt;/div&gt;</p><p>         &lt;button class="btn" ng-click="c.updateMap(c.data.blocks, 'total')"&gt;Total&lt;/button&gt;</p><p>         &lt;button class="btn" ng-click="c.updateMap(c.data.blocks, 'p1')"&gt;Priority 1&lt;/button&gt;</p><p>         &lt;button class="btn" ng-click="c.updateMap(c.data.blocks, 'p2')"&gt;Priority 2&lt;/button&gt;</p><p>         &lt;button class="btn" ng-click="c.updateMap(c.data.blocks, 'p3')"&gt;Priority 3&lt;/button&gt;</p><p>         &lt;button class="btn" ng-click="c.updateMap(c.data.blocks, 'p4')"&gt;Priority 4&lt;/button&gt;</p><p>         &lt;button class="btn" ng-click="c.updateMap(c.data.blocks, 'p5')"&gt;Priority 5&lt;/button&gt;</p><p>&lt;/div&gt;</p><p></p><h1>CSS</h1><p></p><p><img   alt="Post 5 CSS.png" class="image-3 jive-image" height="430" src="5d9de3bddbd81fc03eb27a9e0f961927.iix" style="height: 430px; width: 325.631px;" width="326"/></p><p></p><p>rect.bordered {</p><p>         stroke: #E6E6E6;</p><p>         stroke-width:2px;</p><p>}</p><p></p><p>text.mono {</p><p>         font-size: 9pt;</p><p>         font-family: Consolas, courier;</p><p>         fill: #aaa;</p><p>}</p><p></p><p>text.axis-workweek {</p><p>         fill: #000;</p><p>}</p><p></p><p>text.axis-worktime {</p><p>         fill: #000;</p><p>}</p><p></p><p>.btn {</p><p>         background-color: white;</p><p>         border: 1px solid gray !important;</p><p>}</p><p></p><p>.centered-chart {</p><p>         text-align: center;</p><p>}</p><p></p><h1>Client Script</h1><p></p><p>function() {</p><p>                       /* widget controller */</p><p>                       var c = this;</p><p>                 </p><p>                       var margin = { top: 50, right: 0, bottom: 100, left: 30 },</p><p>                       width = 960 - margin.left - margin.right,</p><p>                       height = 430 - margin.top - margin.bottom,</p><p>                       gridSize = Math.floor(width / 24),</p><p>                       legendElementWidth = gridSize*2,</p><p>                       buckets = 9,</p><p>                       colors = ["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],</p><p>                       days = ["Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"],</p><p>                       times = ["1a", "2a", "3a", "4a", "5a", "6a", "7a", "8a", "9a", "10a", "11a", "12a", "1p", "2p", "3p", "4p", "5p", "6p", "7p", "8p", "9p", "10p", "11p", "12p"];</p><p>                 </p><p>                       // Create the chart svg using the defined sizes</p><p>                       var svg = d3.select("#chart").append("svg")</p><p>                       .attr("width", width + margin.left + margin.right)</p><p>                       .attr("height", height + margin.top + margin.bottom)</p><p>                       .append("g")</p><p>                       .attr("transform", "translate(" + margin.left + "," + margin.top + ")");</p><p>                 </p><p>                       // Create the update function that takes the data and count property as parameters</p><p>                       c.updateMap = function(data, count) {</p><p>                                               // Create day labels</p><p>                                               var dayLabels = svg.selectAll(".dayLabel")</p><p>                                               .data(days)</p><p>                                               .enter().append("text")</p><p>                                               .text(function (d) { return d; })</p><p>                                               .attr("x", 0)</p><p>                                               .attr("y", function (d, i) { return i * gridSize; })</p><p>                                               .style("text-anchor", "end")</p><p>                                               .attr("transform", "translate(-6," + gridSize / 1.5 + ")")</p><p>                                               .attr("class", function (d, i) { return ((i &gt;= 0 &amp;&amp; i &lt;= 4) ? "dayLabel mono axis axis-workweek" : "dayLabel mono axis"); });</p><p>                                         </p><p>                                               // Create time labels</p><p>                                               var timeLabels = svg.selectAll(".timeLabel")</p><p>                                               .data(times)</p><p>                                               .enter().append("text")</p><p>                                               .text(function(d) { return d; })</p><p>                                               .attr("x", function(d, i) { return i * gridSize; })</p><p>                                               .attr("y", 0)</p><p>                                               .style("text-anchor", "middle")</p><p>                                               .attr("transform", "translate(" + gridSize / 2 + ", -6)")</p><p>                                               .attr("class", function(d, i) { return ((i &gt;= 7 &amp;&amp; i &lt;= 16) ? "timeLabel mono axis axis-worktime" : "timeLabel mono axis"); });</p><p>                                         </p><p>                                               // Creates color scale based on the number of buckets and</p><p>                                               var colorScale = d3.scaleQuantile()</p><p>                                               .domain([0, buckets - 1, d3.max(data, function (d) { return d[count]; })])</p><p>                                               .range(colors);</p><p>                                         </p><p>                                               // Enter and update blocks</p><p>                                               var blocks = svg.selectAll(".hour")</p><p>                                               .data(data, function(d) {return d.day+':'+d.hour;});</p><p>                                         </p><p>                                               blocks.enter().append("rect")</p><p>                                               .attr("x", function(d) { return (d.hour - 1) * gridSize; })</p><p>                                               .attr("y", function(d) { return (d.day - 1) * gridSize; })</p><p>                                               .attr("rx", 4)</p><p>                                               .attr("ry", 4)</p><p>                                               .attr("class", "hour bordered")</p><p>                                               .attr("width", gridSize)</p><p>                                               .attr("height", gridSize)</p><p>                                               .style("fill", colors[0])</p><p>                                               .transition().duration(1500)</p><p>                                               .style("fill", function(d) { return colorScale(d[count]); });</p><p>                                         </p><p>                                               blocks.transition().duration(1500)</p><p>                                               .style("fill", function(d) { return colorScale(d[count]); });</p><p>                                         </p><p>                                               // Create the new legend and remove the existing legend                     </p><p>                                               var legend = svg.selectAll(".legend")</p><p>                                               .data([0].concat(colorScale.quantiles()), function(d) { return d; });</p><p>                                         </p><p>                                               var legendEnter = legend.enter().append("g")</p><p>                                               .attr("class", "legend");</p><p>                 </p><p>                                               legendEnter.append("rect")</p><p>                                               .attr("x", function(d, i) { return legendElementWidth * i; })</p><p>                                               .attr("y", height)</p><p>                                               .attr("width", legendElementWidth)</p><p>                                               .attr("height", gridSize / 2)</p><p>                                               .style("fill", function(d, i) { return colors[i]; })</p><p>                                         </p><p>                                               legendEnter.append("text")</p><p>                                               .attr("class", "mono")</p><p>                                               .text(function(d) { return "â‰¥ " + Math.round(d); })</p><p>                                               .attr("x", function(d, i) { return legendElementWidth * i; })</p><p>                                               .attr("y", height + gridSize);</p><p>                                         </p><p>                                               legend.exit().remove();</p><p>                       };</p><p>                 </p><p>                       // Function that sets the initial blocks while waiting for the server data to be returned</p><p>                       function setInitialBlocks() {</p><p>                                               var intialBlocks = [];</p><p></p><p>                                               for (i=1;i&lt;8;i++) {</p><p>                                                                       for (j=1;j&lt;25;j++) {</p><p>                                                                                               intialBlocks.push({"day": i, "hour": j, "total": 0});</p><p>                                                                       }</p><p>                                               }</p><p>                                         </p><p>                                               c.updateMap(intialBlocks, "total");</p><p>                       }</p><p>                 </p><p>                       // Function to retrieve block data from the server script</p><p>                       c.display = function() {</p><p>                                               c.server.update().then(function(data) {</p><p>                                                                       c.updateMap(c.data.blocks, "total");</p><p>                                               })</p><p>                       }</p><p>                 </p><p>                       setInitialBlocks();</p><p>                       c.display();</p><p>}</p><p></p><h1>Server Script</h1><p></p><p>(function() {</p><p>                 </p><p>                       if (input) {</p><p>                                               var incData = [];</p><p>                                         </p><p>                                               for (i=1;i&lt;8;i++) {</p><p>                                                                       for (j=1;j&lt;25;j++) {</p><p>                                                                                               incData.push({"id": i + ":" + j, "day": i, "hour": j, "total": 0, "p1": 0,</p><p>                                                                                               "p2": 0, "p3": 0, "p4": 0, "p5": 0});</p><p>                                                                       }</p><p>                                               }</p><p>                                         </p><p>                                               // Query the incident table and start totaling the number of records for each priority</p><p>                                               var incGR = new GlideRecord('incident');</p><p>                                               incGR.orderByDesc('opened_at');</p><p>                                               incGR.setLimit(3000);</p><p>                                               incGR.query();</p><p>                                               while (incGR.next()) {</p><p>                                                                       var hour = incGR.opened_at.slice(11,13);</p><p>                                                                       var gdt = new GlideDateTime(incGR.opened_at);</p><p>                                                                       var day = gdt.getDayOfWeek();</p><p>                                                                       var key = day+':'+hour;</p><p>                                                                       var block = incData.filter(findBlock(key));</p><p>                                                                       if (block) {</p><p>                                                                                               block[0].total++;</p><p>                                                                                               switch(incGR.priority+'') {</p><p>                                                                                                                       case '1':</p><p>                                                                                                                       block[0].p1++;</p><p>                                                                                                                       break;</p><p>                                                                                                                       case '2':</p><p>                                                                                                                       block[0].p2++;</p><p>                                                                                                                       break;</p><p>                                                                                                                       case '3':</p><p>                                                                                                                       block[0].p3++;</p><p>                                                                                                                       break;</p><p>                                                                                                                       case '4':</p><p>                                                                                                                       block[0].p4++;</p><p>                                                                                                                       break;</p><p>                                                                                                                       case '5':</p><p>                                                                                                                       block[0].p5++;</p><p>                                                                                                                       break;</p><p>                                                                                               }</p><p>                                                                       }</p><p>                                               }</p><p>                                         </p><p>                                               data.blocks = incData;</p><p>                       }</p><p>                 </p><p>                       function findBlock(key) {</p><p>                                               return function(element) {</p><p>                                                                       return element.id == key;</p><p>                                               }</p><p>                       }     </p><p>})();</p><p></p><h1>D3 Transitions</h1><p></p><p>By clicking one of the priority buttons, we can transition our heat map to only look at our incidents with that priority. Although screenshots won't demo the aesthetically pleasing, gradual D3 transitions used in our widget, here is an example:</p><p></p><p>All incidents:</p><p><img   alt="Post 5 Total.png" class="image-4 jive-image" height="384" src="de00194edb589f048c8ef4621f9619fd.iix" style="height: 384px; width: 823.806px;" width="824"/></p><p></p><p>Priority 4 incidents:</p><p><img   alt="Post 5 Priority 4.png" class="image-5 jive-image" height="385" src="bc5ce04edbd45f048c8ef4621f961928.iix" style="height: 385px; width: 820.275px;" width="820"/></p><p></p><p>Mitch Stutler</p><p>VividCharts Founder</p><p><a title="vidcharts.com/" href="http://vividcharts.com/">vividcharts.com</a></p><p><a title="nkedin.com/in/mitchellstutler/" href="http://linkedin.com/in/mitchellstutler/">linkedin.com/in/mitchellstutler</a></p><p><a title="itter.com/mitchstutler" href="http://twitter.com/mitchstutler">twitter.com/mitchstutler</a></p><h1></h1><h1>Sources</h1><p>- <a title="3js.org/" href="https://d3js.org/">https://d3js.org/</a></p><p>- <a title=".ocks.org/tjdecke/5558084" href="http://bl.ocks.org/tjdecke/5558084">Day / Hour Heatmap</a></p>