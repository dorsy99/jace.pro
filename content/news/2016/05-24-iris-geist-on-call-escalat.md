---
title: "OnCall Escalations taken apart and put back together"
date: 2016-05-23T20:16:04.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=347c22e1dbd0dbc01dcaf3231f96199a"
---
<p><a title="ocs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/on_call_scheduling/concept/c_UseEscalationsWithOnCallSchedul.html" href="https://docs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/on_call_scheduling/concept/c_UseEscalationsWithOnCallSchedul.html">On-call escalations</a> allow you to inform your primary, secondary, tertiary, ... on-call engineer that an issue requires their immediate attention. I had a few customers ask me about on-call escalations these last few weeks. In trying to answer my customer's questions, I found that I needed to dig deeper into the issue and — since doing it anyway — I want to share my findings with this stellar community.</p><p></p><p>The first issue I encountered, was that when using the base system (out of box) <a title="ocs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/on_call_scheduling/concept/c_OnCallEscalationsByEmailWorkflow.html" href="https://docs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/on_call_scheduling/concept/c_OnCallEscalationsByEmailWorkflow.html">Escalation Email workflow</a>, the initial escalation message that should look similar to this:</p><p><img   alt="escalation email workflow1.jpg" class="image-7 jive-image" src="33e5e40adbd457041dcaf3231f961986.iix" style="width: 620px; height: 55px; float: left;"/></p><p></p><p></p><p></p><p></p><p>is not entered into the incident at all and if the number of reminders is set to 0, it shows NaN:</p><p><img   alt="escalation email workflow2.jpg" class="image-8 jive-image" src="b064480edb181304b322f4621f96199f.iix" style="width: 620px; height: 56px; float: left;"/></p><p></p><p></p><p></p><p></p><p>Additionally, during the escalation through the different on-call levels, it enters into the comments</p><p><img   alt="email workflow.jpg" class="image-9 jive-image" src="1e816f39db141704ed6af3231f96193c.iix" style="height: auto; float: left;"/></p><p></p><p></p><p></p><p></p><p>without mentioning who was reminded.</p><p></p><p>The next issue was that the workflow through the trigger rule only fired if the <a title="i.service-now.com/kb_view.do?sysparm_article=KB0547296" href="https://hi.service-now.com/kb_view.do?sysparm_article=KB0547296">assignment group was not filled in</a>. In my system, the assignment groups are automatically filled based on the incident category. I was able to use one or the other rule, but not both. I created a workaround using a business rule that empties out the assignment group, but with that, the workflow then fired, and <strong>it kept firing over and over and over again</strong>, until I had over a dozen workflows associated to my incident. Ack!</p><p></p><p>And on top of all of these items, I also attempted to modify the workflow to alert, not just the current escalation point but the past<a title="ocs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/on_call_scheduling/concept/c_ExampleEscalationScenario.html" href="https://docs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/on_call_scheduling/concept/c_ExampleEscalationScenario.html"> escalation points</a> as well. I had to first understand, what inputs the on-call rotation scripts and functions are using, so that I could then use them myself to work as needed.</p><p></p><h1>Syntax Usage of the OnCallRotation scripts</h1><p><span style="color: #343d47; line-height: 1.5;">The following methods are used in scripts and workflows to determine who the current person on call for a specific group is as well as other related information. </span></p><p></p><h3><span style="line-height: 1.5;"><strong>1. getEscalationPlan(sys_id pointing to assignment group, current date/time)</strong></span></h3><p>inputs:</p><p>                   sys_id for the current record's assignment group</p><p>                   Date/Time value retrieved through GlideDateTime()</p><p></p><p>Sample usage:</p><p>                   var rota = new SNC.OnCallRotation();</p><p>                   var gdt = new GlideDateTime();</p><p>                   var escalationPlan = rota.getEscalationPlan(workflow.scratchpad.assignment_group, gdt);</p><p></p><p>output:</p><p>                       gs.log("Escalation Plan " + escalationPlan, "Escalation");</p><p>                       <span style="font-size: 10.0pt; font-family: Arial; color: #343d47; background: whitesmoke;">Escalation Plan [Escalatee [Order:1, UserId:46d44a23a9fe19810012d100cca80666, DeviceId:null, IsDevice:false, TimeBetweenReminders:1970-01-01 00:10:00, ReminderNum:2, Roster ID:633a3aeaeb201100fcfb858ad106fe0a], Escalatee [Order:2, UserId:5137153cc611227c000bbd1bd8cd2007, DeviceId:null, IsDevice:false, TimeBetweenReminders:1970-01-01 00:05:00, ReminderNum:1, Roster ID:7a5007eeeb201100fcfb858ad106fe8b], Escalatee [Order:3, UserId:681b365ec0a80164000fb0b05854a0cd, DeviceId:null, IsDevice:false, TimeBetweenReminders:1970-01-01 00:05:00, ReminderNum:0, Roster ID:b36007eeeb201100fcfb858ad106fe98]]</span></p><p></p><p>The Escalation Plan is a list (not an array) of all the escalatees defined for this plan. To retrieve elements of this list, use the get(level number in string format) method defined against this list as described in 2).</p><p></p><h3><span style="color: #3d3d3d;">2. </span><span style="line-height: 1.5;">escalationPlan.get(level number representing the current level: 1=Primary, 2=Secondary, …)</span></h3><p>input:</p><p>                   current level number (1, 2, ...) but in string format</p><p></p><p>sample usage: </p><p>                       var level = workflow.scratchpad.currentLevel+"";</p><p>                       var escalatee = escalationPlan.get(level-1);</p><p></p><p>output:</p><ol style="list-style-type: lower-alpha;"><li>gs.log("Escalatee " + escalatee, "Escalation");</li></ol><p><span style="font-size: 10.0pt; font-family: Arial; color: #343d47; background: whitesmoke;">Escalatee Escalatee [Order:1, UserId:46d44a23a9fe19810012d100cca80666, DeviceId:null, IsDevice:false, TimeBetweenReminders:1970-01-01 00:10:00, ReminderNum:2, Roster ID:633a3aeaeb201100fcfb858ad106fe0a]</span></p><p></p><p>This returns a list containing the information for the escalation on that level. Contents of individual areas can be addressed as escalatee.&lt;field label before the :&gt;</p><ol style="list-style-type: lower-alpha;"><li>escalatee.timeBetweenReminders.getNumericValue()</li><li>escalatee.reminderNum;</li></ol><p></p><h3><span style="color: #3d3d3d;"><span style="font-weight: bold;">3. </span>getCurrentRotaID()</span></h3><p><span style="color: #3d3d3d;">inputs:</span></p><p><span style="color: #3d3d3d;">                   none</span></p><p></p><p><span style="color: #3d3d3d;">Sample usage:</span></p><p>                       workflow.scratchpad.currentRotaID = rota.getCurrentRotaID(); // store the rota sys_id</p><p>                       // Check if we have more people on the escalation lineup</p><p></p><p>output:</p><p>                       gs.log("Current Rota ID " + workflow.scratchpad.currentRotaID, "Escalation");</p><p><span style="font-size: 10.0pt; font-family: Arial; color: #343d47; background: whitesmoke;">Current Rota ID af3a3aeaeb201100fcfb858ad106fe09</span></p><p></p><p>This returns the sys_id of the Rota record (cmn_rota) that is linked to the current assignment group.</p><p></p><h3><span style="line-height: 1.5;">4. getEscalateeAt(current assignment group, date/time, escalation level: </span>1=Primary, 2=Secondary, …<span style="line-height: 1.5;">)</span></h3><p><span style="line-height: 1.5;">input:</span></p><p><span style="line-height: 1.5;">                   sys_id of the current record's assignment group</span></p><p><span style="line-height: 1.5;">                   date/time in format of GlideDateTime()</span></p><p><span style="line-height: 1.5;">                   escalation level in string format</span></p><p></p><p><span style="line-height: 1.5;">sample usage:</span></p><p><span style="line-height: 1.5;">                   var currentEscalatee = rota.getEscalateeAt(workflow.scratchpad.assignment_group, gdt, level);</span></p><p></p><p><span style="line-height: 1.5;">ouptut:</span></p><ol style="list-style-type: lower-alpha;"><li>gs.log("Current Escalatee" + currentEscalatee, "Escalation");</li></ol><p><span style="font-size: 10.0pt; font-family: Arial; color: #343d47; background: whitesmoke;">Current Escalatee[object GlideRecord]</span></p><p></p><p>This method returns the current (for this level) Escalatee's user (sys_user) record. The current escalatee ID then is the user's sys_id.</p><p></p><h3>5. Updating the current incident   <strong>         </strong></h3><h3><strong>   </strong></h3><h4><strong>5.1 - Initial Escalation update</strong></h4><p>writeLineupToIncidentActivityLog(escalation Plan list, Number of reminders for this escalatee, Time inbetween individual reminders, current incident's sys_id)</p><p>inputs:</p><p>                   Escalation plan list (returned from escalationPlan.get())</p><p>                   Number of reminders from this escalatee (also retrieved from the escalationPlan)</p><p>                   Time between individual reminders (also retrieved from the escalationPlan)</p><p>                   sys_id of the current incident</p><p></p><p>Sample Usage:</p><pre __default_attr="plain" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14636037801266117 jive_text_macro" data-renderedposition="2315.578125_8_1192_448" jivemacro_uid="_14636037801266117"><p>function writeLineupToIncidentActivityLog(plan, numberOfReminders, timeBetweenReminders, incident) {</p><p>                       var message = gs.getMessage("This incident Escalation is in Process. Escalation Plan is now: ");</p><p>                       var lineBreak = " ";</p><p>                       message += lineBreak;</p><p></p><p>                       for(var i = 0; i &lt; plan.size(); i++) {</p><p>                                               //show next escalatee and amount of reminders</p><p>                                               var userId = plan.get(i).userId;</p><p>                                               var userGR = new GlideRecord('sys_user');</p><p>                                               userGR.get(userId);</p><p>                                               var name = userGR.name;</p><p>                                               var reminder = gs.getMessage("reminders");</p><p>                                               if(numberOfReminders == 1)</p><p>                                                                       reminder = gs.getMessage("reminder");</p><p>                 </p><p>                                               if(numberOfReminders == 0)</p><p>                                                                       numberOfReminders = "no";</p><p>                 </p><p>                                               message += name + " (" + numberOfReminders + " " + reminder + ") ";</p><p>                                               message += lineBreak;</p><p>                                               if(i &lt; plan.size()) {</p><p>                                                                       //show when next escalation will happen</p><p>                                                                       //take number of reminders times time between reminders</p><p>                                                                       var time = numberOfReminders * timeBetweenReminders;</p><p>                                                                       message += gs.getMessage("In ") + time/60 + " " + gs.getMessage("minutes") + ". ";</p><p>                                               }</p><p>                       current.comments = message;</p><p>}</p></pre><p>output:</p><p>                   A message in the incident's comments</p><p><img   alt="escalation email workflow1.jpg" class="image-7 jive-image" src="33e5e40adbd457041dcaf3231f961986.iix" style="width: 620px; height: 55px; float: left;"/></p><h4></h4><h4></h4><h4></h4><h4></h4><h4></h4><h4>5.2 - Updates whenever an escalation email is sent to escalatee:</h4><p>writeEscalationToIncidentActivityLog(Name of the current Escalatee, sys_id of the current incident)</p><p>inputs:</p><p>                   user name of the current escalatee</p><p>                   sys_id of the current incident</p><p></p><p>Sample Usage:</p><pre __default_attr="plain" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_1463603736616297 jive_text_macro" data-renderedposition="3057.578125_8_1192_64" jivemacro_uid="_1463603736616297"><p>function writeEscalationToIncidentActivityLog(name, incidentId) {</p><p>                       var message = gs.getMessage("Incident escalated to " + name);</p><p>                       current.comments = message;</p><p>}</p></pre><p></p><p>output:</p><p>                   A message in the incident's comments</p><table border="1" class="jiveBorder" style="border: 1px solid #c6c6c6; width: 100%;"><tbody><tr><td style="padding: 6px;"><p style="padding-left: 30px;">*Incident escalated to David Loo</p></td></tr></tbody></table><p></p><p><span style="font-size: 18pt;"><strong>Sample setup to alert escalatees when a high priority incident is unassigned</strong></span></p><p>Now that we know how to call the different methods related to the on-call code, this example will show how to create a copy of the out of box workflow to email the escalatees and modify it to alert not just the current level, but also the prior level(s), send an email, and start this flow whenever an incident matches the criteria (eg. P1, P2, or assignment group changes, etc)</p><p></p><h2>Switching from trigger rule to business rule</h2><p>I started out by changing from the <a title="ocs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/on_call_scheduling/concept/c_EscalationTriggers.html" href="https://docs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/on_call_scheduling/concept/c_EscalationTriggers.html">trigger rule</a> to calling my workflow from a business rule instead. That gave me better control under which circumstances I want the workflow called. I chose to start my workflow after the priority changes to a P1 or P2, or when the assignment group changes. This is set up through the Business Rule condition. I am running the business rule after insert or update.</p><p></p><pre __default_attr="plain" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_14629836203777549" data-renderedposition="3454.578125_8_1192_128" jivemacro_uid="_14629836203777549" modifiedtitle="true"><p>function onAfter(current, previous) {</p><p>//This function will be automatically called when this rule is processed.</p><p>var wf = new Workflow();</p><p>wf.cancel(current);</p><p>gs.addInfoMessage(gs.getMessage("Workflows for {0} have been cancelled", current.getDisplayValue()) +" due to changed conditions");</p><p></p><p>wf.startFlow('043a297c131f5e00d57c50f32244b058', current, current.operation()); </p><p>}</p></pre><p></p><p>I chose to cancel the existing workflows, but you might not want to do that in your system, if you are planning to have more than one workflow associated with the record. The startFlow function needs to be passed the sys_id of the wf_workflow (Workflow) record, the current record, and the current operation as above.</p><p></p><p><span style="font-size: 14pt;"><strong>Creating and modifying a copy of the On-Call Escalation Email workflow</strong></span></p><p><span style="font-size: 10pt;">Next, I created a copy of the out-of-box On-Call Escalation Email workflow and changed it to meet my requirements. I also included some fixes for the issues described in the beginning. </span></p><p></p><p><span style="font-size: 10pt;">Because I called the workflow from a business rule, rather than <a title="ocs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/on_call_scheduling/task/t_CreateATriggerRule.html" href="https://docs.servicenow.com/bundle/geneva-servicenow-platform/page/administer/on_call_scheduling/task/t_CreateATriggerRule.html">creating a trigger rule</a>, the "vars" object was not passed in and I had to change the "Is there any schedule at the time?" activity to use <em>current</em> instead of <em>vars</em> to determine the assignment group:</span></p><pre __default_attr="plain" __jive_macro_name="code" class="_jivemacro_uid_14629867511188834 jive_macro_code jive_text_macro" data-renderedposition="3777.578125_8_1192_192" jivemacro_uid="_14629867511188834"><p>answer = ifScript();</p><p></p><p>function ifScript() {</p><p>                       var rota = new SNC.OnCallRotation();</p><p>                       var gdt   = new GlideDateTime();</p><p>                       var escalationPlan = rota.getEscalationPlan(<span style="text-decoration: underline; color: #e23d39;"><strong>current</strong></span>.assignment_group.sys_id.toString(), gdt);</p><p>                 </p><p>       if (JSUtil.nil(rota) || JSUtil.nil(rota.getCurrentRotaID())) {</p><p>               return 'no';</p><p>       }</p><p>       return 'yes';</p><p>}</p></pre><table border="1"><tbody><tr><td><p><strong>Line 06 was changed from...</strong></p><p>var escalationPlan = rota.getEscalationPlan(vars.assignment_group.sys_id.toString(), gdt);</p><p><strong>to...</strong></p><p>var escalationPlan = rota.getEscalationPlan(current.assignment_group.sys_id.toString(), gdt);</p></td></tr></tbody></table><p></p><p>In the "More Escalation Levels Available?" activity, I had to do the same adjustment on line 08:</p><pre __default_attr="plain" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14631721102269745 jive_text_macro" data-renderedposition="4104.578125_8_1192_144" jivemacro_uid="_14631721102269745"><p>answer = ifScript();</p><p></p><p>function ifScript() {</p><p>   // Set current level to 0 if we are here for first time</p><p>   // and save the assignment group on the scratchpad</p><p>   if(JSUtil.nil(workflow.scratchpad.currentLevel)){</p><p>   workflow.scratchpad.currentLevel = 0;</p><p>   workflow.scratchpad.assignment_group = current.assignment_group.sys_id + "";</p><p>   }</p></pre><p></p><p></p><p><span style="color: #303030;">For your reference, the full script in the "More Escalation Levels Available" activity then shows:</span></p><pre __default_attr="plain" __jive_macro_name="code" class="_jivemacro_uid_14637780152195749 jive_macro_code jive_text_macro" data-renderedposition="4311.578125_8_1192_1474" jivemacro_uid="_14637780152195749"><p><span style="color: #3d3d3d; line-height: 1.5;">answer = ifScript();</span></p><p></p><p>function ifScript() {</p><p>                       // Set current level to 0 if we are here for first time</p><p>                       // and save the assignment group on the scratchpad</p><p>                       if(JSUtil.nil(workflow.scratchpad.currentLevel)){</p><p>                                               workflow.scratchpad.currentLevel = 0;</p><p>                                               workflow.scratchpad.assignment_group = <span style="color: #c0504d;"><strong>current</strong></span>.assignment_group.sys_id + "";</p><p>                       }</p><p></p><p></p><p>                       var rota = new SNC.OnCallRotation();</p><p>                       var gdt = new GlideDateTime();</p><p>                       var escalationPlan = rota.getEscalationPlan(workflow.scratchpad.assignment_group, gdt);</p><p></p><p>                       workflow.scratchpad.escalationPlan=escalationPlan;</p><p>               </p><p>                       workflow.scratchpad.currentRotaID = rota.getCurrentRotaID(); // store the rota sys_id</p><p>                       // Check if we have more people on the escalation lineup</p><p>               </p><p>                       if(escalationPlan.size() &gt; workflow.scratchpad.currentLevel) {</p><p>                                               workflow.scratchpad.current_backup = workflow.scratchpad.currentLevel ? "backup" : "current";</p><p>                                               workflow.scratchpad.currentLevel ++;</p><p>                                               var level = workflow.scratchpad.currentLevel+"";</p><p>                                               var escalatee = escalationPlan.get(level-1);</p><p>                                               var currentEscalatee = rota.getEscalateeAt(workflow.scratchpad.assignment_group, gdt, level);</p><p>               </p><p>                                               // Handle null due to time-off case</p><p>                                               if(!currentEscalatee || !currentEscalatee.sys_id){                 </p><p>                                                                       return ifScript();</p><p>                                               }</p><p>                                                               </p><p>                                               workflow.scratchpad.currentEscalateeId = currentEscalatee.sys_id;</p><p>                                               workflow.scratchpad.timeBetweenReminders = escalatee.timeBetweenReminders.getNumericValue() / 1000;</p><p>                                               workflow.scratchpad.reminderNum = escalatee.reminderNum;</p><p>                                               workflow.scratchpad.reminderSentNum = 0;</p><p>                                                               </p><p>                                               var user = new GlideRecord('sys_user');</p><p>                                               user.get(currentEscalatee.sys_id);</p><p>                                                               </p><p>                                               //write to incident activity log</p><p>                                               if(level == 1) {</p><p>                                                             //first message, presenting lineup</p><p>                                                             writeLineupToIncidentActivityLog(escalationPlan, escalatee.reminderNum, workflow.scratchpad.timeBetweenReminders, current.getUniqueValue());</p><p>                                               }</p><p>                                               else {</p><p>                                                             writeEscalationToIncidentActivityLog(user.name, current.getUniqueValue());</p><p>                                               }</p><p>               </p><p>                                               workflow.scratchpad.escalateeName = user.name;</p><p>                                               return 'yes';</p><p>                       }</p><p>                       return 'no';</p><p>}</p><p></p><p>function writeEscalationToIncidentActivityLog(name, incidentId) {</p><p>                       var message = gs.getMessage("Incident escalated to " + name);</p><p>                       current.comments = message;</p><p>}</p><p></p><p>function writeLineupToIncidentActivityLog(plan, numberOfReminders, timeBetweenReminders, incident) {</p><p>                       //var message = "[code] ";</p><p>                       var message = gs.getMessage("This incident Escalation is in Process. Escalation Plan is now: ");</p><p>                       var lineBreak = " ";</p><p>                       message += lineBreak;</p><p></p><p>                       for(var i = 0; i &lt; plan.size(); i++) {</p><p>                                               //show next escalatee and amount of reminders</p><p>                                               var userId = plan.get(i).userId;</p><p>                                               var userGR = new GlideRecord('sys_user');</p><p>                                               userGR.get(userId);</p><p>                                               var name = userGR.name;</p><p>                                               var reminder = gs.getMessage("reminders");</p><p>                                               if(numberOfReminders == 1)</p><p>                                                                       reminder = gs.getMessage("reminder");</p><p>               </p><p>                                               if(numberOfReminders == 0)</p><p>                                                                       numberOfReminders = "no";</p><p>               </p><p>                                               message += name + " (" + numberOfReminders + " " + reminder + ") ";</p><p>                                               message += lineBreak;</p><p>                                               if(i &lt; plan.size()) {</p><p>                                                                       //show when next escalation will happen</p><p>                                                                       //take number of reminders times time between reminders</p><p>                                                                       var time = numberOfReminders * timeBetweenReminders;</p><p>                                                                       message += gs.getMessage("In ") + time/60 + " " + gs.getMessage("minutes") + ". ";</p><p>                                               }</p><p>                       }</p><p></p><p>                       //message += " [/code]";</p><p>                       current.comments = message;</p><p>}</p></pre><h2></h2><h2></h2><h2>Creating events to prompt the escalation emails</h2><p>The majority of my changes happened in the "Escalatee has an e-mail?" activity since I switched the workflow from using a workflow notification to creating an event in the event queue.   I did this to allow for more flexibility in the recipients as well as the content of the email through scripting. To accomplish this change, I had to move all notification work into this activity "Escalatee has an e-mail", where I create the event record with all needed parameters:</p><p></p><pre __default_attr="plain" __jive_macro_name="code" class="_jivemacro_uid_14637657808583168 jive_macro_code jive_text_macro" data-renderedposition="5959.578125_8_1192_752" jivemacro_uid="_14637657808583168"><p>// run script</p><p>answer = ifScript();</p><p></p><p>// script to determine answer</p><p>function ifScript() {</p><p>                       // get the current escalatee</p><p>                       var currentEscalatee = new GlideRecord("sys_user");</p><p>                       currentEscalatee.get(workflow.scratchpad.currentEscalateeId);</p><p><span style="color: #c0504d;"><strong>                       workflow.scratchpad.escalateeName = currentEscalatee.name;</strong></span></p><p>                       // determine does user has e-mail address</p><p>                       if (JSUtil.notNil(currentEscalatee.email)) {</p><p>                                               //write to activity log</p><p>                                               logToIncident(workflow.scratchpad.currentLevel, currentEscalatee.name, currentEscalatee.sys_id);</p><p>                                               return 'yes';</p><p>                       } else {</p><p>                                               // log error</p><p>                                               var reason = gs.getMessage("Cannot escalate to {0}: no email address configured", [currentEscalatee.getValue('name')] );</p><p>                                               workflow.error(reason);</p><p>                                               activity.state = 'faulted';</p><p>                                               activity.fault_description = reason;</p><p>                                               return 'no';</p><p>                       }</p><p>}</p><p></p><p>function logToIncident(level, name,esc_id) {</p><p>                       var message = name + " is " + getLevelName(level) + " and has been contacted via Email";</p><p>                       current.comments = message;</p><p><span style="color: #c0504d;"><strong>                       var rota = new SNC.OnCallRotation();</strong></span></p><p><span style="color: #c0504d;"><strong>                       var gdt= new GlideDateTime();</strong></span></p><p><span style="color: #c0504d;"><strong>                       gs.eventQueue("OnCall.escalated", current, esc_id, getLevelName(level));</strong></span></p><p><span style="color: #c0504d;"><strong>for (var esc_ind=1; esc_ind&lt;level; esc_ind++) {</strong></span></p><p><span style="color: #c0504d;"><strong>                       esc_ind_str=esc_ind+""</strong></span></p><p><span style="color: #c0504d;"><strong>                       var priorEscalatee=rota.getEscalateeAt(workflow.scratchpad.assignment_group, gdt, esc_ind_str);</strong></span></p><p><span style="color: #c0504d;"><strong>                                               gs.eventQueue("OnCall.escalated", current, priorEscalatee.sys_id, getLevelName(esc_ind_str));               </strong></span></p><p>                       }</p><p>}</p><p></p><p>function getLevelName(level) {</p><p>                       var levels = [];</p><p>                       levels[1] = "Primary on-call";</p><p>                       levels[2] = "Secondary on-call";</p><p>                       levels[3] = "Tertiary on-call";</p><p>                       if(level &gt; 3)</p><p>                                               return level+"th level";</p><p></p><p>                       return levels[level];</p><p>}</p></pre><table border="1"><tbody><tr><td><p>I added line 09 to fix the issue where the incident update did not include the escalatee's name <strong><br/></strong></p><p><strong>workflow.scratchpad.escalateeName = currentEscalatee.name</strong></p></td></tr></tbody></table><p></p><p><span style="line-height: 1.5;">The logToIncident function was modified from:</span></p><pre __default_attr="plain" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_14637659101859614" data-renderedposition="6804.578125_8_1192_80" jivemacro_uid="_14637659101859614"><p>function writeToIncidentActivityLog(name) {</p><p>   var message = gs.getMessage("Escalation plan exhausted and failed to assign incident. Communication has been sent to ");</p><p>   message += name;</p><p>   current.comments = message;</p><p>}</p></pre><p><span style="line-height: 1.5;"> to</span></p><pre __default_attr="plain" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14637659249497122 jive_text_macro" data-renderedposition="6905.578125_8_1192_194" jivemacro_uid="_14637659249497122"><p><span style="line-height: 1.5;">function logToIncident(level, name,esc_id) {</span></p><p>                       var message = name + " is " + getLevelName(level) + " and has been contacted via Email";</p><p>                       current.comments = message;</p><p><span style="color: #c0504d;"><strong>                       var rota = new SNC.OnCallRotation();</strong></span></p><p><span style="color: #c0504d;"><strong>                       var gdt= new GlideDateTime();</strong></span></p><p><span style="color: #c0504d;"><strong>                       gs.eventQueue("OnCall.escalated", current, esc_id, getLevelName(level));</strong></span></p><p><span style="color: #c0504d;"><strong>for (var esc_ind=1; esc_ind&lt;level; esc_ind++) {</strong></span></p><p><span style="color: #c0504d;"><strong>                       esc_ind_str=esc_ind+""</strong></span></p><p><span style="color: #c0504d;"><strong>                       var priorEscalatee=rota.getEscalateeAt(workflow.scratchpad.assignment_group, gdt, esc_ind_str);</strong></span></p><p><span style="color: #c0504d;"><strong>                       gs.eventQueue("OnCall.escalated", current, priorEscalatee.sys_id, getLevelName(esc_ind_str));                 </strong></span></p><p>                       }</p><p>}</p></pre><p></p><p>These changes were done to be able to create the Event record that would then trigger the email notification. The parameters I am passing to the event record are:</p><p>esc_id = sys_id of the current Escalatee's user record</p><p>getLevelName(level), which will return the string:</p><ul><li>"Primary on-call" for level 1</li><li>"Secondary on-call" for level 2</li><li>"Tertiary on-call" for level 3</li><li>"4th level on-call" for level 4, etc.</li></ul><p></p><p>Since I wanted to email not only the current Escalatee, but all prior Escalatees up to that point as well, I added a for loop going through all levels prior to the current escalation level and created events for those users as well.</p><p></p><p>To inform the incident caller that the record was escalated in the "Reminder needed?" activity, I incorporated a fix to include the current escalatee in the incident's comments, eg. "Beth Anglin has been reminded via Email"   (this was possible through adding and filling workflow.scratchpad.escalateeName in the "Escalatee has an e-mail?" activity highlighted above):</p><pre __default_attr="plain" __jive_macro_name="code" class="_jivemacro_uid_14637781232325041 jive_macro_code jive_text_macro" data-renderedposition="7407.5625_8_1192_306" jivemacro_uid="_14637781232325041"><p><span style="color: #3d3d3d; line-height: 1.5;">answer = ifScript();</span></p><p></p><p>function ifScript() {</p><p>                       // Send a reminder if needed</p><p>                       if (workflow.scratchpad.reminderSentNum &lt; workflow.scratchpad.reminderNum) {</p><p>                                               workflow.scratchpad.reminderSentNum ++ ;</p><p>                                               workflow.scratchpad.reminder = "REMINDER: ";</p><p>                                               activityLog();</p><p>                                               return 'yes';</p><p>                       } else</p><p>                                               workflow.scratchpad.reminder = "";</p><p></p><p>                       return 'no';</p><p>}</p><p></p><p>function activityLog() {</p><p><span style="color: #c0504d;"><strong>                       var message = gs.getMessage(workflow.scratchpad.escalateeName + ' has been reminded via Email');</strong></span></p><p>                       current.comments = message;</p><p>}</p></pre><table border="1"><tbody><tr><td><p>I modified line 17 to fix the issue where the incident update did not include the escalatee's name <strong><br/></strong></p><p><span style="font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px; background-position: repeat;"><strong>var message = gs.getMessage(workflow.scratchpad.escalateeName + ' has been reminded via Email');</strong></span></p><p><span style="font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px; background-position: repeat;"><strong>used to be:</strong></span></p><p>var message = gs.getMessage(workflow.scratchpad.currentEscalateeId + ' has been reminded via Email');</p></td></tr></tbody></table><p></p><h2>Create a notification and matching event registry</h2><p>For event based notifications, we will first have to register the event in the Event Registry (<strong>System Policy &gt; Events &gt; Registry</strong>).   I created the</p><p><span style="color: #c0504d;"><strong>OnCall.escalated </strong></span>event to be against the incident table and fired through a workflow.</p><p><img   alt="notification matching event.jpg" class="image-10 jive-image" src="6385850edb141b04ed6af3231f9619af.iix" style="width: 620px; height: 146px; display: block; margin-left: auto; margin-right: auto;"/></p><p>I then created a notification (<strong>System Policy &gt; Email &gt; Notifications</strong>) as outlined below that runs when this event is fired. The mail script is necessary to determine the user's name based on the user's sys_id.</p><p></p><table border="1"><tbody><tr><td colspan="1"><strong>Subject:</strong></td></tr><tr><td><p>Quick Assignment Required:</p><p>${number}</p></td></tr><tr><td><p><strong>Message text:</strong></p></td></tr><tr><td><p><span style="font-family: Arial; color: black;">${mail_script:UserName} An ${sys_class_name} ${number} has been raised: ${short_description} and you are identified as the ${event.parm2} person now.</span></p><p><span style="font-family: Arial; color: black;">Please navigate to the ${sys_class_name} and assign it to yourself.</span></p><p><span style="font-family: Arial; color: black;">Number: ${number}<br/>Short Description: ${short_description}<br/>Caller: ${caller_id}<br/>Company: ${company}<br/>Category: ${category}<br/>State: ${state}</span></p><p><span style="font-family: Arial; color: black;">Click here to view the ${sys_class_name}: ${URI_REF}</span></p></td></tr><tr><td><strong>Mail Script:</strong></td></tr><tr><td><p><span style="font-family: Arial; color: black;">var userID=event.parm1</span></p><p><span style="font-family: Arial; color: black;">var recipientUser=new GlideRecord("sys_user");</span></p><p><span style="font-family: Arial; color: black;">recipientUser.get(userID);</span></p><p><span style="font-family: Arial; color: black;">var userName=recipientUser.name;</span></p><p><span style="font-family: Arial; color: black;">template.print("Dear " + userName + ",");</span></p><p><span style="font-family: Arial; color: black;">template.print("&lt;br /&gt;");</span></p></td></tr><tr><td><p></p></td></tr></tbody></table><p></p><p>You can only pass 2 parameters to the event queue, and the first has to be the recipient's (group or user) sys_id, as set by the "Event Parm 1 contains recipient" checkbox in the notification. To be able to inform the recipient of which level escalation this is in regards to, and address him or her by their full name, the mail script is used to retrieve the user's name based on the sys_id of the user record passed in as a parameter.</p><p></p><p>When all is done, the finished modified workflow show like this - a simplified flow with added functionality:</p><p><img   alt="on-call direct trigger escalation.jpg" class="image-11 jive-image" src="2603a08adb105f048c8ef4621f961978.iix" style="width: 620px; height: 291px; display: block; margin-left: auto; margin-right: auto;"/></p><p>Armed with this knowledge and examples, you can now use the on-call module as needed by your organization's specific notification requirements. I am looking forward to your feedback and together going deeper in this very interesting topic.</p>