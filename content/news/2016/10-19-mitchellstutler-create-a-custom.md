---
title: "Create a custom bar chart in Service Portal with multiple data sets"
date: 2016-10-18T21:06:38.000Z
authors: ["mitchellstutler"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=0e6dea29dbd0dbc01dcaf3231f96199d"
---
<p style="color: #666666; font-family: 'Open Sans';"><span style="color: #3d3d3d;">In this post, we are going to build a Service Portal widget with an interactive bar chart with multiple data sets. This is the third post in my series that focuses on using D3js within ServiceNow's Service Portal. If you haven't already worked through the previous posts and are finding yourself lost, you might want to check those out <a class="wz-link internal-link" data-attached-link="{&quot;type&quot;:&quot;Pages&quot;,&quot;url&quot;:&quot;id1473969682107&quot;,&quot;title&quot;:&quot;Blog&quot;}" href="http://mitchstutler.com/blog" style="color: #1968d3; text-decoration: underline;"><span style="color: #3d3d3d; text-decoration: underline;">here</span></a>.</span></p><p style="color: #666666; font-family: 'Open Sans';"></p><p style="color: #666666; font-family: 'Open Sans';"><span style="color: #3d3d3d;">New concepts to the series that we will touch on in this post are entering, updating, and exiting data with D3, working with transitions to change our data in a pleasing manner, and adding basic interactive aspects such as hovering effects. The key pieces of our widget that we are going to be focusing on are our server script and our client script.</span></p><p style="color: #666666; font-family: 'Open Sans';"></p><h1><span style="color: #3d3d3d;">Server script</span></h1><p style="color: #666666; font-family: 'Open Sans';"></p><p style="color: #666666; font-family: 'Open Sans';"><span style="color: #3d3d3d;">For this chart, we are going to have the ability to view the counts of active, inactive, and all incidents by category. There are multiple ways to get this data from our server script, but for simplicity's sake we are just going to use 3 separate GlideAggregate calls and push that data into one of 3 arrays defined on the data object. Each of these arrays will contain an object for each category returned from the GlideAggregate call. Each of these objects will look like this after our server script:</span></p><p style="color: #666666; font-family: 'Open Sans';"></p><p style="color: #666666; font-family: 'Open Sans';"><span style="color: #3d3d3d;">{category: "Software", "value": 14}</span></p><p style="color: #666666; font-family: 'Open Sans';"></p><p style="color: #666666; font-family: 'Open Sans';"><span style="color: #3d3d3d;">Below is a screenshot of my server script as well as the pasted code:</span></p><p style="color: #666666; font-family: 'Open Sans';"></p><p style="color: #666666; font-family: 'Open Sans';"><span style="color: #3d3d3d;"><img   alt="Post 4 Server Script.png" class="image-1 jive-image" src="e6015086db105344e9737a9e0f961971.iix" style="height: auto;"/></span></p><p style="color: #666666; font-family: 'Open Sans';"></p><p><span style="color: #3d3d3d;">(function() {</span></p><p><span style="color: #3d3d3d;">             /* populate the 'data' object */</span></p><p><span style="color: #3d3d3d;">             options.width = options.width || 600;</span></p><p><span style="color: #3d3d3d;">             options.bar_height = options.bar_height || 20;</span></p><p><span style="color: #3d3d3d;">             options.left_margin = options.left_margin || 100;</span></p><p></p><p><span style="color: #3d3d3d;">             data.active = [];</span></p><p><span style="color: #3d3d3d;">             data.inactive = [];</span></p><p><span style="color: #3d3d3d;">             data.all = [];</span></p><p></p><p><span style="color: #3d3d3d;">             // Get count of active incidents</span></p><p><span style="color: #3d3d3d;">             var count = new GlideAggregate('incident');</span></p><p><span style="color: #3d3d3d;">             count.addQuery('active', 'true');</span></p><p><span style="color: #3d3d3d;">             count.addAggregate('COUNT', 'category');</span></p><p><span style="color: #3d3d3d;">             count.query();</span></p><p><span style="color: #3d3d3d;">             while (count.next()) {</span></p><p><span style="color: #3d3d3d;">                       var category = count.category.getDisplayValue();</span></p><p><span style="color: #3d3d3d;">                       var categoryCount = count.getAggregate('COUNT', 'category');</span></p><p><span style="color: #3d3d3d;">                       data.active.push({category: category, "value": categoryCount});</span></p><p><span style="color: #3d3d3d;">             }</span></p><p></p><p><span style="color: #3d3d3d;">             / / Get count of inactive incidents</span></p><p><span style="color: #3d3d3d;">             var inactiveCount = new GlideAggregate('incident');</span></p><p><span style="color: #3d3d3d;">             inactiveCount.addQuery('active', 'false');</span></p><p><span style="color: #3d3d3d;">             inactiveCount.addAggregate('COUNT', 'category');</span></p><p><span style="color: #3d3d3d;">             inactiveCount.query();</span></p><p><span style="color: #3d3d3d;">             while (inactiveCount.next()) {</span></p><p><span style="color: #3d3d3d;">                       var category = inactiveCount.category.getDisplayValue();</span></p><p><span style="color: #3d3d3d;">                       var categoryCount = inactiveCount.getAggregate('COUNT', 'category');</span></p><p><span style="color: #3d3d3d;">                       data.inactive.push({category: category, "value": categoryCount});</span></p><p><span style="color: #3d3d3d;">             }</span></p><p></p><p><span style="color: #3d3d3d;">             // Get count of all incidents</span></p><p><span style="color: #3d3d3d;">             var allCount = new GlideAggregate('incident');</span></p><p><span style="color: #3d3d3d;">             allCount.addAggregate('COUNT', 'category');</span></p><p><span style="color: #3d3d3d;">             allCount.query();</span></p><p><span style="color: #3d3d3d;">             while (allCount.next()) {</span></p><p><span style="color: #3d3d3d;">                       var category = allCount.category.getDisplayValue();</span></p><p><span style="color: #3d3d3d;">                       var categoryCount = allCount.getAggregate('COUNT', 'category');</span></p><p><span style="color: #3d3d3d;">                       data.all.push({category: category, "value": categoryCount});</span></p><p><span style="color: #3d3d3d;">             }</span></p><p><span style="color: #3d3d3d;">})();</span></p><p></p><h1><span style="color: #3d3d3d;">Client script</span></h1><p></p><p><span style="color: #3d3d3d;">Since we are working with multiple data sets, we are going to set up a function that takes a data set as a parameter and then updates our bar chart accordingly. This gives us the ability to call this function from buttons in our widget so the user can navigate through these data sets. You might also notice at the end of our client script that we are calling this function with one of the data sets so that the bar chart will be present after the widget loads.</span></p><p></p><p><span style="color: #3d3d3d;">When working with multiple data sets in D3, there are 3 major pieces to the process of changing data sets: entering new data, updating existing data that is also present in the new data set, and exiting existing data that isn't in the new data set. For this example, I enter the new data, then I exit any of the bars that are no longer needed, then enter any new bars, and finally update the bars that are leftover from the previous data set.</span></p><p></p><p><span style="color: #3d3d3d;">Something else that is new from the previous post is that we will use a key function when we bind our data set. For this chart, we are going to use our category name as the key value:</span></p><p></p><p><span style="color: #3d3d3d;">var bar = chart.selectAll("g").data(data, function(d) { return d.category;});</span></p><p></p><p><span style="color: #3d3d3d;">What this allows us to do is update a bar that has values in multiple data sets. For example, the category "Software" appears in both the active and inactive data sets. Since we are keying off of the category name value, we will just update the existing "Software" bar to its new size instead of removing it and then adding a brand new bar.</span></p><p></p><p><span style="color: #3d3d3d;">Now that we are able to update existing bars we will use D3 transitions to gradually change from the existing width to the new width. We will also use transitions for entering new data bars.</span></p><p></p><p><span style="color: #3d3d3d;">The last new piece of functionality that we are adding in this post is attaching mouse-over and mouse-out functions to our bars to give an extra layer of interactive capabilities. Our mouse-over function is going to change the color of the bar that is being hovered on as well as show a tool-tip that provides the exact count of records for that given bar.   Below is the code for our function:</span></p><p></p><p><span style="color: #3d3d3d;">function($scope) {</span></p><p><span style="color: #3d3d3d;">   /* widget controller */</span></p><p><span style="color: #3d3d3d;">   var c = this;</span></p><p></p><p><span style="color: #3d3d3d;">   // Grab our category counts from our Server Script</span></p><p><span style="color: #3d3d3d;">   $scope.activeData = c.data.active;</span></p><p><span style="color: #3d3d3d;">   $scope.inactiveData = c.data.inactive;</span></p><p><span style="color: #3d3d3d;">   $scope.allData = c.data.all;</span></p><p></p><p><span style="color: #3d3d3d;">   // Set the width of the chart along with the height of each bar</span></p><p><span style="color: #3d3d3d;">   var width = c.options.width,</span></p><p><span style="color: #3d3d3d;">   barHeight = c.options.bar_height,</span></p><p><span style="color: #3d3d3d;">   leftMargin = c.options.left_margin;</span></p><p></p><p><span style="color: #3d3d3d;">   $scope.updateBars = function(data) {</span></p><p><span style="color: #3d3d3d;">             // Set the dimensions of our chart</span></p><p><span style="color: #3d3d3d;">             var chart = d3.select(".chart").attr("width", width)</span></p><p><span style="color: #3d3d3d;">             .attr("height", barHeight * data.length + 50);</span></p><p></p><p><span style="color: #3d3d3d;">             // Remove existing axis and tooltip</span></p><p><span style="color: #3d3d3d;">             d3.select(".x.axis").remove();</span></p><p><span style="color: #3d3d3d;">             chart.select(".counter").remove();</span></p><p></p><p><span style="color: #3d3d3d;">             // Add a placeholder text element for our tooltip</span></p><p><span style="color: #3d3d3d;">             var counter = chart.append("text").attr("class", "counter")</span></p><p><span style="color: #3d3d3d;">             .attr("y", 10)</span></p><p><span style="color: #3d3d3d;">             .attr("x", width-20);</span></p><p></p><p><span style="color: #3d3d3d;">             // Set the domain and range of the chart</span></p><p><span style="color: #3d3d3d;">             var x = d3.scaleLinear()</span></p><p><span style="color: #3d3d3d;">             .range([leftMargin, width])</span></p><p><span style="color: #3d3d3d;">             .domain([0, d3.max(data, function(d) { return d.value; })]);</span></p><p></p><p><span style="color: #3d3d3d;">             // Bind our new data to our g elements</span></p><p><span style="color: #3d3d3d;">             var bar = chart.selectAll("g").data(data, function(d) { return d.category;});</span></p><p></p><p><span style="color: #3d3d3d;">             // Remove existing bars that aren't in the new data</span></p><p><span style="color: #3d3d3d;">             bar.exit().remove();</span></p><p></p><p><span style="color: #3d3d3d;">             // Create new g elements for new categories in our new data</span></p><p><span style="color: #3d3d3d;">             var barEnter = bar.enter().append("g")</span></p><p><span style="color: #3d3d3d;">             .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });</span></p><p></p><p><span style="color: #3d3d3d;">             // Enter new rect elements</span></p><p><span style="color: #3d3d3d;">             barEnter.append("rect")</span></p><p><span style="color: #3d3d3d;">             .on("mouseover", highlightBar)</span></p><p><span style="color: #3d3d3d;">             .on("mouseout", unhighlightBar)</span></p><p><span style="color: #3d3d3d;">             .attr("class", "chart-bar")</span></p><p><span style="color: #3d3d3d;">             .attr("height", barHeight - 1)</span></p><p><span style="color: #3d3d3d;">             .attr("x", leftMargin)</span></p><p><span style="color: #3d3d3d;">             .transition().duration(750)</span></p><p><span style="color: #3d3d3d;">             .attr("width", function(d) { return x(d.value) - leftMargin; });</span></p><p></p><p><span style="color: #3d3d3d;">             // Enter new text labels</span></p><p><span style="color: #3d3d3d;">             barEnter.append("text")</span></p><p><span style="color: #3d3d3d;">             .attr("x", leftMargin - 5)</span></p><p><span style="color: #3d3d3d;">             .attr("y", barHeight / 2)</span></p><p><span style="color: #3d3d3d;">             .attr("width", leftMargin)</span></p><p><span style="color: #3d3d3d;">             .attr("dy", ".35em")</span></p><p><span style="color: #3d3d3d;">             .style("fill", "black")</span></p><p><span style="color: #3d3d3d;">             .style("text-anchor", "end")</span></p><p><span style="color: #3d3d3d;">             .transition()</span></p><p><span style="color: #3d3d3d;">             .delay(750)</span></p><p><span style="color: #3d3d3d;">             .text(function(d) { return d.category; });</span></p><p></p><p><span style="color: #3d3d3d;">             // Update existing bars</span></p><p><span style="color: #3d3d3d;">             bar.transition().duration(750)</span></p><p><span style="color: #3d3d3d;">             .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });</span></p><p></p><p><span style="color: #3d3d3d;">             bar.selectAll('rect')</span></p><p><span style="color: #3d3d3d;">             .on("mouseover", highlightBar)</span></p><p><span style="color: #3d3d3d;">             .on("mouseout", unhighlightBar)</span></p><p><span style="color: #3d3d3d;">             .data(data, function(d) { return d.category;})</span></p><p><span style="color: #3d3d3d;">             .transition().duration(750)</span></p><p><span style="color: #3d3d3d;">             .attr("width", function(d) { return x(d.value) - leftMargin; });</span></p><p></p><p><span style="color: #3d3d3d;">             // Create the x-axis and append it to the bottom of the chart</span></p><p><span style="color: #3d3d3d;">             var xAxis = d3.axisBottom().scale(x);</span></p><p></p><p><span style="color: #3d3d3d;">             chart.append("g")</span></p><p><span style="color: #3d3d3d;">             .attr("class", "x axis")</span></p><p><span style="color: #3d3d3d;">             .attr("transform", "translate(0," + (barHeight * data.length) + ")")</span></p><p><span style="color: #3d3d3d;">             .attr("x", leftMargin)</span></p><p><span style="color: #3d3d3d;">             .transition()</span></p><p><span style="color: #3d3d3d;">             .delay(750)</span></p><p><span style="color: #3d3d3d;">             .call(xAxis);</span></p><p></p><p></p><p><span style="color: #3d3d3d;">             // Define functions for our hover functionality</span></p><p><span style="color: #3d3d3d;">             function highlightBar(d,i) {</span></p><p><span style="color: #3d3d3d;">                       d3.select(this).style("fill", "#b0c4de");</span></p><p><span style="color: #3d3d3d;">                       counter.text(d.category + ' ' + d.value);</span></p><p><span style="color: #3d3d3d;">             }</span></p><p></p><p><span style="color: #3d3d3d;">             function unhighlightBar(d,i) {</span></p><p><span style="color: #3d3d3d;">                       d3.select(this).style("fill", "#4682b4");</span></p><p><span style="color: #3d3d3d;">                       counter.text("");</span></p><p><span style="color: #3d3d3d;">             }</span></p><p></p><p><span style="color: #3d3d3d;">   }</span></p><p></p><p><span style="color: #3d3d3d;">   $scope.updateBars($scope.activeData);</span></p><p></p><p><span style="color: #3d3d3d;">}</span></p><p></p><h1><span style="color: #3d3d3d;">HTML</span></h1><p></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';">Below is a screenshot and pasted code for our HTML:</span></p><p></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';"><img   alt="Post 4 HTML.png" class="image-2 jive-image" src="b784f3fddb10d3049c9ffb651f9619e8.iix" style="height: auto;"/></span></p><p></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';">&lt;div class="centered-chart row"&gt;</span></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';">         &lt;h1&gt;D3 Bar Chart&lt;/h1&gt;</span></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';">         &lt;div class="chart-container"&gt;</span></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';">                   &lt;svg class="chart"&gt;&lt;/svg&gt;</span></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';">         &lt;/div&gt;</span></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';">         &lt;div class="button-container"&gt;</span></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';">                   &lt;button class="btn" ng-click="updateBars(activeData)"&gt;Active&lt;/button&gt;</span></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';">                   &lt;button class="btn" ng-click="updateBars(inactiveData)"&gt;Inactive&lt;/button&gt;</span></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';">                   &lt;button class="btn" ng-click="updateBars(allData)"&gt;All&lt;/button&gt;</span></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';">         &lt;/div&gt;</span></p><p><span style="color: #3d3d3d; font-family: 'Open Sans';">&lt;/div&gt;</span></p><p></p><h1><span style="color: #3d3d3d;">CSS</span></h1><p></p><p><span style="color: #3d3d3d;">Below is a screenshot and pasted code for our CSS:</span></p><p></p><p><span style="color: #3d3d3d;"><img   alt="Post 4 CSS.png" class="image-3 jive-image" src="d802d94edb989f048c8ef4621f96194e.iix" style="height: auto;"/></span></p><p></p><p><span style="color: #3d3d3d;">.btn {</span></p><p><span style="color: #3d3d3d;">         background-color: white;</span></p><p><span style="color: #3d3d3d;">         border: 1px solid gray !important;</span></p><p><span style="color: #3d3d3d;">}</span></p><p></p><p><span style="color: #3d3d3d;">.chart rect {</span></p><p><span style="color: #3d3d3d;">         fill: #4682b4;</span></p><p><span style="color: #3d3d3d;">}</span></p><p></p><p><span style="color: #3d3d3d;">.chart-container {</span></p><p><span style="color: #3d3d3d;">         height: 200px;</span></p><p><span style="color: #3d3d3d;">}</span></p><p></p><p><span style="color: #3d3d3d;">.chart text {</span></p><p><span style="color: #3d3d3d;">         font: 10px sans-serif;</span></p><p><span style="color: #3d3d3d;">}</span></p><p></p><p><span style="color: #3d3d3d;">.centered-chart {</span></p><p><span style="color: #3d3d3d;">         text-align: center;</span></p><p><span style="color: #3d3d3d;">}</span></p><p></p><p><span style="color: #3d3d3d;">.counter {</span></p><p><span style="color: #3d3d3d;">         text-anchor: end;</span></p><p><span style="color: #3d3d3d;">}</span></p><p></p><p><span style="color: #3d3d3d;">.axis text {</span></p><p><span style="color: #3d3d3d;">font: 10px sans-serif;</span></p><p><span style="color: #3d3d3d;">}</span></p><p></p><p><span style="color: #3d3d3d;">.axis path,</span></p><p><span style="color: #3d3d3d;">.axis line {</span></p><p><span style="color: #3d3d3d;">         fill: none;</span></p><p><span style="color: #3d3d3d;">         stroke: #000;</span></p><p><span style="color: #3d3d3d;">         shape-rendering: crispEdges;</span></p><p><span style="color: #3d3d3d;">}</span></p><p></p><h1><span style="color: #3d3d3d;">Finished product</span></h1><p></p><p><span style="color: #3d3d3d;">Now that we have everything in place, we can test it out. If you followed along on your own instance correctly, your widget should look similar to this:</span></p><p></p><p><span style="color: #3d3d3d;"><img   alt="Post 4 Bar Chart.png" class="image-4 jive-image" src="7d5e6886db98d704ed6af3231f96193e.iix" style="width: 620px; height: 296px;"/></span></p><p></p><p><span style="color: #3d3d3d;">If yours looks different, it could be that the data in our instances are different. Otherwise, check out the previous posts in this series and see if you missed a step.</span></p><p></p><p><span style="color: #3d3d3d;">We now have what we need to work with multiple data sets to create interactive data visualization widgets in the Service Portal. Keep an eye out for future posts that will build on these foundation blocks of D3 and Service Portal.</span></p><p></p><p></p><p>Mitch Stutler</p><p>VividCharts Founder</p><p><a title="vidcharts.com/" href="http://vividcharts.com/">vividcharts.com</a></p><p><a title="nkedin.com/in/mitchellstutler/" href="http://linkedin.com/in/mitchellstutler/">linkedin.com/in/mitchellstutler</a></p><p><a title="itter.com/mitchstutler" href="http://twitter.com/mitchstutler">twitter.com/mitchstutler</a></p><p></p><h1>Sources</h1><p>- <a title=" data-attached-link=" class="wz-link" data-attached-link="{&quot;type&quot;:&quot;Web&quot;,&quot;url&quot;:&quot;https://docs.servicenow.com/bundle/helsinki-servicenow-platform/page/script/glide-server-apis/reference/r_GlideAggregateExamples.html&quot;,&quot;title&quot;:&quot;https://docs.servicenow.com/bundle/helsinki-servicenow-platform/page/script/glide-server-apis/reference/r_GlideAggregateExamples.html&quot;}" href="https://docs.servicenow.com/bundle/helsinki-servicenow-platform/page/script/glide-server-apis/reference/r_GlideAggregateExamples.html" style="color: #1968d3; text-decoration: underline; font-family: 'Open Sans';">ServiceNow GlideAggregate</a></p><p>- <a data-attached-link="{&quot;type&quot;:&quot;Web&quot;,&quot;url&quot;:&quot;https://d3js.org/&quot;,&quot;title&quot;:&quot;https://d3js.org/&quot;}" href="https://d3js.org/" style="color: #1968d3; text-decoration: underline; font-family: 'Open Sans';" title="https://d3js.org/">https://d3js.org/</a></p>