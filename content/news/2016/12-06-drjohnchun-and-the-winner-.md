---
title: "And the winner is Randomly Selecting GlideRecords"
date: 2016-12-06T03:08:18.000Z
authors: ["drjohnchun"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=2f0e6e2ddbd0dbc01dcaf3231f961925"
---
<p>I've been running a blog series on <a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=efed222ddbd0dbc01dcaf3231f9619f9">Data Sampling Techniques</a> where the latest topic was on <a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=757d2269dbd0dbc01dcaf3231f961917">Statistical Sampling Using Scripted Filter</a>. While the series is targeted towards those interested in data analysis and data quality, I felt a variation of the technique might be of general interest to a wider audience and use cases. So here's a technique on random sampling, that is, randomly selecting <a title="iki.servicenow.com/?title=GlideRecord" href="https://wiki.servicenow.com/?title=GlideRecord">GlideRecords</a> using a <a title="ki.servicenow.com/?title=Script_Includes" href="http://wiki.servicenow.com/?title=Script_Includes">Script Include</a> and a <a title="ki.servicenow.com/?title=Using_Filters_and_Breadcrumbs#Scripted_Filters" href="http://wiki.servicenow.com/?title=Using_Filters_and_Breadcrumbs#Scripted_Filters">Scripted Filter</a>. Some use cases might include:</p><p></p><ol><li>Randomly picking top 3 prize winners for those who responded to Service Desk Satisfaction Survey in the last month, the grand prize being an iPad! This would be a good way to increase response rates to any survey.</li><li>As you're launching the new Service Portal, you want to promote the portal and self service by giving away prizes; the more the customers use the portal, the better chances they have at winning the prizes.</li><li>You've noticed your Knowledge Base is being underutilized, so you'd like to promote the use by giving away prizes.</li><li>With the year-end holidays are approaching, you want to give out prizes to your customers as part of marketing campaign.</li><li>An auditor is asking for a random sample of 10 change records for the Accounts Payable system from the last 12 months.</li><li>You as Process Manager would like to review 30 incident records from the last month as part of Continual Service Improvement program.</li></ol><p></p><p>There may be numerous other use cases not listed here and I'd like to hear about yours. For more analytical data sampling techniques, please see my <a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=efed222ddbd0dbc01dcaf3231f9619f9">blog series</a>.</p><p></p><p>Let's add some fun and excitement!</p><p></p><p><img __jive_macro_name="toc" class="jive_macro_toc jive_macro" data-renderedposition="384.578125_8_61_72" src="/8.0.4.21bdc7e/images/tiny_mce3/plugins/jiveemoticons/images/spacer.gif"/></p><h3>OVERVIEW</h3><p></p><p>Here's a quick overview of what we'll do; more technical details can be found in my other <a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=757d2269dbd0dbc01dcaf3231f961917">blog</a>. Here, we'll focus more on various use cases.</p><p></p><ol><li>Create a <a title="ki.servicenow.com/?title=Script_Includes" href="http://wiki.servicenow.com/?title=Script_Includes">Script Include</a> with a function we'll call <span style="font-family: 'courier new', courier;">randomSample()</span>.</li><li>Call <span style="font-family: 'courier new', courier;">randomSample()</span> from <a title="ki.servicenow.com/?title=Condition_Builder" href="http://wiki.servicenow.com/?title=Condition_Builder">Condition Builders</a> using a <a title="ki.servicenow.com/?title=Using_Filters_and_Breadcrumbs#Scripted_Filters" href="http://wiki.servicenow.com/?title=Using_Filters_and_Breadcrumbs#Scripted_Filters">Scripted Filter</a>.</li><li>Retrieve and review the records.</li></ol><p></p><h3>SCRIPT INCLUDE randomSample()</h3><p></p><p>Let's first create a Script Include with the <span style="font-family: 'courier new', courier;">randomSample()</span> function; this is similar to the <span style="font-family: 'courier new', courier;">statSample()</span> function from my other blog, without the statistical part. Here's how the function works:</p><p></p><ol><li>Takes the <em>table name</em> and <em>encoded query string</em> needed for querying and <em>sample size</em>; if a field other than <span style="font-family: 'courier new', courier;">sys_id</span> is to be returned, specify it.</li><li>Query the table and get the row count using<span style="font-family: 'courier new', courier;"> .getRowCount()</span>.</li><li>Pick a random row from the record set and save the specified field value or <span style="font-family: 'courier new', courier;">sys_id</span>; repeat until the <em>sample size</em> number of unique values are collected.</li><li><p>Return the saved field values in an array.</p></li></ol><p></p><p>To create a new Script Include,</p><p></p><ol><li>Log in with admin role.</li><li>Navigate to <strong>System Definition &gt; Script Includes</strong>.</li><li>Click on <strong>New</strong> button to create a new <strong>Script Include</strong>.</li><li>Fill the form as in the screenshot below:<br/><img   class="jive-image image-8" height="341" src="ea5aed8edb505b04ed6af3231f961989.iix" style="border: 1px solid #ccc; height: 341px; width: 866.475px;" width="866"/></li><li>This can be either Global or Scoped; if Scoped, make sure to jot down the <strong>API Name</strong> to be used later in Scripted Filter.</li><li>Since we want to use this from other applications, set <strong>Accessible from</strong> to <strong>All application scopes</strong>.</li><li>For this to be used as a Scripted Filter, <strong>Client callable</strong> must be <strong>checked</strong>.</li><li>In the Script field, paste the below script (also attached below as a file).</li><li>Finally, click on <strong>Submit</strong>.</li></ol><p></p><pre __default_attr="info" __jive_macro_name="alert" alert="info" class="jive_text_macro jive_macro_alert" data-renderedposition="1532.71875_8_1192_127"><p>NOTE: I noticed an unexplained behavior that the function is called twice in a row when it's used in a Scripted Filter; the first call generates the list view and the results from the second call are displayed in the Condition Builder's breadcrumb, resulting in different sets of data between the breadcrumb and the list view. This would go unnoticed in most cases because the repeated calls bring back the same results. However, due to the random nature of <span style="font-family: 'courier new', courier;">randomSample()</span>, the return values are different each time the function is called. I added some special handling to the script to ensure the results are identical for all calls by sampling only during the first call. I also ensured the function can be called by other scripts as a Script Include without an issue in case it's used outside of Scripted Filter.</p></pre><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14809708243212348 jive_text_macro" data-renderedposition="1694.71875_8_1192_1104" jivemacro_uid="_14809708243212348"><p>/** </p><p> * Performs random sampling against a filtered list of GlideRecords.</p><p> * Takes table name and encoded query string then returns an array of specified field or sys_id of sample records.</p><p> * </p><p> * SCRIPTED FILTER EXAMPLE</p><p> *</p><p> * EXAMPLE 1: GET RANDOM SAMPLE USING ENCODED QUERY STRING</p><p> * [Sys ID] [is] [javascript:randomSample('incident', 'active=1', 30)]</p><p> * returns 30 sample records from the population size of 54,939</p><p> *</p><p> * NOTE: Scripted Filter runs in rhino.sandbox context so not all classes/objects are available for scripting.</p><p> * NOTE: The function is run twice in Scripted Filter somehow, so use randomSampleRecords to run only once.</p><p> *</p><p><span> * MIT License </span><a title="" _jive_internal="true" href="http://tldrlegal.com/l/mit" rel="nofollow" target="_blank">http://tldrlegal.com/l/mit</a></p><p> * Copyright (c) 2016 John.Chun @snowaid.com</p><p> *</p><p> * @param {string} tableName - name of table for GlideRecord </p><p> * @param {string} encodedQuery - encoded query string </p><p> * @param {int} sampleSize - number of records to have in sample </p><p> * @param {string} fieldName - name of field whose unique values are to be returned</p><p> * @return {string[]} array of sys_id of random sample records</p><p> */</p><p></p><p>var randomSampleRecords = [];   // this is in rhino.sandbox context in Scripted Filter; otherwise in global</p><p></p><p>function randomSample(tableName, encodedQuery, sampleSize, fieldName) {</p><p></p><p>   if (randomSampleRecords.length) return randomSampleRecords;   // in Scripted Filter, force to run only once</p><p>   try {</p><p>       //var gr = new GlideRecordSecure(tableName);   // enforce ACL; GlideRecordSecure undefined in Scripted Filter in Helsinki</p><p>       var isScriptedFilter = !this.GlideRecordSecure;   // use the fact that GlideRecordSecure is undefined in Scripted Filter</p><p>       var gr = new GlideRecord(tableName);</p><p>       if (!gr.isValid()) throw 'Invalid table name "' + tableName + '".';</p><p>       if (!gr.canRead()) throw 'No permission to read from "' + tableName + '".';   // test ACL for table</p><p>       fieldName = fieldName || 'sys_id';   // default to sys_id</p><p>       if (gr.getElement(fieldName) == null) throw 'Field "' + fieldName + '" not found.';</p><p>       if (!(sampleSize &gt; 0)) throw 'Sample size must be a positive integer.';</p><p>       </p><p>       // get population</p><p>       if (encodedQuery) gr.addQuery(encodedQuery);</p><p>       gr.query();   // to getRowCount()</p><p>       var population = gr.getRowCount();</p><p>       if (!population || population &lt; sampleSize) throw 'Total number of rows ' + population + ' is less than sample size ' + sampleSize + '.';</p><p></p><p>       // throw dice and get a random sample</p><p>       var offsets = [], records = [];</p><p>       while (records.length &lt; sampleSize) {</p><p>           var offset = Math.floor(Math.random() * population);   // 0 &lt;= offset &lt; population</p><p>           if (indexOf(offsets, offset) &gt;= 0) continue;   // dupe offset, so rethrow dice</p><p>           offsets.push(offset);</p><p>           if (offsets.length &gt;= population) break;   // tried entire population</p><p>           gr.chooseWindow(offset, offset + 1);   // works in global &amp; scoped</p><p>           gr.query();</p><p>           if (gr.next()) {</p><p>               var value = gr.getElement(fieldName).toString();</p><p>               if (indexOf(records, value) &lt; 0) records.push(value);</p><p>           }</p><p>       }</p><p></p><p>       if (isScriptedFilter) randomSampleRecords = records;   // in Scripted Filter, save randomSampleRecords</p><p>       return records;</p><p>   }</p><p>   catch(e) {</p><p>       return 'ERROR: ' + e;   // return error message</p><p>   }</p><p>   </p><p>   // emulates Array.prototype.indexOf() in older JavaScript</p><p>   function indexOf(arr, val) { for (var i = 0; i &lt; arr.length; i++) if (arr[i] == val) return i; return -1; }</p><p>}</p></pre><p></p><h3>SERVICE DESK SATISFACTION SURVEY WINNERS</h3><p></p><p>Let's pick three lucky winners among those who responded to Service Desk Satisfaction Survey last month. If someone responded to more than one survey, it increases the odds of winning (if not, they may not be motivated to respond to subsequent surveys). Sent-out surveys are stored in the <strong>Survey Instances [asmt_assessment_instance]</strong> table (the <strong>Survey Responses [asmt_assessment_instance_question]</strong> table contains a row for each question answered; unless you want to increase the odds based on the number of questions answered, the Instance table is a better choice). We'll look at only <strong>Service Desk Satisfaction Survey</strong> and whom they were sent out to, in the <strong>user</strong> field. We'll also filter the <strong>taken_on</strong> field to last month only. Since we're selecting people, we'll do all this in a list view for <strong>Users</strong>. Below is the summary of the parameter values:</p><p></p><table border="1" class="jiveBorder" style="border: 1px solid #c6c6c6; width: 100%;"><tbody><tr><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px;" valign="middle"><strong>Parameter</strong></th><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px;" valign="middle"><strong>Value</strong></th></tr><tr><td colspan="1" style="padding: 6px;">List View</td><td colspan="1" style="padding: 6px;">Organization &gt; Users</td></tr><tr><td style="padding: 6px;">tableName</td><td style="padding: 6px;">asmt_assessment_instance</td></tr><tr><td style="padding: 6px;">encodedQuery</td><td style="padding: 6px;">metric_type.name=Service Desk Satisfaction Survey^taken_onONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()</td></tr><tr><td style="padding: 6px;">fieldName</td><td style="padding: 6px;">user.name</td></tr><tr><td style="padding: 6px;">Scripted Filter</td><td style="padding: 6px;"><span style="font-family: 'courier new', courier;">javascript:randomSample('asmt_assessment_instance', 'metric_type.name=Service Desk Satisfaction Survey^taken_onONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()', 3, 'user.name')</span></td></tr></tbody></table><p></p><p>By default, the return value is an array of <span style="font-family: 'courier new', courier;">sys_id</span>. However, you can pick any other field. For example, we can pick user.name, dot-walking to the user record's name field. We need to set the Condition Builder to</p><p></p><p><strong>[Name] [is] [javascript:randomSample('asmt_assessment_instance', 'metric_type.name=Service Desk Satisfaction Survey^taken_onONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()', 3, 'user.name')]</strong></p><p></p><p>Make sure this is the only filter condition. When you run this, the result is</p><p></p><p><img   class="image-7 jive-image" src="db6a37b9db145fc03eb27a9e0f96197a.iix" style="border: 1px solid #ccc; max-width: 1200px; max-height: 900px;"/></p><p></p><p>The breadcrumb shows the three winners, in the order they were picked at random. The list view under it shows the three user records, in the sort order you defined, which, in this case, is by Name in descending order. If you have first, second, and third prizes, you'll want to use the breadcrumb. Depending on your rules, you may want to add a few backup winners so if the winners don't claim their prizes within a certain time, the prizes are given to backup winners. You may also want to use backup winners in case Service Desk staff members are picked but disqualified.</p><p></p><p>Every time you refresh this, you'll get different winners; you may want to make sure to have that one official drawing (refresh) for the prizes.</p><p></p><p>If your organization has people with the same name, you may want to use <strong>User ID</strong> instead since it should be unique:</p><p></p><p><strong>[User ID] [is] [javascript:randomSample('asmt_assessment_instance', 'metric_type.name=Service Desk Satisfaction Survey^taken_onONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()', 3, 'user.user_name')]</strong></p><p></p><p><img   class="jive-image image-4" src="73402906db94d7041dcaf3231f96198b.iix" style="border: 1px solid #ccc; max-width: 1200px; max-height: 900px;"/></p><p></p><p>If you really insist on using <span style="font-family: 'courier new', courier;">sys_id</span>, here's what it looks like (<strong>user</strong> is a reference field that returns <span style="font-family: 'courier new', courier;">sys_id</span> from the <strong>sys_user</strong> table):</p><p></p><p><strong>[Sys ID] [is] [javascript:randomSample('asmt_assessment_instance', 'metric_type.name=Service Desk Satisfaction Survey^taken_onONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()', 3, 'user')]</strong></p><p></p><p><img   class="image-5 jive-image" height="199" src="4cfef442db9c9344e9737a9e0f96195f.iix" style="border: 1px solid #ccc; height: 199px; width: 785.86px;" width="786"/></p><p></p><p>Notice the breadcrumb is not as useful as before unless you can tell who's who from the <span style="font-family: 'courier new', courier;">sys_id</span>s (you can hover over the <strong>User ID</strong> column and look at the link displayed at the bottom of the browser, if needed).</p><p></p><p>If you don't have permission to the <strong>Users [sys_user]</strong> table, you can run the Scripted Filter from other list views, such as Incident. Simply navigate to <strong>Incident &gt; Open</strong> and set the Condition Builder as below:</p><p></p><p><strong>[Number] [is] [javascript:randomSample('asmt_assessment_instance', 'metric_type.name=Service Desk Satisfaction Survey^taken_onONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()', 3, 'user.name')]</strong></p><p></p><p>You can use <strong>Number</strong> or any other string field. This will show</p><p></p><p><img   class="image-6 jive-image" height="310" src="c4dad4cadb5c17041dcaf3231f9619d2.iix" style="border: 1px solid #ccc; height: 310px; width: 714.498px;" width="714"/></p><p></p><p>This obviously doesn't show the names in the list view since it's not a Users list view but the names appear in the breadcrumb, as shown in the screenshot above.</p><p></p><h3>KNOWLEDGE BASE USERS</h3><p></p><p>You've noticed your Knowledge Base is being underutilized, so you'd like to promote the use by giving away prizes. You'll pick 3 winners from those who viewed KB articles last month; the more articles they viewed, the higher odds of winning. The data on who viewed which knowledge base article is stored in the <strong>Knowledge Use [kb_use]</strong> table. We'll use <strong>sys_updated_on </strong>and <strong>user</strong> fields to run similar conditions as before:</p><p></p><table border="1" class="jiveBorder" style="border: 1px solid #c6c6c6; width: 100%;"><tbody><tr><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px;" valign="middle"><strong>Parameter</strong></th><th style="text-align: left; background-color: #f2f2f2; color: #505050; padding: 6px;" valign="middle"><strong>Value</strong></th></tr><tr><td colspan="1" style="padding: 6px;">List View</td><td colspan="1" style="padding: 6px;">Organization &gt; Users</td></tr><tr><td style="padding: 6px;">tableName</td><td style="padding: 6px;">kb_use</td></tr><tr><td style="padding: 6px;">encodedQuery</td><td style="padding: 6px;">sys_updated_onONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()</td></tr><tr><td style="padding: 6px;">fieldName</td><td style="padding: 6px;">user.name</td></tr><tr><td style="padding: 6px;">Scripted Filter</td><td style="padding: 6px;"><span style="font-family: 'courier new', courier;">javascript:randomSample('kb_use', 'sys_updated_onONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()', 3, 'user.name')</span></td></tr></tbody></table><p></p><p>We need to set the Condition Builder to</p><p></p><p><strong>[Name] [is] [javascript:randomSample('kb_use', 'sys_updated_onONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()', 3, 'user.name')]</strong></p><p></p><p>Make sure to run this on the first day of the month; if a user viewed the same article last month as well as this month, the <strong>sys_updated_on</strong> field will only show this month's date, removing the record from the pool.</p><p></p><h3>INCIDENT SAMPLE RECORDS FOR CONTINUAL SERVICE IMPROVEMENT</h3><p></p><p>You as Process Manager would like to review 30 incident records from the last month as part of Continual Service Improvement program. Let's look at only the closed incident tickets and randomly select 30 records:</p><p></p><table border="1" class="jiveBorder" style="border: 1px solid #c6c6c6;"><tbody><tr><th style="padding: 6px; text-align: left; background-color: #f2f2f2; color: #505050;" valign="middle"><strong>Parameter</strong></th><th style="padding: 6px; text-align: left; background-color: #f2f2f2; color: #505050;" valign="middle"><strong>Value</strong></th></tr><tr><td colspan="1" style="padding: 6px;">List View</td><td colspan="1" style="padding: 6px;">Incident &gt; Open (or any Incident list view)</td></tr><tr><td style="padding: 6px;">tableName</td><td style="padding: 6px;">incident</td></tr><tr><td style="padding: 6px;">encodedQuery</td><td style="padding: 6px;">closed_atONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()</td></tr><tr><td style="padding: 6px;">fieldName</td><td style="padding: 6px;"></td></tr><tr><td style="padding: 6px;">Scripted Filter</td><td style="padding: 6px;"><span style="font-family: 'courier new', courier;">javascript:randomSample('incident', 'closed_atONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()', 30)</span></td></tr></tbody></table><p></p><p>We need to set the Condition Builder to</p><p></p><p><strong>[Sys ID] [is] [javascript:randomSample('incident', 'closed_atONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()', 30)]</strong></p><p></p><p>This returns an array of <span style="font-family: 'courier new', courier;">sys_id</span>s; another option is to return an array of Numbers and match on Number:</p><p></p><p><strong>[Number] [is] [javascript:randomSample('incident', 'closed_atONLast month@javascript:gs.beginningOfLastMonth()@javascript:gs.endOfLastMonth()', 30, 'number')]</strong></p><p></p><p>We've looked at a few practical use cases. This should give you ideas on how to use random sampling so you can use it for other cases. Enjoy and have fun!</p><p></p><p><em>Please feel free to connect, follow, post feedback / questions / comments, share, like, bookmark, endorse.</em></p><table><tbody><tr><td>John Chun, <span style="font-size: 8pt;">PhD PMP</span> <a href="http://linkedin.com/in/DrJohnChun"><img alt="see John's LinkedIn profile" class="image-2 jive-image" src="http://megaicons.net/static/img/icons_sizes/182/456/16/linkedin-icon.png" style="height: auto; vertical-align: -13px;" title="see John's LinkedIn profile"/></a><p><a href="http://snowaid.com/"><img alt="visit snowaid" class="image-1 jive-image" src="http://snowaid.com/images/signature.png" style="height: auto; margin-top: -9px;" title="visit snowaid"/></a></p></td><td><a _jive_internal="true" href="/people/drjohnchun/content"><img alt="ServiceNow Advocate" class="image-3 jive-image" src="http://snowaid.com/images/sn_advocate_135x48.png" style="margin-top: -3px;"/></a></td></tr></tbody></table>